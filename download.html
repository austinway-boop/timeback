<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Download Questions</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" as="style">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preload" href="/css/style.css" as="style">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* ---- Page-specific styles ---- */
        .dl-header { margin-bottom: 28px; }
        .dl-header h1 { font-size: 1.6rem; font-weight: 800; color: var(--color-text); margin-bottom: 6px; }
        .dl-header p { font-size: 0.88rem; color: var(--color-text-secondary); line-height: 1.5; }

        /* ---- Course selector ---- */
        .dl-courses { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .dl-course-card {
            background: var(--color-surface); border-radius: 14px; padding: 20px;
            box-shadow: var(--shadow); cursor: pointer; transition: all 0.2s ease;
            border: 2px solid transparent; position: relative;
        }
        .dl-course-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .dl-course-card.selected { border-color: var(--color-primary); background: var(--color-primary-light); }
        .dl-course-card .cc-icon { width: 40px; height: 40px; border-radius: 10px; background: var(--color-primary-light); color: var(--color-primary); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-bottom: 12px; }
        .dl-course-card.selected .cc-icon { background: var(--color-primary); color: #fff; }
        .dl-course-card .cc-title { font-weight: 700; font-size: 0.95rem; color: var(--color-text); line-height: 1.35; }
        .dl-course-card .cc-meta { font-size: 0.78rem; color: var(--color-text-muted); margin-top: 6px; }

        /* ---- Action bar ---- */
        .dl-actions { display: flex; gap: 12px; align-items: center; margin-bottom: 28px; flex-wrap: wrap; }
        .dl-btn {
            padding: 11px 22px; border-radius: 10px; font-weight: 600; font-size: 0.88rem;
            border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
            transition: all 0.15s;
        }
        .dl-btn-primary { background: var(--color-primary); color: #fff; }
        .dl-btn-primary:hover { background: var(--color-primary-dark); }
        .dl-btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .dl-btn-secondary { background: var(--color-surface); color: var(--color-text); border: 1.5px solid var(--color-border); }
        .dl-btn-secondary:hover { background: var(--color-bg); }
        .dl-btn-secondary:disabled { opacity: 0.4; cursor: not-allowed; }
        .dl-status { font-size: 0.82rem; color: var(--color-text-secondary); display: flex; align-items: center; gap: 6px; }
        .dl-status .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ---- Results tree ---- */
        .dl-results { margin-top: 8px; }
        .dl-summary {
            background: var(--color-surface); border-radius: 14px; padding: 20px 24px;
            box-shadow: var(--shadow); margin-bottom: 20px; display: flex; gap: 24px; flex-wrap: wrap;
        }
        .dl-stat { text-align: center; }
        .dl-stat-val { font-size: 1.6rem; font-weight: 800; color: var(--color-primary); }
        .dl-stat-label { font-size: 0.72rem; font-weight: 600; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

        .dl-unit {
            background: var(--color-surface); border-radius: 14px;
            box-shadow: var(--shadow); margin-bottom: 14px; overflow: hidden;
        }
        .dl-unit-header {
            padding: 16px 20px; display: flex; align-items: center; gap: 12px;
            cursor: pointer; user-select: none; transition: background 0.15s;
        }
        .dl-unit-header:hover { background: var(--color-bg); }
        .dl-unit-header .chevron { font-size: 0.75rem; color: var(--color-text-muted); transition: transform 0.2s; }
        .dl-unit.open .dl-unit-header .chevron { transform: rotate(90deg); }
        .dl-unit-header .unit-title { font-weight: 700; font-size: 0.95rem; flex: 1; }
        .dl-unit-header .unit-badge { font-size: 0.72rem; font-weight: 600; background: var(--color-primary-light); color: var(--color-primary-dark); padding: 3px 10px; border-radius: 20px; }
        .dl-unit-body { display: none; border-top: 1px solid var(--color-border); }
        .dl-unit.open .dl-unit-body { display: block; }

        .dl-lesson {
            border-bottom: 1px solid var(--color-border); padding: 0;
        }
        .dl-lesson:last-child { border-bottom: none; }
        .dl-lesson-header {
            padding: 12px 20px 12px 36px; display: flex; align-items: center; gap: 10px;
            cursor: pointer; user-select: none; transition: background 0.15s;
        }
        .dl-lesson-header:hover { background: #FAFBFC; }
        .dl-lesson-header .chevron { font-size: 0.65rem; color: var(--color-text-muted); transition: transform 0.2s; }
        .dl-lesson.open .dl-lesson-header .chevron { transform: rotate(90deg); }
        .dl-lesson-header .lesson-title { font-weight: 600; font-size: 0.88rem; color: var(--color-text-secondary); flex: 1; }
        .dl-lesson-header .lesson-badge { font-size: 0.7rem; font-weight: 600; background: #F0F4F8; color: var(--color-text-muted); padding: 2px 8px; border-radius: 12px; }
        .dl-lesson-body { display: none; padding: 0 20px 16px 52px; }
        .dl-lesson.open .dl-lesson-body { display: block; }

        .dl-question {
            background: var(--color-bg); border-radius: 10px; padding: 14px 16px;
            margin-bottom: 10px; font-size: 0.84rem; line-height: 1.55;
        }
        .dl-question:last-child { margin-bottom: 0; }
        .dl-q-num { font-weight: 700; color: var(--color-primary); margin-right: 6px; }
        .dl-q-type { display: inline-block; font-size: 0.68rem; font-weight: 700; padding: 2px 7px; border-radius: 6px; margin-left: 8px; vertical-align: middle; }
        .dl-q-type.mcq { background: #E3F2FD; color: #1565C0; }
        .dl-q-type.frq { background: #FFF3E0; color: #E65100; }
        .dl-q-prompt { margin-top: 6px; color: var(--color-text); }
        .dl-q-stimulus { margin-top: 6px; padding: 8px 12px; background: #F8F5FF; border-left: 3px solid var(--color-purple); border-radius: 0 8px 8px 0; font-size: 0.8rem; color: var(--color-text-secondary); }
        .dl-q-choices { margin-top: 8px; padding-left: 4px; }
        .dl-q-choice { display: flex; align-items: flex-start; gap: 8px; padding: 4px 0; font-size: 0.82rem; color: var(--color-text-secondary); }
        .dl-q-choice .choice-id { font-weight: 700; color: var(--color-text-muted); min-width: 20px; }
        .dl-q-choice.correct { color: #2E7D32; font-weight: 600; }
        .dl-q-choice.correct .choice-id { color: #2E7D32; }

        /* ---- Video card ---- */
        .dl-video {
            background: #EFF6FF; border-radius: 10px; padding: 12px 16px;
            margin-bottom: 10px; display: flex; align-items: center; gap: 12px; font-size: 0.84rem;
        }
        .dl-video-icon { width: 36px; height: 36px; border-radius: 8px; background: #DBEAFE; color: #2563EB; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; }
        .dl-video-info { flex: 1; min-width: 0; }
        .dl-video-title { font-weight: 600; color: var(--color-text); margin-bottom: 2px; }
        .dl-video-link { font-size: 0.78rem; color: #2563EB; word-break: break-all; }
        .dl-video-link a { color: #2563EB; text-decoration: underline; }

        /* ---- Article card ---- */
        .dl-article {
            background: #FFF7ED; border-radius: 10px; padding: 14px 16px;
            margin-bottom: 10px; font-size: 0.84rem; line-height: 1.55;
        }
        .dl-article-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .dl-article-icon { width: 30px; height: 30px; border-radius: 7px; background: #FFEDD5; color: #C2410C; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0; }
        .dl-article-title { font-weight: 600; color: var(--color-text); }
        .dl-article-url { font-size: 0.75rem; color: #C2410C; word-break: break-all; }
        .dl-article-url a { color: #C2410C; text-decoration: underline; }
        .dl-article-content { color: var(--color-text-secondary); font-size: 0.82rem; margin-top: 6px; max-height: 150px; overflow: hidden; position: relative; }
        .dl-article-content.expanded { max-height: none; }
        .dl-article-toggle { font-size: 0.78rem; color: var(--color-primary); cursor: pointer; margin-top: 4px; font-weight: 600; border: none; background: none; padding: 0; }

        /* ---- Section label inside lesson ---- */
        .dl-section-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: var(--color-text-muted); margin: 14px 0 8px; padding-bottom: 4px; border-bottom: 1px solid var(--color-border); display: flex; align-items: center; gap: 6px; }
        .dl-section-label:first-child { margin-top: 0; }
        .dl-section-label i { font-size: 0.65rem; }

        /* ---- Empty state ---- */
        .dl-empty { text-align: center; padding: 60px 20px; color: var(--color-text-muted); }
        .dl-empty i { font-size: 2.5rem; margin-bottom: 16px; display: block; opacity: 0.3; }
        .dl-empty p { font-size: 0.92rem; }

        /* ---- Loading skeleton ---- */
        .dl-loading { display: flex; align-items: center; gap: 10px; padding: 40px 0; justify-content: center; color: var(--color-text-secondary); font-size: 0.9rem; }

        @media (max-width: 768px) {
            .dl-courses { grid-template-columns: 1fr; }
            .dl-summary { gap: 16px; }
            .dl-lesson-header { padding-left: 24px; }
            .dl-lesson-body { padding-left: 36px; }
        }
    </style>
</head>
<body data-view="student" data-active="download">
<div class="layout">
    <nav class="sidebar" id="sidebar"></nav>
    <main class="main-content">

        <!-- Header -->
        <div class="dl-header">
            <h1><i class="fa-solid fa-download" style="color:var(--color-primary);margin-right:8px;font-size:1.3rem"></i> Download AP Content</h1>
            <p>Select an AP course to extract and download all videos, articles, and questions organized by unit and lesson.</p>
        </div>

        <!-- Course selector -->
        <div id="courses-loading" class="dl-loading">
            <span class="spinner" style="width:20px;height:20px;border:2.5px solid var(--color-border);border-top-color:var(--color-primary);border-radius:50%;animation:spin .6s linear infinite;display:inline-block"></span>
            Loading AP courses...
        </div>
        <div class="dl-courses" id="courses-grid" style="display:none"></div>

        <!-- Actions -->
        <div class="dl-actions" id="actions-bar" style="display:none">
            <button class="dl-btn dl-btn-primary" id="btn-extract" disabled onclick="extractContent()">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Extract Content
            </button>
            <button class="dl-btn dl-btn-secondary" id="btn-download" disabled onclick="downloadJSON()">
                <i class="fa-solid fa-file-arrow-down"></i> Download JSON
            </button>
            <span class="dl-status" id="status-text"></span>
        </div>

        <!-- Results -->
        <div class="dl-results" id="results" style="display:none"></div>

        <!-- Empty state (shown when no AP courses found) -->
        <div class="dl-empty" id="empty-state" style="display:none">
            <i class="fa-solid fa-book-open"></i>
            <p>No AP courses found in this organization.</p>
        </div>

    </main>
</div>

<script src="/js/layout.js?v=3"></script>
<script src="/js/app.js"></script>
<script>
/* =========================================================================
   AlphaLearn â€” TEMP Download Questions Page
   ========================================================================= */

var apCourses = [];
var selectedCourseId = null;
var extractedData = null;

/* ---- Helpers --------------------------------------------------------- */
function isAPCourse(title) { return /\bAP\b/.test((title || '').trim()); }

function setStatus(html) {
    document.getElementById('status-text').innerHTML = html;
}

/* ---- 1. Load courses from enrollments (same source as dashboard) ------ */
(function loadCourses() {
    var userId = localStorage.getItem('alphalearn_userId') || localStorage.getItem('alphalearn_sourcedId') || '';
    if (!userId) {
        document.getElementById('courses-loading').innerHTML =
            '<i class="fa-solid fa-exclamation-triangle" style="color:#E53E3E"></i> Not signed in. <a href="/login" style="color:var(--color-primary);">Sign in</a> first.';
        return;
    }

    fetch('/api/enrollments?userId=' + encodeURIComponent(userId))
        .then(function (r) { return r.json(); })
        .then(function (data) {
            var raw = data.data || data.enrollments || data.courses || (Array.isArray(data) ? data : []);

            // Extract AP courses from enrollment data with the correct
            // course.sourcedId that PowerPath recognizes.
            var seen = {};
            for (var i = 0; i < raw.length; i++) {
                var e = raw[i];
                var course = e.course || {};
                var title = (course.title || '').trim();
                if (!isAPCourse(title)) continue;
                var key = title.toLowerCase();
                if (seen[key]) continue;
                seen[key] = true;
                apCourses.push({
                    sourcedId: course.sourcedId || course.id || '',
                    title: title,
                    courseCode: course.courseCode || course.sourcedId || '',
                });
            }

            document.getElementById('courses-loading').style.display = 'none';

            if (apCourses.length === 0) {
                document.getElementById('empty-state').style.display = '';
                return;
            }

            var grid = document.getElementById('courses-grid');
            grid.style.display = '';
            document.getElementById('actions-bar').style.display = '';

            var icons = ['fa-book-open', 'fa-flask', 'fa-calculator', 'fa-globe-americas', 'fa-atom', 'fa-landmark', 'fa-dna', 'fa-laptop-code'];

            apCourses.forEach(function (c, i) {
                var card = document.createElement('div');
                card.className = 'dl-course-card';
                card.dataset.id = c.sourcedId;
                card.innerHTML =
                    '<div class="cc-icon"><i class="fa-solid ' + icons[i % icons.length] + '"></i></div>' +
                    '<div class="cc-title">' + escapeHtml(c.title) + '</div>' +
                    '<div class="cc-meta">' + escapeHtml(c.courseCode) + '</div>';
                card.onclick = function () { selectCourse(c.sourcedId, card); };
                grid.appendChild(card);
            });
        })
        .catch(function (err) {
            document.getElementById('courses-loading').innerHTML =
                '<i class="fa-solid fa-exclamation-triangle" style="color:#E53E3E"></i> Failed to load courses: ' + escapeHtml(err.message);
        });
})();

function escapeHtml(str) {
    var d = document.createElement('div');
    d.textContent = str || '';
    return d.innerHTML;
}

/* ---- 2. Select course ------------------------------------------------ */
function selectCourse(courseId, card) {
    selectedCourseId = courseId;
    extractedData = null;
    document.getElementById('btn-extract').disabled = false;
    document.getElementById('btn-download').disabled = true;
    document.getElementById('results').style.display = 'none';
    setStatus('');

    // Toggle selected styling
    var cards = document.querySelectorAll('.dl-course-card');
    for (var i = 0; i < cards.length; i++) cards[i].classList.remove('selected');
    card.classList.add('selected');
}

/* ---- 3. Extract content ---------------------------------------------- */
function extractContent() {
    if (!selectedCourseId) return;

    var btn = document.getElementById('btn-extract');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Extracting...';
    document.getElementById('btn-download').disabled = true;
    document.getElementById('results').style.display = 'none';
    setStatus('<span class="spinner"></span> Fetching lesson plan tree, videos, articles &amp; questions...');

    fetch('/api/temp-extract?courseId=' + encodeURIComponent(selectedCourseId))
        .then(function (r) { return r.json(); })
        .then(function (data) {
            btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Extract Content';
            btn.disabled = false;

            if (!data.success) {
                setStatus('<i class="fa-solid fa-exclamation-triangle" style="color:#E53E3E"></i> ' + escapeHtml(data.error || 'Unknown error'));
                return;
            }

            extractedData = data;
            document.getElementById('btn-download').disabled = false;
            var parts = [];
            if (data.totalVideos) parts.push(data.totalVideos + ' video' + (data.totalVideos !== 1 ? 's' : ''));
            if (data.totalArticles) parts.push(data.totalArticles + ' article' + (data.totalArticles !== 1 ? 's' : ''));
            parts.push(data.totalQuestions + ' question' + (data.totalQuestions !== 1 ? 's' : ''));
            setStatus('<i class="fa-solid fa-check-circle" style="color:#2E7D32"></i> Extracted ' + parts.join(', ') + ' from ' + data.unitCount + ' units');
            renderResults(data);
        })
        .catch(function (err) {
            btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Extract Content';
            btn.disabled = false;
            setStatus('<i class="fa-solid fa-exclamation-triangle" style="color:#E53E3E"></i> ' + escapeHtml(err.message));
        });
}

/* ---- 4. Render results tree ------------------------------------------ */
function renderResults(data) {
    var container = document.getElementById('results');
    container.style.display = '';
    container.innerHTML = '';

    // Summary bar
    var summary = document.createElement('div');
    summary.className = 'dl-summary';
    summary.innerHTML =
        '<div class="dl-stat"><div class="dl-stat-val">' + data.unitCount + '</div><div class="dl-stat-label">Units</div></div>' +
        '<div class="dl-stat"><div class="dl-stat-val">' + countLessons(data) + '</div><div class="dl-stat-label">Lessons</div></div>' +
        '<div class="dl-stat"><div class="dl-stat-val">' + (data.totalVideos || 0) + '</div><div class="dl-stat-label">Videos</div></div>' +
        '<div class="dl-stat"><div class="dl-stat-val">' + (data.totalArticles || 0) + '</div><div class="dl-stat-label">Articles</div></div>' +
        '<div class="dl-stat"><div class="dl-stat-val">' + data.totalQuestions + '</div><div class="dl-stat-label">Questions</div></div>';
    container.appendChild(summary);

    if (!data.units || data.units.length === 0) {
        container.innerHTML += '<div class="dl-empty"><i class="fa-solid fa-folder-open"></i><p>No units found for this course.</p></div>';
        return;
    }

    // Units
    data.units.forEach(function (unit, ui) {
        var unitEl = document.createElement('div');
        unitEl.className = 'dl-unit';
        var unitQCount = 0, unitVCount = 0, unitACount = 0;
        (unit.lessons || []).forEach(function (l) {
            unitQCount += (l.questions || []).length;
            unitVCount += (l.videos || []).length;
            unitACount += (l.articles || []).length;
        });
        var badgeParts = [];
        if (unitVCount) badgeParts.push(unitVCount + ' vid');
        if (unitACount) badgeParts.push(unitACount + ' art');
        badgeParts.push(unitQCount + ' Q');

        var unitHeader = document.createElement('div');
        unitHeader.className = 'dl-unit-header';
        unitHeader.innerHTML =
            '<i class="fa-solid fa-chevron-right chevron"></i>' +
            '<span class="unit-title">' + escapeHtml(unit.title || ('Unit ' + (ui + 1))) + '</span>' +
            '<span class="unit-badge">' + badgeParts.join(' / ') + '</span>';
        unitHeader.onclick = function () { unitEl.classList.toggle('open'); };
        unitEl.appendChild(unitHeader);

        var unitBody = document.createElement('div');
        unitBody.className = 'dl-unit-body';

        (unit.lessons || []).forEach(function (lesson, li) {
            var lessonEl = document.createElement('div');
            lessonEl.className = 'dl-lesson';
            var qs = lesson.questions || [];
            var vids = lesson.videos || [];
            var arts = lesson.articles || [];
            var totalItems = vids.length + arts.length + qs.length;

            var lBadgeParts = [];
            if (vids.length) lBadgeParts.push(vids.length + ' vid');
            if (arts.length) lBadgeParts.push(arts.length + ' art');
            lBadgeParts.push(qs.length + ' Q');

            var lessonHeader = document.createElement('div');
            lessonHeader.className = 'dl-lesson-header';
            lessonHeader.innerHTML =
                '<i class="fa-solid fa-chevron-right chevron"></i>' +
                '<span class="lesson-title">' + escapeHtml(lesson.title || ('Lesson ' + (li + 1))) + '</span>' +
                '<span class="lesson-badge">' + lBadgeParts.join(' / ') + '</span>';
            lessonHeader.onclick = function (e) { e.stopPropagation(); lessonEl.classList.toggle('open'); };
            lessonEl.appendChild(lessonHeader);

            var lessonBody = document.createElement('div');
            lessonBody.className = 'dl-lesson-body';

            if (totalItems === 0) {
                lessonBody.innerHTML = '<div style="font-size:0.82rem;color:var(--color-text-muted);padding:8px 0;"><i class="fa-solid fa-info-circle"></i> No content extracted for this lesson.</div>';
            } else {
                // Videos
                if (vids.length > 0) {
                    lessonBody.innerHTML += '<div class="dl-section-label"><i class="fa-solid fa-play"></i> Videos</div>';
                    vids.forEach(function (v) {
                        lessonBody.innerHTML += renderVideo(v);
                    });
                }

                // Articles
                if (arts.length > 0) {
                    lessonBody.innerHTML += '<div class="dl-section-label"><i class="fa-solid fa-file-lines"></i> Articles</div>';
                    arts.forEach(function (a, ai) {
                        lessonBody.innerHTML += renderArticle(a, ai);
                    });
                }

                // Questions
                if (qs.length > 0) {
                    lessonBody.innerHTML += '<div class="dl-section-label"><i class="fa-solid fa-clipboard-question"></i> Questions</div>';
                    qs.forEach(function (q, qi) {
                        lessonBody.innerHTML += renderQuestion(q, qi);
                    });
                }
            }

            lessonEl.appendChild(lessonBody);
            unitBody.appendChild(lessonEl);
        });

        unitEl.appendChild(unitBody);
        container.appendChild(unitEl);
    });
}

function renderVideo(v) {
    var html = '<div class="dl-video">';
    html += '<div class="dl-video-icon"><i class="fa-solid fa-play"></i></div>';
    html += '<div class="dl-video-info">';
    html += '<div class="dl-video-title">' + escapeHtml(v.title || 'Video') + '</div>';
    if (v.url) {
        html += '<div class="dl-video-link"><a href="' + escapeHtml(v.url) + '" target="_blank" rel="noopener">' + escapeHtml(v.url) + '</a></div>';
    }
    html += '</div></div>';
    return html;
}

function renderArticle(a, idx) {
    var artId = 'art-' + Math.random().toString(36).substr(2, 6);
    var html = '<div class="dl-article">';
    html += '<div class="dl-article-header">';
    html += '<div class="dl-article-icon"><i class="fa-solid fa-file-lines"></i></div>';
    html += '<div><div class="dl-article-title">' + escapeHtml(a.title || 'Article') + '</div>';
    if (a.url) {
        html += '<div class="dl-article-url"><a href="' + escapeHtml(a.url) + '" target="_blank" rel="noopener">' + escapeHtml(a.url) + '</a></div>';
    }
    html += '</div></div>';
    if (a.content) {
        html += '<div class="dl-article-content" id="' + artId + '">' + escapeHtml(a.content) + '</div>';
        html += '<button class="dl-article-toggle" onclick="toggleArticle(\'' + artId + '\', this)">Show more</button>';
    }
    html += '</div>';
    return html;
}

function toggleArticle(id, btn) {
    var el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle('expanded');
    btn.textContent = el.classList.contains('expanded') ? 'Show less' : 'Show more';
}

function renderQuestion(q, idx) {
    var html = '<div class="dl-question">';
    html += '<span class="dl-q-num">Q' + (idx + 1) + '</span>';
    if (q.title) html += '<strong>' + escapeHtml(q.title) + '</strong>';
    html += '<span class="dl-q-type ' + (q.type || 'mcq') + '">' + (q.type === 'frq' ? 'FRQ' : 'MCQ') + '</span>';

    if (q.stimulus) {
        html += '<div class="dl-q-stimulus">' + escapeHtml(q.stimulus) + '</div>';
    }

    if (q.prompt) {
        html += '<div class="dl-q-prompt">' + escapeHtml(q.prompt) + '</div>';
    }

    if (q.choices && q.choices.length > 0) {
        html += '<div class="dl-q-choices">';
        q.choices.forEach(function (c) {
            var isCorrect = q.correctAnswer && c.id === q.correctAnswer;
            html += '<div class="dl-q-choice' + (isCorrect ? ' correct' : '') + '">' +
                '<span class="choice-id">' + escapeHtml(c.id) + '</span>' +
                '<span>' + escapeHtml(c.label) + (isCorrect ? ' <i class="fa-solid fa-check"></i>' : '') + '</span>' +
                '</div>';
        });
        html += '</div>';
    }

    html += '</div>';
    return html;
}

function countLessons(data) {
    var n = 0;
    (data.units || []).forEach(function (u) { n += (u.lessons || []).length; });
    return n;
}

/* ---- 5. Download JSON ------------------------------------------------ */
function downloadJSON() {
    if (!extractedData) return;
    var courseName = (extractedData.course && extractedData.course.title) || 'ap-course';
    var safeName = courseName.replace(/[^a-zA-Z0-9]+/g, '_').replace(/_+/g, '_').toLowerCase();
    var filename = '_temp_' + safeName + '_content.json';

    var blob = new Blob([JSON.stringify(extractedData, null, 2)], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>
