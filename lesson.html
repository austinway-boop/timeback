<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Lesson</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body { background: var(--color-bg); }

        .lesson-page {
            display: flex; flex-direction: column;
            min-height: 100vh; max-width: 960px;
            margin: 0 auto; padding: 0 20px;
        }

        /* â”€â”€ Stepper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stepper {
            display: flex; align-items: center; gap: 8px;
            padding: 20px 0 16px; flex-shrink: 0;
        }
        .step {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px; border-radius: 24px;
            font-size: 0.82rem; font-weight: 600;
            cursor: pointer; transition: all var(--transition);
            border: 2px solid transparent;
        }
        .step.active {
            background: var(--color-primary); color: #fff;
            border-color: var(--color-primary);
        }
        .step.completed {
            background: var(--color-primary-light); color: var(--color-primary);
            border-color: var(--color-primary);
        }
        .step.upcoming {
            background: var(--color-bg); color: var(--color-text-muted);
            border-color: var(--color-border);
        }
        .step i { font-size: 0.85rem; }
        .step-arrow {
            font-size: 0.7rem; color: var(--color-text-muted);
            margin: 0 2px;
        }

        /* â”€â”€ Content Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .lesson-content {
            flex: 1; display: flex; flex-direction: column;
            background: var(--color-surface); border-radius: var(--radius);
            border: 1px solid var(--color-border);
            overflow: hidden; min-height: 400px;
        }
        .video-wrap {
            width: 100%; max-width: 720px; margin: 24px auto;
            aspect-ratio: 16 / 9; border-radius: 10px; overflow: hidden;
            background: #000;
        }
        .video-wrap iframe { width: 100%; height: 100%; border: none; }

        .article-wrap {
            flex: 1; padding: 32px 40px; overflow-y: auto;
            font-size: 1rem; line-height: 1.8; color: var(--color-text);
        }
        .article-wrap img { max-width: 100%; border-radius: 8px; margin: 12px 0; }
        .article-wrap h1, .article-wrap h2, .article-wrap h3 { margin: 20px 0 10px; }
        .article-wrap p { margin-bottom: 14px; }
        .article-loading {
            display: flex; align-items: center; justify-content: center;
            padding: 60px; color: var(--color-text-muted);
            flex-direction: column; gap: 12px;
        }
        .article-loading i { font-size: 1.5rem; }
        .lesson-placeholder {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 40px; color: var(--color-text-muted); text-align: center;
        }
        .lesson-placeholder i { font-size: 3rem; margin-bottom: 16px; opacity: 0.3; }
        .lesson-placeholder p { font-size: 0.95rem; margin-bottom: 8px; }
        .lesson-placeholder .sub { font-size: 0.82rem; color: var(--color-text-muted); }

        /* â”€â”€ Bottom Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .lesson-nav {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 0 24px; flex-shrink: 0;
        }
        .lesson-nav.hidden { display: none; }
        .nav-btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 12px 24px; border-radius: var(--radius-sm);
            font-size: 0.9rem; font-weight: 600;
            cursor: pointer; transition: all var(--transition);
            text-decoration: none; border: none;
            font-family: var(--font);
        }
        .nav-btn.back {
            background: var(--color-surface); color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
        }
        .nav-btn.back:hover { border-color: var(--color-primary); color: var(--color-primary); }
        .nav-btn.continue {
            background: var(--color-primary); color: #fff;
        }
        .nav-btn.continue:hover { background: var(--color-primary-dark); }
        .nav-btn i { font-size: 0.85rem; }

        /* â”€â”€ Quiz (inline) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .quiz-area { padding: 24px 28px; }
        .quiz-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
        .quiz-title { font-size: 1.1rem; font-weight: 700; flex: 1; }
        .pp-scoreboard { display: flex; align-items: center; gap: 20px; background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius); padding: 14px 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .pp-ring { position: relative; width: 56px; height: 56px; flex-shrink: 0; }
        .pp-ring svg { transform: rotate(-90deg); }
        .pp-ring-bg { fill: none; stroke: #E8ECF1; stroke-width: 4; }
        .pp-ring-fill { fill: none; stroke: var(--color-primary); stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }
        .pp-ring-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1rem; color: var(--color-primary); }
        .pp-stat { text-align: center; padding: 0 14px; border-left: 1px solid var(--color-border); }
        .pp-stat-label { font-size: 0.68rem; font-weight: 600; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .pp-stat-value { font-size: 1.1rem; font-weight: 700; color: var(--color-text); }
        .pp-label { font-size: 0.7rem; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .pp-score-text { font-weight: 700; font-size: 0.9rem; color: var(--color-text); }
        .question-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius); padding: 24px; margin-bottom: 16px; }
        .question-num { font-size: 0.72rem; font-weight: 700; color: var(--color-primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .question-text { font-size: 1rem; font-weight: 500; line-height: 1.7; margin-bottom: 18px; }
        .question-text img { max-width: 100%; border-radius: 8px; margin: 10px 0; }
        .choices { display: flex; flex-direction: column; gap: 8px; }
        .choice { display: flex; align-items: flex-start; gap: 12px; padding: 12px 16px; border: 2px solid var(--color-border); border-radius: 10px; cursor: pointer; transition: all 0.15s; }
        .choice:hover { border-color: var(--color-primary); background: var(--color-primary-light); }
        .choice.selected { border-color: var(--color-primary); background: var(--color-primary-light); }
        .choice.correct { border-color: #2E7D32; background: #E8F5E9; }
        .choice.incorrect { border-color: #E53E3E; background: #FFF5F5; }
        .choice-letter { width: 30px; height: 30px; border-radius: 50%; background: var(--color-bg); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.82rem; flex-shrink: 0; }
        .choice.selected .choice-letter { background: var(--color-primary); color: #fff; }
        .choice.correct .choice-letter { background: #2E7D32; color: #fff; }
        .choice.incorrect .choice-letter { background: #E53E3E; color: #fff; }
        .choice-text { flex: 1; font-size: 0.92rem; line-height: 1.5; padding-top: 3px; }
        .feedback { padding: 14px; border-radius: 10px; margin-top: 14px; font-size: 0.88rem; line-height: 1.6; display: none; }
        .feedback.correct { background: #E8F5E9; border: 1px solid #A5D6A7; color: #1B5E20; display: block; }
        .feedback.incorrect { background: #FFF5F5; border: 1px solid #FFCDD2; color: #B71C1C; display: block; }
        .stimulus-box { background: var(--color-bg); border-radius: var(--radius-sm); padding: 18px; margin-bottom: 16px; line-height: 1.7; font-size: 0.93rem; max-height: 350px; overflow-y: auto; }
        .stimulus-box img { max-width: 100%; border-radius: 8px; }
        .quiz-btn { padding: 12px 24px; border: none; border-radius: 10px; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; font-family: var(--font); }
        .quiz-btn-primary { background: var(--color-primary); color: #fff; }
        .quiz-btn-primary:hover { background: var(--color-primary-dark); }
        .quiz-btn-primary:disabled { background: #CBD5E0; cursor: not-allowed; }
        .quiz-btn-secondary { background: var(--color-bg); color: var(--color-text-secondary); border: 1px solid var(--color-border); }
        .quiz-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .result-card { padding: 36px; text-align: center; }
        .result-score { font-size: 3rem; font-weight: 800; color: var(--color-primary); }
        .result-label { font-size: 0.95rem; color: var(--color-text-secondary); margin-top: 4px; }
        .result-details { display: flex; gap: 16px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .result-stat { text-align: center; }
        .result-stat-val { font-size: 1.3rem; font-weight: 700; }
        .result-stat-label { font-size: 0.75rem; color: var(--color-text-muted); }
        .xp-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 1rem; font-weight: 700; color: var(--color-primary); background: var(--color-primary-light); padding: 6px 16px; border-radius: 20px; margin-top: 14px; }
        .loading-msg { text-align: center; padding: 48px; color: var(--color-text-muted); }

        /* â”€â”€ AP Exam UI (fullscreen overlay) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .ap-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: #f5f5f5; display: flex; flex-direction: column;
            font-family: var(--font);
        }
        .ap-header {
            display: flex; align-items: center; padding: 10px 24px;
            background: #fff; border-bottom: 1px solid #ddd; flex-shrink: 0;
        }
        .ap-header-title { flex: 1; font-size: 0.92rem; font-weight: 600; color: #222; }
        .ap-timer {
            font-size: 1.5rem; font-weight: 300; color: #222;
            font-variant-numeric: tabular-nums; margin: 0 32px;
        }
        .ap-timer.warning { color: #D97706; }
        .ap-timer.danger { color: #DC2626; }
        .ap-tools { display: flex; gap: 20px; align-items: center; }
        .ap-tool-btn {
            display: flex; flex-direction: column; align-items: center; gap: 1px;
            background: none; border: none; cursor: pointer; color: #666;
            font-size: 0.62rem; font-weight: 500; padding: 4px 6px;
        }
        .ap-tool-btn i { font-size: 1rem; color: #444; }
        .ap-tool-btn:hover i { color: #000; }
        .ap-divider {
            height: 5px; flex-shrink: 0;
            background: repeating-linear-gradient(90deg,
                #E8C840 0 6px, transparent 6px 9px,
                #5B9BD5 9px 15px, transparent 15px 18px,
                #333 18px 24px, transparent 24px 27px
            );
        }
        .ap-body { display: flex; flex: 1; overflow: hidden; background: #fff; }
        .ap-passage {
            width: 45%; min-width: 300px; padding: 32px 36px; overflow-y: auto;
            border-right: 1px solid #e0e0e0; background: #fff;
            font-size: 0.95rem; line-height: 1.85; color: #333;
        }
        .ap-passage p { margin-bottom: 14px; }
        .ap-passage img { max-width: 100%; border-radius: 4px; margin: 10px 0; }
        .ap-question-panel {
            flex: 1; padding: 28px 36px; overflow-y: auto; background: #fff;
        }
        .ap-q-tools {
            display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
        }
        .ap-q-num {
            display: flex; align-items: center; justify-content: center;
            min-width: 30px; height: 30px; padding: 0 8px; border-radius: 6px;
            background: #2d2d2d; color: #fff;
            font-size: 0.85rem; font-weight: 800; flex-shrink: 0;
        }
        .ap-q-bookmark {
            display: inline-flex; align-items: center; gap: 5px;
            background: none; border: none; cursor: pointer;
            font-size: 0.82rem; font-weight: 400; color: #666; padding: 4px 0;
        }
        .ap-q-bookmark:hover { color: #333; }
        .ap-q-bookmark.marked { color: #B45309; font-weight: 600; }
        .ap-q-bookmark.marked i { color: #B45309; }
        .ap-q-abc {
            margin-left: auto; width: 28px; height: 28px; border: 1.5px solid #ccc;
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: 700; color: #999; cursor: pointer; background: #fff;
        }
        .ap-q-prompt {
            font-size: 1rem; line-height: 1.75; margin-bottom: 24px; color: #222;
        }
        .ap-choices { display: flex; flex-direction: column; gap: 0; }
        .ap-choice {
            display: flex; align-items: center; gap: 14px;
            padding: 14px 16px; border: 1.5px solid #ddd;
            border-bottom: none; cursor: pointer; transition: background 0.1s;
            background: #fff;
        }
        .ap-choice:first-child { border-radius: 8px 8px 0 0; }
        .ap-choice:last-child { border-bottom: 1.5px solid #ddd; border-radius: 0 0 8px 8px; }
        .ap-choice:only-child { border-radius: 8px; border-bottom: 1.5px solid #ddd; }
        .ap-choice:hover { background: #f9f9f9; }
        .ap-choice.selected { background: #EDF2FF; border-color: #9bb8f0; }
        .ap-choice.selected + .ap-choice { border-top-color: #9bb8f0; }
        .ap-choice-letter {
            width: 32px; height: 32px; border-radius: 50%;
            border: 2px solid #bbb; background: #fff;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.85rem; color: #555; flex-shrink: 0;
        }
        .ap-choice.selected .ap-choice-letter {
            border-color: #3366cc; background: #3366cc; color: #fff;
        }
        .ap-choice-text { flex: 1; font-size: 0.95rem; line-height: 1.5; color: #333; }
        .ap-footer-divider {
            height: 5px; flex-shrink: 0;
            background: repeating-linear-gradient(90deg,
                #E8C840 0 6px, transparent 6px 9px,
                #5B9BD5 9px 15px, transparent 15px 18px,
                #333 18px 24px, transparent 24px 27px
            );
        }
        .ap-footer {
            display: flex; align-items: center; padding: 10px 24px;
            background: #fff; border-top: 1px solid #ddd; flex-shrink: 0;
        }
        .ap-nav-btn {
            padding: 10px 28px; border: none; border-radius: 20px;
            font-weight: 600; font-size: 0.88rem; cursor: pointer;
            font-family: var(--font); transition: all 0.15s;
        }
        .ap-nav-prev { background: transparent; color: #555; border: 1.5px solid #ccc; }
        .ap-nav-prev:hover { background: #f0f0f0; }
        .ap-nav-next { background: #1a237e; color: #fff; }
        .ap-nav-next:hover { background: #0d1557; }
        .ap-nav-btn:disabled { opacity: 0.35; cursor: not-allowed; }
        .ap-q-nav {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 18px; border: 1.5px solid #ccc; border-radius: 20px;
            background: #fff; font-size: 0.85rem; font-weight: 600; color: #333;
            cursor: pointer; margin: 0 auto;
        }
        .ap-q-nav:hover { border-color: #999; }
        .ap-progress {
            display: flex; gap: 4px; align-items: center; flex: 1;
            justify-content: center; flex-wrap: wrap; margin: 0 20px;
        }
        .ap-dot {
            width: 12px; height: 12px; border-radius: 50%;
            border: 2px solid #ccc; background: #fff;
            cursor: pointer; transition: all 0.12s;
        }
        .ap-dot.answered { background: #3366cc; border-color: #3366cc; }
        .ap-dot.current { border-color: #222; border-width: 2.5px; }
        .ap-dot.marked { border-color: #D97706; background: #FEF3C7; }
        .ap-body.no-passage .ap-question-panel { max-width: 680px; margin: 0 auto; }
        @media (max-width: 900px) {
            .ap-body { flex-direction: column; }
            .ap-passage { width: 100%; min-width: 0; max-height: 40vh; border-right: none; border-bottom: 1px solid #e0e0e0; }
            .ap-question-panel { padding: 20px; }
            .ap-timer { font-size: 1.2rem; margin: 0 16px; }
        }

        /* â”€â”€ Top Nav Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .lesson-topnav {
            display: flex; align-items: center; gap: 14px;
            padding: 20px 0 0; flex-shrink: 0;
        }
        .back-link {
            display: inline-flex; align-items: center; gap: 6px;
            color: var(--color-text-muted); font-size: 0.84rem; font-weight: 500;
            cursor: pointer; text-decoration: none; transition: color var(--transition);
            background: none; border: none; padding: 0;
        }
        .back-link i { font-size: 0.75rem; }
        .back-link:hover { color: var(--color-primary); }
        .lesson-topnav .lesson-title-text {
            flex: 1; font-size: 0.95rem; font-weight: 600; color: var(--color-text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {
            .stepper { flex-wrap: wrap; }
            .step { padding: 6px 12px; font-size: 0.78rem; }
            .lesson-content iframe, .lesson-content .article-frame { min-height: 350px; }
            .quiz-area { padding: 16px; }
            .pp-scoreboard { gap: 12px; padding: 12px 14px; }
        }
    </style>
</head>
<body>
    <div class="lesson-page">
        <!-- Top Nav -->
        <div class="lesson-topnav">
            <a class="back-link" id="back-to-course" onclick="goBackToCourse()">
                <i class="fa-solid fa-arrow-left"></i> Back to Course
            </a>
            <span class="lesson-title-text" id="lesson-title-text"></span>
        </div>

        <!-- Stepper -->
        <div class="stepper" id="stepper"></div>

        <!-- Content Area -->
        <div class="lesson-content" id="lesson-content">
            <div class="lesson-placeholder">
                <i class="fa-solid fa-spinner fa-spin"></i>
                <p>Loading lesson...</p>
            </div>
        </div>

        <!-- Bottom Nav -->
        <div class="lesson-nav" id="lesson-nav">
            <button class="nav-btn back" id="btn-back" onclick="goBack()">
                <i class="fa-solid fa-arrow-left"></i> Back
            </button>
            <button class="nav-btn continue" id="btn-continue" onclick="goNext()">
                Continue <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <script>
    /* ====================================================================
       Lesson Viewer â€” Video â†’ Article â†’ Quiz (all inline)
       ==================================================================== */
    var steps = [];
    var currentStep = 0;
    var lessonData = null;

    var stepConfig = {
        'Video':   { icon: 'fa-video',              label: 'Video' },
        'Article': { icon: 'fa-file-lines',          label: 'Article' },
        'Quiz':    { icon: 'fa-clipboard-question',   label: 'Quiz' }
    };

    /* â”€â”€ Inline quiz state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var quizState = {
        attemptId: null, questionNum: 0, correct: 0, total: 0,
        xpEarned: 0, ppScore: 0, streak: 0,
        currentQuestion: null, selectedChoice: null, answered: false,
        testId: '', title: '', active: false, finished: false,
        // For static (QTI) quiz
        staticQuestions: null, staticIdx: 0,
    };
    var quizArea = null; // reference to the quiz container element

    function resetQuizState() {
        quizState.attemptId = null; quizState.questionNum = 0;
        quizState.correct = 0; quizState.total = 0; quizState.xpEarned = 0;
        quizState.ppScore = 0; quizState.streak = 0;
        quizState.currentQuestion = null; quizState.selectedChoice = null;
        quizState.answered = false; quizState.active = false;
        quizState.finished = false; quizState.staticQuestions = null;
        quizState.staticIdx = 0;
    }

    /* â”€â”€ QTI renderNode (for rich question content) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderNode(node) {
        if (!node) return '';
        if (typeof node === 'string') return node;
        if (Array.isArray(node)) return node.map(renderNode).join('');
        var html = '';
        for (var key in node) {
            if (key.startsWith('_')) continue;
            var val = node[key];
            if (key === 'strong' || key === 'b') { html += '<strong>' + (typeof val === 'string' ? val : renderNode(val)) + '</strong>'; continue; }
            if (key === 'em' || key === 'i') { html += '<em>' + (typeof val === 'string' ? val : renderNode(val)) + '</em>'; continue; }
            if (key === 'p') { var ps = Array.isArray(val) ? val : [val]; ps.forEach(function(p) { html += '<p>' + (typeof p === 'string' ? p : (p['_'] || renderNode(p))) + '</p>'; }); continue; }
            if (key === 'img') { var ia = val['_attributes'] || val; html += '<img src="' + esc(ia.src||'') + '" alt="' + esc(ia.alt||'') + '" style="max-width:100%;border-radius:8px;">'; continue; }
            if (key === 'span') { html += typeof val === 'string' ? val : renderNode(val); continue; }
            if (key === 'div') { var ds = Array.isArray(val) ? val : [val]; ds.forEach(function(d){ html += renderNode(d); }); continue; }
            if (typeof val === 'object' && val !== null) html += renderNode(val);
        }
        return html;
    }

    /* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function init() {
        var raw = sessionStorage.getItem('al_lesson_data');
        if (!raw) { showError('No lesson data found. Please go back and select a lesson.'); return; }
        try { lessonData = JSON.parse(raw); } catch(e) { showError('Invalid lesson data.'); return; }

        document.title = 'AlphaLearn - ' + (lessonData.title || 'Lesson');
        var titleEl = document.getElementById('lesson-title-text');
        if (titleEl) titleEl.textContent = lessonData.title || 'Lesson';

        var resources = lessonData.resources || [];
        var videos = [], articles = [], quizzes = [];
        for (var i = 0; i < resources.length; i++) {
            var r = resources[i];
            if (r.label === 'Video') videos.push(r);
            else if (r.label === 'Quiz') quizzes.push(r);
            else articles.push(r);
        }
        if (videos.length > 0) steps.push({ type: 'Video', resource: videos[0] });
        if (articles.length > 0) steps.push({ type: 'Article', resource: articles[0] });
        if (quizzes.length > 0) steps.push({ type: 'Quiz', resource: quizzes[0] });

        if (steps.length === 0) { showError('This lesson has no content yet.'); return; }

        renderStepper();
        showStep(0);
    }

    function renderStepper() {
        var el = document.getElementById('stepper');
        var html = '';
        for (var i = 0; i < steps.length; i++) {
            if (i > 0) html += '<i class="fa-solid fa-chevron-right step-arrow"></i>';
            var cfg = stepConfig[steps[i].type] || { icon: 'fa-circle', label: steps[i].type };
            var cls = i < currentStep ? 'completed' : i === currentStep ? 'active' : 'upcoming';
            html += '<div class="step ' + cls + '" onclick="showStep(' + i + ')">' +
                '<i class="fa-solid ' + cfg.icon + '"></i><span>' + cfg.label + '</span></div>';
        }
        el.innerHTML = html;
    }

    /* â”€â”€ Show Step â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function showStep(idx) {
        if (idx < 0 || idx >= steps.length) return;
        currentStep = idx;
        renderStepper();

        var step = steps[idx];
        var contentEl = document.getElementById('lesson-content');
        var nav = document.getElementById('lesson-nav');
        var btnContinue = document.getElementById('btn-continue');

        var url = step.resource.url || step.resource.pillUrl || '';

        if (step.type === 'Video') {
            nav.classList.remove('hidden');
            btnContinue.style.display = '';
            btnContinue.innerHTML = (idx === steps.length - 1) ? 'Finish <i class="fa-solid fa-check"></i>' : 'Continue <i class="fa-solid fa-arrow-right"></i>';
            var btnBack = document.getElementById('btn-back');
            btnBack.innerHTML = '<i class="fa-solid fa-arrow-left"></i> Back';
            btnBack.onclick = function() { goBack(); };
            var embedUrl = toEmbedUrl(url);
            if (embedUrl) {
                contentEl.innerHTML = '<div class="video-wrap"><iframe src="' + esc(embedUrl) + '" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>';
            } else {
                contentEl.innerHTML = '<div class="lesson-placeholder"><i class="fa-solid fa-video"></i><p>Video</p><p class="sub"><a href="' + esc(url) + '" target="_blank" style="color:var(--color-primary);">Open video in new tab</a></p></div>';
            }
        } else if (step.type === 'Article') {
            nav.classList.remove('hidden');
            btnContinue.style.display = '';
            btnContinue.innerHTML = (idx === steps.length - 1) ? 'Finish <i class="fa-solid fa-check"></i>' : 'Continue <i class="fa-solid fa-arrow-right"></i>';
            var btnBack = document.getElementById('btn-back');
            btnBack.innerHTML = '<i class="fa-solid fa-arrow-left"></i> Back';
            btnBack.onclick = function() { goBack(); };
            var resId = step.resource.resId || '';
            if (url || resId) {
                contentEl.innerHTML = '<div class="article-loading"><i class="fa-solid fa-spinner fa-spin"></i><span>Loading article...</span></div>';
                fetchArticle(url, resId, contentEl);
            } else {
                contentEl.innerHTML = '<div class="lesson-placeholder"><i class="fa-solid fa-file-lines"></i><p>Article content</p><p class="sub">No article URL available for this lesson.</p></div>';
            }
        } else if (step.type === 'Quiz') {
            // Full-page overlay hides everything while quiz data loads
            nav.classList.add('hidden');
            resetQuizState();
            quizState.active = true;
            quizState.title = lessonData.title || 'Quiz';
            // Show full-page loader (covers entire viewport)
            var existingLoader = document.getElementById('quiz-fullpage-loader');
            if (existingLoader) existingLoader.remove();
            var loader = document.createElement('div');
            loader.id = 'quiz-fullpage-loader';
            loader.className = 'quiz-fullpage-loader';
            loader.innerHTML = '<div class="qfl-spinner"></div>';
            document.body.appendChild(loader);
            // Prepare quiz area behind the overlay
            contentEl.innerHTML = '<div class="quiz-area" id="quiz-area"></div>';
            quizArea = document.getElementById('quiz-area');
            startInlineQuiz(step.resource);
        }
    }

    /* ==================================================================
       INLINE QUIZ ENGINE
       ================================================================== */

    async function startInlineQuiz(resource) {
        var pillUrl = resource.pillUrl || '';
        var resUrl = resource.url || '';
        // Parse quiz params from pillUrl (e.g. /quiz?url=...&title=...&subject=...&grade=...)
        var qParams = {};
        if (pillUrl && pillUrl.includes('?')) {
            var sp = new URLSearchParams(pillUrl.split('?')[1]);
            qParams.url = sp.get('url') || '';
            qParams.id = sp.get('id') || sp.get('testId') || '';
            qParams.subject = sp.get('subject') || '';
            qParams.grade = sp.get('grade') || sp.get('gradeLevel') || '';
            qParams.title = sp.get('title') || '';
        }
        var testId = qParams.id || resource.resId || '';
        var qtiUrl = qParams.url || resUrl || '';
        var subject = qParams.subject || '';
        var gradeLevel = qParams.grade || '';
        if (qParams.title) quizState.title = qParams.title;
        quizState.testId = testId;

        var userId = localStorage.getItem('alphalearn_userId') || localStorage.getItem('alphalearn_sourcedId') || '';

        // â”€â”€ 1. PowerPath adaptive flow â”€â”€
        if (userId && (testId || qtiUrl)) {
            try {
                var startResp = await fetch('/api/quiz-session?action=start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ studentId: userId, testId: testId, subject: subject, grade: gradeLevel }),
                });
                var startData = await startResp.json();
                if (startData.attemptId || startData.id) {
                    quizState.attemptId = startData.attemptId || startData.id;
                    await loadNextQuestion();
                    return;
                }
            } catch(e) { console.warn('PowerPath start failed:', e.message); }
        }

        // â”€â”€ 2. QTI content fetch â”€â”€
        if (qtiUrl || testId) {
            var loaded = await loadAllQTIQuestions(qtiUrl, testId, subject, gradeLevel);
            if (loaded) return;
        }

        // â”€â”€ 3. Fallback: show message â”€â”€
        removeQuizLoader();
        quizArea.innerHTML = '<div class="loading-msg"><i class="fa-solid fa-clipboard-question" style="font-size:2rem;display:block;margin-bottom:12px;opacity:0.3;"></i><p>No quiz questions available for this lesson.</p></div>';
        showNavAfterQuiz(false);
    }

    /* â”€â”€ PowerPath adaptive: one question at a time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function loadNextQuestion() {
        if (!quizState.attemptId) return;
        // Keep the initial loading spinner for the first question; show inline loading for subsequent ones
        if (quizState.questionNum > 0) {
            quizArea.innerHTML = '<div class="loading-msg"><i class="fa-solid fa-spinner fa-spin" style="font-size:1.2rem;display:block;margin-bottom:10px;"></i>Loading question...</div>';
        }
        try {
            var resp = await fetch('/api/quiz-session?action=next&attemptId=' + encodeURIComponent(quizState.attemptId));
            var data = await resp.json();
            if (data.complete || data.finished || data.error === 'no_more_questions') {
                showQuizResults();
                return;
            }
            quizState.currentQuestion = data;
            quizState.questionNum++;
            quizState.selectedChoice = null;
            quizState.answered = false;
            renderQuestion(data);
        } catch(e) {
            removeQuizLoader();
            quizArea.innerHTML = '<div class="loading-msg">Error loading question: ' + esc(e.message) + '</div>';
        }
    }

    /* â”€â”€ Remove full-page loader once quiz UI is ready â”€â”€â”€â”€â”€â”€ */
    function removeQuizLoader() {
        var el = document.getElementById('quiz-fullpage-loader');
        if (el) el.remove();
    }

    /* â”€â”€ Render a question â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderQuestion(q) {
        removeQuizLoader();
        // Show nav with exit option now that quiz content is ready
        var nav = document.getElementById('lesson-nav');
        nav.classList.remove('hidden');
        var btnBack = document.getElementById('btn-back');
        btnBack.innerHTML = '<i class="fa-solid fa-arrow-left"></i> Exit Quiz';
        btnBack.onclick = function() { goBackToCourse(); };
        document.getElementById('btn-continue').style.display = 'none';

        var prompt = q.prompt || q.question || q.text || q.body || '';
        if (typeof prompt === 'object') prompt = renderNode(prompt);
        var choices = q.choices || q.options || q.answers || [];
        var stimulus = q.stimulus || q.passage || q.reading || '';
        if (typeof stimulus === 'object') stimulus = renderNode(stimulus);
        var isFRQ = q.isFRQ || false;
        var expectedLines = q.expectedLines || 10;

        var accuracy = quizState.total > 0 ? Math.round((quizState.correct / quizState.total) * 100) : 0;
        var ppScore = Math.max(0, Math.min(100, quizState.ppScore));
        var circ = 2 * Math.PI * 24;
        var dash = circ - (ppScore / 100) * circ;

        var html = '<div class="quiz-header"><div class="quiz-title">' + esc(quizState.title) + '</div></div>' +
        '<div class="pp-scoreboard">' +
            '<div class="pp-ring"><svg width="56" height="56" viewBox="0 0 56 56">' +
                '<circle class="pp-ring-bg" cx="28" cy="28" r="24"/>' +
                '<circle class="pp-ring-fill" cx="28" cy="28" r="24" stroke-dasharray="' + circ.toFixed(1) + '" stroke-dashoffset="' + dash.toFixed(1) + '"/>' +
            '</svg><div class="pp-ring-text">' + ppScore + '</div></div>' +
            '<div><div class="pp-label">PowerPath 100</div><div class="pp-score-text">' + ppScore + ' / 100</div></div>' +
            '<div class="pp-stat"><div class="pp-stat-label">Questions</div><div class="pp-stat-value">' + quizState.total + '</div></div>' +
            '<div class="pp-stat"><div class="pp-stat-label">Accuracy</div><div class="pp-stat-value">' + accuracy + '%</div></div>' +
        '</div>';

        if (stimulus) html += '<div class="stimulus-box">' + stimulus + '</div>';

        html += '<div class="question-card"><div class="question-num">Question ' + quizState.questionNum + (isFRQ ? ' â€” Free Response' : '') + '</div>';
        html += '<div class="question-text">' + (prompt || 'Loading question...') + '</div>';

        if (isFRQ) {
            html += '<textarea id="frq-response" rows="' + expectedLines + '" placeholder="Type your response here..." ' +
                'style="width:100%;padding:12px;border:2px solid var(--color-border);border-radius:10px;font-size:0.93rem;font-family:inherit;line-height:1.7;resize:vertical;outline:none;box-sizing:border-box;" ' +
                'oninput="document.getElementById(\'quiz-submit\').disabled=!this.value.trim()"></textarea>';
        } else if (choices.length > 0) {
            var letters = 'ABCDEFGHIJ';
            html += '<div class="choices" id="choices">';
            for (var i = 0; i < choices.length; i++) {
                var c = choices[i];
                var cText = c.text || c.label || c.value || c.content || (typeof c === 'string' ? c : '');
                if (typeof cText === 'object') cText = renderNode(cText);
                var cId = c.id || c.identifier || letters[i] || String(i);
                html += '<div class="choice" data-id="' + esc(cId) + '" onclick="selectAnswer(this,\'' + esc(cId) + '\')">' +
                    '<div class="choice-letter">' + (letters[i] || i) + '</div>' +
                    '<div class="choice-text">' + (cText || 'Option ' + (letters[i]||i)) + '</div></div>';
            }
            html += '</div>';
        }

        html += '<div class="feedback" id="feedback"></div></div>';
        html += '<div class="quiz-actions"><button class="quiz-btn quiz-btn-primary" id="quiz-submit" onclick="submitQuizAnswer()" disabled><i class="fa-solid fa-check"></i> Submit Answer</button></div>';

        quizArea.innerHTML = html;
    }

    function selectAnswer(el, choiceId) {
        if (quizState.answered) return;
        quizState.selectedChoice = choiceId;
        document.querySelectorAll('.choice').forEach(function(c) { c.classList.remove('selected'); });
        el.classList.add('selected');
        document.getElementById('quiz-submit').disabled = false;
    }

    /* â”€â”€ Submit answer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function submitQuizAnswer() {
        var frqEl = document.getElementById('frq-response');
        if (frqEl && !quizState.selectedChoice) quizState.selectedChoice = frqEl.value.trim();
        if (!quizState.selectedChoice || quizState.answered) return;
        quizState.answered = true;
        quizState.total++;

        var btn = document.getElementById('quiz-submit');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking...';

        var isCorrect = false, feedback = '';

        // PowerPath adaptive submit
        if (quizState.attemptId) {
            try {
                var resp = await fetch('/api/quiz-session?action=respond', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        attemptId: quizState.attemptId,
                        questionId: quizState.currentQuestion.id || quizState.currentQuestion.questionId || '',
                        response: quizState.selectedChoice,
                    }),
                });
                var data = await resp.json();
                isCorrect = data.correct || data.isCorrect || false;
                feedback = data.feedback || data.explanation || '';
                if (data.xpEarned) quizState.xpEarned += data.xpEarned;
            } catch(e) {}
        }
        // Static quiz: check locally
        else if (quizState.staticQuestions) {
            var sq = quizState.staticQuestions[quizState.staticIdx];
            if (sq) {
                if (sq.isFRQ) {
                    isCorrect = quizState.selectedChoice.length >= 30;
                } else {
                    isCorrect = quizState.selectedChoice === sq.correctId;
                    feedback = (sq.feedbackMap || {})[quizState.selectedChoice] || '';
                }
            }
        }

        // Score
        var pointsChange = 0;
        if (isCorrect) {
            quizState.correct++;
            quizState.streak++;
            var mult = quizState.streak <= 3 ? 1 : Math.min(2.5, 1 + (quizState.streak - 3) * 0.75);
            pointsChange = Math.round(5 * mult);
            quizState.ppScore = Math.min(100, quizState.ppScore + pointsChange);
            quizState.xpEarned += 1;
        } else {
            quizState.streak = 0;
            pointsChange = -4;
            quizState.ppScore = Math.max(0, quizState.ppScore + pointsChange);
        }

        // Show feedback
        var fb = document.getElementById('feedback');
        if (fb) {
            fb.className = 'feedback ' + (isCorrect ? 'correct' : 'incorrect');
            var streakText = isCorrect && quizState.streak > 3 ? ' <span style="font-size:0.82rem;">ğŸ”¥ ' + quizState.streak + ' streak</span>' : '';
            fb.innerHTML = (isCorrect ? '<strong><i class="fa-solid fa-check-circle"></i> Correct! +' + pointsChange + '</strong>' + streakText : '<strong><i class="fa-solid fa-times-circle"></i> Incorrect ' + pointsChange + '</strong>') +
                (feedback ? '<p style="margin-top:6px;">' + feedback + '</p>' : '');
        }

        // Highlight choices
        document.querySelectorAll('.choice').forEach(function(c) {
            if (c.dataset.id === quizState.selectedChoice) c.classList.add(isCorrect ? 'correct' : 'incorrect');
        });

        // FRQ feedback
        if (frqEl) { frqEl.disabled = true; frqEl.style.opacity = '0.7'; }

        // Update scoreboard
        updateScoreboard();

        // Next button
        if (quizState.ppScore >= 100) {
            btn.innerHTML = '<i class="fa-solid fa-trophy"></i> PowerPath 100 â€” Complete!';
            btn.disabled = false;
            btn.onclick = function() { showQuizResults(); };
        } else if (quizState.staticQuestions && quizState.staticIdx + 1 >= quizState.staticQuestions.length) {
            btn.innerHTML = '<i class="fa-solid fa-flag-checkered"></i> See Results';
            btn.disabled = false;
            btn.onclick = function() { showQuizResults(); };
        } else {
            btn.innerHTML = '<i class="fa-solid fa-arrow-right"></i> Next Question';
            btn.disabled = false;
            btn.onclick = function() {
                quizState.selectedChoice = null;
                quizState.answered = false;
                if (quizState.staticQuestions) {
                    quizState.staticIdx++;
                    showStaticQuestion();
                } else {
                    loadNextQuestion();
                }
            };
        }
    }

    function updateScoreboard() {
        var ppScore = Math.max(0, Math.min(100, quizState.ppScore));
        var accuracy = quizState.total > 0 ? Math.round((quizState.correct / quizState.total) * 100) : 0;
        var circ = 2 * Math.PI * 24;
        var dash = circ - (ppScore / 100) * circ;
        var sb = document.querySelector('.pp-scoreboard');
        if (!sb) return;
        var fill = sb.querySelector('.pp-ring-fill');
        if (fill) fill.setAttribute('stroke-dashoffset', dash.toFixed(1));
        var ringText = sb.querySelector('.pp-ring-text');
        if (ringText) ringText.textContent = ppScore;
        var vals = sb.querySelectorAll('.pp-stat-value');
        if (vals[0]) vals[0].textContent = quizState.total;
        if (vals[1]) vals[1].textContent = accuracy + '%';
        var scoreText = sb.querySelector('.pp-score-text');
        if (scoreText) scoreText.textContent = ppScore + ' / 100';
    }

    /* â”€â”€ Quiz results (inline) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function showQuizResults() {
        quizState.finished = true;
        var pct = quizState.total > 0 ? Math.round((quizState.correct / quizState.total) * 100) : 0;
        var passed = pct >= 90;
        if (pct < 80) quizState.xpEarned = 0;

        quizArea.innerHTML = '<div class="result-card">' +
            '<div style="font-size:2.5rem;margin-bottom:6px;">' + (passed ? 'ğŸ‰' : pct >= 80 ? 'ğŸ‘' : 'ğŸ“') + '</div>' +
            '<div class="result-score">' + pct + '%</div>' +
            '<div class="result-label">' + (passed ? 'Mastery Achieved!' : pct >= 80 ? 'Good Work!' : 'Keep Practicing') + '</div>' +
            '<div class="xp-badge"><i class="fa-solid fa-bolt"></i> ' + quizState.xpEarned + ' XP earned' + (pct < 80 ? ' (need â‰¥80% for XP)' : '') + '</div>' +
            '<div class="result-details">' +
                '<div class="result-stat"><div class="result-stat-val" style="color:#2E7D32;">' + quizState.correct + '</div><div class="result-stat-label">Correct</div></div>' +
                '<div class="result-stat"><div class="result-stat-val">' + (quizState.total - quizState.correct) + '</div><div class="result-stat-label">Incorrect</div></div>' +
                '<div class="result-stat"><div class="result-stat-val">' + quizState.total + '</div><div class="result-stat-label">Questions</div></div>' +
                '<div class="result-stat"><div class="result-stat-val" style="color:' + (passed ? '#2E7D32' : pct >= 80 ? '#F9A825' : '#E53E3E') + ';">' + pct + '%</div><div class="result-stat-label">Accuracy</div></div>' +
            '</div>' +
            (passed ? '<div style="margin-top:14px;padding:10px 18px;background:#E8F5E9;border-radius:10px;color:#1B5E20;font-size:0.88rem;"><i class="fa-solid fa-check-circle" style="margin-right:6px;"></i>Lesson complete! You can continue.</div>' : '') +
        '</div>';

        // Finalize PowerPath attempt
        if (quizState.attemptId) {
            fetch('/api/quiz-session?action=finalize', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ attemptId: quizState.attemptId }),
            }).catch(function(){});
        }

        // Mark lesson complete if passed
        if (passed) {
            var lessonId = lessonData.title || '';
            if (lessonId) localStorage.setItem('completed_' + lessonId, 'true');
        }

        // Show nav with finish/retry
        showNavAfterQuiz(passed);
    }

    function showNavAfterQuiz(passed) {
        var nav = document.getElementById('lesson-nav');
        nav.classList.remove('hidden');
        var btnContinue = document.getElementById('btn-continue');
        btnContinue.style.display = '';
        if (passed || quizState.finished) {
            btnContinue.innerHTML = 'Finish Lesson <i class="fa-solid fa-check"></i>';
            btnContinue.onclick = function() { goBackToCourse(); };
        } else {
            btnContinue.innerHTML = 'Continue <i class="fa-solid fa-arrow-right"></i>';
            btnContinue.onclick = function() { goBackToCourse(); };
        }
        var btnBack = document.getElementById('btn-back');
        btnBack.innerHTML = '<i class="fa-solid fa-arrow-left"></i> Back to Course';
        btnBack.onclick = function() { goBackToCourse(); };
    }

    /* â”€â”€ QTI static questions (fallback) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function loadAllQTIQuestions(qtiUrl, testId, subject, gradeLevel) {
        try {
            var apiUrl = '/api/qti-item?';
            if (qtiUrl) apiUrl += 'url=' + encodeURIComponent(qtiUrl);
            else apiUrl += 'id=' + encodeURIComponent(testId) + '&type=assessment';
            if (subject) apiUrl += '&subject=' + encodeURIComponent(subject);
            if (gradeLevel) apiUrl += '&grade=' + encodeURIComponent(gradeLevel);
            if (quizState.title) apiUrl += '&title=' + encodeURIComponent(quizState.title);

            var resp = await fetch(apiUrl);
            var result = await resp.json();
            if (!result.success || !result.data) return false;
            var data = result.data;

            // Check for stimulus content (article displayed as quiz content)
            var stim = data['qti-assessment-stimulus'];
            if (stim) {
                var stimBody = stim['qti-stimulus-body'] || {};
                removeQuizLoader();
                quizArea.innerHTML = '<div style="padding:20px;"><h2 style="font-size:1.1rem;font-weight:700;margin-bottom:14px;">' + esc(data.title || quizState.title) + '</h2>' +
                    '<div class="stimulus-box" style="max-height:none;">' + renderNode(stimBody) + '</div></div>';
                showNavAfterQuiz(false);
                return true;
            }

            var questions = data.questions || [];
            if (questions.length === 0) return false;

            quizState.title = data.title || quizState.title;
            // Parse QTI questions into usable format
            quizState.staticQuestions = questions.map(function(q) {
                var qi = q['qti-assessment-item'] || (q.content && q.content['qti-assessment-item']) || q;
                var attrs = qi['_attributes'] || {};
                var body = qi['qti-item-body'] || {};
                var eti = body['qti-extended-text-interaction'];
                var ci = body['qti-choice-interaction'] || {};
                var isFRQ = !!eti && !ci['qti-simple-choice'];

                // Extract prompt
                var promptText = '';
                var sources = [ci['qti-prompt'], body['qti-prompt'], eti && eti['qti-prompt'], qi.prompt, qi.question];
                for (var ps = 0; ps < sources.length; ps++) {
                    var src = sources[ps];
                    if (!src) continue;
                    if (typeof src === 'string' && src.length > 3) { promptText = src; break; }
                    if (src.p) {
                        var pArr = Array.isArray(src.p) ? src.p : [src.p];
                        promptText = pArr.map(function(p) { return '<p>' + (typeof p === 'string' ? p : (p['_'] || renderNode(p))) + '</p>'; }).join('');
                        if (promptText) break;
                    }
                    if (typeof src === 'object') { var r = renderNode(src); if (r && r.length > 3) { promptText = r; break; } }
                }
                if (!promptText) promptText = qi.title || attrs.title || q.title || '';

                var sc = ci['qti-simple-choice'] || [];
                if (!Array.isArray(sc)) sc = [sc];
                var choices = isFRQ ? [] : sc.map(function(c, i) {
                    var ca = c['_attributes'] || {};
                    var t = c.p ? (typeof c.p === 'string' ? c.p : (c.p['_'] || renderNode(c.p))) : renderNode(c);
                    return { id: ca.identifier || String(i), text: t };
                });

                var rd = qi['qti-response-declaration'] || {};
                var cr = rd['qti-correct-response'] || {};
                var correctId = cr['qti-value'] || '';

                var feedbackMap = {};
                if (!isFRQ) {
                    sc.forEach(function(c) {
                        var ca = c['_attributes'] || {};
                        var fb = c['qti-feedback-inline'] || {};
                        if (fb.span) feedbackMap[ca.identifier] = typeof fb.span === 'string' ? fb.span : renderNode(fb.span);
                    });
                }

                // Extract stimulus content (article/passage attached by backend)
                var stimulusHtml = '';
                var secStim = q['_sectionStimulus'] || qi['_sectionStimulus'] || null;
                if (secStim) {
                    var stimObj = secStim;
                    if (stimObj.content && stimObj.content['qti-assessment-stimulus']) stimObj = stimObj.content['qti-assessment-stimulus'];
                    else if (stimObj['qti-assessment-stimulus']) stimObj = stimObj['qti-assessment-stimulus'];
                    var stimContent = stimObj['qti-stimulus-body'] || stimObj.body || stimObj.content || stimObj;
                    if (typeof stimContent === 'string' && stimContent.length > 10) stimulusHtml = stimContent;
                    else if (typeof stimContent === 'object') stimulusHtml = renderNode(stimContent);
                    if (!stimulusHtml && secStim.rawXml) stimulusHtml = secStim.rawXml;
                    if (!stimulusHtml) stimulusHtml = renderNode(secStim);
                }

                return { prompt: promptText, choices: choices, correctId: correctId, feedbackMap: feedbackMap, isFRQ: isFRQ, expectedLines: 10, stimulus: stimulusHtml };
            });

            quizState.staticIdx = 0;

            // AP exam UI only for cumulative reviews and MCQ assessments
            var titleLower = (quizState.title || '').toLowerCase();
            var isAPStyle = /cumulative|review|mcq|end.of.unit|unit.test|final.test|exam|aps[\s:\-]/i.test(titleLower);

            if (isAPStyle) {
                quizState.answers = new Array(quizState.staticQuestions.length).fill(null);
                quizState.marked = new Array(quizState.staticQuestions.length).fill(false);
                startAPExam();
            } else {
                // Normal inline quiz (PowerPath style, one at a time)
                showStaticQuestion();
            }
            return true;
        } catch(e) {
            console.warn('QTI load failed:', e);
            return false;
        }
    }

    /* ==================================================================
       AP EXAM UI â€” full feature set
       ================================================================== */
    var apState = {
        crossOutMode: false,
        crossedOut: [],   // array of Sets per question
        notes: [],        // string per question
        notesOpen: false,
        calcOpen: false,
        refOpen: false,
        zoomLevel: 100,
        highlightMode: false,
    };

    function startAPExam() {
        var n = quizState.staticQuestions.length;
        apState.crossedOut = [];
        apState.notes = [];
        for (var i = 0; i < n; i++) { apState.crossedOut.push({}); apState.notes.push(''); }
        apState.crossOutMode = false;
        apState.notesOpen = false;
        apState.calcOpen = false;
        apState.refOpen = false;
        apState.zoomLevel = 100;
        apState.highlightMode = false;
        renderAPQuestion();
    }

    function renderAPQuestion() {
        removeQuizLoader();
        var idx = quizState.staticIdx;
        var q = quizState.staticQuestions[idx];
        var totalQ = quizState.staticQuestions.length;
        var passage = quizState.cachedPassage || '';
        if (q.stimulus) passage = q.stimulus;
        var hasPassage = passage && passage.length > 10;
        var letters = 'ABCDEFGHIJ';
        var isMarked = quizState.marked[idx];
        var old = document.getElementById('ap-overlay');
        if (old) old.remove();
        var overlay = document.createElement('div');
        overlay.id = 'ap-overlay';
        overlay.className = 'ap-overlay';
        var html = '';

        // â”€â”€ Header with all tools â”€â”€
        html += '<div class="ap-header">' +
            '<div class="ap-header-title">' + esc(quizState.title) + '</div>' +
            '<div class="ap-tools">' +
                '<button class="ap-tool-btn' + (apState.highlightMode ? ' active' : '') + '" onclick="apToggleHighlight()" title="Highlight text"><i class="fa-solid fa-highlighter"></i><span>Highlight</span></button>' +
                '<div class="ap-tool-sep"></div>' +
                '<div class="ap-more-wrap">' +
                    '<button class="ap-tool-btn" onclick="apToggleMore()" title="More tools"><i class="fa-solid fa-ellipsis-vertical"></i><span>More</span></button>' +
                    '<div class="ap-more-dropdown" id="ap-more-dd">' +
                        '<button class="ap-more-item" onclick="apAddNote();apCloseMore()"><i class="fa-solid fa-sticky-note"></i>Sticky Note</button>' +
                        '<button class="ap-more-item" onclick="apToggleCalc();apCloseMore()"><i class="fa-solid fa-calculator"></i>Calculator</button>' +
                        '<button class="ap-more-item" onclick="apToggleRef();apCloseMore()"><i class="fa-solid fa-book-open"></i>Reference Sheet</button>' +
                        '<button class="ap-more-item" onclick="apShowReview();apCloseMore()"><i class="fa-solid fa-list-check"></i>Review Answers</button>' +
                        '<button class="ap-more-item" onclick="exitAPExam()"><i class="fa-solid fa-right-from-bracket"></i>Exit Exam</button>' +
                    '</div>' +
                '</div>' +
            '</div></div>';

        html += '<div class="ap-divider"></div>';

        // â”€â”€ Body â”€â”€
        html += '<div class="ap-body' + (hasPassage ? '' : ' no-passage') + '">';
        if (hasPassage) {
            html += '<div class="ap-passage" id="ap-passage">' + passage + '</div>';
        }
        html += '<div class="ap-question-panel" id="ap-qpanel">';

        // Question tools
        var abcActive = apState.crossOutMode;
        html += '<div class="ap-q-tools">' +
            '<div class="ap-q-num">' + (idx + 1) + '</div>' +
            '<button class="ap-q-bookmark' + (isMarked ? ' marked' : '') + '" onclick="toggleAPMark()">' +
                '<i class="fa-' + (isMarked ? 'solid' : 'regular') + ' fa-bookmark"></i> Mark for Review' +
            '</button>' +
            '<div class="ap-q-abc' + (abcActive ? ' active' : '') + '" onclick="apToggleCrossOut()" title="Eliminate answers">ABC' + (abcActive ? '<div class="abc-strike"></div>' : '') + '</div>' +
        '</div>';

        html += '<div class="ap-q-prompt">' + (q.prompt || '') + '</div>';

        // Choices
        if (q.choices && q.choices.length > 0) {
            html += '<div class="ap-choices' + (apState.crossOutMode ? ' crossout-mode' : '') + '">';
            var co = apState.crossedOut[idx] || {};
            for (var ci = 0; ci < q.choices.length; ci++) {
                var c = q.choices[ci];
                var sel = quizState.answers[idx] === c.id ? ' selected' : '';
                var crossed = co[c.id] ? ' crossed-out' : '';
                html += '<div class="ap-choice' + sel + crossed + '" data-id="' + esc(c.id) + '" onclick="apClickChoice(this,\'' + esc(c.id) + '\')">' +
                    '<div class="ap-choice-letter">' + (letters[ci] || ci) + '</div>' +
                    '<div class="ap-choice-text">' + (c.text || '') + '</div>' +
                    '<button class="ap-crossout-btn" onclick="event.stopPropagation();apCrossOutOne(this.parentElement,\'' + esc(c.id) + '\')" title="Cross out"><i class="fa-solid fa-xmark"></i></button>' +
                '</div>';
            }
            html += '</div>';
        } else if (q.isFRQ) {
            var saved = quizState.answers[idx] || '';
            html += '<textarea id="ap-frq" rows="' + (q.expectedLines || 10) + '" placeholder="Type your response here..." ' +
                'style="width:100%;padding:14px;border:1.5px solid #ddd;border-radius:8px;font-size:0.95rem;font-family:inherit;line-height:1.7;resize:vertical;outline:none;box-sizing:border-box;" ' +
                'oninput="quizState.answers[quizState.staticIdx]=this.value">' + esc(saved) + '</textarea>';
        }

        // Sticky note (draggable)
        html += '<div class="ap-notes-panel' + (apState.notesOpen ? ' open' : '') + '" id="ap-notes">' +
            '<div class="ap-notes-header" onmousedown="apStartDrag(event,\'ap-notes\')"><span>Q' + (idx+1) + ' Notes</span><button onclick="apState.notesOpen=false;document.getElementById(\'ap-notes\').classList.remove(\'open\')">&times;</button></div>' +
            '<div class="ap-notes-body"><textarea placeholder="Write your notes here..." oninput="apState.notes[' + idx + ']=this.value">' + esc(apState.notes[idx] || '') + '</textarea></div></div>';

        html += '</div></div>'; // question-panel, body

        html += '<div class="ap-footer-divider"></div>';

        // â”€â”€ Footer â”€â”€
        html += '<div class="ap-footer">' +
            '<button class="ap-nav-btn ap-nav-prev" onclick="apNav(-1)"' + (idx === 0 ? ' disabled' : '') + '>Back</button>' +
            '<div style="flex:1;display:flex;justify-content:center;position:relative;">' +
                '<button class="ap-q-nav" onclick="toggleAPNav()" id="ap-q-nav-btn">Question ' + (idx + 1) + ' of ' + totalQ + ' <i class="fa-solid fa-chevron-up" id="ap-nav-chevron"></i></button>' +
                '<div class="ap-nav-dropdown" id="ap-nav-dropdown">' +
                    '<div class="ap-nav-dropdown-header">Questions</div>' +
                    '<div class="ap-nav-grid">';
        for (var di = 0; di < totalQ; di++) {
            var dc = 'ap-nav-item';
            if (quizState.answers[di] !== null) dc += ' answered';
            if (di === idx) dc += ' current';
            if (quizState.marked[di]) dc += ' marked';
            html += '<div class="' + dc + '" onclick="apGoTo(' + di + ')">' + (di + 1) + '</div>';
        }
        html += '</div></div></div>' +
            '<button class="ap-nav-btn ap-nav-next" onclick="apNav(1)">' + (idx === totalQ - 1 ? 'Review' : 'Next') + '</button>' +
        '</div>';

        // Calculator panel
        html += '<div class="ap-calc-panel' + (apState.calcOpen ? ' open' : '') + '" id="ap-calc">' +
            '<div class="ap-calc-header" onmousedown="apStartDrag(event,\'ap-calc\')"><span>Graphing Calculator</span><button onclick="apToggleCalc()">&times;</button></div>' +
            '<iframe src="https://www.desmos.com/calculator" loading="lazy"></iframe></div>';

        // Reference panel
        html += '<div class="ap-ref-panel' + (apState.refOpen ? ' open' : '') + '" id="ap-ref">' +
            '<div class="ap-ref-header"><span>Reference Sheet</span><button onclick="apToggleRef()">&times;</button></div>' +
            '<div class="ap-ref-body">' +
                '<h3>Algebra</h3><table><tr><td>Slope</td><td>m = (y2 - y1) / (x2 - x1)</td></tr><tr><td>Slope-intercept</td><td>y = mx + b</td></tr><tr><td>Point-slope</td><td>y - y1 = m(x - x1)</td></tr><tr><td>Quadratic</td><td>x = (-b +/- sqrt(b2 - 4ac)) / 2a</td></tr><tr><td>Distance</td><td>d = sqrt((x2-x1)2 + (y2-y1)2)</td></tr><tr><td>Midpoint</td><td>M = ((x1+x2)/2, (y1+y2)/2)</td></tr></table>' +
                '<h3>Geometry</h3><table><tr><td>Area (rect)</td><td>A = lw</td></tr><tr><td>Area (triangle)</td><td>A = 1/2 bh</td></tr><tr><td>Area (circle)</td><td>A = pi * r2</td></tr><tr><td>Circumference</td><td>C = 2 * pi * r</td></tr><tr><td>Volume (rect prism)</td><td>V = lwh</td></tr><tr><td>Volume (cylinder)</td><td>V = pi * r2 * h</td></tr><tr><td>Volume (sphere)</td><td>V = 4/3 * pi * r3</td></tr><tr><td>Pythagorean</td><td>a2 + b2 = c2</td></tr></table>' +
                '<h3>Statistics</h3><table><tr><td>Mean</td><td>sum of values / n</td></tr><tr><td>Probability</td><td>P(A) = favorable / total</td></tr><tr><td>Percent change</td><td>(new - old) / old * 100</td></tr></table>' +
                '<h3>Trigonometry</h3><table><tr><td>sin</td><td>opposite / hypotenuse</td></tr><tr><td>cos</td><td>adjacent / hypotenuse</td></tr><tr><td>tan</td><td>opposite / adjacent</td></tr></table>' +
            '</div></div>';

        overlay.innerHTML = html;
        document.body.appendChild(overlay);
    }

    // â”€â”€ Choice handling (select or cross-out) â”€â”€
    function apClickChoice(el, choiceId) {
        var idx = quizState.staticIdx;
        if (apState.crossOutMode) {
            // Toggle cross-out
            if (!apState.crossedOut[idx]) apState.crossedOut[idx] = {};
            if (apState.crossedOut[idx][choiceId]) {
                delete apState.crossedOut[idx][choiceId];
                el.classList.remove('crossed-out');
            } else {
                apState.crossedOut[idx][choiceId] = true;
                el.classList.add('crossed-out');
            }
        } else {
            // Select answer
            quizState.answers[idx] = choiceId;
            var overlay = document.getElementById('ap-overlay');
            if (!overlay) return;
            overlay.querySelectorAll('.ap-choice').forEach(function(c) { c.classList.remove('selected'); });
            el.classList.add('selected');
        }
    }

    function apToggleCrossOut() {
        apState.crossOutMode = !apState.crossOutMode;
        renderAPQuestion();
    }

    function apCrossOutOne(el, choiceId) {
        var idx = quizState.staticIdx;
        if (!apState.crossedOut[idx]) apState.crossedOut[idx] = {};
        if (apState.crossedOut[idx][choiceId]) {
            delete apState.crossedOut[idx][choiceId];
            el.classList.remove('crossed-out');
        } else {
            apState.crossedOut[idx][choiceId] = true;
            el.classList.add('crossed-out');
        }
    }

    // â”€â”€ Navigation â”€â”€
    function apNav(dir) {
        var next = quizState.staticIdx + dir;
        if (next < 0) return;
        if (next >= quizState.staticQuestions.length) { apShowReview(); return; }
        quizState.staticIdx = next;
        renderAPQuestion();
    }
    function apGoTo(idx) {
        if (idx < 0 || idx >= quizState.staticQuestions.length) return;
        quizState.staticIdx = idx;
        renderAPQuestion();
    }
    function toggleAPMark() { quizState.marked[quizState.staticIdx] = !quizState.marked[quizState.staticIdx]; renderAPQuestion(); }
    function toggleAPNav() {
        var dd = document.getElementById('ap-nav-dropdown');
        var chev = document.getElementById('ap-nav-chevron');
        if (!dd) return;
        var isOpen = dd.classList.toggle('open');
        if (chev) chev.style.transform = isOpen ? 'rotate(180deg)' : '';
    }

    // â”€â”€ More dropdown â”€â”€
    function apToggleMore() {
        var dd = document.getElementById('ap-more-dd');
        if (dd) dd.classList.toggle('open');
    }
    function apCloseMore() {
        var dd = document.getElementById('ap-more-dd');
        if (dd) dd.classList.remove('open');
    }
    // Close more dropdown when clicking outside
    document.addEventListener('click', function(e) {
        var dd = document.getElementById('ap-more-dd');
        if (dd && dd.classList.contains('open') && !e.target.closest('.ap-more-wrap')) dd.classList.remove('open');
    });

    // â”€â”€ Highlight tool â”€â”€
    function apToggleHighlight() {
        apState.highlightMode = !apState.highlightMode;
        renderAPQuestion();
        if (apState.highlightMode) {
            document.addEventListener('mouseup', apDoHighlight);
        } else {
            document.removeEventListener('mouseup', apDoHighlight);
        }
    }
    function apDoHighlight(e) {
        if (!apState.highlightMode) return;
        // Click on existing highlight to remove it
        if (e && e.target && e.target.closest && e.target.closest('mark.ap-hl')) {
            var mark = e.target.closest('mark.ap-hl');
            var text = document.createTextNode(mark.textContent);
            mark.parentNode.replaceChild(text, mark);
            return;
        }
        var sel = window.getSelection();
        if (!sel || sel.isCollapsed || !sel.rangeCount) return;
        var range = sel.getRangeAt(0);
        var container = range.commonAncestorContainer;
        var el = container.nodeType === 3 ? container.parentElement : container;
        if (!el.closest || (!el.closest('.ap-passage') && !el.closest('.ap-q-prompt'))) return;
        var mark = document.createElement('mark');
        mark.className = 'ap-hl';
        try { range.surroundContents(mark); } catch(e) {}
        sel.removeAllRanges();
    }

    // â”€â”€ Notes â”€â”€
    function apAddNote() {
        apState.notesOpen = !apState.notesOpen;
        var panel = document.getElementById('ap-notes');
        if (panel) panel.classList.toggle('open', apState.notesOpen);
    }

    // â”€â”€ Calculator â”€â”€
    function apToggleCalc() {
        apState.calcOpen = !apState.calcOpen;
        var panel = document.getElementById('ap-calc');
        if (panel) panel.classList.toggle('open', apState.calcOpen);
    }

    // â”€â”€ Reference sheet â”€â”€
    function apToggleRef() {
        apState.refOpen = !apState.refOpen;
        var panel = document.getElementById('ap-ref');
        if (panel) panel.classList.toggle('open', apState.refOpen);
    }

    // â”€â”€ Draggable panels â”€â”€
    function apStartDrag(e, panelId) {
        var panel = document.getElementById(panelId);
        if (!panel) return;
        var startX = e.clientX, startY = e.clientY;
        var rect = panel.getBoundingClientRect();
        var origLeft = rect.left, origTop = rect.top;
        panel.style.position = 'fixed';
        function onMove(ev) {
            panel.style.left = (origLeft + ev.clientX - startX) + 'px';
            panel.style.top = (origTop + ev.clientY - startY) + 'px';
            panel.style.right = 'auto';
        }
        function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
    }

    // â”€â”€ Review page â”€â”€
    function apShowReview() {
        var old = document.getElementById('ap-overlay');
        if (old) old.remove();
        var overlay = document.createElement('div');
        overlay.id = 'ap-overlay';
        overlay.className = 'ap-overlay';
        var totalQ = quizState.staticQuestions.length;
        var answered = 0, markedCount = 0;
        for (var i = 0; i < totalQ; i++) { if (quizState.answers[i] !== null) answered++; if (quizState.marked[i]) markedCount++; }
        var letters = 'ABCDEFGHIJ';

        var html = '<div class="ap-header"><div class="ap-header-title">' + esc(quizState.title) + ' - Review</div>' +
            '<div class="ap-tools"><button class="ap-tool-btn" onclick="exitAPExam()"><i class="fa-solid fa-right-from-bracket"></i><span>Exit</span></button></div></div>' +
            '<div class="ap-divider"></div>' +
            '<div class="ap-review">' +
            '<h2>Review Your Answers</h2>' +
            '<p style="font-size:0.88rem;color:#555;margin-bottom:20px;">' + answered + ' of ' + totalQ + ' answered' + (markedCount > 0 ? ' &middot; ' + markedCount + ' marked for review' : '') + '</p>' +
            '<table class="ap-review-table"><thead><tr><th>#</th><th>Status</th><th>Answer</th><th>Marked</th></tr></thead><tbody>';

        for (var ri = 0; ri < totalQ; ri++) {
            var q = quizState.staticQuestions[ri];
            var ans = quizState.answers[ri];
            var statusCls = ans !== null ? 'status-answered' : 'status-unanswered';
            var statusText = ans !== null ? 'Answered' : 'Unanswered';
            var ansLetter = '-';
            if (ans !== null && q.choices) {
                for (var ai = 0; ai < q.choices.length; ai++) {
                    if (q.choices[ai].id === ans) { ansLetter = letters[ai] || (ai + 1); break; }
                }
            } else if (ans !== null && q.isFRQ) { ansLetter = 'Written'; }
            var markedStr = quizState.marked[ri] ? '<i class="fa-solid fa-bookmark" style="color:#D97706;"></i>' : '';
            html += '<tr onclick="apGoTo(' + ri + ')" style="cursor:pointer;"><td><strong>' + (ri + 1) + '</strong></td>' +
                '<td class="' + statusCls + '">' + statusText + '</td>' +
                '<td>' + ansLetter + '</td><td>' + markedStr + '</td></tr>';
        }

        html += '</tbody></table>';

        // Submit area
        var allDone = answered === totalQ;
        html += '<div style="text-align:center;margin-top:28px;">';
        if (allDone) {
            html += '<button class="ap-nav-btn ap-nav-next" onclick="apFinalSubmit()" style="padding:12px 36px;font-size:0.95rem;">Submit Test</button>';
        } else {
            html += '<p style="font-size:0.85rem;color:#DC2626;margin-bottom:12px;">' + (totalQ - answered) + ' question' + (totalQ - answered > 1 ? 's' : '') + ' unanswered</p>' +
                '<button class="ap-nav-btn ap-nav-next" onclick="apFinalSubmit()" style="padding:12px 36px;font-size:0.95rem;opacity:0.7;">Submit Anyway</button>';
        }
        html += '<br><button class="ap-nav-btn ap-nav-prev" onclick="renderAPQuestion()" style="margin-top:10px;">Return to Questions</button>';
        html += '</div></div>';

        overlay.innerHTML = html;
        document.body.appendChild(overlay);
    }

    // â”€â”€ Submit (from header) â€” shows confirmation â”€â”€
    function submitAPExam() {
        var totalQ = quizState.staticQuestions.length;
        var answered = 0;
        for (var i = 0; i < totalQ; i++) { if (quizState.answers[i] !== null) answered++; }
        if (answered < totalQ) {
            // Show confirmation modal
            var modal = document.createElement('div');
            modal.className = 'ap-modal-overlay';
            modal.id = 'ap-confirm-modal';
            modal.innerHTML = '<div class="ap-modal"><h3>Submit Test?</h3>' +
                '<p>You have <strong>' + (totalQ - answered) + '</strong> unanswered question' + (totalQ - answered > 1 ? 's' : '') + '. Are you sure you want to submit?</p>' +
                '<div class="ap-modal-btns">' +
                    '<button onclick="document.getElementById(\'ap-confirm-modal\').remove()" style="background:#f0f0f0;color:#555;">Go Back</button>' +
                    '<button onclick="document.getElementById(\'ap-confirm-modal\').remove();apShowReview()" style="background:#1a237e;color:#fff;">Review Answers</button>' +
                '</div></div>';
            document.body.appendChild(modal);
        } else {
            apShowReview();
        }
    }

    // â”€â”€ Final submit (scores and closes) â”€â”€
    function apFinalSubmit() {
        var ol = document.getElementById('ap-overlay');
        if (ol) ol.remove();
        var correct = 0, total = quizState.staticQuestions.length;
        for (var i = 0; i < total; i++) {
            var q = quizState.staticQuestions[i];
            var ans = quizState.answers[i];
            if (q.isFRQ) { if (ans && ans.length >= 30) correct++; }
            else { if (ans === q.correctId) correct++; }
        }
        quizState.correct = correct;
        quizState.total = total;
        quizState.xpEarned = correct;
        showQuizResults();
    }

    function exitAPExam() {
        var ol = document.getElementById('ap-overlay');
        if (ol) ol.remove();
        document.removeEventListener('mouseup', apDoHighlight);
        goBackToCourse();
    }

    // Keep old function for PowerPath flow compatibility
    function showStaticQuestion() {
        if (quizState.staticIdx >= quizState.staticQuestions.length) { showQuizResults(); return; }
        var q = quizState.staticQuestions[quizState.staticIdx];
        quizState.currentQuestion = q;
        quizState.selectedChoice = null;
        quizState.answered = false;
        quizState.questionNum = quizState.staticIdx + 1;
        renderQuestion({ prompt: q.prompt, choices: q.choices, isFRQ: q.isFRQ, expectedLines: q.expectedLines, stimulus: q.stimulus });
    }

    /* ==================================================================
       NAVIGATION
       ================================================================== */
    function goNext() {
        if (currentStep < steps.length - 1) {
            showStep(currentStep + 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            goBackToCourse();
        }
    }

    function goBack() {
        if (currentStep > 0) {
            showStep(currentStep - 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            goBackToCourse();
        }
    }

    function goBackToCourse() {
        if (window.history.length > 1) window.history.back();
        else window.location.href = '/dashboard';
    }

    /* â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function toEmbedUrl(url) {
        if (!url) return '';
        var yt = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
        if (yt) return 'https://www.youtube.com/embed/' + yt[1];
        var vm = url.match(/vimeo\.com\/(\d+)/);
        if (vm) return 'https://player.vimeo.com/video/' + vm[1];
        if (url.includes('/embed') || url.includes('player.')) return url;
        return url;
    }

    function esc(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function showError(msg) {
        document.getElementById('lesson-content').innerHTML =
            '<div class="lesson-placeholder"><i class="fa-solid fa-circle-exclamation"></i><p>' + msg + '</p>' +
            '<p class="sub"><a href="/dashboard" style="color:var(--color-primary);">Back to Dashboard</a></p></div>';
        document.getElementById('btn-continue').style.display = 'none';
    }

    function fetchArticle(url, resId, contentEl) {
        var proxyUrl = '/api/article-proxy?';
        var params = [];
        if (url) params.push('url=' + encodeURIComponent(url));
        if (resId) params.push('id=' + encodeURIComponent(resId));
        proxyUrl += params.join('&');

        fetch(proxyUrl)
            .then(function(resp) {
                if (!resp.ok) {
                    return resp.text().then(function(body) {
                        var detail = '';
                        try { detail = JSON.parse(body).error || ''; } catch(e) {}
                        throw new Error(detail || 'Failed to load article (status ' + resp.status + ')');
                    });
                }
                var ct = resp.headers.get('content-type') || '';
                if (ct.includes('application/json')) {
                    return resp.json().then(function(data) { return data.html || data.body || data.content || data.text || ''; });
                }
                return resp.text();
            })
            .then(function(html) {
                if (html && html.trim().length > 0) {
                    contentEl.innerHTML = '<div class="article-wrap">' + html + '</div>';
                    // Cache for AP exam passage panel
                    quizState.cachedPassage = html;
                } else {
                    contentEl.innerHTML = '<div class="lesson-placeholder"><i class="fa-solid fa-file-lines"></i><p>Article content is empty.</p></div>';
                }
            })
            .catch(function(err) {
                console.warn('[Lesson] Article fetch failed:', err);
                contentEl.innerHTML = '<div class="lesson-placeholder"><i class="fa-solid fa-file-lines"></i><p style="font-weight:600;color:var(--color-text);">Article</p><p class="sub">Could not load article content.</p></div>';
            });
    }

    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
