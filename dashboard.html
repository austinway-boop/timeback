<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Home</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body data-view="student" data-active="home">

    <!-- Layout -->
    <div class="layout">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="main-content">
            <div class="student-home">
                <!-- Welcome -->
                <h1 class="welcome-heading">Welcome, <span id="user-name">Austin</span>!</h1>

                <!-- Assigned Tests -->
                <section class="assigned-tests-section" id="tests-section" style="display:none;">
                    <h2 class="section-title">Assigned Tests</h2>
                    <div class="assigned-tests-grid" id="tests-grid"></div>
                </section>

                <!-- Time Toggle -->
                <div class="time-toggle">
                    <button class="toggle-btn active" data-period="today">Today</button>
                    <button class="toggle-btn" data-period="week">This Week</button>
                </div>

                <!-- Course Cards -->
                <div class="course-grid" id="course-grid">
                    <div style="grid-column:1/-1;text-align:center;padding:48px;color:var(--color-text-muted);">
                        <div class="loading-spinner" style="margin:0 auto 12px;"></div>
                        Loading your courses...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/layout.js"></script>
    <script src="/js/app.js"></script>
    <script>
    /* ---- Color + icon mappings for courses -------------------------------- */
    const COURSE_THEMES = ['teal', 'purple', 'pink', 'orange'];
    const COURSE_ICONS  = {
        math:       'fa-calculator',
        science:    'fa-atom',
        language:   'fa-book-open',
        reading:    'fa-book-open-reader',
        geography:  'fa-globe-americas',
        biology:    'fa-dna',
        tech:       'fa-laptop-code',
        default:    'fa-graduation-cap',
    };

    function guessIcon(title) {
        const t = (title || '').toLowerCase();
        if (t.includes('math') || t.includes('algebra') || t.includes('calculus')) return COURSE_ICONS.math;
        if (t.includes('chem') || t.includes('physics'))                          return COURSE_ICONS.science;
        if (t.includes('bio'))                                                     return COURSE_ICONS.biology;
        if (t.includes('read') || t.includes('ela') || t.includes('english'))     return COURSE_ICONS.reading;
        if (t.includes('lang') || t.includes('composition') || t.includes('writing')) return COURSE_ICONS.language;
        if (t.includes('geo') || t.includes('history') || t.includes('social'))   return COURSE_ICONS.geography;
        if (t.includes('code') || t.includes('tech') || t.includes('gumpp'))      return COURSE_ICONS.tech;
        return COURSE_ICONS.default;
    }

    function renderCourses(courses) {
        if (!courses.length) {
            document.getElementById('course-grid').innerHTML =
                '<div style="grid-column:1/-1;text-align:center;padding:48px;color:var(--color-text-muted);">No courses found for your account.</div>';
            return;
        }
        document.getElementById('course-grid').innerHTML = courses.map((c, i) => {
            const color    = COURSE_THEMES[i % COURSE_THEMES.length];
            const icon     = guessIcon(c.title || '');
            const name     = c.title || 'Untitled Course';
            const xpEarned = c.xpEarned || 0;
            const xpTotal  = c.xpTotal  || 0;
            const pct      = xpTotal > 0 ? (xpEarned / xpTotal * 100) : 0;
            return `
                <div class="course-card">
                    <div class="course-card-image card-theme-${color}">
                        <div class="course-card-illustration"><i class="fa-solid ${icon}"></i></div>
                    </div>
                    <div class="course-card-body">
                        <div class="course-card-header">
                            <span class="status-dot blue"></span>
                            <span class="course-card-name">${name}</span>
                        </div>
                        <div class="course-card-xp">
                            <span class="xp-progress">${xpEarned} / ${xpTotal} XP</span>
                            <span class="xp-period">TODAY</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pct}%"></div>
                        </div>
                    </div>
                </div>`;
        }).join('');
    }

    function showError(msg) {
        document.getElementById('course-grid').innerHTML =
            `<div style="grid-column:1/-1;text-align:center;padding:48px;color:#E53E3E;">
                <i class="fa-solid fa-circle-exclamation"></i> ${msg}
            </div>`;
    }

    document.addEventListener('DOMContentLoaded', async function () {
        const name  = localStorage.getItem('alphalearn_name') || 'Student';
        const email = localStorage.getItem('alphalearn_email') || '';
        document.getElementById('user-name').textContent = name;

        if (!email) {
            showError('No email found. Please <a href="/login" style="color:var(--color-primary)">sign in</a> first.');
            return;
        }

        try {
            /* 1. Fast user lookup by email (single filtered request) */
            const lookupResp = await fetch(`/api/user-lookup?email=${encodeURIComponent(email)}`);
            const lookupData = await lookupResp.json();

            if (!lookupData.user || !lookupData.user.sourcedId) {
                showError('Could not find your account. Please check your email and try again.');
                return;
            }

            const userId = lookupData.user.sourcedId;

            // Cache the sourcedId so future page loads can skip the lookup
            localStorage.setItem('alphalearn_userId', userId);

            /* 2. Fetch enrolled courses via EduBridge */
            const enrollResp = await fetch(`/api/enrollments?userId=${userId}`);
            const enrollData = await enrollResp.json();

            const raw = enrollData.data
                || enrollData.enrollments
                || enrollData.courses
                || (Array.isArray(enrollData) ? enrollData : []);

            /* 3. Filter and categorise enrollments */
            const courses = [];
            const tests   = [];

            for (const e of raw) {
                const course = e.course || {};
                const cMeta  = course.metadata || {};
                const goals  = (e.metadata && e.metadata.goals) || {};
                const title  = course.title || '';
                const subjects = course.subjects || [];

                // Skip non-courses
                if (title.startsWith('Manual XP'))       continue;  // manual XP tracker
                if (title.includes('Hole-Filling'))      continue;  // personalised remediation
                if (!subjects.length && !cMeta.primaryApp && !cMeta.courseType) continue; // school enrolment rows

                const item = {
                    title,
                    subject:  subjects[0] || '',
                    xpEarned: e.xpEarned || 0,
                    xpTotal:  goals.dailyXp || e.xpTotal || 0,
                    app:      cMeta.primaryApp || cMeta.app || '',
                    hasTest:  'test' in cMeta,
                    hasQuiz:  'quiz' in cMeta,
                };

                // Courses with a test component go to the Assigned Tests section
                if (item.hasTest) {
                    tests.push(item);
                }

                courses.push(item);
            }

            /* 4. Render tests in top section */
            if (tests.length) {
                document.getElementById('tests-section').style.display = '';
                document.getElementById('tests-grid').innerHTML = tests.map(t => {
                    const icon = guessIcon(t.title);
                    const styleClass = t.subject.toLowerCase().replace(/\s+/g, '-') || 'default';
                    return `
                    <div class="test-card">
                        <div class="test-card-image test-image-reading" style="background:linear-gradient(135deg,#E8F5E9 0%,#C8E6C9 50%,#A5D6A7 100%);">
                            <div class="test-card-illustration" style="color:#2E7D32;">
                                <i class="fa-solid fa-clipboard-check"></i>
                            </div>
                        </div>
                        <div class="test-card-info">
                            <div class="test-card-status">
                                <span class="status-dot blue"></span>
                                <span class="test-card-name">${t.title}</span>
                            </div>
                            <div class="test-card-meta">
                                <span class="test-badge">${t.subject}</span>
                                <span class="test-badge">${t.xpTotal} XP</span>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }

            /* 5. Render course cards */
            renderCourses(courses);

            /* 6. Load today's XP analytics in background */
            const today = new Date().toISOString().split('T')[0];
            fetch(`/api/analytics?email=${encodeURIComponent(email)}&startDate=${today}&endDate=${today}`)
                .then(r => r.json())
                .then(data => console.log('[AlphaLearn] Analytics:', data))
                .catch(() => {});

        } catch (err) {
            showError('Unable to reach the Timeback API. Please try again later.');
            console.error('[AlphaLearn]', err);
        }
    });
    </script>
</body>
</html>
