<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Home</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body data-view="student" data-active="home">

    <!-- Layout -->
    <div class="layout">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="main-content">
            <div class="student-home">
                <!-- Welcome -->
                <h1 class="welcome-heading">Welcome, <span id="user-name">Austin</span>!</h1>

                <!-- Assigned Tests -->
                <section class="assigned-tests-section" id="tests-section" style="display:none;">
                    <h2 class="section-title">Assigned Tests</h2>
                    <div class="assigned-tests-grid" id="tests-grid"></div>
                </section>

                <!-- Time Toggle -->
                <div class="time-toggle">
                    <button class="toggle-btn active" data-period="today">Today</button>
                    <button class="toggle-btn" data-period="week">This Week</button>
                </div>

                <!-- Course Cards -->
                <div class="course-grid" id="course-grid">
                    <!-- Skeleton course cards -->
                    <div class="course-card" style="pointer-events:none;">
                        <div class="course-card-image skeleton" style="height:140px;border-radius:12px 12px 0 0;"></div>
                        <div class="course-card-body">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                                <div class="skeleton skeleton-circle" style="width:8px;height:8px;"></div>
                                <div class="skeleton skeleton-text" style="width:70%;"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <div class="skeleton skeleton-text" style="width:50%;"></div>
                                <div class="skeleton skeleton-text" style="width:20%;"></div>
                            </div>
                            <div class="skeleton" style="height:6px;width:100%;border-radius:3px;"></div>
                        </div>
                    </div>
                    <div class="course-card" style="pointer-events:none;">
                        <div class="course-card-image skeleton" style="height:140px;border-radius:12px 12px 0 0;"></div>
                        <div class="course-card-body">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                                <div class="skeleton skeleton-circle" style="width:8px;height:8px;"></div>
                                <div class="skeleton skeleton-text" style="width:55%;"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <div class="skeleton skeleton-text" style="width:45%;"></div>
                                <div class="skeleton skeleton-text" style="width:25%;"></div>
                            </div>
                            <div class="skeleton" style="height:6px;width:100%;border-radius:3px;"></div>
                        </div>
                    </div>
                    <div class="course-card" style="pointer-events:none;">
                        <div class="course-card-image skeleton" style="height:140px;border-radius:12px 12px 0 0;"></div>
                        <div class="course-card-body">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                                <div class="skeleton skeleton-circle" style="width:8px;height:8px;"></div>
                                <div class="skeleton skeleton-text" style="width:65%;"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <div class="skeleton skeleton-text" style="width:55%;"></div>
                                <div class="skeleton skeleton-text" style="width:20%;"></div>
                            </div>
                            <div class="skeleton" style="height:6px;width:100%;border-radius:3px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Course Detail Modal -->
    <div class="modal-overlay" id="course-modal" style="position:fixed;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.15);width:90%;max-width:520px;max-height:85vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid #E8ECF1;">
                <h2 style="font-size:1.15rem;font-weight:700;margin:0;" id="course-modal-title">Course Details</h2>
                <button onclick="closeCourseModal()" style="width:32px;height:32px;border:none;background:transparent;font-size:1.4rem;color:#A0AEC0;cursor:pointer;border-radius:8px;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.background='#F4F6F9'" onmouseout="this.style.background='transparent'">&times;</button>
            </div>
            <div id="course-modal-body" style="padding:24px;"></div>
        </div>
    </div>

    <script src="/js/layout.js"></script>
    <script src="/js/app.js"></script>
    <script>
    /* ---- Color + icon mappings for courses -------------------------------- */
    const COURSE_THEMES = ['teal', 'purple', 'pink', 'orange'];
    const COURSE_ICONS  = {
        math:       'fa-calculator',
        science:    'fa-atom',
        language:   'fa-book-open',
        reading:    'fa-book-open-reader',
        geography:  'fa-globe-americas',
        biology:    'fa-dna',
        tech:       'fa-laptop-code',
        default:    'fa-graduation-cap',
    };

    function guessIcon(title) {
        const t = (title || '').toLowerCase();
        if (t.includes('math') || t.includes('algebra') || t.includes('calculus')) return COURSE_ICONS.math;
        if (t.includes('chem') || t.includes('physics'))                          return COURSE_ICONS.science;
        if (t.includes('bio'))                                                     return COURSE_ICONS.biology;
        if (t.includes('read') || t.includes('ela') || t.includes('english'))     return COURSE_ICONS.reading;
        if (t.includes('lang') || t.includes('composition') || t.includes('writing')) return COURSE_ICONS.language;
        if (t.includes('geo') || t.includes('history') || t.includes('social'))   return COURSE_ICONS.geography;
        if (t.includes('code') || t.includes('tech') || t.includes('gumpp'))      return COURSE_ICONS.tech;
        return COURSE_ICONS.default;
    }

    /* ---- Lesson-based course detection (has totalLessons from API) ------- */
    function isLessonCourse(c) { return (c.totalLessons || 0) > 0; }

    /* ---- State ------------------------------------------------------------ */
    let allCourses = [];       // set once after enrollment fetch
    let xpByCourseIdx = {};    // { 0: 13, 1: 25, ... } — XP per course index (daily/weekly)
    let fullYearXpIdx = {};    // { 0: 500, 1: 1200, ... } — full-year XP for unit estimation
    let currentPeriod = 'today';

    // Timeback-native app names (XP reported here for courses without their own app)
    const NATIVE_APPS = ['timeback dash', 'alpha timeback', 'alphalearn', 'timeback'];

    // Goals from localStorage (set on goals page)
    const GOALS_KEY = 'alphalearn_goals';
    function loadSavedGoals() {
        try { return JSON.parse(localStorage.getItem(GOALS_KEY)) || {}; }
        catch (e) { return {}; }
    }

    // Quick school-day counter for dashboard pacing display
    function countSchoolDays(endDateStr, excludeNonSchool) {
        const today = new Date(); today.setHours(0,0,0,0);
        const end = new Date(endDateStr + 'T00:00:00');
        if (end <= today) return 0;
        let count = 0;
        const c = new Date(today); c.setDate(c.getDate() + 1);
        while (c <= end) {
            const dow = c.getDay();
            if (excludeNonSchool) { if (dow !== 0 && dow !== 6) count++; }
            else count++;
            c.setDate(c.getDate() + 1);
        }
        return count;
    }

    /* ---- Render ----------------------------------------------------------- */
    function renderCourses() {
        const courses = allCourses;
        if (!courses.length) {
            document.getElementById('course-grid').innerHTML =
                '<div style="grid-column:1/-1;text-align:center;padding:48px;color:var(--color-text-muted);">No courses found for your account.</div>';
            return;
        }
        const periodLabel = currentPeriod === 'today' ? 'TODAY' : 'THIS WEEK';
        const savedGoals = loadSavedGoals();

        document.getElementById('course-grid').innerHTML = courses.map((c, i) => {
            const color     = COURSE_THEMES[i % COURSE_THEMES.length];
            const icon      = guessIcon(c.title || '');
            const name      = c.title || 'Untitled Course';
            const goalKey   = c._goalKey || '';
            const savedGoal = savedGoals[goalKey] || null;
            const lessonBased = isLessonCourse(c);

            let progressText, progressLabel, pct;

            if (lessonBased) {
                // Lesson-based course: show lesson progress + daily pace from goal
                const totalXp = c.totalXp || 1;
                const totalLessons = c.totalLessons;
                const yearXp = fullYearXpIdx[i] || 0;
                const done = Math.min(Math.round((yearXp / totalXp) * totalLessons), totalLessons);
                pct = totalLessons > 0 ? Math.min((done / totalLessons) * 100, 100) : 0;

                // If a goal is set, show lessons/day needed
                if (savedGoal && savedGoal.endDate) {
                    const rem = Math.max(totalLessons - done, 0);
                    const excl = savedGoal.excludeNonSchoolDays !== false;
                    const days = countSchoolDays(savedGoal.endDate, excl);
                    const lpd = days > 0 && rem > 0 ? (rem / days).toFixed(1) : 0;
                    progressText = `${done} / ${totalLessons} lessons`;
                    progressLabel = lpd > 0 ? `${lpd}/DAY` : 'PROGRESS';
                } else {
                    progressText = `${done} / ${totalLessons} lessons`;
                    progressLabel = 'PROGRESS';
                }
            } else {
                // Non-AP: show daily/weekly XP
                const dailyGoal = c.dailyXpGoal || 0;
                const xpEarned = Math.round(xpByCourseIdx[i] || 0);
                const goal = currentPeriod === 'today' ? dailyGoal : dailyGoal * 5;
                pct = goal > 0 ? Math.min((xpEarned / goal) * 100, 100) : 0;
                progressText = `${xpEarned} / ${goal} XP`;
                progressLabel = periodLabel;
            }

            return `
                <div class="course-card" data-course-index="${i}" style="cursor:pointer;">
                    <div class="course-card-image card-theme-${color}">
                        <div class="course-card-illustration"><i class="fa-solid ${icon}"></i></div>
                    </div>
                    <div class="course-card-body">
                        <div class="course-card-header">
                            <span class="status-dot blue"></span>
                            <span class="course-card-name">${name}</span>
                        </div>
                        <div class="course-card-xp">
                            <span class="xp-progress">${progressText}</span>
                            <span class="xp-period">${progressLabel}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pct}%"></div>
                        </div>
                    </div>
                </div>`;
        }).join('');
    }

    function showError(msg) {
        document.getElementById('course-grid').innerHTML =
            `<div style="grid-column:1/-1;text-align:center;padding:48px;color:#E53E3E;">
                <i class="fa-solid fa-circle-exclamation"></i> ${msg}
            </div>`;
    }

    document.addEventListener('DOMContentLoaded', async function () {
        const name  = localStorage.getItem('alphalearn_name') || 'Student';
        const email = localStorage.getItem('alphalearn_email') || '';
        document.getElementById('user-name').textContent = name;

        if (!email) {
            showError('No email found. Please <a href="/login" style="color:var(--color-primary)">sign in</a> first.');
            return;
        }

        try {
            /* 1. Fast user lookup by email (single filtered request) */
            const lookupResp = await fetch(`/api/user-lookup?email=${encodeURIComponent(email)}`);
            const lookupData = await lookupResp.json();

            if (!lookupData.user || !lookupData.user.sourcedId) {
                showError('Could not find your account. Please check your email and try again.');
                return;
            }

            const userId = lookupData.user.sourcedId;

            // Cache the sourcedId so future page loads can skip the lookup
            localStorage.setItem('alphalearn_userId', userId);

            /* 2. Fetch enrolled courses via EduBridge */
            const enrollResp = await fetch(`/api/enrollments?userId=${userId}`);
            const enrollData = await enrollResp.json();

            const raw = enrollData.data
                || enrollData.enrollments
                || enrollData.courses
                || (Array.isArray(enrollData) ? enrollData : []);

            /* 3. Filter to ONLY currently-enrolled, real courses
             *
             * Per EduBridge docs the response is already "active enrollments",
             * so we only need to:
             *   - drop expired (endDate in the past)
             *   - drop obvious non-course rows (Manual XP, Hole-Filling, no-subject admin rows)
             *   - drop PowerPath assessment courses (title contains "- PP")
             *   - separate mastery track tests into their own section
             */
            const now     = new Date();
            const courses = [];
            const tests   = [];

            for (const e of raw) {
                const course   = e.course || {};
                const cMeta    = course.metadata || {};
                const goals    = (e.metadata && e.metadata.goals) || {};
                const metrics  = (e.metadata && e.metadata.metrics) || {};
                const title    = (course.title || '').trim();
                const subjects = course.subjects || [];
                const endDate  = e.endDate ? new Date(e.endDate) : null;

                // ── Skip expired enrollments ──
                if (endDate && endDate < now) continue;

                // ── Skip junk rows ──
                if (!title)                         continue;
                if (title.startsWith('Manual XP'))  continue;
                if (title.includes('Hole-Filling')) continue;
                if (!subjects.length)               continue;  // school/org rows (e.g. "Alpha High School 2025-26")

                // Resolve app name: course.primaryApp.name (per docs) or metadata fallback
                const pApp = course.primaryApp || {};
                const appName = (typeof pApp === 'object' ? pApp.name : '')
                    || cMeta.primaryApp || cMeta.app || '';

                const item = {
                    title,
                    subject:      subjects[0] || '',
                    appName,
                    totalXp:      metrics.totalXp || 0,
                    totalLessons: metrics.totalLessons || 0,
                    dailyXpGoal:  goals.dailyXp || 0,
                    _goalKey:     e.sourcedId || course.sourcedId || title,
                    // Store full enrollment + course data for credential display
                    _raw: e,
                    _course: course,
                    _credentials: e.credentials || (e.metadata && e.metadata.credentials) || course.metadata?.credentials || null,
                    _loginUrl: e.loginUrl || e.url || course.metadata?.loginUrl || course.metadata?.url || course.metadata?.primaryAppUrl || null,
                    _primaryApp: course.metadata?.primaryApp || '',
                    _metadata: { ...course.metadata, ...e.metadata },
                };

                // ── Mastery track tests only (not PP, not regular courses) ──
                const isMastery = metrics.courseType === 'mastery_test'
                    || metrics.courseType === 'mastery-test'
                    || metrics.courseType === 'masteryTest'
                    || (title.toLowerCase().includes('mastery') && title.toLowerCase().includes('test'));

                if (isMastery) {
                    tests.push(item);
                    continue;
                }

                courses.push(item);
            }

            /* 4. Render mastery track tests in top section */
            if (tests.length) {
                document.getElementById('tests-section').style.display = '';
                document.getElementById('tests-grid').innerHTML = tests.map(t => `
                    <div class="test-card">
                        <div class="test-card-image test-image-reading" style="background:linear-gradient(135deg,#E8F5E9 0%,#C8E6C9 50%,#A5D6A7 100%);">
                            <div class="test-card-illustration" style="color:#2E7D32;">
                                <i class="fa-solid fa-clipboard-check"></i>
                            </div>
                        </div>
                        <div class="test-card-info">
                            <div class="test-card-status">
                                <span class="status-dot blue"></span>
                                <span class="test-card-name">${t.title}</span>
                            </div>
                            <div class="test-card-meta">
                                <span class="test-badge">${t.subject}</span>
                                <span class="test-badge">${t.xpTotal} XP</span>
                            </div>
                        </div>
                    </div>`).join('');
            }

            /* 5. Store courses globally, fetch full-year XP for AP unit tracking, then daily XP */
            allCourses = courses;

            // Fetch full-year XP (for lesson course progress estimation)
            const hasLessonCourses = courses.some(c => isLessonCourse(c));
            if (hasLessonCourses) {
                await loadFullYearXp(email);
            }

            await loadXp(email, 'today');

        } catch (err) {
            showError('Unable to reach the Timeback API. Please try again later.');
            console.error('[AlphaLearn]', err);
        }
    });

    /* ---- Fetch XP from EduBridge analytics -------------------------------- */
    function localDateStr(d) {
        // Use LOCAL date (not UTC) so "today" matches the user's timezone
        const yyyy = d.getFullYear();
        const mm   = String(d.getMonth() + 1).padStart(2, '0');
        const dd   = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    async function loadXp(email, period) {
        currentPeriod = period;
        const now = new Date();
        let startDate, endDate;

        if (period === 'today') {
            const d = localDateStr(now);
            startDate = d + 'T00:00:00Z';
            endDate   = d + 'T23:59:59Z';
        } else {
            const dayOfWeek = now.getDay();
            const monday = new Date(now);
            monday.setDate(now.getDate() - ((dayOfWeek + 6) % 7));
            startDate = localDateStr(monday) + 'T00:00:00Z';
            endDate   = localDateStr(now) + 'T23:59:59Z';
        }

        try {
            const resp = await fetch(
                `/api/analytics?email=${encodeURIComponent(email)}&startDate=${startDate}&endDate=${endDate}`
            );
            const data = await resp.json();
            const factsByApp = data.factsByApp || {};
            const facts      = data.facts || {};

            // Build per-app lookup: { subject: { appNameLower: totalXp } }
            const xpMap = {};
            for (const dayData of Object.values(factsByApp)) {
                for (const [subject, apps] of Object.entries(dayData)) {
                    if (!xpMap[subject]) xpMap[subject] = {};
                    for (const [appName, info] of Object.entries(apps)) {
                        const xp = (info.activityMetrics || {}).xpEarned || 0;
                        const key = appName.toLowerCase();
                        xpMap[subject][key] = (xpMap[subject][key] || 0) + xp;
                    }
                }
            }

            // Also build a subject-level fallback from facts
            const xpBySubject = {};
            for (const dayFacts of Object.values(facts)) {
                for (const [subject, info] of Object.entries(dayFacts)) {
                    const xp = (info.activityMetrics || {}).xpEarned || 0;
                    xpBySubject[subject] = (xpBySubject[subject] || 0) + xp;
                }
            }

            // Match XP to each course
            xpByCourseIdx = {};
            for (let i = 0; i < allCourses.length; i++) {
                const c = allCourses[i];
                const subjApps = xpMap[c.subject] || {};
                const appName = (c.appName || '').toLowerCase();

                if (appName && Object.keys(subjApps).length) {
                    // Course has a known app — find matching factsByApp key
                    let matched = subjApps[appName] || 0;
                    if (!matched) {
                        const normalized = appName.replace(/_/g, ' ');
                        for (const [key, xp] of Object.entries(subjApps)) {
                            if (key === normalized || key.includes(normalized) || normalized.includes(key)) {
                                matched = xp;
                                break;
                            }
                        }
                    }
                    xpByCourseIdx[i] = matched;
                } else if (!appName && Object.keys(subjApps).length) {
                    // No app — Timeback-native course: sum XP from native apps
                    let nativeXp = 0;
                    for (const [key, xp] of Object.entries(subjApps)) {
                        if (NATIVE_APPS.some(n => key.includes(n) || n.includes(key))) {
                            nativeXp += xp;
                        }
                    }
                    xpByCourseIdx[i] = nativeXp;
                } else {
                    // Fallback: use subject-level XP if factsByApp had nothing
                    xpByCourseIdx[i] = xpBySubject[c.subject] || 0;
                }
            }
        } catch (err) {
            console.warn('[AlphaLearn] Analytics unavailable:', err.message);
            xpByCourseIdx = {};
        }

        renderCourses();
    }

    /* ---- Full-year XP for AP unit estimation ------------------------------ */
    async function loadFullYearXp(email) {
        try {
            const now = new Date();
            const startOfYear = new Date(now.getFullYear(), 7, 1); // Aug 1
            if (startOfYear > now) startOfYear.setFullYear(startOfYear.getFullYear() - 1);
            const startDate = localDateStr(startOfYear) + 'T00:00:00Z';
            const endDate   = localDateStr(now) + 'T23:59:59Z';

            const resp = await fetch(`/api/analytics?email=${encodeURIComponent(email)}&startDate=${startDate}&endDate=${endDate}`);
            const data = await resp.json();
            const factsByApp = data.factsByApp || {};
            const facts = data.facts || {};

            const xpMap = {};
            for (const dayData of Object.values(factsByApp)) {
                for (const [subject, apps] of Object.entries(dayData)) {
                    if (!xpMap[subject]) xpMap[subject] = {};
                    for (const [appName, info] of Object.entries(apps)) {
                        const xp = (info.activityMetrics || {}).xpEarned || 0;
                        const key = appName.toLowerCase();
                        xpMap[subject][key] = (xpMap[subject][key] || 0) + xp;
                    }
                }
            }
            const xpBySubject = {};
            for (const dayFacts of Object.values(facts)) {
                for (const [subject, info] of Object.entries(dayFacts)) {
                    const xp = (info.activityMetrics || {}).xpEarned || 0;
                    xpBySubject[subject] = (xpBySubject[subject] || 0) + xp;
                }
            }

            fullYearXpIdx = {};
            for (let i = 0; i < allCourses.length; i++) {
                const c = allCourses[i];
                if (!isLessonCourse(c)) continue; // only needed for lesson courses
                const subjApps = xpMap[c.subject] || {};
                const appName = (c.appName || '').toLowerCase();
                if (appName && Object.keys(subjApps).length) {
                    let matched = subjApps[appName] || 0;
                    if (!matched) {
                        const normalized = appName.replace(/_/g, ' ');
                        for (const [key, xp] of Object.entries(subjApps)) {
                            if (key === normalized || key.includes(normalized) || normalized.includes(key)) { matched = xp; break; }
                        }
                    }
                    fullYearXpIdx[i] = matched;
                } else if (!appName && Object.keys(subjApps).length) {
                    let nativeXp = 0;
                    for (const [key, xp] of Object.entries(subjApps)) {
                        if (NATIVE_APPS.some(n => key.includes(n) || n.includes(key))) nativeXp += xp;
                    }
                    fullYearXpIdx[i] = nativeXp;
                } else {
                    fullYearXpIdx[i] = xpBySubject[c.subject] || 0;
                }
            }
        } catch (err) {
            console.warn('[AlphaLearn] Full-year XP unavailable:', err.message);
            fullYearXpIdx = {};
        }
    }

    /* ---- HTML escape helper ---------------------------------------------- */
    function esc(str) {
        if (str === null || str === undefined) return '';
        if (typeof str !== 'string') str = String(str);
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    /** Coerce value to string — objects/arrays become '' to avoid [object Object] */
    function safeStr(val) {
        if (val === null || val === undefined) return '';
        if (typeof val === 'object') return '';
        return String(val);
    }

    /* ---- Course detail modal --------------------------------------------- */
    function openCourseModal(index) {
        const modal = document.getElementById('course-modal');
        try {
            const c = allCourses[index];
            if (!c) return;

            const body  = document.getElementById('course-modal-body');
            document.getElementById('course-modal-title').textContent = c.title || 'Course Details';

            const meta   = c._metadata || {};
            const creds  = c._credentials;
            const url    = c._loginUrl;
            const app    = safeStr(c._primaryApp);
            const raw    = c._raw || {};
            const course = c._course || {};

            // Try to extract credentials from various possible locations
            let username = '', password = '', loginUrl = safeStr(url);

            if (creds && typeof creds === 'object') {
                username = safeStr(creds.username || creds.user || creds.login || creds.email || '');
                password = safeStr(creds.password || creds.pass || creds.secret || '');
                loginUrl = loginUrl || safeStr(creds.url || creds.loginUrl || '');
            }

            // Also check deeper in metadata
            if (!username && meta.username) username = safeStr(meta.username);
            if (!username && meta.login) username = safeStr(meta.login);
            if (!password && meta.password) password = safeStr(meta.password);
            if (!loginUrl && meta.loginUrl) loginUrl = safeStr(meta.loginUrl);
            if (!loginUrl && meta.url) loginUrl = safeStr(meta.url);
            if (!loginUrl && meta.primaryAppUrl) loginUrl = safeStr(meta.primaryAppUrl);
            if (!loginUrl && meta.launchUrl) loginUrl = safeStr(meta.launchUrl);

            // Check raw enrollment fields
            if (!loginUrl && raw.launchUrl) loginUrl = safeStr(raw.launchUrl);
            if (!loginUrl && raw.url) loginUrl = safeStr(raw.url);

            // Build credential rows
            let credentialsHTML = '';
            if (username || password || loginUrl || app) {
                credentialsHTML = `
                    <div style="margin-bottom:20px;">
                        <h3 style="font-size:0.85rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#A0AEC0;margin-bottom:12px;">
                            <i class="fa-solid fa-key" style="margin-right:6px;"></i>Course Credentials
                        </h3>
                        <div style="background:#F4F6F9;border-radius:10px;padding:16px;display:flex;flex-direction:column;gap:12px;">
                            ${app ? `<div><span style="font-size:0.78rem;font-weight:600;color:#718096;display:block;margin-bottom:2px;">Platform</span><span style="font-size:0.95rem;color:#2D3748;font-weight:500;">${esc(app)}</span></div>` : ''}
                            ${username ? `<div><span style="font-size:0.78rem;font-weight:600;color:#718096;display:block;margin-bottom:2px;">Username</span><span style="font-family:'SF Mono','Fira Code',monospace;font-size:0.9rem;color:#2D3748;background:#fff;padding:4px 10px;border-radius:6px;border:1px solid #E8ECF1;display:inline-block;">${esc(username)}</span></div>` : ''}
                            ${password ? `<div><span style="font-size:0.78rem;font-weight:600;color:#718096;display:block;margin-bottom:2px;">Password</span><span style="font-family:'SF Mono','Fira Code',monospace;font-size:0.9rem;color:#2D3748;background:#fff;padding:4px 10px;border-radius:6px;border:1px solid #E8ECF1;display:inline-block;" id="cred-pw">${esc(password)}</span> <button onclick="navigator.clipboard.writeText(document.getElementById('cred-pw').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy',1500)" style="border:none;background:#45B5AA;color:#fff;padding:3px 10px;border-radius:5px;font-size:0.75rem;font-weight:600;cursor:pointer;margin-left:6px;">Copy</button></div>` : ''}
                            ${loginUrl ? `<div><span style="font-size:0.78rem;font-weight:600;color:#718096;display:block;margin-bottom:2px;">Course URL</span><a href="${esc(loginUrl)}" target="_blank" style="font-size:0.88rem;color:#45B5AA;word-break:break-all;">${esc(loginUrl)}</a></div>` : ''}
                        </div>
                    </div>`;
            } else {
                credentialsHTML = `
                    <div style="margin-bottom:20px;">
                        <h3 style="font-size:0.85rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#A0AEC0;margin-bottom:12px;">
                            <i class="fa-solid fa-key" style="margin-right:6px;"></i>Course Credentials
                        </h3>
                        <div style="background:#F4F6F9;border-radius:10px;padding:20px;text-align:center;color:#718096;font-size:0.88rem;">
                            <i class="fa-solid fa-lock" style="font-size:1.2rem;margin-bottom:8px;display:block;opacity:0.5;"></i>
                            No separate credentials needed — this course uses your AlphaLearn account.
                        </div>
                    </div>`;
            }

            // Build all raw metadata display for debugging/transparency
            let metaDetailsHTML = '';
            const displayMeta = {};
            try {
                for (const [k, v] of Object.entries(meta)) {
                    if (v === null || v === undefined || v === '') continue;
                    if (typeof v !== 'object') {
                        displayMeta[k] = String(v);
                    } else if (v !== null && !Array.isArray(v)) {
                        // One level of nesting only — skip deeper objects
                        for (const [k2, v2] of Object.entries(v)) {
                            if (v2 === null || v2 === undefined || v2 === '') continue;
                            if (typeof v2 === 'object') continue;  // skip nested objects/arrays
                            displayMeta[`${k}.${k2}`] = String(v2);
                        }
                    } else if (Array.isArray(v)) {
                        // Render arrays as comma-separated string
                        displayMeta[k] = v.filter(x => x !== null && x !== undefined && typeof x !== 'object').join(', ');
                    }
                }
            } catch (metaErr) {
                console.warn('[AlphaLearn] Error parsing course metadata:', metaErr);
            }

            if (Object.keys(displayMeta).length > 0) {
                metaDetailsHTML = `
                    <details style="margin-bottom:16px;">
                        <summary style="font-size:0.8rem;font-weight:600;color:#A0AEC0;cursor:pointer;margin-bottom:8px;">
                            <i class="fa-solid fa-info-circle" style="margin-right:4px;"></i>All Course Details
                        </summary>
                        <div style="background:#F4F6F9;border-radius:8px;padding:12px;font-size:0.82rem;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                            ${Object.entries(displayMeta).map(([k, v]) => `
                                <div><span style="color:#718096;font-weight:600;">${esc(k)}</span></div>
                                <div style="color:#2D3748;word-break:break-all;">${esc(v)}</div>
                            `).join('')}
                        </div>
                    </details>`;
            }

            // XP info
            const xpEarned = Math.round(xpByCourseIdx[index] || 0);
            const goal = currentPeriod === 'today' ? (c.dailyXpGoal || 0) : (c.dailyXpGoal || 0) * 5;
            const titleEsc = esc(c.title || 'Untitled Course');
            const subjectEsc = esc(c.subject || '');
            const loginUrlEsc = esc(loginUrl);

            body.innerHTML = `
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
                    <div style="width:48px;height:48px;border-radius:12px;background:var(--color-primary-light);display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:var(--color-primary-dark);">
                        <i class="fa-solid ${guessIcon(c.title)}"></i>
                    </div>
                    <div>
                        <div style="font-weight:600;font-size:1rem;color:#2D3748;">${titleEsc}</div>
                        <div style="font-size:0.82rem;color:#718096;">${subjectEsc}${c.totalLessons ? ' · ' + c.totalLessons + ' lessons' : ''}</div>
                    </div>
                </div>

                <div style="display:flex;gap:12px;margin-bottom:20px;">
                    <div style="flex:1;background:#F4F6F9;border-radius:10px;padding:14px;text-align:center;">
                        <div style="font-size:1.3rem;font-weight:700;color:#45B5AA;">${xpEarned}</div>
                        <div style="font-size:0.75rem;font-weight:600;color:#718096;text-transform:uppercase;letter-spacing:0.5px;">XP Earned</div>
                    </div>
                    <div style="flex:1;background:#F4F6F9;border-radius:10px;padding:14px;text-align:center;">
                        <div style="font-size:1.3rem;font-weight:700;color:#2D3748;">${goal}</div>
                        <div style="font-size:0.75rem;font-weight:600;color:#718096;text-transform:uppercase;letter-spacing:0.5px;">XP Goal</div>
                    </div>
                    <div style="flex:1;background:#F4F6F9;border-radius:10px;padding:14px;text-align:center;">
                        <div style="font-size:1.3rem;font-weight:700;color:#2D3748;">${c.totalXp || 0}</div>
                        <div style="font-size:0.75rem;font-weight:600;color:#718096;text-transform:uppercase;letter-spacing:0.5px;">Total XP</div>
                    </div>
                </div>

                ${credentialsHTML}
                ${metaDetailsHTML}

                <div style="display:flex;gap:10px;margin-top:20px;">
                    ${loginUrl ? `<a href="${loginUrlEsc}" target="_blank" rel="noopener" style="flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;background:#45B5AA;color:#fff;border:none;border-radius:10px;font-size:0.95rem;font-weight:600;text-decoration:none;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#389E94'" onmouseout="this.style.background='#45B5AA'">
                        Next <i class="fa-solid fa-arrow-right"></i>
                    </a>` : `<button disabled style="flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;background:#E8ECF1;color:#718096;border:none;border-radius:10px;font-size:0.95rem;font-weight:600;cursor:not-allowed;">
                        No external link available
                    </button>`}
                    <button onclick="closeCourseModal()" style="padding:12px 20px;background:#F4F6F9;color:#718096;border:none;border-radius:10px;font-size:0.95rem;font-weight:500;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#E8ECF1'" onmouseout="this.style.background='#F4F6F9'">
                        Close
                    </button>
                </div>
            `;

            modal.style.display = 'flex';
        } catch (err) {
            console.error('[AlphaLearn] Error opening course modal:', err);
            // Still show the modal with an error message so user gets feedback
            const body = document.getElementById('course-modal-body');
            if (body) {
                body.innerHTML = `
                    <div style="text-align:center;padding:24px;color:#718096;">
                        <i class="fa-solid fa-circle-exclamation" style="font-size:2rem;color:#E53E3E;margin-bottom:12px;display:block;"></i>
                        <p style="font-size:0.95rem;color:#2D3748;font-weight:600;margin-bottom:8px;">Unable to load course details</p>
                        <p style="font-size:0.82rem;">${esc(err.message || 'An unexpected error occurred')}</p>
                        <button onclick="closeCourseModal()" style="margin-top:16px;padding:10px 24px;background:#F4F6F9;color:#718096;border:none;border-radius:8px;font-size:0.9rem;font-weight:500;cursor:pointer;">Close</button>
                    </div>`;
            }
            modal.style.display = 'flex';
        }
    }

    function closeCourseModal() {
        document.getElementById('course-modal').style.display = 'none';
    }

    // Course card click via event delegation (more robust than inline onclick)
    document.addEventListener('click', function(e) {
        var card = e.target.closest('.course-card[data-course-index]');
        if (card) {
            e.preventDefault();
            var idx = parseInt(card.getAttribute('data-course-index'), 10);
            if (!isNaN(idx)) openCourseModal(idx);
        }
    });

    // Close modal on backdrop click
    var modalEl = document.getElementById('course-modal');
    if (modalEl) {
        modalEl.addEventListener('click', function(e) {
            if (e.target === this) closeCourseModal();
        });
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeCourseModal();
    });

    /* ---- Today / This Week toggle ---------------------------------------- */
    document.querySelectorAll('.toggle-btn[data-period]').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.toggle-btn[data-period]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const email = localStorage.getItem('alphalearn_email') || '';
            if (email) loadXp(email, btn.dataset.period);
        });
    });
    </script>
</body>
</html>
