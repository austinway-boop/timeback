<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Home</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" as="style">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preload" href="/css/style.css" as="style">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .course-info-icon-unused {
            display: none; /* removed — whole card is clickable now */
            background: rgba(255,255,255,0.95); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.78rem; color: #718096; cursor: pointer; z-index: 5;
            transition: all 0.2s; box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .course-info-icon:hover { background: #fff; color: #45B5AA; box-shadow: 0 2px 10px rgba(0,0,0,0.15); }
        a.course-info-icon { text-decoration: none; }
    </style>
</head>
<body data-view="student" data-active="home">

    <!-- Layout -->
    <div class="layout">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="main-content">
            <div class="student-home">
                <!-- Welcome -->
                <h1 class="welcome-heading">Welcome, <span id="user-name">Austin</span>!</h1>

                <!-- Assigned Tests -->
                <section class="assigned-tests-section" id="tests-section" style="display:none;">
                    <h2 class="section-title">Assigned Tests</h2>
                    <div class="assigned-tests-grid" id="tests-grid"></div>
                </section>

                <!-- Time Toggle -->
                <div class="time-toggle">
                    <button class="toggle-btn active" data-period="today">Today</button>
                    <button class="toggle-btn" data-period="week">This Week</button>
                </div>

                <!-- Course Cards -->
                <div class="course-grid" id="course-grid">
                    <!-- Skeleton course cards -->
                    <div class="course-card" style="pointer-events:none;">
                        <div class="course-card-image skeleton" style="height:140px;border-radius:12px 12px 0 0;"></div>
                        <div class="course-card-body">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                                <div class="skeleton skeleton-circle" style="width:8px;height:8px;"></div>
                                <div class="skeleton skeleton-text" style="width:70%;"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <div class="skeleton skeleton-text" style="width:50%;"></div>
                                <div class="skeleton skeleton-text" style="width:20%;"></div>
                            </div>
                            <div class="skeleton" style="height:6px;width:100%;border-radius:3px;"></div>
                        </div>
                    </div>
                    <div class="course-card" style="pointer-events:none;">
                        <div class="course-card-image skeleton" style="height:140px;border-radius:12px 12px 0 0;"></div>
                        <div class="course-card-body">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                                <div class="skeleton skeleton-circle" style="width:8px;height:8px;"></div>
                                <div class="skeleton skeleton-text" style="width:55%;"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <div class="skeleton skeleton-text" style="width:45%;"></div>
                                <div class="skeleton skeleton-text" style="width:25%;"></div>
                            </div>
                            <div class="skeleton" style="height:6px;width:100%;border-radius:3px;"></div>
                        </div>
                    </div>
                    <div class="course-card" style="pointer-events:none;">
                        <div class="course-card-image skeleton" style="height:140px;border-radius:12px 12px 0 0;"></div>
                        <div class="course-card-body">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                                <div class="skeleton skeleton-circle" style="width:8px;height:8px;"></div>
                                <div class="skeleton skeleton-text" style="width:65%;"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <div class="skeleton skeleton-text" style="width:55%;"></div>
                                <div class="skeleton skeleton-text" style="width:20%;"></div>
                            </div>
                            <div class="skeleton" style="height:6px;width:100%;border-radius:3px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Course Detail Modal -->
    <div class="modal-overlay" id="course-modal">
        <div style="background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.15);width:90%;max-width:520px;max-height:85vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid #E8ECF1;">
                <h2 style="font-size:1.15rem;font-weight:700;margin:0;" id="course-modal-title">Course Details</h2>
                <button onclick="closeCourseModal()" style="width:32px;height:32px;border:none;background:transparent;font-size:1.4rem;color:#A0AEC0;cursor:pointer;border-radius:8px;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.background='#F4F6F9'" onmouseout="this.style.background='transparent'">&times;</button>
            </div>
            <div id="course-modal-body" style="padding:24px;"></div>
        </div>
    </div>

    <script src="/js/layout.js"></script>
    <script src="/js/app.js?v=2"></script>
    <script>
    /* ---- Color + icon mappings for courses -------------------------------- */
    const COURSE_THEMES = ['teal', 'purple', 'pink', 'orange'];
    const COURSE_ICONS  = {
        math:       'fa-calculator',
        science:    'fa-atom',
        language:   'fa-book-open',
        reading:    'fa-book-open-reader',
        geography:  'fa-globe-americas',
        biology:    'fa-dna',
        tech:       'fa-laptop-code',
        default:    'fa-graduation-cap',
    };

    /* Subject illustration images (fallback) */
    const COURSE_IMAGES = {
        math:       '/img/subjects/math.png',
        science:    '/img/subjects/science.png',
        language:   '/img/subjects/language.png',
        reading:    '/img/subjects/reading.png',
        geography:  '/img/subjects/geography.png',
        biology:    '/img/subjects/biology.png',
        tech:       '/img/subjects/tech.png',
        default:    '/img/subjects/default.png',
    };

    /* Per-app images: checked FIRST before subject fallback */
    /* Per-app images — keys are substrings matched against title + appName + vendorKey */
    const APP_IMAGES = {
        gumpp:       '/img/apps/egumpp.png?v=2',       // matches GUMPP, EGUMPP, e-gumpp
        runestone:   '/img/apps/runestone.png?v=2',
        newsela:     '/img/apps/newsela.png?v=2',
        khan:        '/img/apps/khan.png?v=2',
        readtheory:  '/img/apps/readtheory.png?v=2',
        commonlit:   '/img/apps/commonlit.png?v=2',
        knewton:     '/img/apps/knewton.png?v=2',
        alta:        '/img/apps/knewton.png?v=2',      // "Alta" alone also matches Knewton Alta
        lalilo:      '/img/apps/lalilo.png?v=2',
        rocketmath:  '/img/apps/rocketmath.png?v=2',
        zearn:       '/img/apps/zearn.png?v=2',
        renaissance: '/img/apps/renaissance.png?v=2',
        starreading: '/img/apps/renaissance.png?v=2',   // Star Reading = Renaissance
        starmath:    '/img/apps/renaissance.png?v=2',    // Star Math = Renaissance
        powerpath:   '/img/apps/powerpath.png?v=2',
        edmentum:    '/img/subjects/science.png',
        mathacademy: '/img/subjects/math.png',
        membean:     '/img/subjects/reading.png',
    };

    /* Per-app icon overrides (correct subject for each app) */
    const APP_ICON_MAP = {
        gumpp:       'fa-book-open',       // English grammar/writing
        runestone:   'fa-laptop-code',     // Computer Science
        newsela:     'fa-book-open-reader',// Reading / ELA
        khan:        'fa-calculator',      // Math (primarily)
        readtheory:  'fa-book-open-reader',// Reading comprehension
        commonlit:   'fa-book-open-reader',// Reading / Literature
        knewton:     'fa-calculator',      // Math / Statistics
        alta:        'fa-calculator',      // Knewton Alta
        lalilo:      'fa-book-open-reader',// Reading / Literacy
        rocketmath:  'fa-calculator',      // Math fluency
        zearn:       'fa-calculator',      // Math
        renaissance: 'fa-graduation-cap',  // Assessment (Reading+Math)
        starreading: 'fa-book-open-reader',
        starmath:    'fa-calculator',
        powerpath:   'fa-calculator',      // Math
        edmentum:    'fa-graduation-cap',  // Multi-subject courseware
        mathacademy: 'fa-calculator',      // Math
        membean:     'fa-book-open',       // Vocabulary / ELA
    };

    /* Per-app dot colors — matched to the dominant color of each app image */
    const APP_DOT_COLORS = {
        gumpp:       '#D4A04A',  // golden amber (eGumpp)
        runestone:   '#6366F1',  // indigo/purple (Runestone)
        newsela:     '#7B8FA8',  // slate blue (Newsela)
        khan:        '#4CAF50',  // green (Khan Academy)
        readtheory:  '#9B59B6',  // purple (Read Theory)
        commonlit:   '#C77B7B',  // dusty rose (CommonLit)
        knewton:     '#2C4A7C',  // dark navy (Knewton Alta)
        alta:        '#2C4A7C',  // dark navy (Knewton Alta)
        lalilo:      '#7CB342',  // lime green (Lalilo)
        rocketmath:  '#E74C3C',  // red-orange (Rocket Math)
        zearn:       '#4DB6AC',  // teal (Zearn)
        renaissance: '#F5A623',  // gold (Renaissance)
        starreading: '#F5A623',  // gold (Star Reading)
        starmath:    '#F5A623',  // gold (Star Math)
        powerpath:   '#5B7FD5',  // blue (PowerPath)
        edmentum:    '#0077C8',  // Edmentum blue
        mathacademy: '#2D6A4F',  // Math Academy green
        membean:     '#F28C28',  // Membean orange
    };

    /* Subject fallback dot colors — matched to subject illustration images */
    const SUBJECT_DOT_COLORS = {
        math:       '#4A90D9',  // blue
        science:    '#43A047',  // green
        language:   '#D4884A',  // warm orange
        reading:    '#7E57C2',  // purple
        geography:  '#8D6E63',  // brown
        biology:    '#689F38',  // olive green
        tech:       '#5C6BC0',  // indigo
        default:    '#45B5AA',  // teal
    };

    /* ---- External vs Internal course detection ----------------------------- */
    /* App keys that are EXTERNAL (not hosted in-house on Timeback/AlphaLearn).
     * 'powerpath' is intentionally excluded — it IS in-house. */
    const EXTERNAL_APP_KEYS = new Set([
        'gumpp', 'runestone', 'newsela', 'khan', 'readtheory', 'commonlit',
        'knewton', 'alta', 'lalilo', 'rocketmath', 'zearn',
        'renaissance', 'starreading', 'starmath',
        'edmentum', 'mathacademy', 'membean',
    ]);

    /* Fallback LOGIN PAGE URLs for each known external app — used when
     * userProfiles don't provide a launchUrl for the course.
     * Each URL points directly to the app's login/sign-in page. */
    const KNOWN_APP_URLS = {
        gumpp:       'https://elearning.egumpp.com/login.aspx',   // direct login page
        runestone:   'https://runestone.academy/user/login',      // direct login page
        newsela:     'https://newsela.com/signin',                // sign-in page
        khan:        'https://www.khanacademy.org/login',         // login page
        readtheory:  'https://readtheory.org/auth/login',         // login page
        commonlit:   'https://www.commonlit.org/user/login',      // login page
        knewton:     'https://www.knewton.com/login',             // student login
        alta:        'https://www.knewton.com/login',             // Knewton Alta = same login
        lalilo:      'https://student.lalilo.com',                // student login portal
        rocketmath:  'https://play.rocketmath.com',               // student game login
        zearn:       'https://www.zearn.org',                     // login is on the homepage
        renaissance: 'https://schools.renaissance.com',           // school login portal
        starreading: 'https://schools.renaissance.com',           // Star Reading = Renaissance
        starmath:    'https://schools.renaissance.com',           // Star Math    = Renaissance
        edmentum:    'https://auth.edmentum.com/elf/login',       // Edmentum login
        mathacademy: 'https://www.mathacademy.com/login',         // Math Academy login
        membean:     'https://membean.com/login',                 // Membean login
    };

    /** Determine if a course is external based on its app/title/vendor identifiers.
     *  Uses three layers of detection so no external course slips through:
     *    1. Name/title/vendorKey substring match against known external apps
     *    2. vendorKey matches a userProfile (profiles only exist for external apps)
     *    3. appName is set but is NOT a native/timeback app → must be external
     */
    function isExternalCourse(c) {
        // Layer 1 — matches a known external app by name/title/vendorKey
        var appId = [c.appName, c._vendorKey, c.title].filter(Boolean).join(' ');
        var appKey = matchApp(appId) || matchApp(c.title || '');
        if (appKey && EXTERNAL_APP_KEYS.has(appKey)) return true;

        // Layer 2 — vendorKey has a matching userProfile with a launchUrl
        var vKey = c._vendorKey || '';
        if (vKey && userProfilesMap[vKey] && userProfilesMap[vKey].launchUrl) return true;

        // Layer 3 — appName is NOT a timeback-native app → external
        //   (isTimeback returns true when appName is empty — that's fine,
        //    those are generic timeback courses that belong on the internal page)
        if (!isTimeback(c)) return true;

        // Layer 4 — fuzzy: vendorKey or appName matches any profile's appName
        if (vKey || c.appName) {
            var needle = (c.appName || vKey || '').toLowerCase().replace(/[\s_-]/g, '');
            for (var vid in userProfilesMap) {
                var pName = (userProfilesMap[vid].appName || '').toLowerCase().replace(/[\s_-]/g, '');
                if (pName && needle && (pName.includes(needle) || needle.includes(pName))) return true;
            }
        }

        return false;
    }

    /** Get the best available external URL for a course.
     *  Tries multiple strategies so we always have a URL to open. */
    function getExternalUrl(c) {
        // 1. Exact vendorKey → userProfile launch URL (most accurate)
        var vKey = c._vendorKey || '';
        if (vKey && userProfilesMap[vKey] && userProfilesMap[vKey].launchUrl) {
            return userProfilesMap[vKey].launchUrl.replace(/\/+$/, '');
        }

        // 2. Known app fallback URL by substring match
        var appId = [c.appName, c._vendorKey, c.title].filter(Boolean).join(' ');
        var appKey = matchApp(appId) || matchApp(c.title || '');
        if (appKey && KNOWN_APP_URLS[appKey]) return KNOWN_APP_URLS[appKey];

        // 3. Fuzzy match: search all userProfiles for one whose appName
        //    overlaps with this course's appName or vendorKey
        var needle = (c.appName || vKey || '').toLowerCase().replace(/[\s_-]/g, '');
        if (needle) {
            for (var vid in userProfilesMap) {
                var prof = userProfilesMap[vid];
                var pName = (prof.appName || '').toLowerCase().replace(/[\s_-]/g, '');
                if (pName && (pName.includes(needle) || needle.includes(pName)) && prof.launchUrl) {
                    return prof.launchUrl.replace(/\/+$/, '');
                }
            }
        }

        return '';
    }

    /** Match an app name string against the known app keys */
    function matchApp(appName) {
        const a = (appName || '').toLowerCase().replace(/[\s_-]/g, '');
        if (!a) return null;
        // Check longest keys first to avoid false positives (e.g. "alta" inside "saltation")
        const keys = Object.keys(APP_IMAGES).sort((a, b) => b.length - a.length);
        for (const key of keys) {
            if (a.includes(key)) return key;
        }
        return null;
    }

    function guessIcon(title, appName) {
        // 1. Check app name first
        const app = matchApp(appName) || matchApp(title);
        if (app && APP_ICON_MAP[app]) return APP_ICON_MAP[app];
        // 2. Fall back to title keywords
        const t = (title || '').toLowerCase();
        if (t.includes('math') || t.includes('algebra') || t.includes('calculus')) return COURSE_ICONS.math;
        if (t.includes('chem') || t.includes('physics'))                          return COURSE_ICONS.science;
        if (t.includes('bio'))                                                     return COURSE_ICONS.biology;
        if (t.includes('read') || t.includes('ela') || t.includes('english'))     return COURSE_ICONS.reading;
        if (t.includes('lang') || t.includes('composition') || t.includes('writing')) return COURSE_ICONS.language;
        if (t.includes('geo') || t.includes('history') || t.includes('social'))   return COURSE_ICONS.geography;
        if (t.includes('code') || t.includes('tech'))                              return COURSE_ICONS.tech;
        return COURSE_ICONS.default;
    }

    function guessSubjectImage(title, appName) {
        // 1. Check app name first
        const app = matchApp(appName) || matchApp(title);
        if (app && APP_IMAGES[app]) return APP_IMAGES[app];
        // 2. Fall back to title keywords
        const t = (title || '').toLowerCase();
        if (t.includes('math') || t.includes('algebra') || t.includes('calculus')) return COURSE_IMAGES.math;
        if (t.includes('chem') || t.includes('physics'))                          return COURSE_IMAGES.science;
        if (t.includes('bio'))                                                     return COURSE_IMAGES.biology;
        if (t.includes('read') || t.includes('ela') || t.includes('english'))     return COURSE_IMAGES.reading;
        if (t.includes('lang') || t.includes('composition') || t.includes('writing')) return COURSE_IMAGES.language;
        if (t.includes('geo') || t.includes('history') || t.includes('social'))   return COURSE_IMAGES.geography;
        if (t.includes('code') || t.includes('tech'))                              return COURSE_IMAGES.tech;
        return COURSE_IMAGES.default;
    }

    function guessDotColor(title, appName) {
        // 1. Check app name first
        const app = matchApp(appName) || matchApp(title);
        if (app && APP_DOT_COLORS[app]) return APP_DOT_COLORS[app];
        // 2. Fall back to subject keywords
        const t = (title || '').toLowerCase();
        if (t.includes('math') || t.includes('algebra') || t.includes('calculus')) return SUBJECT_DOT_COLORS.math;
        if (t.includes('chem') || t.includes('physics'))                          return SUBJECT_DOT_COLORS.science;
        if (t.includes('bio'))                                                     return SUBJECT_DOT_COLORS.biology;
        if (t.includes('read') || t.includes('ela') || t.includes('english'))     return SUBJECT_DOT_COLORS.reading;
        if (t.includes('lang') || t.includes('composition') || t.includes('writing')) return SUBJECT_DOT_COLORS.language;
        if (t.includes('geo') || t.includes('history') || t.includes('social'))   return SUBJECT_DOT_COLORS.geography;
        if (t.includes('code') || t.includes('tech'))                              return SUBJECT_DOT_COLORS.tech;
        return SUBJECT_DOT_COLORS.default;
    }

    /* ---- AP Timeback-hosted course detection ------------------------------ */
    function isAPCourse(title) { return /\bAP\b/.test((title || '').trim()); }
    function isTimeback(c) {
        const a = (c.appName || '').toLowerCase().trim();
        if (!a) return true;
        if (NATIVE_APPS.some(n => a.includes(n) || n.includes(a))) return true;
        if (/^pp/i.test(a) || a.includes('powerpath')) return true;
        return false;
    }
    function isLessonCourse(c) { return isAPCourse(c.title) && isTimeback(c); }

    /** True when a course is an internal (Timeback-hosted) app — NOT an external third-party.
     *  Internal apps report lessons via EduBridge enrollment analytics (masteredUnits). */
    function isInternalCourse(c) { return !isExternalCourse(c); }

    /* ---- State ------------------------------------------------------------ */
    let allCourses = [];       // set once after enrollment fetch
    let xpByCourseIdx = {};    // { 0: 13, 1: 25, ... } — XP per course index (daily/weekly)
    let unitsByCourseIdx = {}; // { 0: 2, 1: 0, ... } — mastered units per course (daily/weekly)
    let fullYearXpIdx = {};    // { 0: 500, 1: 1200, ... } — full-year XP for unit estimation
    let masteredIdx = {};      // { 0: 25, ... } — total mastered units (full year)
    let currentPeriod = 'today';
    let userProfilesMap = {};  // { vendorId: { username, credentialId, appName, domain, launchUrl } }
    var _appCredentials = {};   // { vendorId/platform: { username, password } }
    let currentUserId = '';    // user's sourcedId for credential decryption

    // Timeback-native app names (XP reported here for courses without their own app)
    const NATIVE_APPS = ['timeback dash', 'alpha timeback', 'alphalearn', 'timeback'];

    // Goals loaded from API (Upstash KV) — populated in DOMContentLoaded
    let savedGoals = {};

    // US school holidays for a school year starting in September of year y
    function getSchoolHolidays(y) {
        const h = [];
        function pad(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        // Labor Day — 1st Monday of September
        const s1 = new Date(y,8,1);
        h.push(pad(new Date(y,8,1+((8-s1.getDay())%7))));
        // Veterans Day
        h.push(`${y}-11-11`);
        // Thanksgiving — 4th Thursday + Friday
        const n1 = new Date(y,10,1);
        const th = new Date(y,10,1+((11-n1.getDay())%7)+21);
        h.push(pad(th));
        const tf = new Date(th); tf.setDate(tf.getDate()+1); h.push(pad(tf));
        // Winter Break — Dec 23-31, Jan 1-3
        for (let d=23;d<=31;d++) h.push(`${y}-12-${String(d).padStart(2,'0')}`);
        for (let d=1;d<=3;d++)   h.push(`${y+1}-01-${String(d).padStart(2,'0')}`);
        // MLK Day — 3rd Monday of January
        const j1 = new Date(y+1,0,1);
        h.push(pad(new Date(y+1,0,1+((8-j1.getDay())%7)+14)));
        // Presidents Day — 3rd Monday of February
        const f1 = new Date(y+1,1,1);
        h.push(pad(new Date(y+1,1,1+((8-f1.getDay())%7)+14)));
        // Spring Break — 5 days from 3rd Monday of March
        const m1 = new Date(y+1,2,1);
        const sb = new Date(y+1,2,1+((8-m1.getDay())%7)+14);
        for (let i=0;i<5;i++) { const dd=new Date(sb); dd.setDate(dd.getDate()+i); h.push(pad(dd)); }
        // Memorial Day — last Monday of May
        const may31 = new Date(y+1,4,31);
        h.push(pad(new Date(y+1,4,31-((may31.getDay()+6)%7))));
        return new Set(h);
    }

    // School-day counter — excludes weekends AND holidays when excludeNonSchool is true
    function countSchoolDays(endDateStr, excludeNonSchool) {
        const today = new Date(); today.setHours(0,0,0,0);
        const end = new Date(endDateStr + 'T00:00:00');
        if (end <= today) return 0;

        // Build holiday set
        const hs = new Set();
        if (excludeNonSchool) {
            for (let y = today.getFullYear() - 1; y <= end.getFullYear(); y++) {
                for (const h of getSchoolHolidays(y)) hs.add(h);
            }
        }

        let count = 0;
        const c = new Date(today); c.setDate(c.getDate() + 1);
        while (c <= end) {
            const dow = c.getDay();
            if (excludeNonSchool) {
                if (dow !== 0 && dow !== 6 && !hs.has(localDateStr(c))) count++;
            } else {
                count++;
            }
            c.setDate(c.getDate() + 1);
        }
        return count;
    }

    /* ---- Render ----------------------------------------------------------- */
    function renderCourses() {
        const courses = allCourses;
        if (!courses.length) {
            document.getElementById('course-grid').innerHTML =
                '<div style="grid-column:1/-1;text-align:center;padding:48px;color:var(--color-text-muted);">No courses found for your account.</div>';
            return;
        }
        const periodLabel = currentPeriod === 'today' ? 'TODAY' : 'THIS WEEK';

        document.getElementById('course-grid').innerHTML = courses.map((c, i) => {
            const color     = COURSE_THEMES[i % COURSE_THEMES.length];
            const name      = c.title || 'Untitled Course';
            const savedGoal = savedGoals[c._enrollmentId]
                || savedGoals[c._goalKey]
                || savedGoals[(c._raw || {}).id]
                || savedGoals[(c._raw || {}).sourcedId]
                || null;
            const lessonBased = isInternalCourse(c);

            let progressText, progressLabel, pct;

            if (lessonBased) {
                /* Internal app — show lessons completed (masteredUnits) vs daily goal */
                const totalDone = masteredIdx[i] || 0;
                const total = c.totalLessons || (savedGoal && savedGoal.target) || 0;
                const periodLessons = unitsByCourseIdx[i] || 0;

                if (savedGoal && savedGoal.endDate && total > 0) {
                    const rem = Math.max(total - totalDone, 0);
                    const excl = savedGoal.excludeNonSchoolDays !== false;
                    const days = countSchoolDays(savedGoal.endDate, excl);
                    const daily = days > 0 && rem > 0 ? Math.ceil(rem / days) : 0;
                    const periodGoal = currentPeriod === 'today' ? daily : daily * 5;
                    pct = periodGoal > 0 ? Math.min((periodLessons / periodGoal) * 100, 100) : (rem <= 0 ? 100 : 0);
                    progressText = rem <= 0 ? 'Complete!' : `${periodLessons} / ${periodGoal} lessons`;
                    progressLabel = rem <= 0 ? 'DONE' : periodLabel;
                } else {
                    pct = 0;
                    progressText = `${periodLessons} lessons ${currentPeriod === 'today' ? 'today' : 'this week'}`;
                    progressLabel = '<a href="/goals" style="color:var(--color-primary);text-decoration:none;font-weight:600;font-size:0.78rem;" onclick="event.stopPropagation()">Set Goal &rarr;</a>';
                }
            } else {
                // Non-lesson course: show daily/weekly XP
                const kvGoal = savedGoals[c._enrollmentId]
                    || savedGoals[c._goalKey]
                    || savedGoals[(c._raw || {}).id]
                    || savedGoals[(c._raw || {}).sourcedId]
                    || {};
                const dailyGoal = kvGoal.dailyXp || c.dailyXpGoal || 0;
                const xpEarned = Math.round(xpByCourseIdx[i] || 0);
                const goal = currentPeriod === 'today' ? dailyGoal : dailyGoal * 5;
                pct = goal > 0 ? Math.min((xpEarned / goal) * 100, 100) : 0;
                progressText = goal > 0 ? `${xpEarned} / ${goal} XP` : `${xpEarned} XP`;
                progressLabel = goal > 0 ? periodLabel : '<a href="/goals" style="color:var(--color-primary);text-decoration:none;font-weight:600;font-size:0.78rem;" onclick="event.stopPropagation()">Set Goal &rarr;</a>';
            }

            // Check if external course
            const vKey = c._vendorKey || '';
            const profile = vKey ? (userProfilesMap[vKey] || {}) : {};
            const isExternal = !!vKey;
            const launchUrl = profile.launchUrl || '';
            const platformName = profile.appName || c.appName || '';

            // No separate icon — the whole card is clickable

            // Combine all possible app identifiers for image/icon matching
            const appId = [c.appName, platformName, c._vendorKey].filter(Boolean).join(' ');
            const icon = guessIcon(c.title || '', appId);
            const subjectImg = guessSubjectImage(c.title || '', appId);
            const dotColor = guessDotColor(c.title || '', appId);
            console.log(`[Card ${i}] title="${name}" appId="${appId}" matched=${matchApp(appId)||matchApp(name)||'none'} img=${subjectImg}`);

            return `
                <div class="course-card" data-course-index="${i}" style="cursor:pointer;position:relative;">
                    <div class="course-card-image" style="background:#EBF0F9;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                        <img src="${subjectImg}" alt="${esc(name)}" loading="lazy" style="width:100%;height:100%;object-fit:cover;">
                    </div>
                    <div class="course-card-body">
                        <div class="course-card-header">
                            <span class="status-dot" style="background:${dotColor}"></span>
                            <span class="course-card-name">${name}</span>
                        </div>
                        <div class="course-card-xp">
                            <span class="xp-progress">${progressText}</span>
                            <span class="xp-period">${progressLabel}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pct}%"></div>
                        </div>
                    </div>
                </div>`;
        }).join('');

        // Attach click handlers directly to each card element
        document.querySelectorAll('#course-grid .course-card[data-course-index]').forEach(function(card) {
            card.addEventListener('click', function() {
                var idx = parseInt(this.getAttribute('data-course-index'), 10);
                if (isNaN(idx)) return;
                var c = allCourses[idx];
                if (!c) return;

                if (isExternalCourse(c)) {
                    // External course → open the app's site in a new tab
                    var url = getExternalUrl(c);
                    if (url) {
                        window.open(url, '_blank');
                    }
                } else {
                    // Internal course → navigate to course viewer
                    var rawId = (c._raw || {}).id || (c._raw || {}).sourcedId || '';
                    window.location.href = '/course?id=' + encodeURIComponent(rawId) + '&title=' + encodeURIComponent(c.title || '');
                }
            });
        });
    }

    function showError(msg) {
        document.getElementById('course-grid').innerHTML =
            `<div style="grid-column:1/-1;text-align:center;padding:48px;color:#E53E3E;">
                <i class="fa-solid fa-circle-exclamation"></i> ${msg}
            </div>`;
    }

    document.addEventListener('DOMContentLoaded', async function () {
        const name  = localStorage.getItem('alphalearn_name') || 'Student';
        const email = localStorage.getItem('alphalearn_email') || '';
        const cachedUserId = localStorage.getItem('alphalearn_userId') || '';
        document.getElementById('user-name').textContent = name;

        if (!email) {
            showError('No email found. Please <a href="/login" style="color:var(--color-primary)">sign in</a> first.');
            return;
        }

        try {
            /* 1. Fire user-lookup AND enrollments in parallel when we have a cached userId.
             *    This saves a full API round-trip on return visits (~200-500ms). */
            const lookupPromise = fetch(`/api/user-lookup?email=${encodeURIComponent(email)}`).then(r => r.json());
            const earlyEnrollPromise = cachedUserId
                ? fetch(`/api/enrollments?userId=${cachedUserId}`).then(r => r.json())
                : null;

            const lookupData = await lookupPromise;

            if (!lookupData.user || !lookupData.user.sourcedId) {
                showError('Could not find your account. Please check your email and try again.');
                return;
            }

            const userId = lookupData.user.sourcedId;
            currentUserId = userId;
            localStorage.setItem('alphalearn_userId', userId);

            // Build credentials map from userIds (primary source: username + password)
            const userIds = lookupData.user.userIds || [];
            for (const uid of userIds) {
                const type = uid.type || '';
                const identifier = uid.identifier || '';
                if (!type || !identifier) continue;
                if (type.endsWith('_password')) {
                    const platform = type.replace('_password', '');
                    if (!_appCredentials[platform]) _appCredentials[platform] = {};
                    _appCredentials[platform].password = identifier;
                } else {
                    if (!_appCredentials[type]) _appCredentials[type] = {};
                    _appCredentials[type].username = identifier;
                }
            }

            // Build userProfiles map (for app name + launch URL)
            const profiles = lookupData.user.userProfiles || [];
            for (const p of profiles) {
                const vendorId = p.vendorId || p.applicationId || '';
                if (!vendorId) continue;
                const appDomains = (p.app && p.app.domain) || [];
                const pCred = (p.credentials && p.credentials[0]) || {};
                userProfilesMap[vendorId] = {
                    appName: (p.app && p.app.name) || p.description || '',
                    domain: appDomains[0] || '',
                    launchUrl: appDomains[0] ? 'https://' + appDomains[0] : '',
                    username: pCred.username || '',
                };
            }

            /* 2. Use pre-fetched enrollments if userId matches, otherwise fetch now */
            let enrollData;
            if (earlyEnrollPromise && userId === cachedUserId) {
                enrollData = await earlyEnrollPromise;
            } else {
                const enrollResp = await fetch(`/api/enrollments?userId=${userId}`);
                enrollData = await enrollResp.json();
            }

            const raw = enrollData.data
                || enrollData.enrollments
                || enrollData.courses
                || (Array.isArray(enrollData) ? enrollData : []);

            /* 3. Filter to ONLY currently-enrolled, real courses
             *
             * Per EduBridge docs the response is already "active enrollments",
             * so we only need to:
             *   - drop expired (endDate in the past)
             *   - drop obvious non-course rows (Manual XP, Hole-Filling, no-subject admin rows)
             *   - drop PowerPath assessment courses (title contains "- PP")
             *   - separate mastery track tests into their own section
             */
            const now     = new Date();
            const courses = [];
            const tests   = [];

            for (const e of raw) {
                const course   = e.course || {};
                const cMeta    = course.metadata || {};
                const goals    = (e.metadata && e.metadata.goals) || {};
                const metrics  = (e.metadata && e.metadata.metrics) || {};
                const title    = (course.title || '').trim();
                const subjects = course.subjects || [];
                const endDate  = e.endDate ? new Date(e.endDate) : null;

                // ── Skip expired enrollments ──
                if (endDate && endDate < now) continue;

                // ── Skip junk rows ──
                if (!title)                         continue;
                if (title.startsWith('Manual XP'))  continue;
                if (title.includes('Hole-Filling')) continue;
                if (!subjects.length)               continue;  // school/org rows (e.g. "Alpha High School 2025-26")

                // Resolve app name: course.primaryApp.name (per docs) or metadata fallback
                const pApp = course.primaryApp || {};
                const appName = (typeof pApp === 'object' ? pApp.name : '')
                    || cMeta.primaryApp || cMeta.app || '';

                // Check both enrollment metadata AND course metadata for metrics
                const cMetrics = (cMeta.metrics) || {};
                const totalLessons = metrics.totalLessons || cMetrics.totalLessons || cMeta.totalLessons
                    || course.totalLessons || metrics.totalUnits || cMetrics.totalUnits || cMeta.totalUnits || course.totalUnits || 0;
                const totalXp = metrics.totalXp || cMetrics.totalXp || cMeta.totalXp || course.totalXp || 0;

                // Vendor key: used to match course → userProfiles for credentials
                const vendorKey = cMeta.primaryApp || cMeta.app || cMeta.vendor
                    || (typeof pApp === 'object' && pApp.id ? pApp.id : '') || '';

                const item = {
                    title,
                    subject:      subjects[0] || '',
                    appName,
                    totalXp,
                    totalLessons,
                    dailyXpGoal:  goals.dailyXp || 0,
                    _goalKey:     e.id || e.sourcedId || course.id || course.sourcedId || title,
                    _enrollmentId: e.id || e.sourcedId || '',
                    _vendorKey:   vendorKey,
                    _raw: e,
                    _course: course,
                    _metadata: { ...course.metadata, ...e.metadata },
                };

                // ── Mastery track tests only (not PP, not regular courses) ──
                const isMastery = metrics.courseType === 'mastery_test'
                    || metrics.courseType === 'mastery-test'
                    || metrics.courseType === 'masteryTest'
                    || (title.toLowerCase().includes('mastery') && title.toLowerCase().includes('test'));

                if (isMastery) {
                    tests.push(item);
                    continue;
                }

                courses.push(item);
            }

            /* 4. Render PowerPath assigned tests in top section */
            // Fetch test assignments from PowerPath
            let ppAssignments = [];
            try {
                const ppResp = await fetch('/api/assign-test?student=' + encodeURIComponent(userId));
                const ppData = await ppResp.json();
                ppAssignments = (ppData.testAssignments || []).filter(a => {
                    const st = (a.assignmentStatus || a.status || '').toLowerCase();
                    return st !== 'cancelled' && st !== 'expired';
                });
            } catch(e) {}

            // Build test list: PowerPath assignments + mastery track enrollments
            const allTests = [];
            ppAssignments.forEach(a => {
                const subj = a.subject || '';
                const gr = a.grade || a.gradeLevel || '';
                const name = a.testName || (subj && gr ? subj + ' Grade ' + gr : 'Test Assignment');
                const status = (a.assignmentStatus || a.status || 'assigned').toLowerCase();
                const assignmentId = a.sourcedId || a.assignmentId || '';
                const lessonId = a.componentResourceSourcedId || a.lessonId || '';
                allTests.push({
                    title: name, subject: subj, grade: gr,
                    status: status, assignmentId: assignmentId,
                    lessonId: lessonId,
                    type: 'assigned',
                });
            });
            tests.forEach(t => {
                if (!allTests.some(x => x.title === t.title)) {
                    allTests.push({ title: t.title, subject: t.subject, type: 'mastery', status: 'assigned', assignmentId: '' });
                }
            });

            if (allTests.length) {
                document.getElementById('tests-section').style.display = '';
                document.getElementById('tests-grid').innerHTML = allTests.map(t => {
                    const isComplete = t.status === 'completed';
                    const isInProgress = t.status === 'in_progress';
                    const gradient = isComplete
                        ? 'linear-gradient(135deg,#E8F5E9 0%,#C8E6C9 50%,#A5D6A7 100%)'
                        : isInProgress
                        ? 'linear-gradient(135deg,#FFFDE7 0%,#FFF9C4 50%,#FFF176 100%)'
                        : 'linear-gradient(135deg,#EBF4FF 0%,#BEE3F8 50%,#90CDF4 100%)';
                    const iconColor = isComplete ? '#2E7D32' : isInProgress ? '#F57F17' : '#2B6CB0';
                    const icon = isComplete ? 'fa-check-circle' : 'fa-clipboard-check';
                    const statusLabel = isComplete ? 'Completed' : isInProgress ? 'In Progress' : 'Assigned';
                    const statusColor = isComplete ? '#2E7D32' : isInProgress ? '#F57F17' : '#2B6CB0';
                    const statusBg = isComplete ? '#E8F5E9' : isInProgress ? '#FFF8E1' : '#EBF4FF';

                    // Link to MasteryTrack dashboard where student sees all their tests
                    const testUrl = 'https://alphatest.alpha.school';

                    const clickAction = testUrl && !isComplete
                        ? `onclick="window.open('${testUrl}', '_blank')"`
                        : '';

                    return `<div class="test-card" style="cursor:${testUrl && !isComplete ? 'pointer' : 'default'};" ${clickAction}>
                        <div class="test-card-image" style="background:${gradient};">
                            <div class="test-card-illustration" style="color:${iconColor};">
                                <i class="fa-solid ${icon}"></i>
                            </div>
                        </div>
                        <div class="test-card-info">
                            <div class="test-card-status">
                                <span class="status-dot" style="background:${statusColor};"></span>
                                <span class="test-card-name">${t.title}</span>
                            </div>
                            <div class="test-card-meta">
                                <span class="test-badge">${t.subject}</span>
                                <span class="test-badge" style="background:${statusBg};color:${statusColor};">${statusLabel}</span>
                            </div>
                            ${testUrl && !isComplete ? '<div style="margin-top:8px;"><span style="display:inline-flex;align-items:center;gap:4px;padding:4px 12px;background:#2B6CB0;color:#fff;border-radius:6px;font-size:0.75rem;font-weight:600;"><i class="fa-solid fa-arrow-up-right-from-square" style="font-size:0.65rem;"></i> Take Test</span></div>' : ''}
                        </div>
                    </div>`;
                }).join('');
            }

            /* 5. Store courses globally, fetch goals + full-year XP + daily XP in parallel */
            allCourses = courses;

            const hasInternalCourses = courses.some(c => isInternalCourse(c));
            await Promise.all([
                // Load goals from KV API
                fetch(`/api/goals?userId=${encodeURIComponent(userId)}`)
                    .then(r => r.json())
                    .then(d => { savedGoals = d.goals || {}; })
                    .catch(e => { console.warn('[AlphaLearn] Goals unavailable:', e.message); }),
                hasInternalCourses ? loadFullYearXp(email) : Promise.resolve(),
                loadXp(email, 'today'),
            ]);

            // Re-render after all parallel fetches complete so masteredIdx
            // (from loadFullYearXp) is guaranteed to be populated.
            renderCourses();

        } catch (err) {
            showError('Unable to reach the Timeback API. Please try again later.');
            console.error('[AlphaLearn]', err);
        }
    });

    /* ---- Fetch XP from EduBridge analytics -------------------------------- */
    function localDateStr(d) {
        // Use LOCAL date (not UTC) so "today" matches the user's timezone
        const yyyy = d.getFullYear();
        const mm   = String(d.getMonth() + 1).padStart(2, '0');
        const dd   = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    // User's IANA timezone (e.g. "America/Chicago") — sent to analytics API
    // so the server can group facts by the correct local day.
    const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || '';

    async function loadXp(email, period) {
        currentPeriod = period;
        const now = new Date();
        let startDate, endDate;

        if (period === 'today') {
            // Build proper UTC timestamps for local day boundaries
            const s = new Date(now); s.setHours(0, 0, 0, 0);
            const e = new Date(now); e.setHours(23, 59, 59, 999);
            startDate = s.toISOString();
            endDate   = e.toISOString();
        } else {
            const dayOfWeek = now.getDay();
            const monday = new Date(now);
            monday.setDate(now.getDate() - ((dayOfWeek + 6) % 7));
            monday.setHours(0, 0, 0, 0);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            sunday.setHours(23, 59, 59, 999);
            startDate = monday.toISOString();
            endDate   = sunday.toISOString();
        }

        try {
            const ac = new AbortController();
            setTimeout(function() { ac.abort(); }, 10000); // 10s timeout
            const resp = await fetch(
                `/api/analytics?email=${encodeURIComponent(email)}&startDate=${startDate}&endDate=${endDate}&timezone=${encodeURIComponent(userTimezone)}`,
                { signal: ac.signal }
            );
            const data = await resp.json();
            const factsByApp = data.factsByApp || {};
            const facts      = data.facts || {};

            // Build per-app lookup for XP
            const xpMap = {};
            for (const dayData of Object.values(factsByApp)) {
                for (const [subject, apps] of Object.entries(dayData)) {
                    if (!xpMap[subject]) xpMap[subject] = {};
                    for (const [appName, info] of Object.entries(apps)) {
                        const am = info.activityMetrics || {};
                        const key = appName.toLowerCase();
                        xpMap[subject][key] = (xpMap[subject][key] || 0) + (am.xpEarned || 0);
                    }
                }
            }

            // Also build a subject-level fallback from facts
            const xpBySubject = {};
            for (const dayFacts of Object.values(facts)) {
                for (const [subject, info] of Object.entries(dayFacts)) {
                    const am = info.activityMetrics || {};
                    xpBySubject[subject] = (xpBySubject[subject] || 0) + (am.xpEarned || 0);
                }
            }

            // Match XP to each course
            xpByCourseIdx = {};
            unitsByCourseIdx = {};
            for (let i = 0; i < allCourses.length; i++) {
                const c = allCourses[i];
                const subjApps = xpMap[c.subject] || {};
                const appName = (c.appName || '').toLowerCase();

                if (appName && Object.keys(subjApps).length) {
                    let matchedXp = subjApps[appName] || 0;
                    if (!matchedXp) {
                        const normalized = appName.replace(/_/g, ' ');
                        for (const [key, xp] of Object.entries(subjApps)) {
                            if (key === normalized || key.includes(normalized) || normalized.includes(key)) {
                                matchedXp = xp;
                                break;
                            }
                        }
                    }
                    xpByCourseIdx[i] = matchedXp;
                } else if (!appName && Object.keys(subjApps).length) {
                    let nativeXp = 0;
                    for (const [key, xp] of Object.entries(subjApps)) {
                        if (NATIVE_APPS.some(n => key.includes(n) || n.includes(key))) {
                            nativeXp += xp;
                        }
                    }
                    xpByCourseIdx[i] = nativeXp;
                } else {
                    xpByCourseIdx[i] = xpBySubject[c.subject] || 0;
                }
            }

            // Fetch lessons completed for internal apps via enrollment analytics (masteredUnits).
            // This replaces the old lesson-count API which used raw OneRoster assessmentResults
            // and was slow/unreliable. The EduBridge enrollment analytics endpoint is the
            // proper way to get masteredUnits for internal (Timeback-hosted) courses.
            const hasInternal = allCourses.some(c => isInternalCourse(c));
            if (hasInternal) {
                try {
                    const lessonPromises = [];
                    for (let idx = 0; idx < allCourses.length; idx++) {
                        const c = allCourses[idx];
                        if (!isInternalCourse(c)) continue;
                        if (!c._enrollmentId) continue;
                        lessonPromises.push(
                            fetch(`/api/enrollment-analytics?enrollmentId=${encodeURIComponent(c._enrollmentId)}&startDate=${startDate}&endDate=${endDate}&timezone=${encodeURIComponent(userTimezone)}`)
                                .then(r => r.json())
                                .then(data => ({ idx, data }))
                                .catch(() => null)
                        );
                    }
                    const results = await Promise.all(lessonPromises);
                    for (const r of results) {
                        if (!r || !r.data) continue;
                        const { idx, data } = r;
                        const facts      = data.facts || {};
                        const factsByApp = data.factsByApp || {};

                        // Sum masteredUnits from facts (date → subject → metrics)
                        let totalMastered = 0;
                        for (const dayFacts of Object.values(facts)) {
                            for (const info of Object.values(dayFacts)) {
                                const am = info.activityMetrics || {};
                                totalMastered += am.masteredUnits || 0;
                            }
                        }
                        // Also check factsByApp (date → subject → app → metrics) for completeness
                        let appMastered = 0;
                        for (const dayData of Object.values(factsByApp)) {
                            for (const apps of Object.values(dayData)) {
                                for (const info of Object.values(apps)) {
                                    const am = info.activityMetrics || {};
                                    appMastered += am.masteredUnits || 0;
                                }
                            }
                        }
                        unitsByCourseIdx[idx] = Math.max(totalMastered, appMastered);
                    }
                } catch (e) {
                    console.warn('[AlphaLearn] Enrollment analytics unavailable:', e.message);
                }
            }
        } catch (err) {
            console.warn('[AlphaLearn] Analytics unavailable:', err.message);
            xpByCourseIdx = {};
        }

        renderCourses();
    }

    /* ---- Full-year mastered units for internal courses -------------------- */
    async function loadFullYearXp(email) {
        fullYearXpIdx = {};
        masteredIdx = {};

        // 1. Try to use the mastered cache from the goals page (per-enrollment data)
        let cacheUsed = false;
        try {
            const raw = localStorage.getItem('alphalearn_mastered_cache');
            if (raw) {
                const cached = JSON.parse(raw);
                const age = cached.updatedAt ? (Date.now() - new Date(cached.updatedAt).getTime()) : Infinity;
                // Use cache if less than 1 hour old
                if (age < 3600000 && cached.data) {
                    for (let i = 0; i < allCourses.length; i++) {
                        const c = allCourses[i];
                        if (!isInternalCourse(c)) continue;
                        const entry = cached.data[c._enrollmentId] || null;
                        if (entry) {
                            masteredIdx[i] = entry.mastered || 0;
                            fullYearXpIdx[i] = entry.xp || 0;
                            cacheUsed = true;
                        }
                    }
                }
            }
        } catch (e) { /* ignore cache errors */ }

        // 2. If cache covered all lesson courses, we're done
        const lessonCourseCount = allCourses.filter((c, i) => isInternalCourse(c)).length;
        const cachedCount = Object.keys(masteredIdx).length;
        if (cacheUsed && cachedCount >= lessonCourseCount) return;

        // 3. Fallback: per-enrollment analytics calls for courses not in cache
        try {
            const now = new Date();
            const startOfYear = new Date(now.getFullYear(), 7, 1);
            if (startOfYear > now) startOfYear.setFullYear(startOfYear.getFullYear() - 1);
            startOfYear.setHours(0, 0, 0, 0);
            const endDay = new Date(now); endDay.setHours(23, 59, 59, 999);
            const startDate = startOfYear.toISOString();
            const endDate   = endDay.toISOString();

            const promises = [];
            for (let i = 0; i < allCourses.length; i++) {
                const c = allCourses[i];
                if (!isInternalCourse(c)) continue;
                if (masteredIdx[i] !== undefined) continue; // already from cache
                if (!c._enrollmentId) continue;

                promises.push(
                    fetch(`/api/enrollment-analytics?enrollmentId=${encodeURIComponent(c._enrollmentId)}&startDate=${startDate}&endDate=${endDate}&timezone=${encodeURIComponent(userTimezone)}`)
                        .then(r => r.json())
                        .then(data => ({ i, data }))
                        .catch(() => null)
                );
            }

            if (promises.length > 0) {
                const results = await Promise.all(promises);
                for (const r of results) {
                    if (!r || !r.data) continue;
                    const { i, data } = r;
                    const facts      = data.facts || {};
                    const factsByApp = data.factsByApp || {};

                    let totalXp = 0, totalMastered = 0, totalQ = 0;
                    for (const dayFacts of Object.values(facts)) {
                        for (const info of Object.values(dayFacts)) {
                            const am = info.activityMetrics || {};
                            totalXp      += am.xpEarned || 0;
                            totalQ       += am.totalQuestions || 0;
                            totalMastered += am.masteredUnits || am.lessonsCompleted || am.completedLessons
                                || am.unitsCompleted || am.completedUnits || 0;
                        }
                    }
                    let appXp = 0, appMastered = 0;
                    for (const dayData of Object.values(factsByApp)) {
                        for (const apps of Object.values(dayData)) {
                            for (const info of Object.values(apps)) {
                                const am = info.activityMetrics || {};
                                appXp      += am.xpEarned || 0;
                                appMastered += am.masteredUnits || am.lessonsCompleted || am.completedLessons
                                    || am.unitsCompleted || am.completedUnits || 0;
                            }
                        }
                    }
                    fullYearXpIdx[i] = Math.max(totalXp, appXp);
                    fullYearXpIdx['q_' + i] = totalQ; // year total questions for ratio calc
                    masteredIdx[i]   = Math.max(totalMastered, appMastered);
                }
            }
        } catch (err) {
            console.warn('[AlphaLearn] Full-year analytics unavailable:', err.message);
        }

        // For internal courses still missing totalLessons, fetch from course API
        const missing = allCourses.map((c, i) => {
            if (!isInternalCourse(c) || c.totalLessons > 0) return null;
            const cid = (c._course && (c._course.sourcedId || c._course.id)) || '';
            if (!cid) return null;
            return fetch(`/api/course-info?courseId=${encodeURIComponent(cid)}`)
                .then(r => r.json())
                .then(d => { if (d.totalLessons) allCourses[i].totalLessons = d.totalLessons; })
                .catch(() => null);
        }).filter(Boolean);
        if (missing.length) await Promise.all(missing);
    }

    /* ---- HTML escape helper ---------------------------------------------- */
    function esc(str) {
        if (str === null || str === undefined) return '';
        if (typeof str !== 'string') str = String(str);
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    /** Coerce value to string — objects/arrays become '' to avoid [object Object] */
    function safeStr(val) {
        if (val === null || val === undefined) return '';
        if (typeof val === 'object') return '';
        return String(val);
    }

    /* ---- Course detail modal (internal courses only) ---------------------- */
    function openCourseModal(index) {
        const modal = document.getElementById('course-modal');
        if (!modal) return;
        try {
            const c = allCourses[index];
            if (!c) return;

            const body = document.getElementById('course-modal-body');
            document.getElementById('course-modal-title').textContent = c.title || 'Course Details';

            const titleEsc = esc(c.title || 'Untitled Course');
            const subjectEsc = esc(c.subject || '');
            const xpEarned = Math.round(xpByCourseIdx[index] || 0);
            const goal = currentPeriod === 'today' ? (c.dailyXpGoal || 0) : (c.dailyXpGoal || 0) * 5;
            const pct = goal > 0 ? Math.min((xpEarned / goal) * 100, 100) : 0;

            body.innerHTML = `
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
                    <div style="width:48px;height:48px;border-radius:12px;background:var(--color-primary-light);display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:var(--color-primary-dark);">
                        <i class="fa-solid ${guessIcon(c.title, [c.appName, c._vendorKey].filter(Boolean).join(' '))}"></i>
                    </div>
                    <div>
                        <div style="font-weight:600;font-size:1rem;color:#2D3748;">${titleEsc}</div>
                        <div style="font-size:0.82rem;color:#718096;">${subjectEsc}${c.totalLessons ? ' &middot; ' + c.totalLessons + ' lessons' : ''}</div>
                    </div>
                </div>

                <div style="display:flex;gap:12px;margin-bottom:20px;">
                    <div style="flex:1;background:#F4F6F9;border-radius:10px;padding:14px;text-align:center;">
                        <div style="font-size:1.3rem;font-weight:700;color:#45B5AA;">${xpEarned}</div>
                        <div style="font-size:0.75rem;font-weight:600;color:#718096;text-transform:uppercase;letter-spacing:0.5px;">XP Earned</div>
                    </div>
                    <div style="flex:1;background:#F4F6F9;border-radius:10px;padding:14px;text-align:center;">
                        <div style="font-size:1.3rem;font-weight:700;color:#2D3748;">${goal}</div>
                        <div style="font-size:0.75rem;font-weight:600;color:#718096;text-transform:uppercase;letter-spacing:0.5px;">Daily Goal</div>
                    </div>
                </div>

                <div class="progress-bar" style="height:8px;margin-bottom:20px;">
                    <div class="progress-fill" style="width:${pct}%"></div>
                </div>

                <button onclick="closeCourseModal()" style="width:100%;padding:12px 20px;background:#F4F6F9;color:#718096;border:none;border-radius:10px;font-size:0.95rem;font-weight:500;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#E8ECF1'" onmouseout="this.style.background='#F4F6F9'">
                    Close
                </button>
            `;

            modal.classList.add('open');
        } catch (err) {
            console.error('[AlphaLearn] Error opening course modal:', err);
            const body = document.getElementById('course-modal-body');
            if (body) {
                body.innerHTML = `
                    <div style="text-align:center;padding:24px;color:#718096;">
                        <i class="fa-solid fa-circle-exclamation" style="font-size:2rem;color:#E53E3E;margin-bottom:12px;display:block;"></i>
                        <p style="font-size:0.95rem;color:#2D3748;font-weight:600;margin-bottom:8px;">Unable to load course details</p>
                        <p style="font-size:0.82rem;">${esc(err.message || 'An unexpected error occurred')}</p>
                        <button onclick="closeCourseModal()" style="margin-top:16px;padding:10px 24px;background:#F4F6F9;color:#718096;border:none;border-radius:8px;font-size:0.9rem;font-weight:500;cursor:pointer;">Close</button>
                    </div>`;
            }
            modal.classList.add('open');
        }
    }

    function closeCourseModal() {
        var m = document.getElementById('course-modal');
        if (m) m.classList.remove('open');
    }

    // Close modal on backdrop click
    var modalEl = document.getElementById('course-modal');
    if (modalEl) {
        modalEl.addEventListener('click', function(e) {
            if (e.target === this) closeCourseModal();
        });
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeCourseModal();
    });

    /* ---- Today / This Week toggle ---------------------------------------- */
    document.querySelectorAll('.toggle-btn[data-period]').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.toggle-btn[data-period]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const email = localStorage.getItem('alphalearn_email') || '';
            if (email) loadXp(email, btn.dataset.period);
        });
    });
    </script>
</body>
</html>
