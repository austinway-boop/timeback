<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Home</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .course-info-icon {
            position: absolute; top: 10px; right: 10px;
            width: 26px; height: 26px;
            background: rgba(255,255,255,0.92); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; color: #718096; cursor: pointer; z-index: 5;
            transition: all 0.2s; box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .course-info-icon:hover { background: #fff; color: #45B5AA; box-shadow: 0 2px 10px rgba(0,0,0,0.15); }
        .course-info-tooltip {
            display: none; position: absolute; top: 110%; right: -4px;
            background: #fff; border: 1px solid #E8ECF1; border-radius: 10px;
            padding: 14px 16px; min-width: 240px; max-width: 300px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.12); font-size: 0.82rem;
            z-index: 10; text-align: left; color: #2D3748; line-height: 1.6;
        }
        .course-info-icon:hover .course-info-tooltip { display: block; }
        .course-info-tooltip code {
            background: #F4F6F9; padding: 2px 8px; border-radius: 4px;
            font-family: 'SF Mono','Fira Code',monospace; font-size: 0.85em;
        }
        .course-info-tooltip .tip-label { font-size: 0.72rem; font-weight: 600; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; }
        .course-info-tooltip a { color: #45B5AA; word-break: break-all; }
    </style>
</head>
<body data-view="student" data-active="home">

    <!-- Layout -->
    <div class="layout">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="main-content">
            <div class="student-home">
                <!-- Welcome -->
                <h1 class="welcome-heading">Welcome, <span id="user-name">Austin</span>!</h1>

                <!-- Assigned Tests -->
                <section class="assigned-tests-section" id="tests-section" style="display:none;">
                    <h2 class="section-title">Assigned Tests</h2>
                    <div class="assigned-tests-grid" id="tests-grid"></div>
                </section>

                <!-- Time Toggle -->
                <div class="time-toggle">
                    <button class="toggle-btn active" data-period="today">Today</button>
                    <button class="toggle-btn" data-period="week">This Week</button>
                </div>

                <!-- Course Cards -->
                <div class="course-grid" id="course-grid">
                    <!-- Skeleton course cards -->
                    <div class="course-card" style="pointer-events:none;">
                        <div class="course-card-image skeleton" style="height:140px;border-radius:12px 12px 0 0;"></div>
                        <div class="course-card-body">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                                <div class="skeleton skeleton-circle" style="width:8px;height:8px;"></div>
                                <div class="skeleton skeleton-text" style="width:70%;"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <div class="skeleton skeleton-text" style="width:50%;"></div>
                                <div class="skeleton skeleton-text" style="width:20%;"></div>
                            </div>
                            <div class="skeleton" style="height:6px;width:100%;border-radius:3px;"></div>
                        </div>
                    </div>
                    <div class="course-card" style="pointer-events:none;">
                        <div class="course-card-image skeleton" style="height:140px;border-radius:12px 12px 0 0;"></div>
                        <div class="course-card-body">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                                <div class="skeleton skeleton-circle" style="width:8px;height:8px;"></div>
                                <div class="skeleton skeleton-text" style="width:55%;"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <div class="skeleton skeleton-text" style="width:45%;"></div>
                                <div class="skeleton skeleton-text" style="width:25%;"></div>
                            </div>
                            <div class="skeleton" style="height:6px;width:100%;border-radius:3px;"></div>
                        </div>
                    </div>
                    <div class="course-card" style="pointer-events:none;">
                        <div class="course-card-image skeleton" style="height:140px;border-radius:12px 12px 0 0;"></div>
                        <div class="course-card-body">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                                <div class="skeleton skeleton-circle" style="width:8px;height:8px;"></div>
                                <div class="skeleton skeleton-text" style="width:65%;"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <div class="skeleton skeleton-text" style="width:55%;"></div>
                                <div class="skeleton skeleton-text" style="width:20%;"></div>
                            </div>
                            <div class="skeleton" style="height:6px;width:100%;border-radius:3px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Course Detail Modal -->
    <div class="modal-overlay" id="course-modal">
        <div style="background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.15);width:90%;max-width:520px;max-height:85vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid #E8ECF1;">
                <h2 style="font-size:1.15rem;font-weight:700;margin:0;" id="course-modal-title">Course Details</h2>
                <button onclick="closeCourseModal()" style="width:32px;height:32px;border:none;background:transparent;font-size:1.4rem;color:#A0AEC0;cursor:pointer;border-radius:8px;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.background='#F4F6F9'" onmouseout="this.style.background='transparent'">&times;</button>
            </div>
            <div id="course-modal-body" style="padding:24px;"></div>
        </div>
    </div>

    <script src="/js/layout.js"></script>
    <script src="/js/app.js"></script>
    <script>
    /* ---- Color + icon mappings for courses -------------------------------- */
    const COURSE_THEMES = ['teal', 'purple', 'pink', 'orange'];
    const COURSE_ICONS  = {
        math:       'fa-calculator',
        science:    'fa-atom',
        language:   'fa-book-open',
        reading:    'fa-book-open-reader',
        geography:  'fa-globe-americas',
        biology:    'fa-dna',
        tech:       'fa-laptop-code',
        default:    'fa-graduation-cap',
    };

    /* Subject illustration images (fallback) */
    const COURSE_IMAGES = {
        math:       '/img/subjects/math.png',
        science:    '/img/subjects/science.png',
        language:   '/img/subjects/language.png',
        reading:    '/img/subjects/reading.png',
        geography:  '/img/subjects/geography.png',
        biology:    '/img/subjects/biology.png',
        tech:       '/img/subjects/tech.png',
        default:    '/img/subjects/default.png',
    };

    /* Per-app images: checked FIRST before subject fallback */
    const APP_IMAGES = {
        egumpp:      '/img/apps/egumpp.png',
        runestone:   '/img/apps/runestone.png',
        newsela:     '/img/apps/newsela.png',
        khan:        '/img/apps/khan.png',
        readtheory:  '/img/apps/readtheory.png',
        commonlit:   '/img/apps/commonlit.png',
        knewton:     '/img/apps/knewton.png',
        lalilo:      '/img/apps/lalilo.png',
        rocket:      '/img/apps/rocketmath.png',
        zearn:       '/img/apps/zearn.png',
        renaissance: '/img/apps/renaissance.png',
        powerpath:   '/img/apps/powerpath.png',
    };

    /* Per-app icon overrides (correct subject for each app) */
    const APP_ICON_MAP = {
        egumpp:      'fa-book-open',       // English grammar/writing
        runestone:   'fa-laptop-code',     // Computer Science
        newsela:     'fa-book-open-reader',// Reading / ELA
        khan:        'fa-calculator',      // Math (primarily)
        readtheory:  'fa-book-open-reader',// Reading comprehension
        commonlit:   'fa-book-open-reader',// Reading / Literature
        knewton:     'fa-calculator',      // Math / Statistics
        lalilo:      'fa-book-open-reader',// Reading / Literacy
        rocket:      'fa-calculator',      // Math fluency
        zearn:       'fa-calculator',      // Math
        renaissance: 'fa-graduation-cap',  // Assessment (Reading+Math)
        powerpath:   'fa-calculator',      // Math
    };

    /** Match an app name string against the known app keys */
    function matchApp(appName) {
        const a = (appName || '').toLowerCase().replace(/[\s_-]/g, '');
        for (const key of Object.keys(APP_IMAGES)) {
            if (a.includes(key)) return key;
        }
        return null;
    }

    function guessIcon(title, appName) {
        // 1. Check app name first
        const app = matchApp(appName) || matchApp(title);
        if (app && APP_ICON_MAP[app]) return APP_ICON_MAP[app];
        // 2. Fall back to title keywords
        const t = (title || '').toLowerCase();
        if (t.includes('math') || t.includes('algebra') || t.includes('calculus')) return COURSE_ICONS.math;
        if (t.includes('chem') || t.includes('physics'))                          return COURSE_ICONS.science;
        if (t.includes('bio'))                                                     return COURSE_ICONS.biology;
        if (t.includes('read') || t.includes('ela') || t.includes('english'))     return COURSE_ICONS.reading;
        if (t.includes('lang') || t.includes('composition') || t.includes('writing')) return COURSE_ICONS.language;
        if (t.includes('geo') || t.includes('history') || t.includes('social'))   return COURSE_ICONS.geography;
        if (t.includes('code') || t.includes('tech'))                              return COURSE_ICONS.tech;
        return COURSE_ICONS.default;
    }

    function guessSubjectImage(title, appName) {
        // 1. Check app name first
        const app = matchApp(appName) || matchApp(title);
        if (app && APP_IMAGES[app]) return APP_IMAGES[app];
        // 2. Fall back to title keywords
        const t = (title || '').toLowerCase();
        if (t.includes('math') || t.includes('algebra') || t.includes('calculus')) return COURSE_IMAGES.math;
        if (t.includes('chem') || t.includes('physics'))                          return COURSE_IMAGES.science;
        if (t.includes('bio'))                                                     return COURSE_IMAGES.biology;
        if (t.includes('read') || t.includes('ela') || t.includes('english'))     return COURSE_IMAGES.reading;
        if (t.includes('lang') || t.includes('composition') || t.includes('writing')) return COURSE_IMAGES.language;
        if (t.includes('geo') || t.includes('history') || t.includes('social'))   return COURSE_IMAGES.geography;
        if (t.includes('code') || t.includes('tech'))                              return COURSE_IMAGES.tech;
        return COURSE_IMAGES.default;
    }

    /* ---- AP Timeback-hosted course detection ------------------------------ */
    function isAPCourse(title) { return /\bAP\b/.test((title || '').trim()); }
    function isTimeback(c) {
        const a = (c.appName || '').toLowerCase().trim();
        if (!a) return true;
        if (NATIVE_APPS.some(n => a.includes(n) || n.includes(a))) return true;
        if (/^pp/i.test(a) || a.includes('powerpath')) return true;
        return false;
    }
    function isLessonCourse(c) { return isAPCourse(c.title) && isTimeback(c); }

    /* ---- State ------------------------------------------------------------ */
    let allCourses = [];       // set once after enrollment fetch
    let xpByCourseIdx = {};    // { 0: 13, 1: 25, ... } — XP per course index (daily/weekly)
    let fullYearXpIdx = {};    // { 0: 500, 1: 1200, ... } — full-year XP for unit estimation
    let masteredIdx = {};      // { 0: 25, ... } — mastered units from analytics (for lesson courses)
    let currentPeriod = 'today';
    let userProfilesMap = {};  // { vendorId: { username, credentialId, appName, domain, launchUrl } }
    let currentUserId = '';    // user's sourcedId for credential decryption

    // Timeback-native app names (XP reported here for courses without their own app)
    const NATIVE_APPS = ['timeback dash', 'alpha timeback', 'alphalearn', 'timeback'];

    // Goals from localStorage (set on goals page)
    const GOALS_KEY = 'alphalearn_goals';
    function loadSavedGoals() {
        try { return JSON.parse(localStorage.getItem(GOALS_KEY)) || {}; }
        catch (e) { return {}; }
    }

    // US school holidays for a school year starting in September of year y
    function getSchoolHolidays(y) {
        const h = [];
        function pad(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        // Labor Day — 1st Monday of September
        const s1 = new Date(y,8,1);
        h.push(pad(new Date(y,8,1+((8-s1.getDay())%7))));
        // Veterans Day
        h.push(`${y}-11-11`);
        // Thanksgiving — 4th Thursday + Friday
        const n1 = new Date(y,10,1);
        const th = new Date(y,10,1+((11-n1.getDay())%7)+21);
        h.push(pad(th));
        const tf = new Date(th); tf.setDate(tf.getDate()+1); h.push(pad(tf));
        // Winter Break — Dec 23-31, Jan 1-3
        for (let d=23;d<=31;d++) h.push(`${y}-12-${String(d).padStart(2,'0')}`);
        for (let d=1;d<=3;d++)   h.push(`${y+1}-01-${String(d).padStart(2,'0')}`);
        // MLK Day — 3rd Monday of January
        const j1 = new Date(y+1,0,1);
        h.push(pad(new Date(y+1,0,1+((8-j1.getDay())%7)+14)));
        // Presidents Day — 3rd Monday of February
        const f1 = new Date(y+1,1,1);
        h.push(pad(new Date(y+1,1,1+((8-f1.getDay())%7)+14)));
        // Spring Break — 5 days from 3rd Monday of March
        const m1 = new Date(y+1,2,1);
        const sb = new Date(y+1,2,1+((8-m1.getDay())%7)+14);
        for (let i=0;i<5;i++) { const dd=new Date(sb); dd.setDate(dd.getDate()+i); h.push(pad(dd)); }
        // Memorial Day — last Monday of May
        const may31 = new Date(y+1,4,31);
        h.push(pad(new Date(y+1,4,31-((may31.getDay()+6)%7))));
        return new Set(h);
    }

    // School-day counter — excludes weekends AND holidays when excludeNonSchool is true
    function countSchoolDays(endDateStr, excludeNonSchool) {
        const today = new Date(); today.setHours(0,0,0,0);
        const end = new Date(endDateStr + 'T00:00:00');
        if (end <= today) return 0;

        // Build holiday set
        const hs = new Set();
        if (excludeNonSchool) {
            for (let y = today.getFullYear() - 1; y <= end.getFullYear(); y++) {
                for (const h of getSchoolHolidays(y)) hs.add(h);
            }
        }

        let count = 0;
        const c = new Date(today); c.setDate(c.getDate() + 1);
        while (c <= end) {
            const dow = c.getDay();
            if (excludeNonSchool) {
                if (dow !== 0 && dow !== 6 && !hs.has(localDateStr(c))) count++;
            } else {
                count++;
            }
            c.setDate(c.getDate() + 1);
        }
        return count;
    }

    /* ---- Render ----------------------------------------------------------- */
    function renderCourses() {
        const courses = allCourses;
        if (!courses.length) {
            document.getElementById('course-grid').innerHTML =
                '<div style="grid-column:1/-1;text-align:center;padding:48px;color:var(--color-text-muted);">No courses found for your account.</div>';
            return;
        }
        const periodLabel = currentPeriod === 'today' ? 'TODAY' : 'THIS WEEK';
        const savedGoals = loadSavedGoals();

        document.getElementById('course-grid').innerHTML = courses.map((c, i) => {
            const color     = COURSE_THEMES[i % COURSE_THEMES.length];
            const icon      = guessIcon(c.title || '', c.appName || '');
            const name      = c.title || 'Untitled Course';
            const goalKey   = c._goalKey || '';
            const savedGoal = savedGoals[goalKey] || null;
            const lessonBased = isLessonCourse(c);

            let progressText, progressLabel, pct;

            if (lessonBased) {
                // Lesson-based AP course: show overall mastered progress toward goal
                const done = masteredIdx[i] || 0;
                const tgt = (savedGoal && savedGoal.target) ? savedGoal.target : (c.totalLessons || 0);

                if (savedGoal && savedGoal.endDate && tgt > 0) {
                    const rem = Math.max(tgt - done, 0);
                    const excl = savedGoal.excludeNonSchoolDays !== false;
                    const days = countSchoolDays(savedGoal.endDate, excl);
                    const pace = days > 0 && rem > 0 ? (rem / days).toFixed(1) : 0;
                    const dayT = excl ? 'school day' : 'day';
                    pct = tgt > 0 ? Math.min((done / tgt) * 100, 100) : 0;
                    progressText = `${done} / ${tgt} units`;
                    progressLabel = rem > 0 && days > 0 ? `~${pace}/${dayT}` : (rem <= 0 ? 'DONE' : 'OVERDUE');
                } else {
                    pct = tgt > 0 ? Math.min((done / tgt) * 100, 100) : 0;
                    progressText = `${done}${tgt > 0 ? ' / ' + tgt : ''} units`;
                    progressLabel = 'SET GOAL';
                }
            } else {
                // Non-AP: show daily/weekly XP
                const dailyGoal = c.dailyXpGoal || 0;
                const xpEarned = Math.round(xpByCourseIdx[i] || 0);
                const goal = currentPeriod === 'today' ? dailyGoal : dailyGoal * 5;
                pct = goal > 0 ? Math.min((xpEarned / goal) * 100, 100) : 0;
                progressText = `${xpEarned} / ${goal} XP`;
                progressLabel = periodLabel;
            }

            // Check if external course with credentials
            const vKey = c._vendorKey || '';
            const creds = vKey ? (credentialsMap[vKey] || {}) : {};
            const profile = vKey ? (userProfilesMap[vKey] || {}) : {};
            const isExternal = !!vKey;
            const launchUrl = profile.launchUrl || '';
            const credUsername = creds.username || '';
            const credPassword = creds.password || '';
            const platformName = profile.appName || c.appName || '';

            // Build info icon tooltip (for external courses with any credential/profile data)
            let infoIconHTML = '';
            if (isExternal && (credUsername || credPassword || launchUrl || platformName)) {
                infoIconHTML = `<div class="course-info-icon" onclick="event.stopPropagation();" title="Course credentials">
                    <i class="fa-solid fa-circle-info"></i>
                    <div class="course-info-tooltip">
                        ${platformName ? `<div><span class="tip-label">Platform</span><br><strong>${esc(platformName)}</strong></div>` : ''}
                        ${credUsername ? `<div style="margin-top:6px;"><span class="tip-label">Username</span><br><code>${esc(credUsername)}</code></div>` : ''}
                        <div style="margin-top:6px;"><span class="tip-label">Password</span><br>${credPassword ? `<code>${esc(credPassword)}</code>` : `<span style="color:#A0AEC0;font-style:italic;">N/A</span>`}</div>
                        ${launchUrl ? `<div style="margin-top:8px;"><a href="${esc(launchUrl)}" target="_blank">${esc(launchUrl)}</a></div>` : ''}
                    </div>
                </div>`;
            }

            const subjectImg = guessSubjectImage(c.title || '', c.appName || '');

            return `
                <div class="course-card" data-course-index="${i}" ${isExternal && launchUrl ? `data-launch-url="${esc(launchUrl)}"` : ''} style="cursor:pointer;position:relative;">
                    ${infoIconHTML}
                    <div class="course-card-image" style="background:#EBF0F9;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                        <img src="${subjectImg}" alt="${esc(name)}" style="width:100%;height:100%;object-fit:cover;">
                    </div>
                    <div class="course-card-body">
                        <div class="course-card-header">
                            <span class="status-dot blue"></span>
                            <span class="course-card-name">${name}</span>
                        </div>
                        <div class="course-card-xp">
                            <span class="xp-progress">${progressText}</span>
                            <span class="xp-period">${progressLabel}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pct}%"></div>
                        </div>
                    </div>
                </div>`;
        }).join('');

        // Attach click handlers directly to each card element
        document.querySelectorAll('#course-grid .course-card[data-course-index]').forEach(function(card) {
            card.addEventListener('click', function() {
                var idx = parseInt(this.getAttribute('data-course-index'), 10);
                if (!isNaN(idx)) openCourseModal(idx);
            });
        });
    }

    function showError(msg) {
        document.getElementById('course-grid').innerHTML =
            `<div style="grid-column:1/-1;text-align:center;padding:48px;color:#E53E3E;">
                <i class="fa-solid fa-circle-exclamation"></i> ${msg}
            </div>`;
    }

    document.addEventListener('DOMContentLoaded', async function () {
        const name  = localStorage.getItem('alphalearn_name') || 'Student';
        const email = localStorage.getItem('alphalearn_email') || '';
        document.getElementById('user-name').textContent = name;

        if (!email) {
            showError('No email found. Please <a href="/login" style="color:var(--color-primary)">sign in</a> first.');
            return;
        }

        try {
            /* 1. Fast user lookup by email (single filtered request) */
            const lookupResp = await fetch(`/api/user-lookup?email=${encodeURIComponent(email)}`);
            const lookupData = await lookupResp.json();

            if (!lookupData.user || !lookupData.user.sourcedId) {
                showError('Could not find your account. Please check your email and try again.');
                return;
            }

            const userId = lookupData.user.sourcedId;

            // Cache the sourcedId so future page loads can skip the lookup
            localStorage.setItem('alphalearn_userId', userId);

            // Build credentials map from userIds (primary source: username + password)
            const userIds = lookupData.user.userIds || [];
            for (const uid of userIds) {
                const type = uid.type || '';
                const identifier = uid.identifier || '';
                if (!type || !identifier) continue;
                if (type.endsWith('_password')) {
                    const platform = type.replace('_password', '');
                    if (!credentialsMap[platform]) credentialsMap[platform] = {};
                    credentialsMap[platform].password = identifier;
                } else {
                    if (!credentialsMap[type]) credentialsMap[type] = {};
                    credentialsMap[type].username = identifier;
                }
            }

            // Build userProfiles map (for app name + launch URL)
            const profiles = lookupData.user.userProfiles || [];
            for (const p of profiles) {
                const vendorId = p.vendorId || p.applicationId || '';
                if (!vendorId) continue;
                const appDomains = (p.app && p.app.domain) || [];
                userProfilesMap[vendorId] = {
                    appName: (p.app && p.app.name) || p.description || '',
                    domain: appDomains[0] || '',
                    launchUrl: appDomains[0] ? 'https://' + appDomains[0] : '',
                };
            }

            /* 2. Fetch enrolled courses via EduBridge */
            const enrollResp = await fetch(`/api/enrollments?userId=${userId}`);
            const enrollData = await enrollResp.json();

            const raw = enrollData.data
                || enrollData.enrollments
                || enrollData.courses
                || (Array.isArray(enrollData) ? enrollData : []);

            /* 3. Filter to ONLY currently-enrolled, real courses
             *
             * Per EduBridge docs the response is already "active enrollments",
             * so we only need to:
             *   - drop expired (endDate in the past)
             *   - drop obvious non-course rows (Manual XP, Hole-Filling, no-subject admin rows)
             *   - drop PowerPath assessment courses (title contains "- PP")
             *   - separate mastery track tests into their own section
             */
            const now     = new Date();
            const courses = [];
            const tests   = [];

            for (const e of raw) {
                const course   = e.course || {};
                const cMeta    = course.metadata || {};
                const goals    = (e.metadata && e.metadata.goals) || {};
                const metrics  = (e.metadata && e.metadata.metrics) || {};
                const title    = (course.title || '').trim();
                const subjects = course.subjects || [];
                const endDate  = e.endDate ? new Date(e.endDate) : null;

                // ── Skip expired enrollments ──
                if (endDate && endDate < now) continue;

                // ── Skip junk rows ──
                if (!title)                         continue;
                if (title.startsWith('Manual XP'))  continue;
                if (title.includes('Hole-Filling')) continue;
                if (!subjects.length)               continue;  // school/org rows (e.g. "Alpha High School 2025-26")

                // Resolve app name: course.primaryApp.name (per docs) or metadata fallback
                const pApp = course.primaryApp || {};
                const appName = (typeof pApp === 'object' ? pApp.name : '')
                    || cMeta.primaryApp || cMeta.app || '';

                // Check both enrollment metadata AND course metadata for metrics
                const cMetrics = (cMeta.metrics) || {};
                const totalLessons = metrics.totalLessons || cMetrics.totalLessons || cMeta.totalLessons || 0;
                const totalXp = metrics.totalXp || cMetrics.totalXp || cMeta.totalXp || 0;

                // Vendor key: used to match course → userProfiles for credentials
                const vendorKey = cMeta.primaryApp || cMeta.app || cMeta.vendor
                    || (typeof pApp === 'object' && pApp.id ? pApp.id : '') || '';

                const item = {
                    title,
                    subject:      subjects[0] || '',
                    appName,
                    totalXp,
                    totalLessons,
                    dailyXpGoal:  goals.dailyXp || 0,
                    _goalKey:     e.id || course.id || title,
                    _enrollmentId: e.id || '',
                    _vendorKey:   vendorKey,
                    _raw: e,
                    _course: course,
                    _metadata: { ...course.metadata, ...e.metadata },
                };

                // ── Mastery track tests only (not PP, not regular courses) ──
                const isMastery = metrics.courseType === 'mastery_test'
                    || metrics.courseType === 'mastery-test'
                    || metrics.courseType === 'masteryTest'
                    || (title.toLowerCase().includes('mastery') && title.toLowerCase().includes('test'));

                if (isMastery) {
                    tests.push(item);
                    continue;
                }

                courses.push(item);
            }

            /* 4. Render mastery track tests in top section */
            if (tests.length) {
                document.getElementById('tests-section').style.display = '';
                document.getElementById('tests-grid').innerHTML = tests.map(t => `
                    <div class="test-card">
                        <div class="test-card-image test-image-reading" style="background:linear-gradient(135deg,#E8F5E9 0%,#C8E6C9 50%,#A5D6A7 100%);">
                            <div class="test-card-illustration" style="color:#2E7D32;">
                                <i class="fa-solid fa-clipboard-check"></i>
                            </div>
                        </div>
                        <div class="test-card-info">
                            <div class="test-card-status">
                                <span class="status-dot blue"></span>
                                <span class="test-card-name">${t.title}</span>
                            </div>
                            <div class="test-card-meta">
                                <span class="test-badge">${t.subject}</span>
                                <span class="test-badge">${t.xpTotal} XP</span>
                            </div>
                        </div>
                    </div>`).join('');
            }

            /* 5. Store courses globally, fetch full-year XP for AP unit tracking, then daily XP */
            allCourses = courses;

            // Fetch full-year XP (for lesson course progress estimation)
            const hasLessonCourses = courses.some(c => isLessonCourse(c));
            if (hasLessonCourses) {
                await loadFullYearXp(email);
            }

            await loadXp(email, 'today');

        } catch (err) {
            showError('Unable to reach the Timeback API. Please try again later.');
            console.error('[AlphaLearn]', err);
        }
    });

    /* ---- Fetch XP from EduBridge analytics -------------------------------- */
    function localDateStr(d) {
        // Use LOCAL date (not UTC) so "today" matches the user's timezone
        const yyyy = d.getFullYear();
        const mm   = String(d.getMonth() + 1).padStart(2, '0');
        const dd   = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    async function loadXp(email, period) {
        currentPeriod = period;
        const now = new Date();
        let startDate, endDate;

        if (period === 'today') {
            const d = localDateStr(now);
            startDate = d + 'T00:00:00Z';
            endDate   = d + 'T23:59:59Z';
        } else {
            const dayOfWeek = now.getDay();
            const monday = new Date(now);
            monday.setDate(now.getDate() - ((dayOfWeek + 6) % 7));
            startDate = localDateStr(monday) + 'T00:00:00Z';
            endDate   = localDateStr(now) + 'T23:59:59Z';
        }

        try {
            const resp = await fetch(
                `/api/analytics?email=${encodeURIComponent(email)}&startDate=${startDate}&endDate=${endDate}`
            );
            const data = await resp.json();
            const factsByApp = data.factsByApp || {};
            const facts      = data.facts || {};

            // Build per-app lookup: { subject: { appNameLower: totalXp } }
            const xpMap = {};
            for (const dayData of Object.values(factsByApp)) {
                for (const [subject, apps] of Object.entries(dayData)) {
                    if (!xpMap[subject]) xpMap[subject] = {};
                    for (const [appName, info] of Object.entries(apps)) {
                        const xp = (info.activityMetrics || {}).xpEarned || 0;
                        const key = appName.toLowerCase();
                        xpMap[subject][key] = (xpMap[subject][key] || 0) + xp;
                    }
                }
            }

            // Also build a subject-level fallback from facts
            const xpBySubject = {};
            for (const dayFacts of Object.values(facts)) {
                for (const [subject, info] of Object.entries(dayFacts)) {
                    const xp = (info.activityMetrics || {}).xpEarned || 0;
                    xpBySubject[subject] = (xpBySubject[subject] || 0) + xp;
                }
            }

            // Match XP to each course
            xpByCourseIdx = {};
            for (let i = 0; i < allCourses.length; i++) {
                const c = allCourses[i];
                const subjApps = xpMap[c.subject] || {};
                const appName = (c.appName || '').toLowerCase();

                if (appName && Object.keys(subjApps).length) {
                    // Course has a known app — find matching factsByApp key
                    let matched = subjApps[appName] || 0;
                    if (!matched) {
                        const normalized = appName.replace(/_/g, ' ');
                        for (const [key, xp] of Object.entries(subjApps)) {
                            if (key === normalized || key.includes(normalized) || normalized.includes(key)) {
                                matched = xp;
                                break;
                            }
                        }
                    }
                    xpByCourseIdx[i] = matched;
                } else if (!appName && Object.keys(subjApps).length) {
                    // No app — Timeback-native course: sum XP from native apps
                    let nativeXp = 0;
                    for (const [key, xp] of Object.entries(subjApps)) {
                        if (NATIVE_APPS.some(n => key.includes(n) || n.includes(key))) {
                            nativeXp += xp;
                        }
                    }
                    xpByCourseIdx[i] = nativeXp;
                } else {
                    // Fallback: use subject-level XP if factsByApp had nothing
                    xpByCourseIdx[i] = xpBySubject[c.subject] || 0;
                }
            }
        } catch (err) {
            console.warn('[AlphaLearn] Analytics unavailable:', err.message);
            xpByCourseIdx = {};
        }

        renderCourses();
    }

    /* ---- Full-year XP + mastered units for AP courses --------------------- */
    async function loadFullYearXp(email) {
        fullYearXpIdx = {};
        masteredIdx = {};

        // 1. Try to use the mastered cache from the goals page (per-enrollment data)
        let cacheUsed = false;
        try {
            const raw = localStorage.getItem('alphalearn_mastered_cache');
            if (raw) {
                const cached = JSON.parse(raw);
                const age = cached.updatedAt ? (Date.now() - new Date(cached.updatedAt).getTime()) : Infinity;
                // Use cache if less than 1 hour old
                if (age < 3600000 && cached.data) {
                    for (let i = 0; i < allCourses.length; i++) {
                        const c = allCourses[i];
                        if (!isLessonCourse(c)) continue;
                        const entry = cached.data[c._enrollmentId] || null;
                        if (entry) {
                            masteredIdx[i] = entry.mastered || 0;
                            fullYearXpIdx[i] = entry.xp || 0;
                            cacheUsed = true;
                        }
                    }
                }
            }
        } catch (e) { /* ignore cache errors */ }

        // 2. If cache covered all lesson courses, we're done
        const lessonCourseCount = allCourses.filter((c, i) => isLessonCourse(c)).length;
        const cachedCount = Object.keys(masteredIdx).length;
        if (cacheUsed && cachedCount >= lessonCourseCount) return;

        // 3. Fallback: per-enrollment analytics calls for courses not in cache
        try {
            const now = new Date();
            const startOfYear = new Date(now.getFullYear(), 7, 1);
            if (startOfYear > now) startOfYear.setFullYear(startOfYear.getFullYear() - 1);
            const startDate = localDateStr(startOfYear) + 'T00:00:00Z';
            const endDate   = localDateStr(now) + 'T23:59:59Z';

            const promises = [];
            for (let i = 0; i < allCourses.length; i++) {
                const c = allCourses[i];
                if (!isLessonCourse(c)) continue;
                if (masteredIdx[i] !== undefined) continue; // already from cache
                if (!c._enrollmentId) continue;

                promises.push(
                    fetch(`/api/enrollment-analytics?enrollmentId=${encodeURIComponent(c._enrollmentId)}&startDate=${startDate}&endDate=${endDate}`)
                        .then(r => r.json())
                        .then(data => ({ i, data }))
                        .catch(() => null)
                );
            }

            if (promises.length > 0) {
                const results = await Promise.all(promises);
                for (const r of results) {
                    if (!r || !r.data) continue;
                    const { i, data } = r;
                    const facts      = data.facts || {};
                    const factsByApp = data.factsByApp || {};

                    let totalXp = 0, totalMastered = 0;
                    for (const dayFacts of Object.values(facts)) {
                        for (const info of Object.values(dayFacts)) {
                            const am = info.activityMetrics || {};
                            totalXp      += am.xpEarned || 0;
                            totalMastered += am.masteredUnits || am.lessonsCompleted || am.completedLessons || 0;
                        }
                    }
                    let appXp = 0, appMastered = 0;
                    for (const dayData of Object.values(factsByApp)) {
                        for (const apps of Object.values(dayData)) {
                            for (const info of Object.values(apps)) {
                                const am = info.activityMetrics || {};
                                appXp      += am.xpEarned || 0;
                                appMastered += am.masteredUnits || am.lessonsCompleted || am.completedLessons || 0;
                            }
                        }
                    }
                    fullYearXpIdx[i] = Math.max(totalXp, appXp);
                    masteredIdx[i]   = Math.max(totalMastered, appMastered);
                }
            }
        } catch (err) {
            console.warn('[AlphaLearn] Full-year analytics unavailable:', err.message);
        }
    }

    /* ---- HTML escape helper ---------------------------------------------- */
    function esc(str) {
        if (str === null || str === undefined) return '';
        if (typeof str !== 'string') str = String(str);
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    /** Coerce value to string — objects/arrays become '' to avoid [object Object] */
    function safeStr(val) {
        if (val === null || val === undefined) return '';
        if (typeof val === 'object') return '';
        return String(val);
    }

    /* ---- Course detail modal (internal courses only) ---------------------- */
    function openCourseModal(index) {
        const modal = document.getElementById('course-modal');
        if (!modal) return;
        try {
            const c = allCourses[index];
            if (!c) return;

            const body = document.getElementById('course-modal-body');
            document.getElementById('course-modal-title').textContent = c.title || 'Course Details';

            const titleEsc = esc(c.title || 'Untitled Course');
            const subjectEsc = esc(c.subject || '');
            const xpEarned = Math.round(xpByCourseIdx[index] || 0);
            const goal = currentPeriod === 'today' ? (c.dailyXpGoal || 0) : (c.dailyXpGoal || 0) * 5;

            // Build metadata display
            let metaDetailsHTML = '';
            const meta = c._metadata || {};
            const displayMeta = {};
            try {
                for (const [k, v] of Object.entries(meta)) {
                    if (v === null || v === undefined || v === '') continue;
                    if (typeof v !== 'object') {
                        displayMeta[k] = String(v);
                    } else if (!Array.isArray(v)) {
                        for (const [k2, v2] of Object.entries(v)) {
                            if (v2 === null || v2 === undefined || v2 === '' || typeof v2 === 'object') continue;
                            displayMeta[`${k}.${k2}`] = String(v2);
                        }
                    } else {
                        displayMeta[k] = v.filter(x => x != null && typeof x !== 'object').join(', ');
                    }
                }
            } catch (e) { /* skip */ }

            if (Object.keys(displayMeta).length > 0) {
                metaDetailsHTML = `
                    <details style="margin-bottom:16px;">
                        <summary style="font-size:0.8rem;font-weight:600;color:#A0AEC0;cursor:pointer;margin-bottom:8px;">
                            <i class="fa-solid fa-info-circle" style="margin-right:4px;"></i>All Course Details
                        </summary>
                        <div style="background:#F4F6F9;border-radius:8px;padding:12px;font-size:0.82rem;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                            ${Object.entries(displayMeta).map(([k, v]) => `
                                <div><span style="color:#718096;font-weight:600;">${esc(k)}</span></div>
                                <div style="color:#2D3748;word-break:break-all;">${esc(v)}</div>
                            `).join('')}
                        </div>
                    </details>`;
            }

            body.innerHTML = `
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
                    <div style="width:48px;height:48px;border-radius:12px;background:var(--color-primary-light);display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:var(--color-primary-dark);">
                        <i class="fa-solid ${guessIcon(c.title, c.appName)}"></i>
                    </div>
                    <div>
                        <div style="font-weight:600;font-size:1rem;color:#2D3748;">${titleEsc}</div>
                        <div style="font-size:0.82rem;color:#718096;">${subjectEsc}${c.totalLessons ? ' · ' + c.totalLessons + ' lessons' : ''}</div>
                    </div>
                </div>

                <div style="display:flex;gap:12px;margin-bottom:20px;">
                    <div style="flex:1;background:#F4F6F9;border-radius:10px;padding:14px;text-align:center;">
                        <div style="font-size:1.3rem;font-weight:700;color:#45B5AA;">${xpEarned}</div>
                        <div style="font-size:0.75rem;font-weight:600;color:#718096;text-transform:uppercase;letter-spacing:0.5px;">XP Earned</div>
                    </div>
                    <div style="flex:1;background:#F4F6F9;border-radius:10px;padding:14px;text-align:center;">
                        <div style="font-size:1.3rem;font-weight:700;color:#2D3748;">${goal}</div>
                        <div style="font-size:0.75rem;font-weight:600;color:#718096;text-transform:uppercase;letter-spacing:0.5px;">XP Goal</div>
                    </div>
                    <div style="flex:1;background:#F4F6F9;border-radius:10px;padding:14px;text-align:center;">
                        <div style="font-size:1.3rem;font-weight:700;color:#2D3748;">${c.totalXp || 0}</div>
                        <div style="font-size:0.75rem;font-weight:600;color:#718096;text-transform:uppercase;letter-spacing:0.5px;">Total XP</div>
                    </div>
                </div>

                <div style="background:#F4F6F9;border-radius:10px;padding:16px;text-align:center;color:#718096;font-size:0.88rem;margin-bottom:16px;">
                    <i class="fa-solid fa-circle-check" style="color:#45B5AA;margin-right:6px;"></i>
                    This is an AlphaLearn internal course. Progress is tracked automatically.
                </div>

                ${metaDetailsHTML}

                <button onclick="closeCourseModal()" style="width:100%;padding:12px 20px;background:#F4F6F9;color:#718096;border:none;border-radius:10px;font-size:0.95rem;font-weight:500;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#E8ECF1'" onmouseout="this.style.background='#F4F6F9'">
                    Close
                </button>
            `;

            modal.classList.add('open');
        } catch (err) {
            console.error('[AlphaLearn] Error opening course modal:', err);
            const body = document.getElementById('course-modal-body');
            if (body) {
                body.innerHTML = `
                    <div style="text-align:center;padding:24px;color:#718096;">
                        <i class="fa-solid fa-circle-exclamation" style="font-size:2rem;color:#E53E3E;margin-bottom:12px;display:block;"></i>
                        <p style="font-size:0.95rem;color:#2D3748;font-weight:600;margin-bottom:8px;">Unable to load course details</p>
                        <p style="font-size:0.82rem;">${esc(err.message || 'An unexpected error occurred')}</p>
                        <button onclick="closeCourseModal()" style="margin-top:16px;padding:10px 24px;background:#F4F6F9;color:#718096;border:none;border-radius:8px;font-size:0.9rem;font-weight:500;cursor:pointer;">Close</button>
                    </div>`;
            }
            modal.classList.add('open');
        }
    }

    function closeCourseModal() {
        var m = document.getElementById('course-modal');
        if (m) m.classList.remove('open');
    }

    // Course card click: external → launch URL directly, internal → open modal
    document.addEventListener('click', function(e) {
        // Don't trigger card click if user clicked the info icon
        if (e.target.closest('.course-info-icon')) return;

        var card = e.target.closest('.course-card[data-course-index]');
        if (card) {
            e.preventDefault();
            var launchUrl = card.getAttribute('data-launch-url');
            if (launchUrl) {
                // External course: open in new tab directly
                window.open(launchUrl, '_blank', 'noopener');
            } else {
                // Internal course: open detail modal
                var idx = parseInt(card.getAttribute('data-course-index'), 10);
                if (!isNaN(idx)) openCourseModal(idx);
            }
        }
    });

    // Close modal on backdrop click
    var modalEl = document.getElementById('course-modal');
    if (modalEl) {
        modalEl.addEventListener('click', function(e) {
            if (e.target === this) closeCourseModal();
        });
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeCourseModal();
    });

    /* ---- Today / This Week toggle ---------------------------------------- */
    document.querySelectorAll('.toggle-btn[data-period]').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.toggle-btn[data-period]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const email = localStorage.getItem('alphalearn_email') || '';
            if (email) loadXp(email, btn.dataset.period);
        });
    });
    </script>
</body>
</html>
