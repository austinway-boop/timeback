<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Quiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .quiz-container { max-width: 760px; margin: 0 auto; padding: 20px; }
        .quiz-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 4px; }
        .quiz-meta { font-size: 0.85rem; color: var(--color-text-secondary); margin-bottom: 20px; }
        .quiz-loading { text-align: center; padding: 60px 20px; color: var(--color-text-muted); }
        .quiz-loading .loading-spinner { margin: 0 auto 12px; }
        .question-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius); padding: 24px; margin-bottom: 16px; }
        .question-number { font-size: 0.78rem; font-weight: 700; color: var(--color-primary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .question-prompt { font-size: 1rem; font-weight: 500; line-height: 1.6; margin-bottom: 16px; }
        .question-prompt img { max-width: 100%; border-radius: 8px; margin: 8px 0; }
        .choice-list { display: flex; flex-direction: column; gap: 8px; }
        .choice-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px 16px; border: 2px solid var(--color-border); border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s; }
        .choice-item:hover { border-color: var(--color-primary); background: var(--color-primary-light); }
        .choice-item.selected { border-color: var(--color-primary); background: var(--color-primary-light); }
        .choice-letter { width: 28px; height: 28px; border-radius: 50%; background: var(--color-bg); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.82rem; flex-shrink: 0; }
        .choice-item.selected .choice-letter { background: var(--color-primary); color: #fff; }
        .choice-text { flex: 1; line-height: 1.5; }
        .choice-text img { max-width: 100%; border-radius: 4px; margin-top: 4px; }
        .stimulus-content { background: var(--color-bg); border-radius: var(--radius-sm); padding: 20px; margin-bottom: 20px; line-height: 1.7; font-size: 0.95rem; }
        .stimulus-content p { margin: 0 0 12px; }
        .quiz-actions { display: flex; gap: 12px; margin-top: 24px; }
        .quiz-btn { padding: 12px 24px; border: none; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.92rem; cursor: pointer; }
        .quiz-btn-primary { background: var(--color-primary); color: #fff; }
        .quiz-btn-primary:hover { background: var(--color-primary-dark); }
        .quiz-btn-secondary { background: var(--color-bg); color: var(--color-text-secondary); }
        .back-btn { display: inline-flex; align-items: center; gap: 6px; color: var(--color-text-secondary); font-size: 0.88rem; font-weight: 500; text-decoration: none; margin-bottom: 16px; }
        .back-btn:hover { color: var(--color-primary); }
        .error-box { background: #FFF5F5; border: 1px solid #FED7D7; border-radius: var(--radius-sm); padding: 16px; color: #C53030; font-size: 0.88rem; margin-top: 12px; }
        .raw-content { background: var(--color-bg); padding: 20px; border-radius: var(--radius-sm); line-height: 1.7; font-size: 0.95rem; }
        .raw-content img { max-width: 100%; }
    </style>
</head>
<body data-view="student" data-active="home">
    <div class="layout">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="main-content">
            <div class="quiz-container">
                <a href="javascript:history.back()" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Back to course</a>
                <div id="quiz-area">
                    <div class="quiz-loading">
                        <div class="loading-spinner"></div>
                        Loading content...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/layout.js"></script>
    <script>
    function esc(s) { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    document.addEventListener('DOMContentLoaded', async function() {
        var params = new URLSearchParams(window.location.search);
        var itemId = params.get('id') || '';
        var itemType = params.get('type') || 'item';
        var itemUrl = params.get('url') || '';
        var title = params.get('title') || 'Content';
        var area = document.getElementById('quiz-area');

        if (!itemId && !itemUrl) {
            area.innerHTML = '<div class="quiz-loading"><p>No content ID provided.</p></div>';
            return;
        }

        var data = null;
        var errors = [];

        // Method 1: Try our backend proxy (uses Cognito client credentials)
        try {
            var apiUrl = '/api/qti-item?';
            if (itemUrl) apiUrl += 'url=' + encodeURIComponent(itemUrl);
            else apiUrl += 'id=' + encodeURIComponent(itemId) + '&type=' + encodeURIComponent(itemType);

            var resp = await fetch(apiUrl);
            var result = await resp.json();
            if (result.success && result.data) {
                data = result.data;
            } else {
                errors.push('Backend: ' + (result.error || resp.status));
            }
        } catch(e) {
            errors.push('Backend: ' + e.message);
        }

        // Method 2: If backend failed, try calling Timeback server function directly
        // (works if user is logged into alpha.timeback.com in the same browser)
        if (!data) {
            try {
                var tbPayload = JSON.stringify({ data: { itemId: itemId, itemType: itemType } });
                var tbResp = await fetch(
                    'https://alpha.timeback.com/_serverFn/src_features_qti_actions_getQtiItem_ts--getQtiItem_createServerFn_handler?payload=' + encodeURIComponent(tbPayload) + '&createServerFn',
                    { credentials: 'include', headers: { 'Accept': 'application/json' } }
                );
                if (tbResp.ok) {
                    data = await tbResp.json();
                } else {
                    errors.push('Timeback serverFn: ' + tbResp.status);
                }
            } catch(e) {
                errors.push('Timeback serverFn: ' + e.message);
            }
        }

        // Method 3: Try the QTI URL directly from the browser (CORS may block)
        if (!data && itemUrl) {
            try {
                var directResp = await fetch(itemUrl, { credentials: 'include' });
                if (directResp.ok) {
                    data = await directResp.json();
                } else {
                    errors.push('Direct QTI: ' + directResp.status);
                }
            } catch(e) {
                errors.push('Direct QTI: CORS blocked');
            }
        }

        // Render content
        if (!data) {
            area.innerHTML = '<h1 class="quiz-title">' + esc(title) + '</h1>' +
                '<div class="error-box"><strong>Could not load content</strong><br>' +
                '<div style="margin-top:8px;font-size:0.82rem;">' + errors.map(esc).join('<br>') + '</div>' +
                '<div style="margin-top:12px;">This content requires authentication with the Timeback platform. ' +
                '<a href="https://alpha.timeback.com/app" target="_blank" style="color:var(--color-primary);font-weight:600;">Open on Timeback</a></div>' +
                '</div>';
            return;
        }

        // ── Render QTI JSON to HTML ──
        function renderNode(node) {
            if (!node) return '';
            if (typeof node === 'string') return '<p>' + node + '</p>';
            if (Array.isArray(node)) return node.map(renderNode).join('');

            var html = '';
            for (var key in node) {
                if (key.startsWith('_')) continue; // skip _attributes, _text
                var val = node[key];

                // Handle text with bold
                if (key === '_' || key === '#text' || key === '_text') {
                    html += val;
                    continue;
                }
                if (key === 'strong' || key === 'b') {
                    html += '<strong>' + (typeof val === 'string' ? val : renderNode(val)) + '</strong>';
                    continue;
                }
                if (key === 'em' || key === 'i') {
                    html += '<em>' + (typeof val === 'string' ? val : renderNode(val)) + '</em>';
                    continue;
                }

                // Headings
                if (key === 'h1' || key === 'h2' || key === 'h3' || key === 'h4') {
                    var items = Array.isArray(val) ? val : [val];
                    for (var i = 0; i < items.length; i++) {
                        html += '<' + key + ' style="margin:20px 0 10px;color:var(--color-text);">' + (typeof items[i] === 'string' ? items[i] : renderNode(items[i])) + '</' + key + '>';
                    }
                    continue;
                }

                // Paragraphs
                if (key === 'p') {
                    var paras = Array.isArray(val) ? val : [val];
                    for (var i = 0; i < paras.length; i++) {
                        var p = paras[i];
                        if (typeof p === 'string') {
                            html += '<p style="margin:0 0 12px;line-height:1.7;">' + p + '</p>';
                        } else if (typeof p === 'object') {
                            var pText = p['_'] || p['_text'] || p['#text'] || '';
                            var bold = p['strong'] || p['b'] || '';
                            if (bold) pText = pText.replace(bold, '<strong>' + bold + '</strong>');
                            if (!pText) pText = renderNode(p);
                            html += '<p style="margin:0 0 12px;line-height:1.7;">' + pText + '</p>';
                        }
                    }
                    continue;
                }

                // Figures/images
                if (key === 'figure') {
                    var figs = Array.isArray(val) ? val : [val];
                    for (var i = 0; i < figs.length; i++) {
                        var fig = figs[i];
                        var img = fig.img || {};
                        var imgAttrs = img['_attributes'] || img;
                        var src = imgAttrs.src || imgAttrs.href || '';
                        var alt = imgAttrs.alt || '';
                        var caption = fig.figcaption || '';
                        if (src) {
                            html += '<figure style="margin:16px 0;text-align:center;">' +
                                '<img src="' + esc(src) + '" alt="' + esc(alt) + '" style="max-width:100%;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">' +
                                (caption ? '<figcaption style="font-size:0.82rem;color:var(--color-text-muted);margin-top:8px;font-weight:600;">' + esc(caption) + '</figcaption>' : '') +
                                '</figure>';
                        }
                    }
                    continue;
                }

                // Images directly
                if (key === 'img') {
                    var imgA = val['_attributes'] || val;
                    html += '<img src="' + esc(imgA.src || '') + '" alt="' + esc(imgA.alt || '') + '" style="max-width:100%;border-radius:8px;margin:8px 0;">';
                    continue;
                }

                // Tables
                if (key === 'table') {
                    var tables = Array.isArray(val) ? val : [val];
                    for (var ti = 0; ti < tables.length; ti++) {
                        var tbl = tables[ti];
                        html += '<div style="overflow-x:auto;margin:16px 0;"><table style="width:100%;border-collapse:collapse;font-size:0.88rem;">';
                        // thead
                        var thead = tbl.thead;
                        if (thead) {
                            html += '<thead>';
                            var hRows = thead.tr ? (Array.isArray(thead.tr) ? thead.tr : [thead.tr]) : [];
                            for (var r = 0; r < hRows.length; r++) {
                                html += '<tr>';
                                var ths = hRows[r].th || [];
                                if (!Array.isArray(ths)) ths = [ths];
                                for (var c = 0; c < ths.length; c++) {
                                    html += '<th style="padding:8px 12px;border:1px solid var(--color-border);background:var(--color-bg);font-weight:600;text-align:left;">' + (typeof ths[c] === 'string' ? ths[c] : renderNode(ths[c])) + '</th>';
                                }
                                html += '</tr>';
                            }
                            html += '</thead>';
                        }
                        // tbody
                        var tbody = tbl.tbody;
                        if (tbody) {
                            html += '<tbody>';
                            var bRows = tbody.tr ? (Array.isArray(tbody.tr) ? tbody.tr : [tbody.tr]) : [];
                            for (var r = 0; r < bRows.length; r++) {
                                html += '<tr>';
                                var tds = bRows[r].td || [];
                                if (!Array.isArray(tds)) tds = [tds];
                                for (var c = 0; c < tds.length; c++) {
                                    var cell = tds[c];
                                    var cellText = '';
                                    if (typeof cell === 'string') cellText = cell;
                                    else if (Array.isArray(cell)) cellText = cell.join('<br>');
                                    else cellText = renderNode(cell);
                                    html += '<td style="padding:8px 12px;border:1px solid var(--color-border);vertical-align:top;">' + cellText + '</td>';
                                }
                                html += '</tr>';
                            }
                            html += '</tbody>';
                        }
                        html += '</table></div>';
                    }
                    continue;
                }

                // Lists
                if (key === 'ul' || key === 'ol') {
                    var lists = Array.isArray(val) ? val : [val];
                    for (var li = 0; li < lists.length; li++) {
                        var items = lists[li].li || [];
                        if (!Array.isArray(items)) items = [items];
                        html += '<' + key + ' style="margin:8px 0 12px 20px;">';
                        for (var j = 0; j < items.length; j++) {
                            html += '<li style="margin-bottom:4px;">' + (typeof items[j] === 'string' ? items[j] : renderNode(items[j])) + '</li>';
                        }
                        html += '</' + key + '>';
                    }
                    continue;
                }

                // Nested div
                if (key === 'div') {
                    var divs = Array.isArray(val) ? val : [val];
                    for (var i = 0; i < divs.length; i++) {
                        html += renderNode(divs[i]);
                    }
                    continue;
                }

                // Anything else with object value - recurse
                if (typeof val === 'object' && val !== null) {
                    html += renderNode(val);
                }
            }
            return html;
        }

        // Detect content type and extract the right data
        var stimulus = data['qti-assessment-stimulus'] || null;
        var assessmentItem = data['qti-assessment-item'] || null;
        var assessmentTest = data['qti-assessment-test'] || null;

        var html = '<h1 class="quiz-title">' + esc(data.title || (stimulus && stimulus['_attributes'] && stimulus['_attributes'].title) || title) + '</h1>';

        // ── Stimulus (reading passage) ──
        if (stimulus) {
            var stimBody = stimulus['qti-stimulus-body'] || {};
            html += '<div class="stimulus-content">' + renderNode(stimBody) + '</div>';
        }

        // ── Check for body/content from other formats ──
        var body = data.body || data.content || data.itemBody || data.passage || '';
        if (!stimulus && body) {
            if (typeof body === 'object') html += '<div class="stimulus-content">' + renderNode(body) + '</div>';
            else html += '<div class="stimulus-content">' + body + '</div>';
        }

        // Parse questions -- handle QTI 3.0 format
        var questions = data.questions || data.items || [];
        var totalQ = data.totalQuestions || questions.length;

        // Parse QTI 3.0 assessment items using renderNode for proper HTML
        function parseQtiItem(item) {
            // Find the assessment item in multiple possible locations
            var qi = item['qti-assessment-item']
                || (item.content && item.content['qti-assessment-item'])
                || item;
            var attrs = qi['_attributes'] || {};
            var itemBody = qi['qti-item-body'] || qi['itemBody'] || {};

            // If itemBody is empty, try to extract prompt/choices directly from the interaction
            if (!itemBody || Object.keys(itemBody).length === 0) {
                // Maybe the interaction is at a different level
                var ci = qi['qti-choice-interaction'] || (qi['qti-item-body'] || {})['qti-choice-interaction'];
                if (ci) itemBody = { 'qti-choice-interaction': ci };
            }

            // Find and extract choices BEFORE rendering (so we can separate prompt from choices)
            function findChoices(node, depth) {
                if (!node || typeof node !== 'object' || depth > 5) return [];
                // Direct choice interaction
                var interaction = node['qti-choice-interaction'] || node['choiceInteraction'];
                if (interaction) {
                    var sc = interaction['qti-simple-choice'] || interaction['simpleChoice'] || [];
                    if (!Array.isArray(sc)) sc = [sc];
                    return sc.map(function(c, i) {
                        var ca = c['_attributes'] || {};
                        // Extract just the choice text (from p._ or p), not the feedback
                        var cText = '';
                        if (c.p) {
                            cText = typeof c.p === 'string' ? c.p : (c.p['_'] || c.p['_text'] || c.p['#text'] || '');
                        }
                        if (!cText) {
                            // Try rendering without feedback nodes
                            var cClone = JSON.parse(JSON.stringify(c));
                            delete cClone['qti-feedback-inline'];
                            delete cClone['_attributes'];
                            cText = renderNode(cClone);
                        }
                        return { id: ca['identifier'] || String(i), html: cText || 'Choice ' + (i+1) };
                    });
                }
                // Recurse into children
                for (var k in node) {
                    if (k.startsWith('_')) continue;
                    var v = node[k];
                    if (typeof v === 'object') {
                        var items = Array.isArray(v) ? v : [v];
                        for (var i = 0; i < items.length; i++) {
                            var found = findChoices(items[i], depth + 1);
                            if (found.length > 0) return found;
                        }
                    }
                }
                return [];
            }

            var choices = findChoices(itemBody, 0);

            // Extract prompt text directly from the known path
            var promptHtml = '';
            var ci = itemBody['qti-choice-interaction'] || {};
            var prompt = ci['qti-prompt'] || ci['prompt'] || {};
            if (prompt) {
                if (prompt.p) {
                    var pVal = prompt.p;
                    promptHtml = typeof pVal === 'string' ? pVal : (pVal['_'] || pVal['_text'] || renderNode(pVal));
                } else {
                    promptHtml = renderNode(prompt);
                }
            }
            // Fallback: render the body without choice interaction
            if (!promptHtml) {
                var bodyClone = JSON.parse(JSON.stringify(itemBody));
                delete bodyClone['qti-choice-interaction'];
                delete bodyClone['choiceInteraction'];
                promptHtml = renderNode(bodyClone);
            }

            return {
                id: attrs['identifier'] || '',
                title: attrs['title'] || '',
                promptHtml: promptHtml,
                choices: choices,
            };
        }

        // Show body/stimulus if present
        if (body) {
            html += '<div class="stimulus-content">' + body + '</div>';
        }

        if (questions.length > 0) {
            html += '<div class="quiz-meta">' + questions.length + ' of ' + totalQ + ' questions loaded</div>';
            var letters = 'ABCDEFGHIJ';

            for (var qi = 0; qi < questions.length; qi++) {
                var parsed = parseQtiItem(questions[qi]);
                html += '<div class="question-card">';
                html += '<div class="question-number">Question ' + (qi + 1) + '</div>';
                html += '<div class="question-prompt">' + (parsed.promptHtml || 'Loading...') + '</div>';

                if (parsed.choices.length > 0) {
                    html += '<div class="choice-list">';
                    for (var ci = 0; ci < parsed.choices.length; ci++) {
                        html += '<div class="choice-item" onclick="selectChoice(this,' + qi + ',' + ci + ')">' +
                            '<span class="choice-letter">' + (letters[ci] || String(ci)) + '</span>' +
                            '<span class="choice-text">' + parsed.choices[ci].html + '</span></div>';
                    }
                    html += '</div>';
                }
                html += '</div>';
            }

            // Submit button
            html += '<div class="quiz-actions"><button class="quiz-btn quiz-btn-primary" onclick="submitQuiz()"><i class="fa-solid fa-check" style="margin-right:6px;"></i>Submit Answers</button></div>';
        } else if (!body && !stimulus) {
            // Last resort: render the whole data object through renderNode
            html += '<div class="stimulus-content">' + renderNode(data) + '</div>';
        }

        html += '<div class="quiz-actions"><button class="quiz-btn quiz-btn-secondary" onclick="history.back()"><i class="fa-solid fa-arrow-left" style="margin-right:6px;"></i>Back to Course</button></div>';

        area.innerHTML = html;
    });
    </script>
</body>
</html>
