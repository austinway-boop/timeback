<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Quiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .quiz-wrap { max-width: 720px; margin: 0 auto; padding: 20px; }
        .quiz-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
        .quiz-title { font-size: 1.2rem; font-weight: 700; flex: 1; }
        .quiz-score { display: flex; align-items: center; gap: 8px; font-size: 0.88rem; font-weight: 700; color: var(--color-primary); background: var(--color-primary-light); padding: 6px 14px; border-radius: 20px; }
        .pp-scoreboard { display: flex; align-items: center; gap: 20px; background: #fff; border: 1px solid var(--color-border); border-radius: var(--radius); padding: 16px 24px; margin-bottom: 20px; }
        .pp-ring { position: relative; width: 64px; height: 64px; flex-shrink: 0; }
        .pp-ring svg { transform: rotate(-90deg); }
        .pp-ring-bg { fill: none; stroke: #E8ECF1; stroke-width: 4; }
        .pp-ring-fill { fill: none; stroke: var(--color-primary); stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }
        .pp-ring-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.1rem; color: var(--color-primary); }
        .pp-stat { text-align: center; padding: 0 16px; border-left: 1px solid var(--color-border); }
        .pp-stat:first-of-type { padding-left: 20px; }
        .pp-stat-label { font-size: 0.7rem; font-weight: 600; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .pp-stat-value { font-size: 1.2rem; font-weight: 700; color: var(--color-text); }
        .pp-label { font-size: 0.72rem; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .pp-score-text { font-weight: 700; font-size: 0.95rem; color: var(--color-text); }
        .quiz-progress-bar { height: 6px; background: #E8ECF1; border-radius: 3px; margin-bottom: 24px; overflow: hidden; }
        .quiz-progress-fill { height: 100%; background: var(--color-primary); border-radius: 3px; transition: width 0.4s ease; }
        .quiz-status { font-size: 0.82rem; color: var(--color-text-muted); margin-bottom: 8px; text-align: center; }
        .question-card { background: #fff; border: 1px solid var(--color-border); border-radius: var(--radius); padding: 28px; margin-bottom: 20px; }
        .question-num { font-size: 0.75rem; font-weight: 700; color: var(--color-primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
        .question-text { font-size: 1.05rem; font-weight: 500; line-height: 1.7; margin-bottom: 20px; }
        .question-text img { max-width: 100%; border-radius: 8px; margin: 10px 0; }
        .choices { display: flex; flex-direction: column; gap: 10px; }
        .choice { display: flex; align-items: flex-start; gap: 14px; padding: 14px 18px; border: 2px solid var(--color-border); border-radius: 12px; cursor: pointer; transition: all 0.15s; }
        .choice:hover { border-color: var(--color-primary); background: var(--color-primary-light); }
        .choice.selected { border-color: var(--color-primary); background: var(--color-primary-light); }
        .choice.correct { border-color: #2E7D32; background: #E8F5E9; }
        .choice.incorrect { border-color: #E53E3E; background: #FFF5F5; }
        .choice-letter { width: 32px; height: 32px; border-radius: 50%; background: var(--color-bg); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; flex-shrink: 0; }
        .choice.selected .choice-letter { background: var(--color-primary); color: #fff; }
        .choice.correct .choice-letter { background: #2E7D32; color: #fff; }
        .choice.incorrect .choice-letter { background: #E53E3E; color: #fff; }
        .choice-text { flex: 1; font-size: 0.95rem; line-height: 1.5; padding-top: 4px; }
        .feedback { padding: 16px; border-radius: 10px; margin-top: 16px; font-size: 0.9rem; line-height: 1.6; display: none; }
        .feedback.correct { background: #E8F5E9; border: 1px solid #A5D6A7; color: #1B5E20; display: block; }
        .feedback.incorrect { background: #FFF5F5; border: 1px solid #FFCDD2; color: #B71C1C; display: block; }
        .quiz-btn { padding: 14px 28px; border: none; border-radius: 10px; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .quiz-btn-primary { background: var(--color-primary); color: #fff; }
        .quiz-btn-primary:hover { background: var(--color-primary-dark); }
        .quiz-btn-primary:disabled { background: #CBD5E0; cursor: not-allowed; }
        .quiz-btn-secondary { background: var(--color-bg); color: var(--color-text-secondary); }
        .quiz-actions { display: flex; gap: 12px; justify-content: flex-end; }
        .result-card { background: #fff; border: 1px solid var(--color-border); border-radius: var(--radius); padding: 40px; text-align: center; }
        .result-score { font-size: 3.5rem; font-weight: 800; color: var(--color-primary); }
        .result-label { font-size: 1rem; color: var(--color-text-secondary); margin-top: 4px; }
        .result-details { display: flex; gap: 20px; justify-content: center; margin-top: 24px; }
        .result-stat { text-align: center; }
        .result-stat-val { font-size: 1.5rem; font-weight: 700; }
        .result-stat-label { font-size: 0.78rem; color: var(--color-text-muted); }
        .xp-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 1.1rem; font-weight: 700; color: var(--color-primary); background: var(--color-primary-light); padding: 8px 20px; border-radius: 20px; margin-top: 16px; }
        .loading-msg { text-align: center; padding: 60px; color: var(--color-text-muted); }
        .loading-msg .loading-spinner { margin: 0 auto 12px; }
        .back-btn { display: inline-flex; align-items: center; gap: 6px; color: var(--color-text-secondary); font-size: 0.88rem; font-weight: 500; text-decoration: none; margin-bottom: 16px; }
        .back-btn:hover { color: var(--color-primary); }
        .stimulus-box { background: var(--color-bg); border-radius: var(--radius-sm); padding: 20px; margin-bottom: 20px; line-height: 1.7; font-size: 0.95rem; max-height: 400px; overflow-y: auto; }
        .stimulus-box img { max-width: 100%; border-radius: 8px; }
    </style>
</head>
<body data-view="student" data-active="home">
    <div class="layout">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="main-content">
            <div class="quiz-wrap">
                <a href="javascript:history.back()" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Back to course</a>
                <div id="quiz-area">
                    <div class="loading-msg"><div class="loading-spinner"></div>Starting quiz...</div>
                </div>
            </div>
        </main>
    </div>
    <script src="/js/layout.js"></script>
    <script>
    function esc(s) { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    // Reuse the renderNode from the QTI parser for rich content
    function renderNode(node) {
        if (!node) return '';
        if (typeof node === 'string') return node;
        if (Array.isArray(node)) return node.map(renderNode).join('');
        var html = '';
        for (var key in node) {
            if (key.startsWith('_')) continue;
            var val = node[key];
            if (key === 'strong' || key === 'b') { html += '<strong>' + (typeof val === 'string' ? val : renderNode(val)) + '</strong>'; continue; }
            if (key === 'em' || key === 'i') { html += '<em>' + (typeof val === 'string' ? val : renderNode(val)) + '</em>'; continue; }
            if (key === 'p') { var ps = Array.isArray(val) ? val : [val]; ps.forEach(function(p) { html += '<p>' + (typeof p === 'string' ? p : (p['_'] || renderNode(p))) + '</p>'; }); continue; }
            if (key === 'img') { var ia = val['_attributes'] || val; html += '<img src="' + esc(ia.src||'') + '" alt="' + esc(ia.alt||'') + '" style="max-width:100%;border-radius:8px;">'; continue; }
            if (key === 'figure') { var figs = Array.isArray(val)?val:[val]; figs.forEach(function(f){ var im=f.img||{}; var a=im['_attributes']||im; html+='<figure style="text-align:center;margin:12px 0;"><img src="'+esc(a.src||'')+'" style="max-width:100%;border-radius:8px;">'+(f.figcaption?'<figcaption style="font-size:0.82rem;color:var(--color-text-muted);margin-top:6px;">'+esc(f.figcaption)+'</figcaption>':'')+'</figure>'; }); continue; }
            if (key === 'span') { html += typeof val === 'string' ? val : renderNode(val); continue; }
            if (key === 'div') { var ds=Array.isArray(val)?val:[val]; ds.forEach(function(d){html+=renderNode(d);}); continue; }
            if (typeof val === 'object' && val !== null) html += renderNode(val);
        }
        return html;
    }

    var quizState = {
        attemptId: null,
        questionNum: 0,
        correct: 0,
        total: 0,
        xpEarned: 0,
        ppScore: 0, // PowerPath 100 score (0-100)
        streak: 0, // consecutive correct answers
        currentQuestion: null,
        selectedChoice: null,
        answered: false,
        testId: '',
        title: '',
    };

    var area = document.getElementById('quiz-area');

    document.addEventListener('DOMContentLoaded', async function() {
        var params = new URLSearchParams(window.location.search);
        var testId = params.get('id') || params.get('testId') || '';
        var qtiUrl = params.get('url') || '';
        var subject = params.get('subject') || '';
        var gradeLevel = params.get('grade') || params.get('gradeLevel') || '';
        var lessonId = params.get('lessonId') || '';
        var courseCode = params.get('courseCode') || '';
        quizState.title = params.get('title') || 'Quiz';
        quizState.testId = testId;

        var userId = localStorage.getItem('alphalearn_userId') || localStorage.getItem('alphalearn_sourcedId') || '';

        // ‚îÄ‚îÄ 1. PowerPath adaptive flow (primary for all assessments) ‚îÄ‚îÄ
        // PowerPath accepts the bank ID as "lesson" and creates an adaptive attempt
        if (userId && testId) {
            try {
                area.innerHTML = '<div class="loading-msg"><div class="loading-spinner"></div>Starting assessment...</div>';
                var startResp = await fetch('/api/quiz-session?action=start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ studentId: userId, testId: testId, subject: subject, grade: gradeLevel }),
                });
                var startData = await startResp.json();
                if (startData.attemptId || startData.id) {
                    quizState.attemptId = startData.attemptId || startData.id;
                    await loadNextQuestion();
                    return;
                }
                console.warn('PowerPath start response:', JSON.stringify(startData));
            } catch(e) {
                console.warn('PowerPath attempt failed:', e.message);
            }
        }

        // ‚îÄ‚îÄ 2. Try production Timeback server functions (user may be logged in) ‚îÄ‚îÄ
        // The production app uses TanStack Start server functions for PowerPath quizzes.
        // Format: POST /_serverFn/{handler}?createServerFn with body {"data":{"lessonId":"..."},"context":{}}
        var effectiveLessonId = lessonId || testId;
        if (effectiveLessonId) {
            try {
                area.innerHTML = '<div class="loading-msg"><div class="loading-spinner"></div>Loading assessment content...</div>';
                var tbBody = JSON.stringify({ data: { lessonId: effectiveLessonId }, context: {} });

                // Try getLessonType first to understand what kind of content this is
                var tbResp = await fetch(
                    'https://alpha.timeback.com/_serverFn/src_features_powerpath-quiz_services_lesson-mastery_ts--getLessonType_createServerFn_handler?createServerFn',
                    { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: tbBody }
                );
                if (tbResp.ok) {
                    var tbData = await tbResp.json();
                    console.log('Timeback getLessonType:', JSON.stringify(tbData));

                    // If we got useful data, use it
                    if (tbData) {
                        var tbQtiUrl = tbData.qtiUrl || tbData.url || tbData.href || '';
                        var tbItemId = tbData.itemId || tbData.testId || tbData.id || tbData.qtiId || '';

                        if (tbQtiUrl) {
                            var loaded = await loadAllQuestions(tbQtiUrl, '', subject, gradeLevel);
                            if (loaded) return;
                        }
                        if (tbItemId) {
                            var loaded = await loadAllQuestions('', tbItemId, subject, gradeLevel);
                            if (loaded) return;
                        }
                        if (tbData.questions || tbData.items) {
                            var qs = tbData.questions || tbData.items || [];
                            if (qs.length > 0) {
                                // TODO: render these questions through the quiz engine
                                console.log('Got ' + qs.length + ' questions from Timeback');
                            }
                        }
                        if (tbData.content || tbData.body || tbData.html) {
                            var content = tbData.content || tbData.body || tbData.html || '';
                            if (typeof content === 'string' && content.length > 20) {
                                area.innerHTML = '<h1 style="font-size:1.3rem;font-weight:700;margin-bottom:16px;">' + esc(quizState.title) + '</h1>' +
                                    '<div class="stimulus-box" style="max-height:none;">' + content + '</div>' +
                                    '<div class="quiz-actions"><button class="quiz-btn quiz-btn-secondary" onclick="history.back()"><i class="fa-solid fa-arrow-left"></i> Back to Course</button></div>';
                                return;
                            }
                        }
                    }
                }
            } catch(e) {
                console.warn('Timeback serverFn failed (CORS or not logged in):', e.message);
            }
        }

        // ‚îÄ‚îÄ 3. QTI direct fetch (for direct QTI URLs only) ‚îÄ‚îÄ
        if (qtiUrl) {
            var loaded = await loadAllQuestions(qtiUrl, '', subject, gradeLevel);
            if (loaded) return;
        }

        // ‚îÄ‚îÄ 4. Local FRQ fallback ‚îÄ‚îÄ
        if (testId || subject) {
            showLocalAssessment(quizState.title, subject, gradeLevel);
            return;
        }

        area.innerHTML = '<div class="loading-msg">No quiz ID provided.</div>';
    });

    // ‚îÄ‚îÄ PowerPath adaptive: load one question at a time ‚îÄ‚îÄ
    async function loadNextQuestion() {
        if (!quizState.attemptId) return;
        area.innerHTML = '<div class="loading-msg"><div class="loading-spinner"></div>Loading question...</div>';

        try {
            var resp = await fetch('/api/quiz-session?action=next&attemptId=' + encodeURIComponent(quizState.attemptId));
            var data = await resp.json();

            if (data.complete || data.finished || data.error === 'no_more_questions') {
                showResults();
                return;
            }

            quizState.currentQuestion = data;
            quizState.questionNum++;
            quizState.selectedChoice = null;
            quizState.answered = false;
            renderQuestion(data);
        } catch(e) {
            area.innerHTML = '<div class="loading-msg">Error loading question: ' + esc(e.message) + '</div>';
        }
    }

    function renderQuestion(q) {
        var prompt = q.prompt || q.question || q.text || q.body || '';
        if (typeof prompt === 'object') prompt = renderNode(prompt);
        var choices = q.choices || q.options || q.answers || [];
        var stimulus = q.stimulus || q.passage || q.reading || '';
        if (typeof stimulus === 'object') stimulus = renderNode(stimulus);
        var isFRQ = q.isFRQ || false;
        var expectedLines = q.expectedLines || 10;

        var accuracy = quizState.total > 0 ? Math.round((quizState.correct / quizState.total) * 100) : 0;
        var ppScore = Math.max(0, Math.min(100, quizState.ppScore));
        var circumference = 2 * Math.PI * 28;
        var dashOffset = circumference - (ppScore / 100) * circumference;

        var html = '<div class="quiz-header"><div class="quiz-title">' + esc(quizState.title) + '</div></div>' +
        '<div class="pp-scoreboard">' +
            '<div class="pp-ring">' +
                '<svg width="64" height="64" viewBox="0 0 64 64">' +
                    '<circle class="pp-ring-bg" cx="32" cy="32" r="28"/>' +
                    '<circle class="pp-ring-fill" cx="32" cy="32" r="28" stroke-dasharray="' + circumference.toFixed(1) + '" stroke-dashoffset="' + dashOffset.toFixed(1) + '"/>' +
                '</svg>' +
                '<div class="pp-ring-text">' + ppScore + '</div>' +
            '</div>' +
            '<div><div class="pp-label">PowerPath 100</div><div class="pp-score-text">' + ppScore + ' / 100</div></div>' +
            '<div class="pp-stat"><div class="pp-stat-label">Questions</div><div class="pp-stat-value">' + quizState.total + '</div></div>' +
            '<div class="pp-stat"><div class="pp-stat-label">Accuracy</div><div class="pp-stat-value">' + accuracy + '%</div></div>' +
        '</div>';

        if (stimulus) {
            html += '<div class="stimulus-box">' + stimulus + '</div>';
        }

        html += '<div class="question-card"><div class="question-num">Question ' + quizState.questionNum + (isFRQ ? ' ‚Äî Free Response' : '') + '</div>';
        html += '<div class="question-text">' + (prompt || 'Loading question...') + '</div>';

        if (isFRQ) {
            // Free Response Question ‚Äî textarea
            html += '<textarea id="frq-response" rows="' + expectedLines + '" placeholder="Type your response here..." ' +
                'style="width:100%;padding:14px;border:2px solid var(--color-border);border-radius:10px;font-size:0.95rem;font-family:inherit;line-height:1.7;resize:vertical;outline:none;transition:border-color 0.15s;box-sizing:border-box;" ' +
                'onfocus="this.style.borderColor=\'var(--color-primary)\'" onblur="this.style.borderColor=\'var(--color-border)\'" ' +
                'oninput="document.getElementById(\'submit-btn\').disabled=!this.value.trim()"></textarea>' +
                '<div style="text-align:right;font-size:0.75rem;color:var(--color-text-muted);margin-top:4px;">Write a complete response. Be specific and use evidence.</div>';
        } else if (choices.length > 0) {
            var letters = 'ABCDEFGHIJ';
            html += '<div class="choices" id="choices">';
            for (var i = 0; i < choices.length; i++) {
                var c = choices[i];
                var cText = c.text || c.label || c.value || c.content || (typeof c === 'string' ? c : '');
                if (typeof cText === 'object') cText = renderNode(cText);
                var cId = c.id || c.identifier || letters[i] || String(i);
                html += '<div class="choice" data-id="' + esc(cId) + '" onclick="selectAnswer(this, \'' + esc(cId) + '\')">' +
                    '<div class="choice-letter">' + (letters[i] || i) + '</div>' +
                    '<div class="choice-text">' + (cText || 'Option ' + (letters[i]||i)) + '</div>' +
                '</div>';
            }
            html += '</div>';
        }

        html += '<div class="feedback" id="feedback"></div>';
        html += '</div>';

        html += '<div class="quiz-actions">' +
            '<button class="quiz-btn quiz-btn-primary" id="submit-btn" onclick="submitAnswer()" disabled><i class="fa-solid fa-check"></i> Submit Answer</button>' +
        '</div>';

        area.innerHTML = html;
    }

    function selectAnswer(el, choiceId) {
        if (quizState.answered) return;
        quizState.selectedChoice = choiceId;
        document.querySelectorAll('.choice').forEach(function(c) { c.classList.remove('selected'); });
        el.classList.add('selected');
        document.getElementById('submit-btn').disabled = false;
    }

    async function submitAnswer() {
        // Handle FRQ: read from textarea
        var frqEl = document.getElementById('frq-response');
        if (frqEl && !quizState.selectedChoice) {
            quizState.selectedChoice = frqEl.value.trim();
        }
        if (!quizState.selectedChoice || quizState.answered) return;
        quizState.answered = true;
        quizState.total++;

        var btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking...';

        // Submit to PowerPath if we have an attempt
        var isCorrect = false;
        var feedback = '';
        if (quizState.attemptId) {
            try {
                var resp = await fetch('/api/quiz-session?action=respond', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        attemptId: quizState.attemptId,
                        questionId: quizState.currentQuestion.id || quizState.currentQuestion.questionId || '',
                        response: quizState.selectedChoice,
                    }),
                });
                var data = await resp.json();
                isCorrect = data.correct || data.isCorrect || false;
                feedback = data.feedback || data.explanation || '';
                if (data.xpEarned) quizState.xpEarned += data.xpEarned;
            } catch(e) {}
        }

        var pointsChange = 0;
        if (isCorrect) {
            quizState.correct++;
            quizState.streak++;
            // Streak multiplier: base 5pts, +0.2x per streak, cap x2
            var multiplier = quizState.streak <= 3 ? 1 : Math.min(2.5, 1 + (quizState.streak - 3) * 0.75);
            pointsChange = Math.round(5 * multiplier);
            quizState.ppScore = Math.min(100, quizState.ppScore + pointsChange);
            quizState.xpEarned += 1;
        } else {
            quizState.streak = 0;
            pointsChange = -4;
            quizState.ppScore = Math.max(0, quizState.ppScore + pointsChange);
        }

        // Show feedback with points and streak
        var feedbackEl = document.getElementById('feedback');
        if (feedbackEl) {
            feedbackEl.className = 'feedback ' + (isCorrect ? 'correct' : 'incorrect');
            var streakText = isCorrect && quizState.streak > 3 ? ' <span style="font-size:0.85rem;">üî• ' + quizState.streak + ' streak (x' + (quizState.streak <= 3 ? 1 : Math.min(2.5, 1 + (quizState.streak - 3) * 0.75)).toFixed(1) + ')</span>' : '';
            feedbackEl.innerHTML = (isCorrect ? '<strong><i class="fa-solid fa-check-circle"></i> Correct! +' + pointsChange + '</strong>' + streakText : '<strong><i class="fa-solid fa-times-circle"></i> Incorrect ' + pointsChange + '</strong> <span style="font-size:0.85rem;">Streak reset</span>') +
                (feedback ? '<p style="margin-top:8px;">' + feedback + '</p>' : '');
        }

        // Highlight choices
        document.querySelectorAll('.choice').forEach(function(c) {
            if (c.dataset.id === quizState.selectedChoice) c.classList.add(isCorrect ? 'correct' : 'incorrect');
        });

        // Update PowerPath scoreboard
        updateScoreboard();

        // Check if score reached 100
        if (quizState.ppScore >= 100) {
            btn.innerHTML = '<i class="fa-solid fa-trophy"></i> PowerPath 100 Complete!';
            btn.disabled = false;
            btn.onclick = function() { showResults(); };
        } else {
            btn.innerHTML = '<i class="fa-solid fa-arrow-right"></i> Next Question';
            btn.disabled = false;
            btn.onclick = function() { loadNextQuestion(); };
        }
    }

    function updateScoreboard() {
        var ppScore = Math.max(0, Math.min(100, quizState.ppScore));
        var accuracy = quizState.total > 0 ? Math.round((quizState.correct / quizState.total) * 100) : 0;
        var circumference = 2 * Math.PI * 28;
        var dashOffset = circumference - (ppScore / 100) * circumference;
        var sb = document.querySelector('.pp-scoreboard');
        if (sb) {
            sb.querySelector('.pp-ring-fill').setAttribute('stroke-dashoffset', dashOffset.toFixed(1));
            sb.querySelector('.pp-ring-text').textContent = ppScore;
            sb.querySelectorAll('.pp-stat-value')[0].textContent = quizState.total;
            sb.querySelectorAll('.pp-stat-value')[1].textContent = accuracy + '%';
            sb.querySelector('.pp-score-text').textContent = ppScore + ' / 100';
        }
    }

    function showResults() {
        var pct = quizState.total > 0 ? Math.round((quizState.correct / quizState.total) * 100) : 0;
        var passed = pct >= 90;
        var noXp = pct < 80;

        // Calculate XP: no XP below 80% accuracy
        if (noXp) quizState.xpEarned = 0;

        area.innerHTML = '<div class="result-card">' +
            '<div style="font-size:3rem;margin-bottom:8px;">' + (passed ? 'üéâ' : pct >= 80 ? 'üëç' : 'üìù') + '</div>' +
            '<div class="result-score">' + pct + '%</div>' +
            '<div class="result-label">' + (passed ? 'Mastery Achieved!' : pct >= 80 ? 'Good Work!' : 'Keep Practicing') + '</div>' +
            '<div class="xp-badge"><i class="fa-solid fa-bolt"></i> ' + quizState.xpEarned + ' XP earned' + (noXp ? ' (need ‚â•80% for XP)' : '') + '</div>' +
            '<div class="result-details">' +
                '<div class="result-stat"><div class="result-stat-val" style="color:#2E7D32;">' + quizState.correct + '</div><div class="result-stat-label">Correct</div></div>' +
                '<div class="result-stat"><div class="result-stat-val">' + (quizState.total - quizState.correct) + '</div><div class="result-stat-label">Incorrect</div></div>' +
                '<div class="result-stat"><div class="result-stat-val">' + quizState.total + '</div><div class="result-stat-label">Questions</div></div>' +
                '<div class="result-stat"><div class="result-stat-val" style="color:' + (passed ? '#2E7D32' : pct >= 80 ? '#F9A825' : '#E53E3E') + ';">' + pct + '%</div><div class="result-stat-label">Accuracy</div></div>' +
            '</div>' +
            (passed ? '<div style="margin-top:16px;padding:12px 20px;background:#E8F5E9;border-radius:10px;color:#1B5E20;font-size:0.9rem;"><i class="fa-solid fa-check-circle" style="margin-right:6px;"></i>This lesson is now marked as complete. You can proceed to the next lesson.</div>' : '') +
            (!passed && pct >= 80 ? '<div style="margin-top:16px;font-size:0.88rem;color:var(--color-text-muted);">Need ‚â•90% for mastery. You earned XP but need <strong>' + (90 - pct) + '% more</strong> to advance.</div>' : '') +
            (!passed && pct < 80 ? '<div style="margin-top:16px;font-size:0.88rem;color:#E53E3E;">Below 80% ‚Äî no XP awarded. Review the material and try again.</div>' : '') +
            '<div style="margin-top:24px;display:flex;gap:12px;justify-content:center;">' +
                (passed ? '<button class="quiz-btn quiz-btn-primary" onclick="history.back()"><i class="fa-solid fa-arrow-right"></i> Continue to Next Lesson</button>' : '<button class="quiz-btn quiz-btn-primary" onclick="location.reload()"><i class="fa-solid fa-redo"></i> Try Again</button>') +
                '<button class="quiz-btn quiz-btn-secondary" onclick="history.back()"><i class="fa-solid fa-arrow-left"></i> Back to Course</button>' +
            '</div>' +
        '</div>';

        // Finalize the attempt
        if (quizState.attemptId) {
            fetch('/api/quiz-session?action=finalize', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({attemptId: quizState.attemptId}),
            }).catch(function(){});
        }

        // Auto-mark lesson as complete if mastery achieved
        if (passed) {
            var params = new URLSearchParams(window.location.search);
            var lessonTitle = params.get('title') || '';
            var lessonId = params.get('id') || params.get('testId') || '';
            if (lessonTitle || lessonId) {
                localStorage.setItem('completed_' + (lessonId || lessonTitle), 'true');
            }
        }
    }

    // ‚îÄ‚îÄ Fallback: load all questions at once from QTI (when PowerPath adaptive fails) ‚îÄ‚îÄ
    // Returns true if content was loaded, false if not
    async function loadAllQuestions(qtiUrl, testId, subject, gradeLevel) {
        area.innerHTML = '<div class="loading-msg"><div class="loading-spinner"></div>Loading quiz...</div>';
        try {
            var apiUrl = '/api/qti-item?';
            if (qtiUrl) apiUrl += 'url=' + encodeURIComponent(qtiUrl);
            else apiUrl += 'id=' + encodeURIComponent(testId) + '&type=assessment';
            // Pass subject/title/grade for QTI catalog search when ID isn't a direct QTI ID
            if (subject) apiUrl += '&subject=' + encodeURIComponent(subject);
            if (gradeLevel) apiUrl += '&grade=' + encodeURIComponent(gradeLevel);
            var quizTitle = quizState.title || '';
            if (quizTitle) apiUrl += '&title=' + encodeURIComponent(quizTitle);
            var resp = await fetch(apiUrl);
            var result = await resp.json();
            if (!result.success || !result.data) {
                return false; // Signal caller to try next fallback
            }
            var data = result.data;

            // Check for PowerPath item body/content (HTML rendered content)
            var ppBody = data.body || data.html || data.content;
            if (typeof ppBody === 'string' && ppBody.length > 20 && !data.questions && !data['qti-assessment-stimulus'] && !data['qti-assessment-test']) {
                area.innerHTML = '<h1 style="font-size:1.3rem;font-weight:700;margin-bottom:16px;">' + esc(data.title || quizState.title) + '</h1>' +
                    '<div class="stimulus-box" style="max-height:none;">' + ppBody + '</div>' +
                    '<div class="quiz-actions"><button class="quiz-btn quiz-btn-secondary" onclick="history.back()"><i class="fa-solid fa-arrow-left"></i> Back to Course</button></div>';
                return true;
            }

            // Check for stimulus
            var stimulus = data['qti-assessment-stimulus'];
            if (stimulus) {
                var stimBody = stimulus['qti-stimulus-body'] || {};
                area.innerHTML = '<h1 style="font-size:1.3rem;font-weight:700;margin-bottom:16px;">' + esc(data.title || quizState.title) + '</h1>' +
                    '<div class="stimulus-box" style="max-height:none;">' + renderNode(stimBody) + '</div>' +
                    '<div class="quiz-actions"><button class="quiz-btn quiz-btn-secondary" onclick="history.back()"><i class="fa-solid fa-arrow-left"></i> Back to Course</button></div>';
                return true;
            }

            // Render questions (from the already-fetched data)
            var questions = data.questions || [];
            if (questions.length > 0) {
                quizState.title = data.title || quizState.title;
                // Use the questions as a static quiz, one at a time
                var allQ = questions.map(function(q) {
                    var qi = q['qti-assessment-item'] || (q.content && q.content['qti-assessment-item']) || q;
                    var attrs = qi['_attributes'] || {};
                    var body = qi['qti-item-body'] || {};

                    // Detect FRQ: qti-extended-text-interaction present
                    var eti = body['qti-extended-text-interaction'];
                    var ci = body['qti-choice-interaction'] || {};
                    var isFRQ = !!eti && !ci['qti-simple-choice'];

                    // Extract prompt ‚Äî check multiple possible locations
                    var prompt = ci['qti-prompt'] || body['qti-prompt'] || (eti && eti['qti-prompt']) || {};
                    var promptText = '';
                    if (prompt.p) {
                        var ps = Array.isArray(prompt.p) ? prompt.p : [prompt.p];
                        promptText = ps.map(function(p) {
                            return '<p>' + (typeof p === 'string' ? p : (p['_'] || renderNode(p))) + '</p>';
                        }).join('');
                    }
                    if (!promptText && typeof prompt === 'string') promptText = prompt;
                    if (!promptText) {
                        var bc = JSON.parse(JSON.stringify(body));
                        delete bc['qti-choice-interaction'];
                        delete bc['qti-extended-text-interaction'];
                        delete bc['qti-response-declaration'];
                        delete bc['qti-outcome-declaration'];
                        promptText = renderNode(bc);
                    }

                    // FRQ: get expected lines
                    var expectedLines = 10;
                    if (eti) {
                        var etiAttrs = eti['_attributes'] || eti;
                        expectedLines = parseInt(etiAttrs['expected-lines'] || etiAttrs.expectedLines || '10', 10);
                    }

                    // Stimulus reference
                    var stimRef = body['qti-stimulus-ref'];
                    var stimId = stimRef ? ((stimRef['_attributes'] || stimRef).identifier || '') : '';

                    // Multiple choice parsing
                    var sc = ci['qti-simple-choice'] || [];
                    if (!Array.isArray(sc)) sc = [sc];
                    var choices = isFRQ ? [] : sc.map(function(c,i) {
                        var ca = c['_attributes'] || {};
                        var t = c.p ? (typeof c.p === 'string' ? c.p : (c.p['_'] || renderNode(c.p))) : renderNode(c);
                        return { id: ca.identifier || String(i), text: t };
                    });

                    // Get correct answer (MC only)
                    var rd = qi['qti-response-declaration'] || {};
                    var cr = rd['qti-correct-response'] || {};
                    var correctId = cr['qti-value'] || '';

                    // Get feedback
                    var feedbackMap = {};
                    if (!isFRQ) {
                        sc.forEach(function(c) {
                            var ca = c['_attributes'] || {};
                            var fb = c['qti-feedback-inline'] || {};
                            if (fb.span) feedbackMap[ca.identifier] = typeof fb.span === 'string' ? fb.span : renderNode(fb.span);
                        });
                    }

                    return {
                        prompt: promptText, choices: choices, correctId: correctId,
                        feedbackMap: feedbackMap, isFRQ: isFRQ, expectedLines: expectedLines,
                        stimulusId: stimId,
                    };
                });

                // Run static quiz one at a time
                var currentIdx = 0;
                function showStaticQuestion() {
                    if (currentIdx >= allQ.length) { showResults(); return; }
                    var q = allQ[currentIdx];
                    quizState.currentQuestion = q;
                    quizState.selectedChoice = null;
                    quizState.answered = false;
                    quizState.questionNum = currentIdx + 1;

                    var qData = {
                        prompt: q.prompt,
                        choices: q.choices.map(function(c) { return { id: c.id, text: c.text }; }),
                        isFRQ: q.isFRQ,
                        expectedLines: q.expectedLines,
                    };
                    renderQuestion(qData);

                    // Override submit to handle locally
                    document.getElementById('submit-btn').onclick = function() {
                        // FRQ: read from textarea
                        var frqEl = document.getElementById('frq-response');
                        if (frqEl && !quizState.selectedChoice) {
                            quizState.selectedChoice = frqEl.value.trim();
                        }
                        if (!quizState.selectedChoice || quizState.answered) return;
                        quizState.answered = true;
                        quizState.total++;

                        var isCorrect;
                        if (q.isFRQ) {
                            // FRQ: mark as correct if response is substantial (30+ chars)
                            isCorrect = quizState.selectedChoice.length >= 30;
                        } else {
                            isCorrect = quizState.selectedChoice === q.correctId;
                        }
                        var pointsChange = 0;
                        if (isCorrect) {
                            quizState.correct++;
                            quizState.streak++;
                            var multiplier = quizState.streak <= 3 ? 1 : Math.min(2.5, 1 + (quizState.streak - 3) * 0.75);
                            pointsChange = Math.round(5 * multiplier);
                            quizState.ppScore = Math.min(100, quizState.ppScore + pointsChange);
                            quizState.xpEarned += q.isFRQ ? 2 : 1;
                        } else {
                            quizState.streak = 0;
                            pointsChange = -4;
                            quizState.ppScore = Math.max(0, quizState.ppScore + pointsChange);
                        }
                        var fb = q.isFRQ ? '' : (q.feedbackMap[quizState.selectedChoice] || '');

                        if (q.isFRQ) {
                            // FRQ: disable textarea, show submission feedback
                            var frqBox = document.getElementById('frq-response');
                            if (frqBox) { frqBox.disabled = true; frqBox.style.opacity = '0.7'; }
                            var feedbackEl = document.getElementById('feedback');
                            feedbackEl.className = 'feedback correct';
                            feedbackEl.innerHTML = '<strong><i class="fa-solid fa-check-circle"></i> Response Submitted</strong>' +
                                (isCorrect ? '<p style="margin-top:6px;">Good response! XP awarded.</p>' : '<p style="margin-top:6px;">Try to write a more detailed response next time (at least 30 characters).</p>');
                        } else {
                            // MC: Highlight correct and incorrect choices
                            document.querySelectorAll('.choice').forEach(function(c) {
                                if (c.dataset.id === quizState.selectedChoice) c.classList.add(isCorrect ? 'correct' : 'incorrect');
                                if (c.dataset.id === q.correctId) c.classList.add('correct');
                            });
                            var feedbackEl = document.getElementById('feedback');
                            feedbackEl.className = 'feedback ' + (isCorrect ? 'correct' : 'incorrect');
                            var streakText = isCorrect && quizState.streak > 3 ? ' <span style="font-size:0.85rem;">üî• ' + quizState.streak + ' streak (x' + (quizState.streak <= 3 ? 1 : Math.min(2.5, 1 + (quizState.streak - 3) * 0.75)).toFixed(1) + ')</span>' : '';
                            feedbackEl.innerHTML = (isCorrect ? '<strong><i class="fa-solid fa-check-circle"></i> Correct! +' + pointsChange + '</strong>' + streakText : '<strong><i class="fa-solid fa-times-circle"></i> Incorrect ' + pointsChange + '</strong>') + (fb ? '<p style="margin-top:8px;">' + fb + '</p>' : '');
                        }

                        // Update PowerPath scoreboard
                        updateScoreboard();

                        var btn = document.getElementById('submit-btn');

                        // Quiz ends when PowerPath score reaches 100
                        if (quizState.ppScore >= 100) {
                            quizState.xpEarned += 5; // bonus
                            btn.innerHTML = '<i class="fa-solid fa-trophy"></i> PowerPath 100 Complete!';
                            btn.onclick = function() { showResults(); };
                        } else if (currentIdx + 1 >= allQ.length) {
                            btn.innerHTML = '<i class="fa-solid fa-flag-checkered"></i> See Results';
                            btn.onclick = function() { showResults(); };
                        } else {
                            btn.innerHTML = '<i class="fa-solid fa-arrow-right"></i> Next Question';
                            btn.onclick = function() { currentIdx++; showStaticQuestion(); };
                        }
                    };
                }
                showStaticQuestion();
            } else {
                // Raw content display
                area.innerHTML = '<h1 style="font-size:1.3rem;font-weight:700;margin-bottom:16px;">' + esc(data.title || quizState.title) + '</h1>' +
                    '<div class="stimulus-box" style="max-height:none;">' + renderNode(data) + '</div>' +
                    '<div class="quiz-actions"><button class="quiz-btn quiz-btn-secondary" onclick="history.back()"><i class="fa-solid fa-arrow-left"></i> Back</button></div>';
            }
            return true;
        } catch(e) {
            return false;
        }
    }

    // ‚îÄ‚îÄ Local FRQ assessment fallback (when PowerPath + QTI both fail) ‚îÄ‚îÄ
    function showLocalAssessment(title, subject, gradeLevel) {
        var subjectDisplay = subject || 'this subject';
        var gradeDisplay = gradeLevel ? 'Grade ' + gradeLevel : '';
        var heading = title || ('End of Unit Assessment' + (gradeDisplay ? ' ‚Äî ' + gradeDisplay : ''));

        quizState.title = heading;

        var prompts = [
            {
                num: 1,
                text: '<p><strong>Part A:</strong> Identify and explain a key concept from this unit. Use specific details and examples from the material you studied.</p>',
                lines: 8,
            },
            {
                num: 2,
                text: '<p><strong>Part B:</strong> Analyze how this concept connects to a broader theme in ' + esc(subjectDisplay) + '. Explain the cause-and-effect relationship.</p>',
                lines: 8,
            },
            {
                num: 3,
                text: '<p><strong>Part C:</strong> Evaluate the significance of what you learned. How does it apply to real-world scenarios? Support your answer with evidence.</p>',
                lines: 10,
            },
        ];

        var html = '<div class="quiz-header">' +
            '<div class="quiz-title">' + esc(heading) + '</div>' +
        '</div>' +
        '<div style="padding:12px 16px;background:#F3F0FF;border:1px solid #D6BCFA;border-radius:10px;margin-bottom:20px;font-size:0.88rem;color:#553C9A;">' +
            '<i class="fa-solid fa-pen-nib" style="margin-right:8px;"></i>' +
            '<strong>Free Response Assessment</strong> ‚Äî Write thoughtful, detailed responses to each prompt below. Minimum 50 characters per response.' +
        '</div>';

        for (var i = 0; i < prompts.length; i++) {
            var p = prompts[i];
            html += '<div class="question-card" style="margin-bottom:16px;">' +
                '<div class="question-num">Question ' + p.num + ' ‚Äî Free Response</div>' +
                '<div class="question-text">' + p.text + '</div>' +
                '<textarea id="local-frq-' + i + '" rows="' + p.lines + '" placeholder="Write your response here..." ' +
                    'style="width:100%;padding:14px;border:2px solid var(--color-border);border-radius:10px;font-size:0.95rem;font-family:inherit;line-height:1.7;resize:vertical;outline:none;box-sizing:border-box;" ' +
                    'onfocus="this.style.borderColor=\'var(--color-primary)\'" onblur="this.style.borderColor=\'var(--color-border)\'" ' +
                    'oninput="checkLocalFrqReady()"></textarea>' +
                '<div style="text-align:right;font-size:0.72rem;color:var(--color-text-muted);margin-top:4px;" id="local-frq-count-' + i + '">0 / 50 characters minimum</div>' +
            '</div>';
        }

        html += '<div class="quiz-actions">' +
            '<button class="quiz-btn quiz-btn-primary" id="local-frq-submit" onclick="submitLocalAssessment(' + prompts.length + ')" disabled>' +
                '<i class="fa-solid fa-paper-plane"></i> Submit Assessment</button>' +
        '</div>';

        area.innerHTML = html;
    }

    function checkLocalFrqReady() {
        var textareas = area.querySelectorAll('textarea[id^="local-frq-"]');
        var allReady = true;
        for (var i = 0; i < textareas.length; i++) {
            var len = textareas[i].value.trim().length;
            var countEl = document.getElementById('local-frq-count-' + i);
            if (countEl) {
                countEl.textContent = len + ' / 50 characters minimum';
                countEl.style.color = len >= 50 ? '#2E7D32' : 'var(--color-text-muted)';
            }
            if (len < 50) allReady = false;
        }
        document.getElementById('local-frq-submit').disabled = !allReady;
    }

    function submitLocalAssessment(count) {
        var responses = [];
        for (var i = 0; i < count; i++) {
            var ta = document.getElementById('local-frq-' + i);
            if (ta) { ta.disabled = true; responses.push(ta.value.trim()); }
        }

        // Award XP: 2 per substantial response
        var xp = 0;
        for (var r = 0; r < responses.length; r++) {
            if (responses[r].length >= 50) xp += 2;
        }

        // Mark as complete
        var params = new URLSearchParams(window.location.search);
        var lessonTitle = params.get('title') || '';
        var lessonId = params.get('id') || params.get('testId') || '';
        if (lessonTitle || lessonId) {
            localStorage.setItem('completed_' + (lessonId || lessonTitle), 'true');
        }

        area.innerHTML = '<div class="result-card">' +
            '<div style="font-size:3rem;margin-bottom:8px;">‚úÖ</div>' +
            '<div class="result-score" style="font-size:2rem;">Assessment Complete</div>' +
            '<div class="result-label" style="margin-top:8px;">Your responses have been recorded.</div>' +
            '<div class="xp-badge"><i class="fa-solid fa-bolt"></i> ' + xp + ' XP earned</div>' +
            '<div class="result-details">' +
                '<div class="result-stat"><div class="result-stat-val">' + responses.length + '</div><div class="result-stat-label">Responses</div></div>' +
                '<div class="result-stat"><div class="result-stat-val">' + xp + '</div><div class="result-stat-label">XP Earned</div></div>' +
            '</div>' +
            '<div style="margin-top:16px;padding:12px 20px;background:#E8F5E9;border-radius:10px;color:#1B5E20;font-size:0.9rem;">' +
                '<i class="fa-solid fa-check-circle" style="margin-right:6px;"></i>This assessment is now marked as complete.</div>' +
            '<div style="margin-top:24px;">' +
                '<button class="quiz-btn quiz-btn-primary" onclick="history.back()"><i class="fa-solid fa-arrow-right"></i> Continue to Next Lesson</button>' +
            '</div>' +
        '</div>';
    }
    </script>
</body>
</html>
</body>
</html>
