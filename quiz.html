<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Quiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .quiz-container { max-width: 760px; margin: 0 auto; padding: 20px; }
        .quiz-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 4px; }
        .quiz-meta { font-size: 0.85rem; color: var(--color-text-secondary); margin-bottom: 20px; }
        .quiz-loading { text-align: center; padding: 60px 20px; color: var(--color-text-muted); }
        .quiz-loading .loading-spinner { margin: 0 auto 12px; }
        .question-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius); padding: 24px; margin-bottom: 16px; }
        .question-number { font-size: 0.78rem; font-weight: 700; color: var(--color-primary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .question-prompt { font-size: 1rem; font-weight: 500; line-height: 1.6; margin-bottom: 16px; }
        .question-prompt img { max-width: 100%; border-radius: 8px; margin: 8px 0; }
        .choice-list { display: flex; flex-direction: column; gap: 8px; }
        .choice-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px 16px; border: 2px solid var(--color-border); border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s; }
        .choice-item:hover { border-color: var(--color-primary); background: var(--color-primary-light); }
        .choice-item.selected { border-color: var(--color-primary); background: var(--color-primary-light); }
        .choice-letter { width: 28px; height: 28px; border-radius: 50%; background: var(--color-bg); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.82rem; flex-shrink: 0; }
        .choice-item.selected .choice-letter { background: var(--color-primary); color: #fff; }
        .choice-text { flex: 1; line-height: 1.5; }
        .choice-text img { max-width: 100%; border-radius: 4px; margin-top: 4px; }
        .stimulus-content { background: var(--color-bg); border-radius: var(--radius-sm); padding: 20px; margin-bottom: 20px; line-height: 1.7; font-size: 0.95rem; }
        .stimulus-content p { margin: 0 0 12px; }
        .quiz-actions { display: flex; gap: 12px; margin-top: 24px; }
        .quiz-btn { padding: 12px 24px; border: none; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.92rem; cursor: pointer; }
        .quiz-btn-primary { background: var(--color-primary); color: #fff; }
        .quiz-btn-primary:hover { background: var(--color-primary-dark); }
        .quiz-btn-secondary { background: var(--color-bg); color: var(--color-text-secondary); }
        .back-btn { display: inline-flex; align-items: center; gap: 6px; color: var(--color-text-secondary); font-size: 0.88rem; font-weight: 500; text-decoration: none; margin-bottom: 16px; }
        .back-btn:hover { color: var(--color-primary); }
        .error-box { background: #FFF5F5; border: 1px solid #FED7D7; border-radius: var(--radius-sm); padding: 16px; color: #C53030; font-size: 0.88rem; margin-top: 12px; }
        .raw-content { background: var(--color-bg); padding: 20px; border-radius: var(--radius-sm); line-height: 1.7; font-size: 0.95rem; }
        .raw-content img { max-width: 100%; }
    </style>
</head>
<body data-view="student" data-active="home">
    <div class="layout">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="main-content">
            <div class="quiz-container">
                <a href="javascript:history.back()" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Back to course</a>
                <div id="quiz-area">
                    <div class="quiz-loading">
                        <div class="loading-spinner"></div>
                        Loading content...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/layout.js"></script>
    <script>
    function esc(s) { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    document.addEventListener('DOMContentLoaded', async function() {
        var params = new URLSearchParams(window.location.search);
        var itemId = params.get('id') || '';
        var itemType = params.get('type') || 'item';
        var itemUrl = params.get('url') || '';
        var title = params.get('title') || 'Content';
        var area = document.getElementById('quiz-area');

        if (!itemId && !itemUrl) {
            area.innerHTML = '<div class="quiz-loading"><p>No content ID provided.</p></div>';
            return;
        }

        var data = null;
        var errors = [];

        // Method 1: Try our backend proxy (uses Cognito client credentials)
        try {
            var apiUrl = '/api/qti-item?';
            if (itemUrl) apiUrl += 'url=' + encodeURIComponent(itemUrl);
            else apiUrl += 'id=' + encodeURIComponent(itemId) + '&type=' + encodeURIComponent(itemType);

            var resp = await fetch(apiUrl);
            var result = await resp.json();
            if (result.success && result.data) {
                data = result.data;
            } else {
                errors.push('Backend: ' + (result.error || resp.status));
            }
        } catch(e) {
            errors.push('Backend: ' + e.message);
        }

        // Method 2: If backend failed, try calling Timeback server function directly
        // (works if user is logged into alpha.timeback.com in the same browser)
        if (!data) {
            try {
                var tbPayload = JSON.stringify({ data: { itemId: itemId, itemType: itemType } });
                var tbResp = await fetch(
                    'https://alpha.timeback.com/_serverFn/src_features_qti_actions_getQtiItem_ts--getQtiItem_createServerFn_handler?payload=' + encodeURIComponent(tbPayload) + '&createServerFn',
                    { credentials: 'include', headers: { 'Accept': 'application/json' } }
                );
                if (tbResp.ok) {
                    data = await tbResp.json();
                } else {
                    errors.push('Timeback serverFn: ' + tbResp.status);
                }
            } catch(e) {
                errors.push('Timeback serverFn: ' + e.message);
            }
        }

        // Method 3: Try the QTI URL directly from the browser (CORS may block)
        if (!data && itemUrl) {
            try {
                var directResp = await fetch(itemUrl, { credentials: 'include' });
                if (directResp.ok) {
                    data = await directResp.json();
                } else {
                    errors.push('Direct QTI: ' + directResp.status);
                }
            } catch(e) {
                errors.push('Direct QTI: CORS blocked');
            }
        }

        // Render content
        if (!data) {
            area.innerHTML = '<h1 class="quiz-title">' + esc(title) + '</h1>' +
                '<div class="error-box"><strong>Could not load content</strong><br>' +
                '<div style="margin-top:8px;font-size:0.82rem;">' + errors.map(esc).join('<br>') + '</div>' +
                '<div style="margin-top:12px;">This content requires authentication with the Timeback platform. ' +
                '<a href="https://alpha.timeback.com/app" target="_blank" style="color:var(--color-primary);font-weight:600;">Open on Timeback</a></div>' +
                '</div>';
            return;
        }

        // Parse and render the QTI content
        var html = '<h1 class="quiz-title">' + esc(data.title || data.identifier || title) + '</h1>';

        // Check for body/content/stimulus text
        var body = data.body || data.content || data.stimulus || data.itemBody || data.passage || '';
        if (typeof body === 'object') body = body.content || body.body || JSON.stringify(body);

        // Check for questions
        var questions = data.questions || data.items || data.assessmentItems || data.interactions || [];
        if (!questions.length && data.qtiMetadata) questions = data.qtiMetadata.items || [];

        // Check for choices in a single-question format
        var choices = data.choices || data.options || data.simpleChoices || [];
        var prompt = data.prompt || data.question || '';

        if (body) {
            html += '<div class="stimulus-content">' + body + '</div>';
        }

        if (prompt || choices.length) {
            // Single question format
            html += '<div class="question-card">';
            if (prompt) html += '<div class="question-prompt">' + prompt + '</div>';
            if (choices.length) {
                var letters = 'ABCDEFGHIJ';
                html += '<div class="choice-list">';
                for (var ci = 0; ci < choices.length; ci++) {
                    var c = choices[ci];
                    var cText = c.text || c.label || c.value || c.content || (typeof c === 'string' ? c : JSON.stringify(c));
                    html += '<div class="choice-item" onclick="this.classList.toggle(\'selected\')">' +
                        '<span class="choice-letter">' + (letters[ci] || ci) + '</span>' +
                        '<span class="choice-text">' + cText + '</span></div>';
                }
                html += '</div>';
            }
            html += '</div>';
        }

        if (questions.length) {
            var letters = 'ABCDEFGHIJ';
            html += '<div class="quiz-meta">' + questions.length + ' questions</div>';
            for (var qi = 0; qi < questions.length; qi++) {
                var q = questions[qi];
                var qPrompt = q.prompt || q.question || q.body || q.text || q.itemBody || '';
                var qChoices = q.choices || q.options || q.simpleChoices || [];
                html += '<div class="question-card"><div class="question-number">Question ' + (qi+1) + '</div>';
                html += '<div class="question-prompt">' + (qPrompt || 'No prompt') + '</div>';
                if (qChoices.length) {
                    html += '<div class="choice-list">';
                    for (var ci = 0; ci < qChoices.length; ci++) {
                        var c = qChoices[ci];
                        var cText = c.text || c.label || c.value || (typeof c === 'string' ? c : JSON.stringify(c));
                        html += '<div class="choice-item" onclick="this.classList.toggle(\'selected\')">' +
                            '<span class="choice-letter">' + (letters[ci] || ci) + '</span>' +
                            '<span class="choice-text">' + cText + '</span></div>';
                    }
                    html += '</div>';
                }
                html += '</div>';
            }
        }

        // If we got data but couldn't parse questions, show the raw content
        if (!body && !questions.length && !prompt) {
            html += '<div class="raw-content">';
            if (typeof data === 'string') {
                html += data;
            } else {
                // Try to show something useful
                var keys = Object.keys(data);
                for (var ki = 0; ki < keys.length; ki++) {
                    var k = keys[ki];
                    var v = data[k];
                    if (typeof v === 'string' && v.length > 10) {
                        html += '<div style="margin-bottom:12px;"><strong>' + esc(k) + ':</strong><div>' + v + '</div></div>';
                    }
                }
                if (!html.includes('<div style="margin-bottom')) {
                    html += '<pre style="font-size:0.8rem;overflow-x:auto;">' + esc(JSON.stringify(data, null, 2)) + '</pre>';
                }
            }
            html += '</div>';
        }

        html += '<div class="quiz-actions"><button class="quiz-btn quiz-btn-secondary" onclick="history.back()"><i class="fa-solid fa-arrow-left" style="margin-right:6px;"></i>Back to Course</button></div>';

        area.innerHTML = html;
    });
    </script>
</body>
</html>
