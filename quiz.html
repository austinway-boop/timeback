<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Quiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .quiz-wrap { max-width: 720px; margin: 0 auto; padding: 20px; }
        .quiz-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
        .quiz-title { font-size: 1.2rem; font-weight: 700; flex: 1; }
        .quiz-score { display: flex; align-items: center; gap: 8px; font-size: 0.88rem; font-weight: 700; color: var(--color-primary); background: var(--color-primary-light); padding: 6px 14px; border-radius: 20px; }
        .quiz-progress-bar { height: 6px; background: #E8ECF1; border-radius: 3px; margin-bottom: 24px; overflow: hidden; }
        .quiz-progress-fill { height: 100%; background: var(--color-primary); border-radius: 3px; transition: width 0.4s ease; }
        .quiz-status { font-size: 0.82rem; color: var(--color-text-muted); margin-bottom: 8px; text-align: center; }
        .question-card { background: #fff; border: 1px solid var(--color-border); border-radius: var(--radius); padding: 28px; margin-bottom: 20px; }
        .question-num { font-size: 0.75rem; font-weight: 700; color: var(--color-primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
        .question-text { font-size: 1.05rem; font-weight: 500; line-height: 1.7; margin-bottom: 20px; }
        .question-text img { max-width: 100%; border-radius: 8px; margin: 10px 0; }
        .choices { display: flex; flex-direction: column; gap: 10px; }
        .choice { display: flex; align-items: flex-start; gap: 14px; padding: 14px 18px; border: 2px solid var(--color-border); border-radius: 12px; cursor: pointer; transition: all 0.15s; }
        .choice:hover { border-color: var(--color-primary); background: var(--color-primary-light); }
        .choice.selected { border-color: var(--color-primary); background: var(--color-primary-light); }
        .choice.correct { border-color: #2E7D32; background: #E8F5E9; }
        .choice.incorrect { border-color: #E53E3E; background: #FFF5F5; }
        .choice-letter { width: 32px; height: 32px; border-radius: 50%; background: var(--color-bg); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; flex-shrink: 0; }
        .choice.selected .choice-letter { background: var(--color-primary); color: #fff; }
        .choice.correct .choice-letter { background: #2E7D32; color: #fff; }
        .choice.incorrect .choice-letter { background: #E53E3E; color: #fff; }
        .choice-text { flex: 1; font-size: 0.95rem; line-height: 1.5; padding-top: 4px; }
        .feedback { padding: 16px; border-radius: 10px; margin-top: 16px; font-size: 0.9rem; line-height: 1.6; display: none; }
        .feedback.correct { background: #E8F5E9; border: 1px solid #A5D6A7; color: #1B5E20; display: block; }
        .feedback.incorrect { background: #FFF5F5; border: 1px solid #FFCDD2; color: #B71C1C; display: block; }
        .quiz-btn { padding: 14px 28px; border: none; border-radius: 10px; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .quiz-btn-primary { background: var(--color-primary); color: #fff; }
        .quiz-btn-primary:hover { background: var(--color-primary-dark); }
        .quiz-btn-primary:disabled { background: #CBD5E0; cursor: not-allowed; }
        .quiz-btn-secondary { background: var(--color-bg); color: var(--color-text-secondary); }
        .quiz-actions { display: flex; gap: 12px; justify-content: flex-end; }
        .result-card { background: #fff; border: 1px solid var(--color-border); border-radius: var(--radius); padding: 40px; text-align: center; }
        .result-score { font-size: 3.5rem; font-weight: 800; color: var(--color-primary); }
        .result-label { font-size: 1rem; color: var(--color-text-secondary); margin-top: 4px; }
        .result-details { display: flex; gap: 20px; justify-content: center; margin-top: 24px; }
        .result-stat { text-align: center; }
        .result-stat-val { font-size: 1.5rem; font-weight: 700; }
        .result-stat-label { font-size: 0.78rem; color: var(--color-text-muted); }
        .xp-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 1.1rem; font-weight: 700; color: var(--color-primary); background: var(--color-primary-light); padding: 8px 20px; border-radius: 20px; margin-top: 16px; }
        .loading-msg { text-align: center; padding: 60px; color: var(--color-text-muted); }
        .loading-msg .loading-spinner { margin: 0 auto 12px; }
        .back-btn { display: inline-flex; align-items: center; gap: 6px; color: var(--color-text-secondary); font-size: 0.88rem; font-weight: 500; text-decoration: none; margin-bottom: 16px; }
        .back-btn:hover { color: var(--color-primary); }
        .stimulus-box { background: var(--color-bg); border-radius: var(--radius-sm); padding: 20px; margin-bottom: 20px; line-height: 1.7; font-size: 0.95rem; max-height: 400px; overflow-y: auto; }
        .stimulus-box img { max-width: 100%; border-radius: 8px; }
    </style>
</head>
<body data-view="student" data-active="home">
    <div class="layout">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="main-content">
            <div class="quiz-wrap">
                <a href="javascript:history.back()" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Back to course</a>
                <div id="quiz-area">
                    <div class="loading-msg"><div class="loading-spinner"></div>Starting quiz...</div>
                </div>
            </div>
        </main>
    </div>
    <script src="/js/layout.js"></script>
    <script>
    function esc(s) { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    // Reuse the renderNode from the QTI parser for rich content
    function renderNode(node) {
        if (!node) return '';
        if (typeof node === 'string') return node;
        if (Array.isArray(node)) return node.map(renderNode).join('');
        var html = '';
        for (var key in node) {
            if (key.startsWith('_')) continue;
            var val = node[key];
            if (key === 'strong' || key === 'b') { html += '<strong>' + (typeof val === 'string' ? val : renderNode(val)) + '</strong>'; continue; }
            if (key === 'em' || key === 'i') { html += '<em>' + (typeof val === 'string' ? val : renderNode(val)) + '</em>'; continue; }
            if (key === 'p') { var ps = Array.isArray(val) ? val : [val]; ps.forEach(function(p) { html += '<p>' + (typeof p === 'string' ? p : (p['_'] || renderNode(p))) + '</p>'; }); continue; }
            if (key === 'img') { var ia = val['_attributes'] || val; html += '<img src="' + esc(ia.src||'') + '" alt="' + esc(ia.alt||'') + '" style="max-width:100%;border-radius:8px;">'; continue; }
            if (key === 'figure') { var figs = Array.isArray(val)?val:[val]; figs.forEach(function(f){ var im=f.img||{}; var a=im['_attributes']||im; html+='<figure style="text-align:center;margin:12px 0;"><img src="'+esc(a.src||'')+'" style="max-width:100%;border-radius:8px;">'+(f.figcaption?'<figcaption style="font-size:0.82rem;color:var(--color-text-muted);margin-top:6px;">'+esc(f.figcaption)+'</figcaption>':'')+'</figure>'; }); continue; }
            if (key === 'span') { html += typeof val === 'string' ? val : renderNode(val); continue; }
            if (key === 'div') { var ds=Array.isArray(val)?val:[val]; ds.forEach(function(d){html+=renderNode(d);}); continue; }
            if (typeof val === 'object' && val !== null) html += renderNode(val);
        }
        return html;
    }

    var quizState = {
        attemptId: null,
        questionNum: 0,
        correct: 0,
        total: 0,
        xpEarned: 0,
        currentQuestion: null,
        selectedChoice: null,
        answered: false,
        testId: '',
        title: '',
    };

    var area = document.getElementById('quiz-area');

    document.addEventListener('DOMContentLoaded', async function() {
        var params = new URLSearchParams(window.location.search);
        var testId = params.get('id') || params.get('testId') || '';
        var qtiUrl = params.get('url') || '';
        quizState.title = params.get('title') || 'Quiz';
        quizState.testId = testId;

        var userId = localStorage.getItem('alphalearn_userId') || localStorage.getItem('alphalearn_sourcedId') || '';

        // Try PowerPath adaptive quiz flow first
        if (testId && userId) {
            try {
                var startResp = await fetch('/api/quiz-session?action=start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({studentId: userId, testId: testId}),
                });
                var startData = await startResp.json();
                if (startData.attemptId || startData.id) {
                    quizState.attemptId = startData.attemptId || startData.id;
                    await loadNextQuestion();
                    return;
                }
            } catch(e) { console.warn('PowerPath attempt failed:', e.message); }
        }

        // Fallback: load all questions from QTI API (old method)
        if (qtiUrl || testId) {
            await loadAllQuestions(qtiUrl, testId);
            return;
        }

        area.innerHTML = '<div class="loading-msg">No quiz ID provided.</div>';
    });

    // ‚îÄ‚îÄ PowerPath adaptive: load one question at a time ‚îÄ‚îÄ
    async function loadNextQuestion() {
        if (!quizState.attemptId) return;
        area.innerHTML = '<div class="loading-msg"><div class="loading-spinner"></div>Loading question...</div>';

        try {
            var resp = await fetch('/api/quiz-session?action=next&attemptId=' + encodeURIComponent(quizState.attemptId));
            var data = await resp.json();

            if (data.complete || data.finished || data.error === 'no_more_questions') {
                showResults();
                return;
            }

            quizState.currentQuestion = data;
            quizState.questionNum++;
            quizState.selectedChoice = null;
            quizState.answered = false;
            renderQuestion(data);
        } catch(e) {
            area.innerHTML = '<div class="loading-msg">Error loading question: ' + esc(e.message) + '</div>';
        }
    }

    function renderQuestion(q) {
        var prompt = q.prompt || q.question || q.text || q.body || '';
        if (typeof prompt === 'object') prompt = renderNode(prompt);
        var choices = q.choices || q.options || q.answers || [];
        var stimulus = q.stimulus || q.passage || q.reading || '';
        if (typeof stimulus === 'object') stimulus = renderNode(stimulus);

        var accuracy = quizState.total > 0 ? Math.round((quizState.correct / quizState.total) * 100) : 0;
        var accColor = accuracy >= 90 ? '#2E7D32' : accuracy >= 80 ? '#F9A825' : accuracy > 0 ? '#E53E3E' : 'var(--color-text-muted)';

        var html = '<div class="quiz-header">' +
            '<div class="quiz-title">' + esc(quizState.title) + '</div>' +
            '<div class="quiz-score"><i class="fa-solid fa-bolt"></i> ' + quizState.xpEarned + ' XP</div>' +
        '</div>' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">' +
            '<div class="quiz-status">Question ' + quizState.questionNum + '</div>' +
            '<div style="display:flex;gap:16px;font-size:0.85rem;font-weight:600;">' +
                '<span>' + quizState.correct + '/' + quizState.total + ' correct</span>' +
                '<span style="color:' + accColor + ';">' + accuracy + '% accuracy</span>' +
            '</div>' +
        '</div>' +
        '<div class="quiz-progress-bar"><div class="quiz-progress-fill" style="width:' + accuracy + '%;background:' + accColor + ';"></div></div>';

        if (stimulus) {
            html += '<div class="stimulus-box">' + stimulus + '</div>';
        }

        html += '<div class="question-card"><div class="question-num">Question ' + quizState.questionNum + '</div>';
        html += '<div class="question-text">' + (prompt || 'Loading question...') + '</div>';

        if (choices.length > 0) {
            var letters = 'ABCDEFGHIJ';
            html += '<div class="choices" id="choices">';
            for (var i = 0; i < choices.length; i++) {
                var c = choices[i];
                var cText = c.text || c.label || c.value || c.content || (typeof c === 'string' ? c : '');
                if (typeof cText === 'object') cText = renderNode(cText);
                var cId = c.id || c.identifier || letters[i] || String(i);
                html += '<div class="choice" data-id="' + esc(cId) + '" onclick="selectAnswer(this, \'' + esc(cId) + '\')">' +
                    '<div class="choice-letter">' + (letters[i] || i) + '</div>' +
                    '<div class="choice-text">' + (cText || 'Option ' + (letters[i]||i)) + '</div>' +
                '</div>';
            }
            html += '</div>';
        }

        html += '<div class="feedback" id="feedback"></div>';
        html += '</div>';

        html += '<div class="quiz-actions">' +
            '<button class="quiz-btn quiz-btn-primary" id="submit-btn" onclick="submitAnswer()" disabled><i class="fa-solid fa-check"></i> Submit Answer</button>' +
        '</div>';

        area.innerHTML = html;
    }

    function selectAnswer(el, choiceId) {
        if (quizState.answered) return;
        quizState.selectedChoice = choiceId;
        document.querySelectorAll('.choice').forEach(function(c) { c.classList.remove('selected'); });
        el.classList.add('selected');
        document.getElementById('submit-btn').disabled = false;
    }

    async function submitAnswer() {
        if (!quizState.selectedChoice || quizState.answered) return;
        quizState.answered = true;
        quizState.total++;

        var btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking...';

        // Submit to PowerPath if we have an attempt
        var isCorrect = false;
        var feedback = '';
        if (quizState.attemptId) {
            try {
                var resp = await fetch('/api/quiz-session?action=respond', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        attemptId: quizState.attemptId,
                        questionId: quizState.currentQuestion.id || quizState.currentQuestion.questionId || '',
                        response: quizState.selectedChoice,
                    }),
                });
                var data = await resp.json();
                isCorrect = data.correct || data.isCorrect || false;
                feedback = data.feedback || data.explanation || '';
                if (data.xpEarned) quizState.xpEarned += data.xpEarned;
            } catch(e) {}
        }

        if (isCorrect) quizState.correct++;

        // Show feedback
        var feedbackEl = document.getElementById('feedback');
        if (feedbackEl) {
            feedbackEl.className = 'feedback ' + (isCorrect ? 'correct' : 'incorrect');
            feedbackEl.innerHTML = (isCorrect ? '<strong><i class="fa-solid fa-check-circle"></i> Correct!</strong>' : '<strong><i class="fa-solid fa-times-circle"></i> Incorrect</strong>') +
                (feedback ? '<p style="margin-top:8px;">' + feedback + '</p>' : '');
        }

        // Highlight selected choice
        document.querySelectorAll('.choice').forEach(function(c) {
            if (c.dataset.id === quizState.selectedChoice) {
                c.classList.add(isCorrect ? 'correct' : 'incorrect');
            }
        });

        // Update score display
        document.querySelector('.quiz-score').innerHTML = '<i class="fa-solid fa-bolt"></i> ' + quizState.xpEarned + ' XP';

        // Show Next button
        btn.innerHTML = '<i class="fa-solid fa-arrow-right"></i> Next Question';
        btn.disabled = false;
        btn.onclick = function() { loadNextQuestion(); };
    }

    function showResults() {
        var pct = quizState.total > 0 ? Math.round((quizState.correct / quizState.total) * 100) : 0;
        var passed = pct >= 90;
        var noXp = pct < 80;

        // Calculate XP: no XP below 80% accuracy
        if (noXp) quizState.xpEarned = 0;

        area.innerHTML = '<div class="result-card">' +
            '<div style="font-size:3rem;margin-bottom:8px;">' + (passed ? 'üéâ' : pct >= 80 ? 'üëç' : 'üìù') + '</div>' +
            '<div class="result-score">' + pct + '%</div>' +
            '<div class="result-label">' + (passed ? 'Mastery Achieved!' : pct >= 80 ? 'Good Work!' : 'Keep Practicing') + '</div>' +
            '<div class="xp-badge"><i class="fa-solid fa-bolt"></i> ' + quizState.xpEarned + ' XP earned' + (noXp ? ' (need ‚â•80% for XP)' : '') + '</div>' +
            '<div class="result-details">' +
                '<div class="result-stat"><div class="result-stat-val" style="color:#2E7D32;">' + quizState.correct + '</div><div class="result-stat-label">Correct</div></div>' +
                '<div class="result-stat"><div class="result-stat-val">' + (quizState.total - quizState.correct) + '</div><div class="result-stat-label">Incorrect</div></div>' +
                '<div class="result-stat"><div class="result-stat-val">' + quizState.total + '</div><div class="result-stat-label">Questions</div></div>' +
                '<div class="result-stat"><div class="result-stat-val" style="color:' + (passed ? '#2E7D32' : pct >= 80 ? '#F9A825' : '#E53E3E') + ';">' + pct + '%</div><div class="result-stat-label">Accuracy</div></div>' +
            '</div>' +
            (passed ? '<div style="margin-top:16px;padding:12px 20px;background:#E8F5E9;border-radius:10px;color:#1B5E20;font-size:0.9rem;"><i class="fa-solid fa-check-circle" style="margin-right:6px;"></i>This lesson is now marked as complete. You can proceed to the next lesson.</div>' : '') +
            (!passed && pct >= 80 ? '<div style="margin-top:16px;font-size:0.88rem;color:var(--color-text-muted);">Need ‚â•90% for mastery. You earned XP but need <strong>' + (90 - pct) + '% more</strong> to advance.</div>' : '') +
            (!passed && pct < 80 ? '<div style="margin-top:16px;font-size:0.88rem;color:#E53E3E;">Below 80% ‚Äî no XP awarded. Review the material and try again.</div>' : '') +
            '<div style="margin-top:24px;display:flex;gap:12px;justify-content:center;">' +
                (passed ? '<button class="quiz-btn quiz-btn-primary" onclick="history.back()"><i class="fa-solid fa-arrow-right"></i> Continue to Next Lesson</button>' : '<button class="quiz-btn quiz-btn-primary" onclick="location.reload()"><i class="fa-solid fa-redo"></i> Try Again</button>') +
                '<button class="quiz-btn quiz-btn-secondary" onclick="history.back()"><i class="fa-solid fa-arrow-left"></i> Back to Course</button>' +
            '</div>' +
        '</div>';

        // Finalize the attempt
        if (quizState.attemptId) {
            fetch('/api/quiz-session?action=finalize', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({attemptId: quizState.attemptId}),
            }).catch(function(){});
        }

        // Auto-mark lesson as complete if mastery achieved
        if (passed) {
            var params = new URLSearchParams(window.location.search);
            var lessonTitle = params.get('title') || '';
            var lessonId = params.get('id') || params.get('testId') || '';
            if (lessonTitle || lessonId) {
                localStorage.setItem('completed_' + (lessonId || lessonTitle), 'true');
            }
        }
    }

    // ‚îÄ‚îÄ Fallback: load all questions at once from QTI (when PowerPath adaptive fails) ‚îÄ‚îÄ
    async function loadAllQuestions(qtiUrl, testId) {
        area.innerHTML = '<div class="loading-msg"><div class="loading-spinner"></div>Loading quiz...</div>';
        try {
            var apiUrl = '/api/qti-item?';
            if (qtiUrl) apiUrl += 'url=' + encodeURIComponent(qtiUrl);
            else apiUrl += 'id=' + encodeURIComponent(testId) + '&type=assessment';
            var resp = await fetch(apiUrl);
            var result = await resp.json();
            if (!result.success || !result.data) {
                area.innerHTML = '<div class="loading-msg">Could not load quiz.</div>';
                return;
            }
            var data = result.data;

            // Check for stimulus
            var stimulus = data['qti-assessment-stimulus'];
            if (stimulus) {
                var stimBody = stimulus['qti-stimulus-body'] || {};
                area.innerHTML = '<h1 style="font-size:1.3rem;font-weight:700;margin-bottom:16px;">' + esc(data.title || quizState.title) + '</h1>' +
                    '<div class="stimulus-box" style="max-height:none;">' + renderNode(stimBody) + '</div>' +
                    '<div class="quiz-actions"><button class="quiz-btn quiz-btn-secondary" onclick="history.back()"><i class="fa-solid fa-arrow-left"></i> Back to Course</button></div>';
                return;
            }

            // Render questions (from the already-fetched data)
            var questions = data.questions || [];
            if (questions.length > 0) {
                quizState.title = data.title || quizState.title;
                // Use the questions as a static quiz, one at a time
                var allQ = questions.map(function(q) {
                    var qi = q['qti-assessment-item'] || (q.content && q.content['qti-assessment-item']) || q;
                    var attrs = qi['_attributes'] || {};
                    var body = qi['qti-item-body'] || {};
                    var ci = body['qti-choice-interaction'] || {};
                    var prompt = ci['qti-prompt'] || {};
                    var promptText = '';
                    if (prompt.p) promptText = typeof prompt.p === 'string' ? prompt.p : (prompt.p['_'] || renderNode(prompt.p));
                    if (!promptText) {
                        var bc = JSON.parse(JSON.stringify(body));
                        delete bc['qti-choice-interaction'];
                        promptText = renderNode(bc);
                    }
                    var sc = ci['qti-simple-choice'] || [];
                    if (!Array.isArray(sc)) sc = [sc];
                    var choices = sc.map(function(c,i) {
                        var ca = c['_attributes'] || {};
                        var t = c.p ? (typeof c.p === 'string' ? c.p : (c.p['_'] || renderNode(c.p))) : renderNode(c);
                        return { id: ca.identifier || String(i), text: t };
                    });
                    // Get correct answer
                    var rd = qi['qti-response-declaration'] || {};
                    var cr = rd['qti-correct-response'] || {};
                    var correctId = cr['qti-value'] || '';
                    // Get feedback
                    var feedbackMap = {};
                    sc.forEach(function(c) {
                        var ca = c['_attributes'] || {};
                        var fb = c['qti-feedback-inline'] || {};
                        if (fb.span) feedbackMap[ca.identifier] = typeof fb.span === 'string' ? fb.span : renderNode(fb.span);
                    });
                    return { prompt: promptText, choices: choices, correctId: correctId, feedbackMap: feedbackMap };
                });

                // Run static quiz one at a time
                var currentIdx = 0;
                function showStaticQuestion() {
                    if (currentIdx >= allQ.length) { showResults(); return; }
                    var q = allQ[currentIdx];
                    quizState.currentQuestion = q;
                    quizState.selectedChoice = null;
                    quizState.answered = false;
                    quizState.questionNum = currentIdx + 1;

                    var qData = {
                        prompt: q.prompt,
                        choices: q.choices.map(function(c) { return { id: c.id, text: c.text }; }),
                    };
                    renderQuestion(qData);

                    // Override submit to handle locally
                    document.getElementById('submit-btn').onclick = function() {
                        if (!quizState.selectedChoice || quizState.answered) return;
                        quizState.answered = true;
                        quizState.total++;
                        var isCorrect = quizState.selectedChoice === q.correctId;
                        if (isCorrect) {
                            quizState.correct++;
                            // XP: 1 XP per minute of focused learning. Estimate ~1 min per question.
                            quizState.xpEarned += 1;
                        }
                        var fb = q.feedbackMap[quizState.selectedChoice] || '';

                        // Highlight correct and incorrect
                        document.querySelectorAll('.choice').forEach(function(c) {
                            if (c.dataset.id === quizState.selectedChoice) c.classList.add(isCorrect ? 'correct' : 'incorrect');
                            if (c.dataset.id === q.correctId) c.classList.add('correct');
                        });

                        // Show feedback
                        var feedbackEl = document.getElementById('feedback');
                        feedbackEl.className = 'feedback ' + (isCorrect ? 'correct' : 'incorrect');
                        feedbackEl.innerHTML = (isCorrect ? '<strong><i class="fa-solid fa-check-circle"></i> Correct!</strong>' : '<strong><i class="fa-solid fa-times-circle"></i> Incorrect</strong>') + (fb ? '<p style="margin-top:8px;">' + fb + '</p>' : '');

                        // Update score displays
                        var acc = Math.round((quizState.correct / quizState.total) * 100);
                        document.querySelector('.quiz-score').innerHTML = '<i class="fa-solid fa-bolt"></i> ' + quizState.xpEarned + ' XP';

                        var btn = document.getElementById('submit-btn');

                        // Check mastery: ‚â•90% accuracy after at least 10 questions = mastery achieved
                        if (quizState.total >= 10 && acc >= 90) {
                            // Award bonus XP for mastery
                            quizState.xpEarned += 5;
                            btn.innerHTML = '<i class="fa-solid fa-trophy"></i> Mastery Achieved! See Results';
                            btn.onclick = function() { showResults(); };
                        } else if (currentIdx + 1 >= allQ.length) {
                            // End of questions
                            btn.innerHTML = '<i class="fa-solid fa-flag-checkered"></i> See Results';
                            btn.onclick = function() { showResults(); };
                        } else {
                            btn.innerHTML = '<i class="fa-solid fa-arrow-right"></i> Next Question';
                            btn.onclick = function() { currentIdx++; showStaticQuestion(); };
                        }
                    };
                }
                showStaticQuestion();
            } else {
                // Raw content display
                area.innerHTML = '<h1 style="font-size:1.3rem;font-weight:700;margin-bottom:16px;">' + esc(data.title || quizState.title) + '</h1>' +
                    '<div class="stimulus-box" style="max-height:none;">' + renderNode(data) + '</div>' +
                    '<div class="quiz-actions"><button class="quiz-btn quiz-btn-secondary" onclick="history.back()"><i class="fa-solid fa-arrow-left"></i> Back</button></div>';
            }
        } catch(e) {
            area.innerHTML = '<div class="loading-msg">Error: ' + esc(e.message) + '</div>';
        }
    }
    </script>
</body>
</html>
