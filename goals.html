<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Goals</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .goals-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:40px}
        .gc{background:var(--color-surface);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);transition:all var(--transition)}
        .gc:hover{box-shadow:var(--shadow-md);transform:translateY(-2px)}
        .gc-b{padding:20px}
        .gc-name{font-weight:600;font-size:1rem;color:var(--color-text);margin-bottom:12px}
        .gc-done{font-size:.85rem;color:var(--color-text-secondary);margin-bottom:14px;display:flex;align-items:center;gap:6px}
        .gc-done strong{color:var(--color-primary);font-weight:700}
        .gc-goal{background:#E8F5E9;border-radius:8px;padding:12px 16px;margin-bottom:14px}
        .gc-goal-text{font-size:.88rem;color:#2E7D32;font-weight:600;display:flex;align-items:center;gap:8px}
        .gc-goal-pace{font-size:.8rem;color:#388E3C;margin-top:4px}
        .gc-lbl{display:block;font-size:.72rem;font-weight:600;color:var(--color-text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
        .gc-inp{width:100%;padding:9px 12px;border:1px solid var(--color-border);border-radius:8px;background:var(--color-surface);color:var(--color-text);font-size:.88rem;outline:none;transition:border-color var(--transition)}
        .gc-inp:focus{border-color:var(--color-primary)}
        .gc-chk{display:flex;align-items:center;gap:8px;margin:10px 0 14px;font-size:.82rem;color:var(--color-text-secondary);cursor:pointer}
        .gc-chk input{width:16px;height:16px;accent-color:var(--color-primary);cursor:pointer}
        .gc-fld{margin-bottom:12px}
        .gc-2{display:flex;gap:10px}.gc-2 .gc-fld{flex:1}
        .gc-preview{background:var(--color-primary-light);border-radius:8px;padding:10px 14px;font-size:.85rem;color:var(--color-primary-dark);font-weight:500;margin-bottom:14px;display:none;align-items:center;gap:8px}
        .gc-preview.show{display:flex}
        .gc-preview i{flex-shrink:0}
        .btn-c{width:100%;padding:11px;background:var(--color-primary);color:#fff;border:none;border-radius:8px;font-weight:600;font-size:.9rem;cursor:pointer;transition:background var(--transition);display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-c:hover{background:var(--color-primary-dark)}
        .btn-x{width:100%;padding:8px;background:transparent;color:var(--color-text-muted);border:1px solid var(--color-border);border-radius:8px;font-weight:500;font-size:.82rem;cursor:pointer;margin-top:8px;transition:all var(--transition)}
        .btn-x:hover{background:#FFEBEE;color:#C62828;border-color:#FFCDD2}
        .empty-s{grid-column:1/-1;text-align:center;padding:48px 20px;color:var(--color-text-muted);font-size:.9rem}
        .toast{position:fixed;bottom:24px;right:24px;background:var(--color-text);color:#fff;padding:14px 24px;border-radius:var(--radius-sm);font-size:.9rem;font-weight:500;box-shadow:var(--shadow-lg);z-index:300;transform:translateY(100px);opacity:0;transition:all .3s ease}
        .toast.show{transform:translateY(0);opacity:1}
        .sec-head{display:flex;align-items:center;gap:10px;font-size:1.1rem;font-weight:700;color:var(--color-text);margin-bottom:16px}
        .sec-head i{color:var(--color-primary)}
        @media(max-width:1200px){.goals-grid{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:768px){.goals-grid{grid-template-columns:1fr}}
    </style>
</head>
<body data-view="student" data-active="goals">
<div class="layout">
    <nav class="sidebar" id="sidebar"></nav>
    <main class="main-content">
        <h1 class="welcome-heading">Goals</h1>

        <div class="sec-head"><i class="fa-solid fa-layer-group"></i> AP Courses</div>
        <div class="goals-grid" id="lg">
            <div class="gc" style="pointer-events:none"><div class="course-card-image skeleton" style="height:130px;border-radius:12px 12px 0 0"></div><div class="gc-b"><div class="skeleton skeleton-text" style="width:60%;margin-bottom:12px"></div><div class="skeleton skeleton-text sm" style="width:40%;margin-bottom:14px"></div><div class="skeleton skeleton-rect" style="height:38px;border-radius:8px;margin-bottom:10px"></div><div class="skeleton skeleton-rect" style="height:38px;border-radius:8px"></div></div></div>
            <div class="gc" style="pointer-events:none"><div class="course-card-image skeleton" style="height:130px;border-radius:12px 12px 0 0"></div><div class="gc-b"><div class="skeleton skeleton-text" style="width:50%;margin-bottom:12px"></div><div class="skeleton skeleton-text sm" style="width:35%;margin-bottom:14px"></div><div class="skeleton skeleton-rect" style="height:38px;border-radius:8px;margin-bottom:10px"></div><div class="skeleton skeleton-rect" style="height:38px;border-radius:8px"></div></div></div>
        </div>

        <div class="sec-head"><i class="fa-solid fa-bolt"></i> XP Courses</div>
        <div class="goals-grid" id="xg">
            <div class="gc" style="pointer-events:none"><div class="course-card-image skeleton" style="height:130px;border-radius:12px 12px 0 0"></div><div class="gc-b"><div class="skeleton skeleton-text" style="width:55%;margin-bottom:12px"></div><div class="skeleton skeleton-text sm" style="width:40%;margin-bottom:14px"></div><div style="display:flex;gap:10px;margin-bottom:10px"><div class="skeleton skeleton-rect" style="flex:1;height:38px;border-radius:8px"></div><div class="skeleton skeleton-rect" style="flex:1;height:38px;border-radius:8px"></div></div><div class="skeleton skeleton-rect" style="height:38px;border-radius:8px"></div></div></div>
        </div>
    </main>
</div>
<div class="toast" id="toast"></div>
<script src="/js/layout.js"></script>
<script src="/js/app.js"></script>
<script>
const THEMES=['teal','purple','pink','orange'],SKEY='alphalearn_goals';
const NATIVE=['timeback dash','alpha timeback','alphalearn','timeback'];
const TBG={teal:'card-theme-teal',purple:'card-theme-purple',pink:'card-theme-pink',orange:'card-theme-orange'};

function ic(t){t=(t||'').toLowerCase();if(t.includes('math')||t.includes('algebra'))return'fa-calculator';if(t.includes('chem')||t.includes('physics'))return'fa-atom';if(t.includes('bio'))return'fa-dna';if(t.includes('history')||t.includes('social')||t.includes('geo'))return'fa-globe-americas';if(t.includes('read')||t.includes('ela')||t.includes('english'))return'fa-book-open-reader';if(t.includes('code')||t.includes('tech'))return'fa-laptop-code';return'fa-graduation-cap';}

function subImg(t){t=(t||'').toLowerCase();if(t.includes('math')||t.includes('algebra')||t.includes('calculus'))return'/img/subjects/math.png';if(t.includes('chem')||t.includes('physics'))return'/img/subjects/science.png';if(t.includes('bio'))return'/img/subjects/biology.png';if(t.includes('read')||t.includes('ela')||t.includes('english'))return'/img/subjects/reading.png';if(t.includes('lang')||t.includes('composition')||t.includes('writing'))return'/img/subjects/language.png';if(t.includes('geo')||t.includes('history')||t.includes('social'))return'/img/subjects/geography.png';if(t.includes('code')||t.includes('tech')||t.includes('gumpp'))return'/img/subjects/tech.png';return'/img/subjects/default.png';}

function isAP(t){return /\bAP\b/.test((t||'').trim());}
function isTimeback(c){
    const a=(c.appName||'').toLowerCase().trim();
    if(!a)return true;
    if(NATIVE.some(n=>a.includes(n)||n.includes(a)))return true;
    if(/^pp/i.test(a)||a.includes('powerpath'))return true;
    return false;
}
function isLesson(c){return isAP(c.title)&&isTimeback(c);}

let ALL=[],XP={},MASTERED={};
function ld(){try{return JSON.parse(localStorage.getItem(SKEY))||{};}catch{return{};}}
function sv(g){localStorage.setItem(SKEY,JSON.stringify(g));}
function toast(m){const e=document.getElementById('toast');e.textContent=m;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),2500);}
function fmtD(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function fmtNice(s){return new Date(s+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}

function holidays(y){const h=[];const s1=new Date(y,8,1);h.push(fmtD(new Date(y,8,1+((8-s1.getDay())%7))));h.push(`${y}-11-11`);const n1=new Date(y,10,1);const th=new Date(y,10,1+((11-n1.getDay())%7)+21);h.push(fmtD(th));const tf=new Date(th);tf.setDate(tf.getDate()+1);h.push(fmtD(tf));for(let d=23;d<=31;d++)h.push(`${y}-12-${String(d).padStart(2,'0')}`);for(let d=1;d<=3;d++)h.push(`${y+1}-01-${String(d).padStart(2,'0')}`);const j1=new Date(y+1,0,1);h.push(fmtD(new Date(y+1,0,1+((8-j1.getDay())%7)+14)));const f1=new Date(y+1,1,1);h.push(fmtD(new Date(y+1,1,1+((8-f1.getDay())%7)+14)));const m1=new Date(y+1,2,1);const sb=new Date(y+1,2,1+((8-m1.getDay())%7)+14);for(let i=0;i<5;i++){const dd=new Date(sb);dd.setDate(dd.getDate()+i);h.push(fmtD(dd));}const may31=new Date(y+1,4,31);h.push(fmtD(new Date(y+1,4,31-((may31.getDay()+6)%7))));return new Set(h);}
function cntDays(end,excl){const t=new Date();t.setHours(0,0,0,0);const e=new Date(end+'T00:00:00');if(e<=t)return{total:0,school:0};const hs=new Set();if(excl){for(let y=t.getFullYear()-1;y<=e.getFullYear();y++)for(const h of holidays(y))hs.add(h);}let tot=0,sch=0;const c=new Date(t);c.setDate(c.getDate()+1);while(c<=e){tot++;const dow=c.getDay();if(excl){if(dow!==0&&dow!==6&&!hs.has(fmtD(c)))sch++;}else sch=tot;c.setDate(c.getDate()+1);}return{total:tot,school:sch};}

/* ---- AP LESSON CARD ---- */
function lessonCard(c,i){
    const th=THEMES[i%4],g=ld()[c._goalKey]||{},has=!!g.endDate;
    const done=MASTERED[i]||0;
    const tgt=g.target||0;

    let goalHtml='';
    if(has&&tgt>0){
        const rem=Math.max(tgt-done,0);
        const excl=g.excludeNonSchoolDays!==false;
        const d=cntDays(g.endDate,excl);
        const eff=d.school||1;
        const lpd=rem>0?(rem/eff):0;
        const dayT=excl?'school day':'day';
        const pct=tgt>0?Math.min((done/tgt)*100,100):0;
        goalHtml=`
            <div class="gc-goal">
                <div class="gc-goal-text"><i class="fa-solid fa-circle-check"></i> ${done} / ${tgt} lessons by ${fmtNice(g.endDate)}</div>
                <div class="gc-goal-pace">${rem>0&&d.school>0?`~${lpd.toFixed(1)} lessons/${dayT} needed &middot; ${d.school} ${dayT}s left`:(rem<=0?'Goal complete!':'Past due')}</div>
            </div>`;
    }

    return `<div class="gc" data-i="${i}" data-k="${c._goalKey}">
        <div class="course-card-image" style="background:#EBF0F9;display:flex;align-items:center;justify-content:center;overflow:hidden;height:130px;"><img src="${subImg(c.title)}" alt="${c.title}" style="width:100%;height:100%;object-fit:cover;"></div>
        <div class="gc-b">
            <div class="gc-name">${c.title}</div>
            <div class="gc-done"><i class="fa-solid fa-check-circle"></i> <strong>${done}</strong> lessons completed</div>
            ${goalHtml}
            <div class="gc-2">
                <div class="gc-fld"><label class="gc-lbl">Total Lessons</label><input type="number" class="gc-inp gl-tgt" min="1" value="${g.target||''}" placeholder="e.g. 100" oninput="previewL(${i})"></div>
                <div class="gc-fld"><label class="gc-lbl">Finish By</label><input type="date" class="gc-inp gl-date" value="${g.endDate||''}" min="${fmtD(new Date())}" onchange="previewL(${i})"></div>
            </div>
            <label class="gc-chk"><input type="checkbox" class="gl-sch" ${(g.excludeNonSchoolDays!==false)?'checked':''} onchange="previewL(${i})"> School days only</label>
            <div class="gc-preview" id="pv-${i}"><i class="fa-solid fa-calculator"></i><span id="pvt-${i}"></span></div>
            <button class="btn-c" id="cb-${i}" style="${has?'':'display:none'}" onclick="saveL(${i})"><i class="fa-solid fa-check"></i> ${has?'Update':'Set'} Goal</button>
            ${has?`<button class="btn-x" onclick="clearG(${i})"><i class="fa-solid fa-xmark"></i> Clear Goal</button>`:''}
        </div></div>`;
}

/* ---- XP CARD ---- */
function xpCard(c,i){
    const th=THEMES[i%4],g=ld()[c._goalKey]||{},has=!!g.type;
    const xpE=Math.round(XP[i]||0),tgt=g.target||0;
    let goalHtml='';
    if(has&&g.endDate){
        const excl=g.excludeNonSchoolDays!==false,d=cntDays(g.endDate,excl),eff=d.school||1;
        const rem=Math.max(tgt-xpE,0),xpd=rem>0?Math.round(rem/eff):0,dayT=excl?'school day':'day';
        goalHtml=`<div class="gc-goal"><div class="gc-goal-text"><i class="fa-solid fa-circle-check"></i> ${xpE} / ${tgt} XP by ${fmtNice(g.endDate)}</div><div class="gc-goal-pace">${rem>0&&d.school>0?'~'+xpd+' XP/'+dayT+' needed':(rem<=0?'Goal reached!':'Past due')}</div></div>`;
    }
    return `<div class="gc" data-i="${i}" data-k="${c._goalKey}">
        <div class="course-card-image" style="background:#EBF0F9;display:flex;align-items:center;justify-content:center;overflow:hidden;height:130px;"><img src="${subImg(c.title)}" alt="${c.title}" style="width:100%;height:100%;object-fit:cover;"></div>
        <div class="gc-b">
            <div class="gc-name">${c.title}</div>
            <div class="gc-done"><i class="fa-solid fa-bolt"></i> <strong>${xpE}</strong> XP earned</div>
            ${goalHtml}
            <div class="gc-2"><div class="gc-fld"><label class="gc-lbl">Target XP</label><input type="number" class="gc-inp gx-tgt" min="1" value="${g.target||''}" placeholder="e.g. 500"></div>
            <div class="gc-fld"><label class="gc-lbl">Finish By</label><input type="date" class="gc-inp gx-date" value="${g.endDate||''}" min="${fmtD(new Date())}"></div></div>
            <label class="gc-chk"><input type="checkbox" class="gx-sch" ${(g.excludeNonSchoolDays!==false)?'checked':''} > School days only</label>
            <button class="btn-c" onclick="saveXP(${i})"><i class="fa-solid fa-check"></i> ${has?'Update':'Set'} Goal</button>
            ${has?`<button class="btn-x" onclick="clearG(${i})"><i class="fa-solid fa-xmark"></i> Clear Goal</button>`:''}
        </div></div>`;
}

/* ---- ACTIONS ---- */
function previewL(i){
    const card=document.querySelector(`.gc[data-i="${i}"]`);
    const tgt=parseInt(card.querySelector('.gl-tgt').value)||0;
    const dt=card.querySelector('.gl-date').value;
    const excl=card.querySelector('.gl-sch').checked;
    const pv=document.getElementById('pv-'+i),pvt=document.getElementById('pvt-'+i),btn=document.getElementById('cb-'+i);
    const done=MASTERED[i]||0;
    if(!tgt||!dt){pv.classList.remove('show');btn.style.display='none';return;}
    const rem=Math.max(tgt-done,0),d=cntDays(dt,excl),dayT=excl?'school day':'day';
    if(d.school<=0)pvt.textContent='That date has passed.';
    else if(rem<=0)pvt.textContent='Already done!';
    else{const lpd=(rem/d.school).toFixed(1);pvt.innerHTML=`~${lpd} lessons/${dayT} &middot; ${d.school} ${dayT}s left`;}
    pv.classList.add('show');btn.style.display='';
}
function saveL(i){
    const card=document.querySelector(`.gc[data-i="${i}"]`);
    const tgt=parseInt(card.querySelector('.gl-tgt').value)||0;
    const dt=card.querySelector('.gl-date').value;
    if(!tgt){toast('Enter total lessons.');return;}if(!dt){toast('Pick a date.');return;}
    const excl=card.querySelector('.gl-sch').checked;
    const g=ld();g[card.dataset.k]={type:'lessons',target:tgt,endDate:dt,excludeNonSchoolDays:excl};sv(g);
    toast('Goal saved!');render();
}
function saveXP(i){
    const card=document.querySelector(`.gc[data-i="${i}"]`);
    const tgt=parseInt(card.querySelector('.gx-tgt').value)||0;
    const dt=card.querySelector('.gx-date').value;
    if(!tgt){toast('Enter target XP.');return;}if(!dt){toast('Pick a date.');return;}
    const excl=card.querySelector('.gx-sch').checked;
    const g=ld();g[card.dataset.k]={type:'xp',target:tgt,endDate:dt,excludeNonSchoolDays:excl};sv(g);
    toast('Goal saved!');render();
}
function clearG(i){const card=document.querySelector(`.gc[data-i="${i}"]`);const g=ld();delete g[card.dataset.k];sv(g);toast('Cleared.');render();}

/* ---- RENDER ---- */
function render(){
    const lc=[],xc=[];ALL.forEach((c,i)=>{if(isLesson(c))lc.push({c,i});else xc.push({c,i});});
    document.getElementById('lg').innerHTML=lc.length?lc.map(({c,i})=>lessonCard(c,i)).join(''):'<div class="empty-s">No AP courses found.</div>';
    document.getElementById('xg').innerHTML=xc.length?xc.map(({c,i})=>xpCard(c,i)).join(''):'<div class="empty-s">No XP courses found.</div>';
}

/* ---- DATA ---- */
document.addEventListener('DOMContentLoaded',async function(){
    const email=localStorage.getItem('alphalearn_email')||'';
    if(!email){document.getElementById('lg').innerHTML='<div class="empty-s">Please <a href="/login" style="color:var(--color-primary)">sign in</a>.</div>';document.getElementById('xg').innerHTML='';return;}
    try{
        const lu=await(await fetch(`/api/user-lookup?email=${encodeURIComponent(email)}`)).json();
        if(!lu.user||!lu.user.sourcedId){document.getElementById('lg').innerHTML='<div class="empty-s">Account not found.</div>';document.getElementById('xg').innerHTML='';return;}
        const uid=lu.user.sourcedId;localStorage.setItem('alphalearn_userId',uid);
        const ed=await(await fetch(`/api/enrollments?userId=${uid}`)).json();
        const raw=ed.data||ed.enrollments||ed.courses||(Array.isArray(ed)?ed:[]);
        const now=new Date(),courses=[];
        for(const e of raw){
            const co=e.course||{},cm=co.metadata||{},gl=(e.metadata&&e.metadata.goals)||{};
            const mt=(e.metadata&&e.metadata.metrics)||{},cmt=cm.metrics||{};
            const ti=(co.title||'').trim(),su=co.subjects||[],eD=e.endDate?new Date(e.endDate):null;
            if(eD&&eD<now)continue;if(!ti||ti.startsWith('Manual XP')||ti.includes('Hole-Filling')||!su.length)continue;
            if(mt.courseType==='mastery_test'||mt.courseType==='mastery-test'||mt.courseType==='masteryTest'||(ti.toLowerCase().includes('mastery')&&ti.toLowerCase().includes('test')))continue;
            const pA=co.primaryApp||{},an=(typeof pA==='object'?pA.name:'')||cm.primaryApp||cm.app||'';
            const totalLessons=mt.totalLessons||cmt.totalLessons||cm.totalLessons||0;
            const totalXp=mt.totalXp||cmt.totalXp||cm.totalXp||0;
            courses.push({title:ti,subject:su[0]||'',appName:an,totalXp,totalLessons,dailyXpGoal:gl.dailyXp||0,_goalKey:e.sourcedId||co.sourcedId||ti,_raw:e,_course:co});
        }
        ALL=courses;
        // Fetch analytics for XP + mastered units
        const soy=new Date(now.getFullYear(),7,1);if(soy>now)soy.setFullYear(soy.getFullYear()-1);
        try{
            const ad=await(await fetch(`/api/analytics?email=${encodeURIComponent(email)}&startDate=${fmtD(soy)}T00:00:00Z&endDate=${fmtD(now)}T23:59:59Z`)).json();
            const fba=ad.factsByApp||{},fa=ad.facts||{};
            const xm={};for(const dd of Object.values(fba))for(const[s,apps]of Object.entries(dd)){if(!xm[s])xm[s]={};for(const[a,info]of Object.entries(apps)){const x=(info.activityMetrics||{}).xpEarned||0;xm[s][a.toLowerCase()]=(xm[s][a.toLowerCase()]||0)+x;}}
            const xs={},mu={};
            for(const df of Object.values(fa))for(const[s,info]of Object.entries(df)){const am=info.activityMetrics||{};xs[s]=(xs[s]||0)+(am.xpEarned||0);mu[s]=(mu[s]||0)+(am.masteredUnits||am.lessonsCompleted||am.completedLessons||0);}
            for(let i=0;i<ALL.length;i++){
                const c=ALL[i],sa=xm[c.subject]||{},an=(c.appName||'').toLowerCase();
                if(an&&Object.keys(sa).length){let m=sa[an]||0;if(!m){const n=an.replace(/_/g,' ');for(const[k,x]of Object.entries(sa))if(k===n||k.includes(n)||n.includes(k)){m=x;break;}}XP[i]=m;}
                else if(!an&&Object.keys(sa).length){let t=0;for(const x of Object.values(sa))t+=x;XP[i]=t||xs[c.subject]||0;}
                else XP[i]=xs[c.subject]||0;
                MASTERED[i]=mu[c.subject]||0;
            }
        }catch(e){console.warn('[AlphaLearn] Analytics:',e.message);}
        render();
    }catch(e){document.getElementById('lg').innerHTML='<div class="empty-s">Unable to load data.</div>';document.getElementById('xg').innerHTML='';console.error(e);}
});
</script>
</body>
</html>
