<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Goals</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .section-heading { display:flex; align-items:center; gap:10px; font-size:1.15rem; font-weight:700; color:var(--color-text); margin-bottom:20px; }
        .section-heading i { color:var(--color-primary); }
        .section-heading .cnt { font-size:0.82rem; font-weight:500; color:var(--color-text-muted); }
        .goals-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:20px; margin-bottom:40px; }
        .goal-card { background:var(--color-surface); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); transition:all var(--transition); }
        .goal-card:hover { box-shadow:var(--shadow-md); transform:translateY(-2px); }
        .gc-body { padding:18px; }
        .gc-name { font-weight:600; font-size:0.95rem; color:var(--color-text); margin-bottom:2px; }
        .gc-sub { font-size:0.8rem; color:var(--color-text-secondary); margin-bottom:14px; }
        .gc-row { display:flex; justify-content:space-between; align-items:baseline; margin-bottom:6px; }
        .gc-prog { font-weight:700; font-size:0.95rem; color:var(--color-text); }
        .gc-badge { font-size:0.72rem; font-weight:600; padding:2px 8px; border-radius:12px; }
        .gc-badge.on-track { background:#E8F5E9; color:#2E7D32; }
        .gc-badge.behind { background:var(--color-orange-light); color:#E65100; }
        .gc-badge.at-risk { background:#FFEBEE; color:#C62828; }
        .gc-badge.none { background:var(--color-bg); color:var(--color-text-muted); }
        .gc-bar { height:6px; background:var(--color-bg); border-radius:3px; overflow:hidden; margin-bottom:14px; }
        .gc-fill { height:100%; border-radius:3px; transition:width .5s ease; }
        .gc-fill.on-track { background:var(--color-primary); }
        .gc-fill.behind { background:var(--color-orange); }
        .gc-fill.at-risk { background:#E53E3E; }
        .gc-fill.none { background:var(--color-border); }
        .gc-pace { background:var(--color-primary-light); border-radius:8px; padding:10px 14px; font-size:0.85rem; color:var(--color-primary-dark); font-weight:500; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
        .gc-pace i { font-size:.95rem; flex-shrink:0; }
        .gc-label { display:block; font-size:0.72rem; font-weight:600; color:var(--color-text-secondary); text-transform:uppercase; letter-spacing:.5px; margin-bottom:5px; }
        .gc-input { width:100%; padding:8px 12px; border:1px solid var(--color-border); border-radius:6px; background:var(--color-surface); color:var(--color-text); font-size:.88rem; outline:none; transition:border-color var(--transition); }
        .gc-input:focus { border-color:var(--color-primary); }
        .gc-check { display:flex; align-items:center; gap:8px; margin:10px 0 12px; font-size:.82rem; color:var(--color-text-secondary); cursor:pointer; }
        .gc-check input { width:16px; height:16px; accent-color:var(--color-primary); cursor:pointer; }
        .gc-field { margin-bottom:10px; }
        .gc-2col { display:flex; gap:10px; }
        .gc-2col .gc-field { flex:1; }
        .btn-confirm { width:100%; padding:10px; background:var(--color-primary); color:#fff; border:none; border-radius:8px; font-weight:600; font-size:.9rem; cursor:pointer; transition:background var(--transition); display:flex; align-items:center; justify-content:center; gap:8px; }
        .btn-confirm:hover { background:var(--color-primary-dark); }
        .btn-clear { width:100%; padding:8px; background:transparent; color:var(--color-text-muted); border:1px solid var(--color-border); border-radius:8px; font-weight:500; font-size:.82rem; cursor:pointer; margin-top:6px; transition:all var(--transition); }
        .btn-clear:hover { background:#FFEBEE; color:#C62828; border-color:#FFCDD2; }
        .gc-saved { background:#E8F5E9; border-radius:8px; padding:10px 14px; font-size:.85rem; color:#2E7D32; font-weight:600; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
        .gc-saved i { font-size:.95rem; }
        .empty-s { grid-column:1/-1; text-align:center; padding:40px 20px; color:var(--color-text-muted); font-size:.9rem; }
        .toast { position:fixed; bottom:24px; right:24px; background:var(--color-text); color:#fff; padding:14px 24px; border-radius:var(--radius-sm); font-size:.9rem; font-weight:500; box-shadow:var(--shadow-lg); z-index:300; transform:translateY(100px); opacity:0; transition:all .3s ease; }
        .toast.show { transform:translateY(0); opacity:1; }
        @media (max-width:1200px) { .goals-grid { grid-template-columns:repeat(2,1fr); } }
        @media (max-width:768px) { .goals-grid { grid-template-columns:1fr; } }
    </style>
</head>
<body data-view="student" data-active="goals">
<div class="layout">
    <nav class="sidebar" id="sidebar"></nav>
    <main class="main-content">
        <h1 class="welcome-heading">Goals</h1>
        <div id="lesson-section">
            <div class="section-heading"><i class="fa-solid fa-layer-group"></i> Lesson Courses <span class="cnt" id="lc"></span></div>
            <div class="goals-grid" id="lg"><div class="empty-s"><div class="loading-spinner" style="margin:0 auto 12px;"></div>Loading courses...</div></div>
        </div>
        <div id="xp-section">
            <div class="section-heading"><i class="fa-solid fa-bolt"></i> XP Courses <span class="cnt" id="xc"></span></div>
            <div class="goals-grid" id="xg"><div class="empty-s"><div class="loading-spinner" style="margin:0 auto 12px;"></div>Loading courses...</div></div>
        </div>
    </main>
</div>
<div class="toast" id="toast"></div>
<script src="/js/layout.js"></script>
<script src="/js/app.js"></script>
<script>
const THEMES=['teal','purple','pink','orange'];
const TBG={teal:'card-theme-teal',purple:'card-theme-purple',pink:'card-theme-pink',orange:'card-theme-orange'};
const NATIVE_APPS=['timeback dash','alpha timeback','alphalearn','timeback'];
const SKEY='alphalearn_goals';

function icon(t){t=(t||'').toLowerCase();if(t.includes('math')||t.includes('algebra')||t.includes('calculus'))return'fa-calculator';if(t.includes('chem')||t.includes('physics'))return'fa-atom';if(t.includes('bio'))return'fa-dna';if(t.includes('read')||t.includes('ela')||t.includes('english'))return'fa-book-open-reader';if(t.includes('lang')||t.includes('composition')||t.includes('writing'))return'fa-book-open';if(t.includes('geo')||t.includes('history')||t.includes('social'))return'fa-globe-americas';if(t.includes('code')||t.includes('tech')||t.includes('gumpp'))return'fa-laptop-code';return'fa-graduation-cap';}

/* Course with totalLessons > 0 = lesson-based goal. Period. */
function isLessonCourse(c){ return (c.totalLessons||0)>0; }

let ALL=[], XP={};
function ld(){try{return JSON.parse(localStorage.getItem(SKEY))||{};}catch{return{};}}
function sv(g){localStorage.setItem(SKEY,JSON.stringify(g));}
function toast(m){const e=document.getElementById('toast');e.textContent=m;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),2500);}

function fmtD(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function fmtNice(s){const d=new Date(s+'T00:00:00');return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}

function holidays(y){const h=[];const s1=new Date(y,8,1);h.push(fmtD(new Date(y,8,1+((8-s1.getDay())%7))));h.push(`${y}-11-11`);const n1=new Date(y,10,1);const th=new Date(y,10,1+((11-n1.getDay())%7)+21);h.push(fmtD(th));const tf=new Date(th);tf.setDate(tf.getDate()+1);h.push(fmtD(tf));for(let d=23;d<=31;d++)h.push(`${y}-12-${String(d).padStart(2,'0')}`);for(let d=1;d<=3;d++)h.push(`${y+1}-01-${String(d).padStart(2,'0')}`);const j1=new Date(y+1,0,1);h.push(fmtD(new Date(y+1,0,1+((8-j1.getDay())%7)+14)));const f1=new Date(y+1,1,1);h.push(fmtD(new Date(y+1,1,1+((8-f1.getDay())%7)+14)));const m1=new Date(y+1,2,1);const sb=new Date(y+1,2,1+((8-m1.getDay())%7)+14);for(let i=0;i<5;i++){const dd=new Date(sb);dd.setDate(dd.getDate()+i);h.push(fmtD(dd));}const may31=new Date(y+1,4,31);h.push(fmtD(new Date(y+1,4,31-((may31.getDay()+6)%7))));return new Set(h);}

function cntDays(end,excl){const t=new Date();t.setHours(0,0,0,0);const e=new Date(end+'T00:00:00');if(e<=t)return{total:0,school:0};const hs=new Set();if(excl){for(let y=t.getFullYear()-1;y<=e.getFullYear();y++)for(const h of holidays(y))hs.add(h);}let tot=0,sch=0;const c=new Date(t);c.setDate(c.getDate()+1);while(c<=e){tot++;const dow=c.getDay();if(excl){if(dow!==0&&dow!==6&&!hs.has(fmtD(c)))sch++;}else sch=tot;c.setDate(c.getDate()+1);}return{total:tot,school:sch};}

/* ---- Lesson card ---------------------------------------------------- */
function lessonCard(c,i){
    const th=THEMES[i%4],ic=icon(c.title),g=ld()[c._goalKey]||{},has=!!g.endDate;
    const tXp=c.totalXp||1,tL=c.totalLessons,xpE=XP[i]||0;
    const xpPer=tL>0?tXp/tL:0;
    const done=tL>0?Math.min(Math.round((xpE/tXp)*tL),tL):0;
    const rem=Math.max(tL-done,0);
    const pct=tL>0?Math.min((done/tL)*100,100):0;

    let statusCls='none',statusLbl='',paceHtml='',savedHtml='';
    if(has){
        const excl=g.excludeNonSchoolDays!==false;
        const d=cntDays(g.endDate,excl);
        const eff=d.school||1;
        const lpd=rem>0?(rem/eff):0;
        const xpd=Math.round(lpd*xpPer);
        const dayT=excl?'school day':'day';
        if(rem<=0){statusCls='on-track';statusLbl='Complete';}
        else if(d.school<=0){statusCls='at-risk';statusLbl='Past due';}
        else if(lpd<=1.5){statusCls='on-track';statusLbl='On track';}
        else if(lpd<=3){statusCls='behind';statusLbl='Behind';}
        else{statusCls='at-risk';statusLbl='At risk';}
        const pTxt=rem>0&&d.school>0?`~${lpd.toFixed(1)} lessons/${dayT} (~${xpd} XP/day) &middot; ${d.school} ${dayT}s left`:(rem<=0?'All lessons complete!':'End date has passed.');
        savedHtml=`<div class="gc-saved"><i class="fa-solid fa-circle-check"></i> Goal: finish by ${fmtNice(g.endDate)}${excl?' (school days)':''}</div>`;
        paceHtml=`<div class="gc-pace"><i class="fa-solid fa-calculator"></i><span>${pTxt}</span></div>`;
    }

    return `<div class="goal-card" data-i="${i}" data-k="${c._goalKey}" data-tl="${tL}" data-xpu="${Math.round(xpPer)}" data-rem="${rem}">
        <div class="course-card-image ${TBG[th]}"><div class="course-card-illustration"><i class="fa-solid ${ic}"></i></div></div>
        <div class="gc-body">
            <div class="gc-name">${c.title}</div>
            <div class="gc-sub">${c.subject} &middot; ${tL} lessons</div>
            <div class="gc-row"><span class="gc-prog">${done} / ${tL} lessons</span><span class="gc-badge ${has?statusCls:'none'}">${has?statusLbl:rem+' remaining'}</span></div>
            <div class="gc-bar"><div class="gc-fill ${has?statusCls:'on-track'}" style="width:${pct}%"></div></div>
            ${savedHtml}${paceHtml}
            <div class="gc-field"><label class="gc-label">Complete by</label><input type="date" class="gc-input gd" value="${g.endDate||''}" min="${fmtD(new Date())}" onchange="pickDate(${i})"></div>
            <label class="gc-check"><input type="checkbox" class="gs" ${(g.excludeNonSchoolDays!==false)?'checked':''} onchange="pickDate(${i})"> School days only</label>
            <div id="pv-${i}" style="display:none" class="gc-pace"><i class="fa-solid fa-calculator"></i><span id="pvt-${i}"></span></div>
            <button class="btn-confirm" id="cb-${i}" style="display:none" onclick="confirmL(${i})"><i class="fa-solid fa-check"></i> Confirm Goal</button>
            ${has?`<button class="btn-clear" onclick="clearG(${i})"><i class="fa-solid fa-xmark"></i> Clear Goal</button>`:''}
        </div></div>`;
}

/* ---- XP card -------------------------------------------------------- */
function xpCard(c,i){
    const th=THEMES[i%4],ic=icon(c.title),g=ld()[c._goalKey]||{},has=!!g.type;
    const xpE=Math.round(XP[i]||0),tgt=g.target||0;
    const pct=tgt>0?Math.min((xpE/tgt)*100,100):0;
    const rem=Math.max(tgt-xpE,0);
    let sCls='none',sLbl='No goal',pHtml='';
    if(has&&g.endDate){
        const excl=g.excludeNonSchoolDays!==false;
        const d=cntDays(g.endDate,excl);
        const eff=d.school||1;const xpd=rem>0?Math.round(rem/eff):0;
        const dayT=excl?'school day':'day';
        if(rem<=0){sCls='on-track';sLbl='Done';}
        else if(d.school<=0){sCls='at-risk';sLbl='Past due';}
        else if(xpd<=100){sCls='on-track';sLbl='On track';}
        else if(xpd<=200){sCls='behind';sLbl='Behind';}
        else{sCls='at-risk';sLbl='At risk';}
        pHtml=`<div class="gc-pace"><i class="fa-solid fa-calculator"></i><span>${rem>0&&d.school>0?'~'+xpd+' XP/'+dayT+' &middot; '+d.school+' '+dayT+'s left':(rem<=0?'Goal reached!':'Past due.')}</span></div>`;
    }
    return `<div class="goal-card" data-i="${i}" data-k="${c._goalKey}">
        <div class="course-card-image ${TBG[th]}"><div class="course-card-illustration"><i class="fa-solid ${ic}"></i></div></div>
        <div class="gc-body">
            <div class="gc-name">${c.title}</div>
            <div class="gc-sub">${c.subject} &middot; XP Goal</div>
            <div class="gc-row"><span class="gc-prog">${xpE}${tgt?' / '+tgt:''} XP</span><span class="gc-badge ${sCls}">${sLbl}</span></div>
            <div class="gc-bar"><div class="gc-fill ${has?sCls:'none'}" style="width:${pct}%"></div></div>
            ${pHtml}
            <div class="gc-2col"><div class="gc-field"><label class="gc-label">Target XP</label><input type="number" class="gc-input gt" min="1" value="${g.target||''}" placeholder="e.g. 500" oninput="pvXP(${i})"></div>
            <div class="gc-field"><label class="gc-label">End Date</label><input type="date" class="gc-input gd" value="${g.endDate||''}" min="${fmtD(new Date())}" onchange="pvXP(${i})"></div></div>
            <label class="gc-check"><input type="checkbox" class="gs" ${(g.excludeNonSchoolDays!==false)?'checked':''} onchange="pvXP(${i})"> School days only</label>
            <button class="btn-confirm" onclick="saveXP(${i})"><i class="fa-solid fa-check"></i> ${has?'Update Goal':'Save Goal'}</button>
            ${has?`<button class="btn-clear" onclick="clearG(${i})"><i class="fa-solid fa-xmark"></i> Clear Goal</button>`:''}
        </div></div>`;
}

/* ---- Lesson date pick → preview + confirm --------------------------- */
function pickDate(i){
    const card=document.querySelector(`.goal-card[data-i="${i}"]`);
    const dt=card.querySelector('.gd').value,excl=card.querySelector('.gs').checked;
    const pv=document.getElementById('pv-'+i),pvt=document.getElementById('pvt-'+i),btn=document.getElementById('cb-'+i);
    const rem=+card.dataset.rem,xpu=+card.dataset.xpu;
    if(!dt){pv.style.display='none';btn.style.display='none';return;}
    const d=cntDays(dt,excl),dayT=excl?'school day':'day';
    if(d.school<=0)pvt.textContent='That date has already passed.';
    else if(rem<=0)pvt.textContent='All lessons complete!';
    else{const lpd=(rem/d.school).toFixed(1),xpd=Math.round(lpd*xpu);pvt.innerHTML=`~${lpd} lessons/${dayT} (~${xpd} XP/day) &middot; ${d.school} ${dayT}s left`;}
    pv.style.display='flex';btn.style.display='';
}

function confirmL(i){
    const card=document.querySelector(`.goal-card[data-i="${i}"]`);
    const dt=card.querySelector('.gd').value;if(!dt){toast('Pick a date first.');return;}
    const excl=card.querySelector('.gs').checked,tl=+card.dataset.tl;
    const g=ld();g[card.dataset.k]={type:'lessons',target:tl,endDate:dt,excludeNonSchoolDays:excl};sv(g);
    toast('Goal confirmed!');render();
}

function pvXP(i){
    const card=document.querySelector(`.goal-card[data-i="${i}"]`);
    /* no separate preview for XP — just inline on save */
}

function saveXP(i){
    const card=document.querySelector(`.goal-card[data-i="${i}"]`);
    const tgt=parseInt(card.querySelector('.gt').value)||0,dt=card.querySelector('.gd').value,excl=card.querySelector('.gs').checked;
    if(!tgt||tgt<=0){toast('Enter a target XP.');return;}
    if(!dt){toast('Pick an end date.');return;}
    const g=ld();g[card.dataset.k]={type:'xp',target:tgt,endDate:dt,excludeNonSchoolDays:excl};sv(g);
    toast('Goal saved!');render();
}

function clearG(i){
    const card=document.querySelector(`.goal-card[data-i="${i}"]`);
    const g=ld();delete g[card.dataset.k];sv(g);toast('Goal cleared.');render();
}

function render(){
    const lc=[],xc=[];
    ALL.forEach((c,i)=>{if(isLessonCourse(c))lc.push({c,i});else xc.push({c,i});});
    document.getElementById('lc').textContent=lc.length?`(${lc.length})`:'';
    document.getElementById('lg').innerHTML=lc.length?lc.map(({c,i})=>lessonCard(c,i)).join(''):'<div class="empty-s">No lesson-based courses found.</div>';
    document.getElementById('xc').textContent=xc.length?`(${xc.length})`:'';
    document.getElementById('xg').innerHTML=xc.length?xc.map(({c,i})=>xpCard(c,i)).join(''):'<div class="empty-s">No XP-based courses found.</div>';
}

function localDS(d){return fmtD(d);}

document.addEventListener('DOMContentLoaded',async function(){
    const email=localStorage.getItem('alphalearn_email')||'';
    if(!email){document.getElementById('lg').innerHTML='<div class="empty-s">Please <a href="/login" style="color:var(--color-primary)">sign in</a>.</div>';document.getElementById('xg').innerHTML='';return;}
    try{
        const lu=await(await fetch(`/api/user-lookup?email=${encodeURIComponent(email)}`)).json();
        if(!lu.user||!lu.user.sourcedId){document.getElementById('lg').innerHTML='<div class="empty-s">Account not found.</div>';document.getElementById('xg').innerHTML='';return;}
        const uid=lu.user.sourcedId;localStorage.setItem('alphalearn_userId',uid);
        const ed=await(await fetch(`/api/enrollments?userId=${uid}`)).json();
        const raw=ed.data||ed.enrollments||ed.courses||(Array.isArray(ed)?ed:[]);
        const now=new Date(),courses=[];
        for(const e of raw){
            const co=e.course||{},cm=co.metadata||{},gl=(e.metadata&&e.metadata.goals)||{},mt=(e.metadata&&e.metadata.metrics)||{};
            const ti=(co.title||'').trim(),su=co.subjects||[],eD=e.endDate?new Date(e.endDate):null;
            if(eD&&eD<now)continue;if(!ti||ti.startsWith('Manual XP')||ti.includes('Hole-Filling')||!su.length)continue;
            if(mt.courseType==='mastery_test'||mt.courseType==='mastery-test'||mt.courseType==='masteryTest'||(ti.toLowerCase().includes('mastery')&&ti.toLowerCase().includes('test')))continue;
            const pA=co.primaryApp||{},an=(typeof pA==='object'?pA.name:'')||cm.primaryApp||cm.app||'';
            courses.push({title:ti,subject:su[0]||'',appName:an,totalXp:mt.totalXp||0,totalLessons:mt.totalLessons||0,dailyXpGoal:gl.dailyXp||0,_goalKey:e.sourcedId||co.sourcedId||ti,_raw:e,_course:co});
        }
        ALL=courses;
        const soy=new Date(now.getFullYear(),7,1);if(soy>now)soy.setFullYear(soy.getFullYear()-1);
        const sd=localDS(soy)+'T00:00:00Z',edS=localDS(now)+'T23:59:59Z';
        try{
            const ad=await(await fetch(`/api/analytics?email=${encodeURIComponent(email)}&startDate=${sd}&endDate=${edS}`)).json();
            const fba=ad.factsByApp||{},fa=ad.facts||{};
            const xm={};for(const dd of Object.values(fba))for(const[s,apps]of Object.entries(dd)){if(!xm[s])xm[s]={};for(const[a,info]of Object.entries(apps)){const x=(info.activityMetrics||{}).xpEarned||0;xm[s][a.toLowerCase()]=(xm[s][a.toLowerCase()]||0)+x;}}
            const xs={};for(const df of Object.values(fa))for(const[s,info]of Object.entries(df))xs[s]=(xs[s]||0)+((info.activityMetrics||{}).xpEarned||0);
            for(let i=0;i<ALL.length;i++){const c=ALL[i],sa=xm[c.subject]||{},an=(c.appName||'').toLowerCase();
                if(an&&Object.keys(sa).length){let m=sa[an]||0;if(!m){const n=an.replace(/_/g,' ');for(const[k,x]of Object.entries(sa))if(k===n||k.includes(n)||n.includes(k)){m=x;break;}}XP[i]=m;}
                else if(!an&&Object.keys(sa).length){let nx=0;for(const[k,x]of Object.entries(sa))if(NATIVE_APPS.some(n=>k.includes(n)||n.includes(k)))nx+=x;XP[i]=nx;}
                else XP[i]=xs[c.subject]||0;}
        }catch(e){console.warn('[AlphaLearn] Analytics unavailable:',e.message);}
        render();
    }catch(e){document.getElementById('lg').innerHTML='<div class="empty-s">Unable to load data.</div>';document.getElementById('xg').innerHTML='';console.error(e);}
});
</script>
</body>
</html>
