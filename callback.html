<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn â€“ Signing In...</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body.login-body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }
        .callback-container { width: 100%; max-width: 420px; padding: 2rem; }
        .callback-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 2.5rem 2rem;
            backdrop-filter: blur(12px);
            text-align: center;
        }
        .callback-logo { display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 2rem; }
        .callback-logo .logo-text { font-size: 1.5rem; font-weight: 700; }
        .callback-logo .logo-alpha { color: #45B5AA; }
        .callback-logo .logo-learn { color: #e2e8f0; }

        /* Loading spinner */
        .callback-spinner {
            width: 48px; height: 48px;
            border: 4px solid rgba(69, 181, 170, 0.2);
            border-top-color: #45B5AA;
            border-radius: 50%;
            animation: cb-spin 0.8s linear infinite;
            margin: 0 auto 1.5rem;
        }
        @keyframes cb-spin { to { transform: rotate(360deg); } }

        .callback-status {
            color: #e2e8f0; font-size: 1.1rem; font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .callback-detail {
            color: #94a3b8; font-size: 0.875rem;
        }

        /* Error state */
        .callback-error {
            display: none;
        }
        .callback-error .error-icon {
            width: 48px; height: 48px;
            background: rgba(239, 68, 68, 0.15);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 1.5rem;
            color: #fca5a5; font-size: 1.25rem;
        }
        .callback-error .error-message {
            color: #fca5a5; font-size: 0.9375rem; font-weight: 500;
            margin-bottom: 1.5rem;
        }
        .callback-error .back-link {
            display: inline-block; padding: 0.625rem 1.5rem;
            background: #45B5AA; color: #0f172a;
            border-radius: 0.5rem; font-weight: 600; font-size: 0.9375rem;
            text-decoration: none; transition: background 0.2s;
        }
        .callback-error .back-link:hover { background: #38a89d; }
    </style>
</head>
<body class="login-body">
    <div class="callback-container">
        <div class="callback-card">
            <div class="callback-logo">
                <svg class="logo-bird" width="36" height="36" viewBox="0 0 40 40" fill="none">
                    <path d="M8 28C8 28 12 20 20 16C28 12 36 8 36 8C36 8 34 16 28 22C22 28 16 30 16 30L8 28Z" fill="#45B5AA"/>
                    <path d="M4 32C4 32 8 28 16 30C16 30 12 34 4 32Z" fill="#45B5AA" opacity="0.7"/>
                    <path d="M20 16C20 16 18 24 16 30" stroke="#45B5AA" stroke-width="1.5" fill="none" opacity="0.5"/>
                </svg>
                <span class="logo-text"><span class="logo-alpha">Alpha</span><span class="logo-learn">Learn</span></span>
            </div>

            <!-- Loading State -->
            <div id="loading-state">
                <div class="callback-spinner"></div>
                <p class="callback-status">Signing you in...</p>
                <p class="callback-detail">Completing Google authentication</p>
            </div>

            <!-- Error State (hidden by default) -->
            <div class="callback-error" id="error-state">
                <div class="error-icon"><i class="fa-solid fa-circle-exclamation"></i></div>
                <p class="error-message" id="error-message">Something went wrong.</p>
                <a href="/login" class="back-link">Back to Sign In</a>
            </div>
        </div>
    </div>

    <script>
    /** Store user data and redirect based on role */
    function handleAuthSuccess(user) {
        const displayName = ((user.givenName || '') + ' ' + (user.familyName || '')).trim() || user.email;
        localStorage.setItem('alphalearn_name', displayName);
        localStorage.setItem('alphalearn_email', user.email || '');
        localStorage.setItem('alphalearn_role', user.role || 'student');
        localStorage.setItem('alphalearn_sourcedId', user.sourcedId || '');

        const role = (user.role || '').toLowerCase();
        if (role.includes('admin') || role.includes('administrator')) {
            window.location.href = '/admin';
        } else {
            window.location.href = '/dashboard';
        }
    }

    function showError(msg) {
        document.getElementById('loading-state').style.display = 'none';
        const errorState = document.getElementById('error-state');
        errorState.style.display = 'block';
        document.getElementById('error-message').textContent = msg;
    }

    /* ---- Process OAuth Callback ------------------------------------------ */
    (async function processCallback() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const error = params.get('error');
        const errorDescription = params.get('error_description');

        // Handle Cognito-level errors (e.g. user denied consent)
        if (error) {
            showError(errorDescription || error || 'Authentication was cancelled.');
            return;
        }

        // No code means the user landed here directly
        if (!code) {
            showError('No authorization code found. Please try signing in again.');
            return;
        }

        try {
            const redirectUri = encodeURIComponent(window.location.origin + '/callback');
            const resp = await fetch('/api/auth/callback?code=' + encodeURIComponent(code) + '&redirect_uri=' + redirectUri);
            const data = await resp.json();

            if (!resp.ok || !data.success) {
                showError(data.error || 'Authentication failed. Please try again.');
                return;
            }

            handleAuthSuccess(data.user);
        } catch (err) {
            console.error('[AlphaLearn] Callback error:', err);
            showError('Unable to complete sign-in. Please try again.');
        }
    })();
    </script>
</body>
</html>
