<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Course</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .course-viewer { max-width: 800px; }
        .back-btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px; border: 1px solid var(--color-border);
            border-radius: var(--radius-sm); background: var(--color-surface);
            color: var(--color-text-secondary); font-size: 0.85rem; font-weight: 500;
            cursor: pointer; text-decoration: none; transition: all 0.2s; margin-bottom: 24px;
        }
        .back-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }

        .course-header-card {
            background: var(--color-surface); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 28px; margin-bottom: 24px;
        }
        .course-title { font-size: 1.5rem; font-weight: 700; color: var(--color-text); margin-bottom: 6px; }
        .course-meta { font-size: 0.9rem; color: var(--color-text-secondary); display: flex; gap: 16px; flex-wrap: wrap; }
        .course-meta-item { display: flex; align-items: center; gap: 6px; }
        .course-meta-item i { color: var(--color-primary); }

        .progress-card {
            background: var(--color-surface); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 24px; margin-bottom: 24px;
        }
        .progress-stats {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;
        }
        .progress-stat {
            text-align: center; padding: 16px;
            background: var(--color-bg); border-radius: var(--radius-sm);
        }
        .progress-stat-value { font-size: 1.5rem; font-weight: 700; color: var(--color-primary); display: block; }
        .progress-stat-label {
            font-size: 0.72rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--color-text-muted); margin-top: 4px; display: block;
        }
        .progress-bar-lg { height: 10px; background: var(--color-bg); border-radius: 5px; overflow: hidden; }
        .progress-fill-lg { height: 100%; background: var(--color-primary); border-radius: 5px; transition: width 0.6s ease; }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.82rem; color: var(--color-text-secondary); margin-top: 8px; }

        .content-card {
            background: var(--color-surface); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 24px; margin-bottom: 24px;
        }
        .content-card h2 {
            font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; color: var(--color-text);
        }
        .launch-btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 14px 28px; background: var(--color-primary); color: #fff;
            border: none; border-radius: var(--radius-sm); font-size: 1rem;
            font-weight: 600; cursor: pointer; transition: background 0.2s;
            text-decoration: none;
        }
        .launch-btn:hover { background: var(--color-primary-dark); color: #fff; }
        .launch-btn i { font-size: 1.1rem; }

        .content-placeholder {
            text-align: center; padding: 40px; color: var(--color-text-muted);
        }
        .content-placeholder i { font-size: 3rem; margin-bottom: 16px; display: block; opacity: 0.4; }
        .content-placeholder p { font-size: 0.95rem; margin-bottom: 16px; }

        .metadata-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            font-size: 0.88rem;
        }
        .metadata-item { padding: 10px 14px; background: var(--color-bg); border-radius: var(--radius-sm); }
        .metadata-key { font-weight: 600; color: var(--color-text-secondary); font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 2px; }
        .metadata-val { color: var(--color-text); font-weight: 500; }

        .skeleton { background: linear-gradient(90deg, #E8ECF1 25%, #F4F6F9 50%, #E8ECF1 75%); background-size: 200% 100%; animation: skeleton-pulse 1.5s ease-in-out infinite; border-radius: 4px; }
        @keyframes skeleton-pulse { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        @media (max-width: 768px) {
            .progress-stats { grid-template-columns: 1fr; }
            .metadata-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body data-view="student" data-active="home">

    <div class="layout">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="main-content">
            <div class="course-viewer">
                <a href="/dashboard" class="back-btn">
                    <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
                </a>

                <!-- Course Header -->
                <div class="course-header-card" id="course-header">
                    <div class="skeleton" style="height:24px;width:60%;margin-bottom:12px;"></div>
                    <div class="skeleton" style="height:14px;width:40%;"></div>
                </div>

                <!-- Progress -->
                <div class="progress-card" id="course-progress">
                    <div class="progress-stats">
                        <div class="progress-stat"><div class="skeleton" style="height:24px;width:40px;margin:0 auto 4px;"></div><div class="skeleton" style="height:10px;width:60px;margin:0 auto;"></div></div>
                        <div class="progress-stat"><div class="skeleton" style="height:24px;width:40px;margin:0 auto 4px;"></div><div class="skeleton" style="height:10px;width:60px;margin:0 auto;"></div></div>
                        <div class="progress-stat"><div class="skeleton" style="height:24px;width:40px;margin:0 auto 4px;"></div><div class="skeleton" style="height:10px;width:60px;margin:0 auto;"></div></div>
                    </div>
                </div>

                <!-- Course Content -->
                <div class="content-card" id="course-content">
                    <div class="content-placeholder">
                        <div class="skeleton" style="height:48px;width:48px;border-radius:50%;margin:0 auto 16px;"></div>
                        <div class="skeleton" style="height:14px;width:200px;margin:0 auto;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/layout.js"></script>
    <script src="/js/app.js"></script>
    <script>
    function esc(str) {
        if (str === null || str === undefined) return '';
        if (typeof str !== 'string') str = String(str);
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    document.addEventListener('DOMContentLoaded', async function() {
        var params = new URLSearchParams(window.location.search);
        var courseTitle = params.get('title') || 'Course';
        var courseId = params.get('id') || '';

        var userId = localStorage.getItem('alphalearn_userId') || localStorage.getItem('alphalearn_sourcedId') || '';

        // Admin detection — admins can skip ahead through locked content
        var userRole = (localStorage.getItem('alphalearn_role') || '').toLowerCase();
        var userEmail = (localStorage.getItem('alphalearn_email') || '').toLowerCase();
        var isAdmin = userRole.includes('admin') || userRole.includes('administrator')
            || userEmail === 'twsevenyw@gmail.com' || userEmail === 'austin.way@alpha.school'
            || userEmail === 'evan.klein@alpha.school';

        // Course unlock toggle — stored per course in localStorage
        var unlockKey = 'course_unlocked_' + (courseId || courseTitle);
        var isUnlocked = localStorage.getItem(unlockKey) === 'true';

        // Set page title
        document.title = 'AlphaLearn - ' + courseTitle;

        // Show header immediately with title from URL
        document.getElementById('course-header').innerHTML =
            '<h1 class="course-title">' + esc(courseTitle) + '</h1>' +
            '<div class="course-meta"><span class="course-meta-item"><i class="fa-solid fa-spinner fa-spin"></i> Loading course data...</span></div>';

        if (!userId) {
            document.getElementById('course-content').innerHTML =
                '<div class="content-placeholder"><i class="fa-solid fa-circle-exclamation"></i><p>No user ID found. Please <a href="/login" style="color:var(--color-primary);">sign in</a> first.</p></div>';
            return;
        }

        // Fetch enrollment data
        var enrollment = null;
        try {
            var resp = await fetch('/api/enrollments?userId=' + encodeURIComponent(userId));
            var data = await resp.json();
            var enrollments = data.data || data.enrollments || data.courses || (Array.isArray(data) ? data : []);

            // Find matching enrollment by ID or title
            for (var i = 0; i < enrollments.length; i++) {
                var e = enrollments[i];
                var eId = e.id || e.sourcedId || '';
                var eTitle = (e.course || {}).title || e.title || '';
                if ((courseId && eId === courseId) || eTitle === courseTitle) {
                    enrollment = e;
                    break;
                }
            }
        } catch(err) {
            console.warn('[Course] Failed to fetch enrollments:', err.message);
        }

        if (!enrollment) {
            // Still show the page with the title
            document.getElementById('course-header').innerHTML =
                '<h1 class="course-title">' + esc(courseTitle) + '</h1>' +
                '<div class="course-meta"><span class="course-meta-item"><i class="fa-solid fa-info-circle"></i> Enrollment data not available</span></div>';
            document.getElementById('course-progress').innerHTML = '';
            document.getElementById('course-content').innerHTML =
                '<div class="content-placeholder"><i class="fa-solid fa-book"></i><p>This course is part of your AlphaLearn curriculum. Course content will appear here as it becomes available.</p></div>';
            return;
        }

        // Parse enrollment data
        var course = enrollment.course || {};
        var meta = { ...(course.metadata || {}), ...(enrollment.metadata || {}) };
        var goals = meta.goals || {};
        var metrics = meta.metrics || {};
        var subjects = (course.subjects || []).join(', ') || '';
        var xpEarned = enrollment.xpEarned || 0;
        var totalXp = metrics.totalXp || goals.dailyXp || 0;
        var dailyGoal = goals.dailyXp || 0;
        var totalLessons = metrics.totalLessons || 0;
        var isAlphaRead = meta.isAlphaRead || false;
        var isAlphaWrite = meta.isAlphaWrite || meta.isAlphawrite || false;
        var endDate = enrollment.endDate || '';

        // Render header
        var metaItems = [];
        if (subjects) metaItems.push('<span class="course-meta-item"><i class="fa-solid fa-book"></i> ' + esc(subjects) + '</span>');
        if (endDate) metaItems.push('<span class="course-meta-item"><i class="fa-solid fa-calendar"></i> Ends ' + esc(endDate.split('T')[0]) + '</span>');
        if (totalLessons) metaItems.push('<span class="course-meta-item"><i class="fa-solid fa-list-check"></i> ' + totalLessons + ' lessons</span>');

        document.getElementById('course-header').innerHTML =
            '<h1 class="course-title">' + esc(course.title || courseTitle) + '</h1>' +
            '<div class="course-meta">' + (metaItems.length ? metaItems.join('') : '<span class="course-meta-item"><i class="fa-solid fa-graduation-cap"></i> AlphaLearn Course</span>') + '</div>';

        // Render progress
        var pct = totalXp > 0 ? Math.min((xpEarned / totalXp) * 100, 100) : 0;
        document.getElementById('course-progress').innerHTML =
            '<div class="progress-stats">' +
                '<div class="progress-stat"><span class="progress-stat-value">' + xpEarned + '</span><span class="progress-stat-label">XP Earned</span></div>' +
                '<div class="progress-stat"><span class="progress-stat-value">' + totalXp + '</span><span class="progress-stat-label">Total XP</span></div>' +
                '<div class="progress-stat"><span class="progress-stat-value">' + dailyGoal + '</span><span class="progress-stat-label">Daily XP Goal</span></div>' +
            '</div>' +
            '<div class="progress-bar-lg"><div class="progress-fill-lg" style="width:' + pct + '%;"></div></div>' +
            '<div class="progress-label"><span>' + Math.round(pct) + '% complete</span><span>' + xpEarned + ' / ' + totalXp + ' XP</span></div>';

        // ── Build content sections ──
        var contentHTML = '';

        // ── Admin mode banner ──
        if (isAdmin) {
            var lockIcon = isUnlocked ? 'fa-lock-open' : 'fa-lock';
            var lockLabel = isUnlocked ? 'Course Unlocked — you can skip ahead' : 'Course Locked — sequential progression';
            var lockBtnText = isUnlocked ? 'Lock Course' : 'Unlock Course';
            var lockBtnColor = isUnlocked ? '#E65100' : '#2E7D32';
            var bannerBg = isUnlocked ? 'linear-gradient(135deg,#FFF8E1,#FFF3E0)' : 'linear-gradient(135deg,#E8F5E9,#F1F8E9)';
            var bannerBorder = isUnlocked ? '#FFE082' : '#A5D6A7';
            contentHTML += '<div style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:' + bannerBg + ';border:1px solid ' + bannerBorder + ';border-radius:var(--radius);margin-bottom:16px;">' +
                '<i class="fa-solid ' + lockIcon + '" style="color:' + lockBtnColor + ';font-size:1.1rem;"></i>' +
                '<div style="flex:1;"><span style="font-weight:700;font-size:0.88rem;color:' + lockBtnColor + ';">' + lockLabel + '</span></div>' +
                '<button onclick="toggleCourseLock()" style="padding:6px 14px;border:1px solid ' + lockBtnColor + ';border-radius:6px;background:transparent;color:' + lockBtnColor + ';font-size:0.8rem;font-weight:600;cursor:pointer;">' + lockBtnText + '</button>' +
            '</div>';
        }

        // ── Daily Goals (student-friendly) ──
        var hasGoals = goals.dailyXp || goals.dailyLessons || goals.dailyActiveMinutes || goals.dailyAccuracy || goals.dailyMasteredUnits;
        if (hasGoals) {
            var goalCards = '';
            if (goals.dailyXp) goalCards += '<div class="progress-stat"><span class="progress-stat-value">' + goals.dailyXp + '</span><span class="progress-stat-label">Daily XP</span></div>';
            if (goals.dailyLessons) goalCards += '<div class="progress-stat"><span class="progress-stat-value">' + goals.dailyLessons + '</span><span class="progress-stat-label">Daily Lessons</span></div>';
            if (goals.dailyActiveMinutes) goalCards += '<div class="progress-stat"><span class="progress-stat-value">' + goals.dailyActiveMinutes + ' min</span><span class="progress-stat-label">Active Minutes</span></div>';
            if (goals.dailyAccuracy) goalCards += '<div class="progress-stat"><span class="progress-stat-value">' + goals.dailyAccuracy + '%</span><span class="progress-stat-label">Accuracy Goal</span></div>';
            if (goals.dailyMasteredUnits) goalCards += '<div class="progress-stat"><span class="progress-stat-value">' + goals.dailyMasteredUnits + '</span><span class="progress-stat-label">Mastered Units</span></div>';
            contentHTML += '<div class="content-card"><h2><i class="fa-solid fa-bullseye" style="color:var(--color-primary);margin-right:8px;"></i>Your Daily Goals</h2><div class="progress-stats" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr));">' + goalCards + '</div></div>';
        }

        // ── Alpha Read / Alpha Write launch ──
        if (isAlphaRead) {
            contentHTML +=
                '<div class="content-card"><h2><i class="fa-solid fa-book-open-reader" style="color:var(--color-primary);margin-right:8px;"></i>Alpha Read</h2>' +
                '<p style="color:var(--color-text-secondary);margin-bottom:16px;">Improve your reading skills with guided practice and comprehension exercises.</p>' +
                '<a href="#" class="launch-btn"><i class="fa-solid fa-rocket"></i> Launch Alpha Read</a></div>';
        }
        if (isAlphaWrite) {
            contentHTML +=
                '<div class="content-card"><h2><i class="fa-solid fa-pen-nib" style="color:var(--color-primary);margin-right:8px;"></i>Alpha Write</h2>' +
                '<p style="color:var(--color-text-secondary);margin-bottom:16px;">Practice writing with AI-powered feedback and guided prompts.</p>' +
                '<a href="#" class="launch-btn"><i class="fa-solid fa-rocket"></i> Launch Alpha Write</a></div>';
        }

        // ── Lesson Progress Tracker ──
        if (totalLessons > 0) {
            var lessonsDone = totalXp > 0 ? Math.min(Math.round((xpEarned / totalXp) * totalLessons), totalLessons) : 0;
            var lessonPct = Math.min((lessonsDone / totalLessons) * 100, 100);
            contentHTML +=
                '<div class="content-card">' +
                    '<h2><i class="fa-solid fa-list-check" style="color:var(--color-primary);margin-right:8px;"></i>Lesson Progress</h2>' +
                    '<div style="display:flex;align-items:baseline;gap:8px;margin-bottom:12px;">' +
                        '<span style="font-size:2rem;font-weight:700;color:var(--color-primary);">' + lessonsDone + '</span>' +
                        '<span style="font-size:1rem;color:var(--color-text-secondary);"> / ' + totalLessons + ' lessons completed</span>' +
                    '</div>' +
                    '<div class="progress-bar-lg"><div class="progress-fill-lg" style="width:' + lessonPct + '%;"></div></div>' +
                    '<div class="progress-label"><span>' + Math.round(lessonPct) + '% complete</span><span>' + (totalLessons - lessonsDone) + ' remaining</span></div>' +
                '</div>';
        }

        // ── Content section: classes + any additional content from API ──
        contentHTML += '<div class="content-card" id="content-section">' +
            '<div style="text-align:center;padding:20px;color:var(--color-text-muted);">' +
                '<div class="loading-spinner" style="margin:0 auto 8px;width:28px;height:28px;"></div>' +
                'Loading course content...' +
            '</div></div>';

        document.getElementById('course-content').innerHTML = contentHTML;

        // Fetch ALL course content from our backend (OneRoster + EduBridge)
        try {
            var enrollmentId = enrollment.id || enrollment.sourcedId || '';
            var courseSourcedId = course.sourcedId || course.id || '';

            var contentUrl = '/api/course-content?';
            if (courseSourcedId) contentUrl += 'courseId=' + encodeURIComponent(courseSourcedId);
            if (enrollmentId) contentUrl += '&enrollmentId=' + encodeURIComponent(enrollmentId);
            if (userId) contentUrl += '&userId=' + encodeURIComponent(userId);

            var contentResp = await fetch(contentUrl);
            var contentData = contentResp.ok ? await contentResp.json() : {};

            var contentEl = document.getElementById('content-section');
            if (!contentEl) return;

            var html = '';

            // ── Build progress lookup from courseProgress.lineItems ──
            // Match by title to determine which lessons are completed
            var progressByTitle = {};
            var cp = contentData.courseProgress;
            if (cp && cp.lineItems) {
                for (var pi = 0; pi < cp.lineItems.length; pi++) {
                    var pItem = cp.lineItems[pi];
                    var pTitle = (pItem.title || '').trim();
                    if (pTitle && pItem.results && pItem.results.length > 0) {
                        var r = pItem.results[0];
                        progressByTitle[pTitle] = {
                            scoreStatus: r.scoreStatus || '',
                            textScore: r.textScore || '',
                            score: r.score,
                            scorePercentile: r.scorePercentile,
                            scoreDate: r.scoreDate || '',
                        };
                    }
                }
            }
            // Count total completed: API progress + localStorage
            var totalCompleted = Object.keys(progressByTitle).length;
            // Also count locally completed lessons not in API
            for (var k in localStorage) {
                if (k.startsWith('completed_') && localStorage.getItem(k) === 'true') {
                    // Check it's not already counted from API
                    var lName = k.replace('completed_', '');
                    if (!progressByTitle[lName]) totalCompleted++;
                }
            }

            // ── Parse lesson plan: subComponents = units → subComponents = lessons → componentResources = content ──
            var plan = contentData.lessonPlan;
            var innerPlan = (plan && plan.lessonPlan) ? plan.lessonPlan : plan;
            var units = (innerPlan && innerPlan.subComponents) ? innerPlan.subComponents : [];
            units.sort(function(a, b) { return (a.sortOrder || '').localeCompare(b.sortOrder || ''); });

            // Extract subject and grade for PowerPath quiz URLs
            var courseSubject = (course.subjects || [])[0] || '';
            var courseGrade = ((course.grades || [])[0] || '').replace(/[^0-9]/g, '');
            var courseCode = (course.sourcedId || course.id || courseId || '').split('-')[0] || '';
            var quizExtra = '';
            if (courseSubject) quizExtra += '&subject=' + encodeURIComponent(courseSubject);
            if (courseGrade) quizExtra += '&grade=' + encodeURIComponent(courseGrade);
            if (courseCode) quizExtra += '&courseCode=' + encodeURIComponent(courseCode);

            if (units.length > 0) {
                // Count totals
                var totalLessons = 0;
                for (var u = 0; u < units.length; u++) totalLessons += (units[u].subComponents || []).length;
                var overallPct = totalLessons > 0 ? Math.round((totalCompleted / totalLessons) * 100) : 0;

                // Overall progress bar
                html += '<div style="background:#fff;border:1px solid var(--color-border);border-radius:var(--radius);padding:20px;margin-bottom:16px;">' +
                    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">' +
                        '<span style="font-weight:700;font-size:1rem;">Course Progress</span>' +
                        '<span style="font-weight:700;font-size:1.3rem;color:var(--color-primary);">' + overallPct + '%</span>' +
                    '</div>' +
                    '<div style="height:10px;background:#E8ECF1;border-radius:5px;overflow:hidden;"><div style="height:100%;width:' + overallPct + '%;background:var(--color-primary);border-radius:5px;"></div></div>' +
                    '<div style="display:flex;justify-content:space-between;margin-top:8px;font-size:0.8rem;color:var(--color-text-muted);"><span>' + totalCompleted + ' of ' + totalLessons + ' completed</span><span>' + units.length + ' units</span></div>' +
                '</div>';

                // Resource type helpers
                function resIcon(type) {
                    var t = (type || '').toLowerCase();
                    if (t === 'video') return 'fa-play-circle';
                    if (t.includes('assessment')) return 'fa-clipboard-check';
                    return 'fa-book-open'; // reading/stimulus
                }
                function resLabel(type, url) {
                    var t = (type || '').toLowerCase();
                    if (t === 'video') return 'Video';
                    if (t === 'assessment' || t === 'quiz' || t === 'test' || t === 'exam' || t === 'frq') return 'Quiz';
                    if (t.includes('assessment') && !t.includes('stimulus') && !t.includes('reading')) return 'Quiz';
                    if (url && url.includes('stimuli')) return 'Reading';
                    if (url && (url.includes('/assessment') || url.includes('/quiz'))) return 'Quiz';
                    return 'Reading';
                }
                function resColor(type) {
                    var t = (type || '').toLowerCase();
                    if (t === 'video') return '#E53E3E';
                    if (t.includes('assessment')) return '#6C5CE7';
                    return 'var(--color-primary-dark)';
                }

                // Track which units are unlocked (sequential progression)
                var prevUnitComplete = true; // first unit always unlocked

                for (var mi = 0; mi < units.length; mi++) {
                    var mod = units[mi];
                    var modTitle = mod.title || 'Unit ' + (mi + 1);
                    var modLessons = mod.subComponents || [];
                    modLessons.sort(function(a, b) { return (a.sortOrder || '').localeCompare(b.sortOrder || ''); });

                    // Handle units with componentResources but no subComponent lessons
                    // (e.g. APS assessment sections that contain resources directly)
                    var unitRes = mod.componentResources || [];
                    if (modLessons.length === 0 && unitRes.length > 0) {
                        for (var uri = 0; uri < unitRes.length; uri++) {
                            var uRes = unitRes[uri].resource || unitRes[uri] || {};
                            modLessons.push({
                                title: uRes.title || ('Assessment ' + (uri + 1)),
                                id: uRes.id || uRes.sourcedId || '',
                                sourcedId: uRes.sourcedId || uRes.id || '',
                                sortOrder: uRes.sortOrder || String(uri),
                                componentResources: [unitRes[uri]],
                            });
                        }
                    }

                    var unitDone = 0;
                    for (var lc = 0; lc < modLessons.length; lc++) {
                        var lcTitle = (modLessons[lc].title || '').trim();
                        var lcLocalKey = 'completed_' + (modLessons[lc].id || modLessons[lc].sourcedId || lcTitle);
                        if (progressByTitle[lcTitle] || localStorage.getItem(lcLocalKey) === 'true') unitDone++;
                    }
                    var unitPct = modLessons.length > 0 ? Math.round((unitDone / modLessons.length) * 100) : 0;
                    var unitLocked = (isAdmin && isUnlocked) ? false : !prevUnitComplete;
                    var unitId = 'unit-' + mi;

                    // Unit header (clickable to expand/collapse)
                    html += '<div style="background:#fff;border-radius:var(--radius);margin-top:' + (mi > 0 ? '12' : '0') + 'px;border:1px solid var(--color-border);border-left:4px solid ' + (unitLocked ? '#A0AEC0' : 'var(--color-primary)') + ';overflow:hidden;' + (unitLocked ? 'opacity:0.6;' : '') + '">' +
                        '<div style="display:flex;align-items:center;gap:12px;padding:16px 20px;cursor:pointer;" onclick="toggleUnit(\'' + unitId + '\')">' +
                            '<div style="width:40px;height:40px;border-radius:50%;background:' + (unitLocked ? '#A0AEC0' : 'var(--color-primary)') + ';color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">' + (unitLocked ? '<i class="fa-solid fa-lock" style="font-size:0.8rem;"></i>' : (mi + 1)) + '</div>' +
                            '<div style="flex:1;"><div style="font-weight:700;font-size:0.95rem;">' + esc(modTitle) + '</div><div style="font-size:0.78rem;color:var(--color-text-muted);">' + modLessons.length + ' lessons · ' + unitDone + ' done' + (unitLocked ? ' · Complete previous unit first' : '') + '</div></div>' +
                            '<div style="display:flex;align-items:center;gap:8px;"><div style="width:80px;height:6px;background:#E8ECF1;border-radius:3px;overflow:hidden;"><div style="height:100%;width:' + unitPct + '%;background:var(--color-primary);border-radius:3px;"></div></div><span style="font-size:0.82rem;font-weight:700;color:var(--color-primary);min-width:36px;text-align:right;">' + unitPct + '%</span></div>' +
                            '<i class="fa-solid fa-chevron-down" id="' + unitId + '-chevron" style="font-size:0.75rem;color:var(--color-text-muted);transition:transform 0.2s;' + (autoExpand ? 'transform:rotate(180deg);' : '') + '"></i>' +
                        '</div>';

                    // Lessons container (collapsible) — auto-expand first incomplete unit
                    var autoExpand = !unitLocked && unitDone < modLessons.length && prevUnitComplete;
                    html += '<div id="' + unitId + '" style="' + (autoExpand ? '' : 'display:none;') + '">';

                    if (!unitLocked) {
                        var prevLessonDone = true; // first lesson always unlocked

                        for (var li = 0; li < modLessons.length; li++) {
                            var lesson = modLessons[li];
                            var lTitle = lesson.title || 'Lesson ' + (li + 1);
                            var prog = progressByTitle[lTitle.trim()] || null;
                            var isDone = prog && (prog.scoreStatus === 'fully graded' || prog.textScore === 'Completed');
                            // Also check localStorage for manually completed
                            var localKey = 'completed_' + (lesson.id || lesson.sourcedId || lTitle);
                            var isLocalDone = localStorage.getItem(localKey) === 'true';
                            isDone = isDone || isLocalDone;
                            var lessonLocked = (isAdmin && isUnlocked) ? false : !prevLessonDone;
                            var resources = lesson.componentResources || [];

                            // Detect assessment type from lesson title (APS, Quiz, Test, etc.)
                            var isAssessmentTitle = /assess|aps[\s:\-]|quiz|final\s*test|unit\s*test|exam/i.test(lTitle);

                            // Determine lesson type from resources + title
                            var lessonType = isAssessmentTitle ? 'quiz' : 'reading';
                            var openUrl = '';
                            // Pass the lesson ID to the quiz page (needed by Timeback server functions)
                            var ppLessonId = lesson.id || lesson.sourcedId || '';
                            var lessonIdParam = ppLessonId ? '&lessonId=' + encodeURIComponent(ppLessonId) : '';

                            var resDetails = [];
                            for (var ri = 0; ri < resources.length; ri++) {
                                var resObj = resources[ri];
                                var res = resObj.resource || resObj || {};
                                var rmeta = (typeof res === 'object' ? res.metadata : null) || {};
                                var rtype = (rmeta.type || res.type || '').toLowerCase();
                                var rurl = rmeta.url || res.url || rmeta.href || res.href || '';
                                var rTitle2 = (typeof res === 'object' ? (res.title || '') : '').substring(0, 60);
                                var resId = res.id || res.sourcedId || resObj.id || resObj.sourcedId || '';

                                if (rtype === 'video') lessonType = 'video';
                                else if (rtype.includes('assess') || rtype.includes('quiz') || rtype.includes('test')) lessonType = 'quiz';

                                var pillUrl = '';
                                if (rtype === 'video' && rurl) { pillUrl = rurl; }
                                else if (rurl && !rurl.includes('flashcard.com')) { pillUrl = '/quiz?url=' + encodeURIComponent(rurl) + '&title=' + encodeURIComponent(lTitle) + quizExtra + lessonIdParam; }
                                else if (resId) { pillUrl = '/quiz?id=' + encodeURIComponent(resId) + '&type=' + encodeURIComponent(rtype || 'assessment') + '&title=' + encodeURIComponent(lTitle) + quizExtra + lessonIdParam; }

                                // Each resource keeps its own type — don't inherit 'assessment' from lesson title
                                // (that was causing readings/videos inside assessment lessons to lose their buttons)
                                resDetails.push({ type: rtype, url: rurl, pillUrl: pillUrl, title: rTitle2, label: resLabel(rtype, rurl) });

                                if (!openUrl && pillUrl) openUrl = pillUrl;
                            }
                            // Fallback: use lesson-level properties if no resource URL found
                            if (!openUrl) {
                                var lessonMetaUrl = (lesson.metadata || {}).url || lesson.url || '';
                                var lessonResId = lesson.id || lesson.sourcedId || '';
                                if (lessonMetaUrl) {
                                    openUrl = '/quiz?url=' + encodeURIComponent(lessonMetaUrl) + '&title=' + encodeURIComponent(lTitle) + quizExtra + lessonIdParam;
                                } else if (lessonResId && (lessonType === 'quiz' || isAssessmentTitle)) {
                                    openUrl = '/quiz?id=' + encodeURIComponent(lessonResId) + '&type=assessment&title=' + encodeURIComponent(lTitle) + quizExtra + lessonIdParam;
                                }
                            }
                            // If we have an openUrl but no resource details, add a synthetic entry so the pill renders
                            if (resDetails.length === 0 && openUrl) {
                                resDetails.push({ type: 'assessment', url: '', pillUrl: openUrl, title: lTitle, label: 'Quiz' });
                            }

                            // Per-resource completion tracking
                            // Buttons only for articles (Reading) and videos (Video) — NOT quizzes/FRQs
                            var nonQuizCount = 0, nonQuizDoneCount = 0;
                            for (var rci = 0; rci < resDetails.length; rci++) {
                                var isQuizRes = (resDetails[rci].label === 'Quiz');
                                resDetails[rci]._isQuiz = isQuizRes;
                                if (!isQuizRes) {
                                    nonQuizCount++;
                                    var resKey = localKey + '_r' + rci;
                                    resDetails[rci]._localKey = resKey;
                                    resDetails[rci]._resDone = localStorage.getItem(resKey) === 'true';
                                    if (resDetails[rci]._resDone) nonQuizDoneCount++;
                                } else {
                                    resDetails[rci]._localKey = '';
                                    resDetails[rci]._resDone = false;
                                }
                            }
                            // Lesson is done when all non-quiz resources are individually completed
                            if (!isDone && nonQuizCount > 0 && nonQuizDoneCount === nonQuizCount) {
                                isDone = true;
                                localStorage.setItem(localKey, 'true');
                            }

                            var typeIcon = lessonType === 'video' ? 'fa-play-circle' : lessonType === 'quiz' ? 'fa-clipboard-check' : 'fa-book-open';
                            var typeColor = lessonType === 'video' ? '#E53E3E' : lessonType === 'quiz' ? '#6C5CE7' : 'var(--color-primary-dark)';
                            var typeLabel = lessonType === 'video' ? 'Video' : lessonType === 'quiz' ? 'Quiz' : 'Reading';
                            var lessonId = 'lesson-' + mi + '-' + li;

                            // Lesson row (expandable)
                            html += '<div style="border-top:1px solid #F4F6F9;' + (lessonLocked ? 'opacity:0.5;pointer-events:none;' : '') + '">' +
                                '<div style="display:flex;align-items:center;gap:10px;padding:12px 20px 12px 40px;cursor:pointer;" onclick="toggleLesson(\'' + lessonId + '\')">' +
                                    '<div style="width:30px;height:30px;border-radius:8px;background:' + (isDone ? '#E8F5E9' : lessonLocked ? '#F4F6F9' : '#F4F6F9') + ';color:' + (isDone ? '#2E7D32' : lessonLocked ? '#CBD5E0' : typeColor) + ';display:flex;align-items:center;justify-content:center;font-size:0.75rem;flex-shrink:0;"><i class="fa-solid ' + (isDone ? 'fa-check' : lessonLocked ? 'fa-lock' : typeIcon) + '"></i></div>' +
                                    '<div style="flex:1;min-width:0;">' +
                                        '<div style="font-weight:500;font-size:0.88rem;">' + esc(lTitle) + '</div>' +
                                        '<div style="font-size:0.72rem;color:var(--color-text-muted);margin-top:2px;">' +
                                            '<span style="color:' + typeColor + ';font-weight:600;">' + typeLabel + '</span>' +
                                            (resDetails.length > 1 ? ' · ' + resDetails.length + ' items' : '') +
                                        '</div>' +
                                    '</div>' +
                                    (isDone ? '<span style="font-size:0.7rem;font-weight:600;padding:2px 8px;border-radius:12px;background:#E8F5E9;color:#2E7D32;">Done</span>' : '') +
                                    '<i class="fa-solid fa-chevron-down" id="' + lessonId + '-chevron" style="font-size:0.6rem;color:var(--color-text-muted);transition:transform 0.2s;"></i>' +
                                '</div>';

                            // Expanded lesson details
                            html += '<div id="' + lessonId + '" style="display:none;padding:0 20px 14px 80px;">';

                            // Resource items — each non-quiz resource gets its own "Mark Complete" button
                            for (var rd = 0; rd < resDetails.length; rd++) {
                                var d = resDetails[rd];
                                var isInt = d.pillUrl && d.pillUrl.startsWith('/');
                                html += '<div style="margin-bottom:8px;">';
                                html += '<a ' + (d.pillUrl ? (isInt ? 'href="' + esc(d.pillUrl) + '"' : 'href="' + esc(d.pillUrl) + '" target="_blank"') : '') + ' style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:' + (d._resDone ? '#F0FFF4' : '#F8FAFC') + ';border:1px solid ' + (d._resDone ? '#C6F6D5' : '#E8ECF1') + ';border-radius:8px;text-decoration:none;color:var(--color-text);transition:all 0.15s;' + (d.pillUrl ? 'cursor:pointer;' : 'opacity:0.5;') + '" onmouseover="this.style.borderColor=\'var(--color-primary)\';this.style.background=\'var(--color-primary-light)\'" onmouseout="this.style.borderColor=\'' + (d._resDone ? '#C6F6D5' : '#E8ECF1') + '\';this.style.background=\'' + (d._resDone ? '#F0FFF4' : '#F8FAFC') + '\'">' +
                                    '<div style="width:32px;height:32px;border-radius:8px;background:' + (d._resDone ? '#E8F5E9' : d.label === 'Video' ? '#FFF5F5' : d.label === 'Quiz' ? '#F3F0FF' : 'var(--color-primary-light)') + ';color:' + (d._resDone ? '#2E7D32' : resColor(d.type)) + ';display:flex;align-items:center;justify-content:center;font-size:0.8rem;flex-shrink:0;"><i class="fa-solid ' + (d._resDone ? 'fa-check' : resIcon(d.type)) + '"></i></div>' +
                                    '<div style="flex:1;min-width:0;">' +
                                        '<div style="font-weight:600;font-size:0.85rem;">' + esc(d.title || d.label) + '</div>' +
                                        '<div style="font-size:0.72rem;color:var(--color-text-muted);">' + d.label + (d._resDone ? ' · <span style="color:#2E7D32;font-weight:600;">Done</span>' : '') + '</div>' +
                                    '</div>' +
                                    (d.pillUrl ? '<i class="fa-solid fa-arrow-right" style="font-size:0.7rem;color:var(--color-primary);"></i>' : '') +
                                '</a>';
                                // Per-resource "Mark Complete" button — only for non-quiz resources that aren't done
                                if (!d._isQuiz && !d._resDone) {
                                    html += '<button onclick="event.stopPropagation(); markComplete(\'' + esc(d._localKey) + '\', this)" style="display:inline-flex;align-items:center;gap:5px;padding:5px 12px;margin:6px 0 0 42px;background:var(--color-primary);color:#fff;border:none;border-radius:6px;font-size:0.75rem;font-weight:600;cursor:pointer;transition:background 0.15s;" onmouseover="this.style.background=\'var(--color-primary-dark)\'" onmouseout="this.style.background=\'var(--color-primary)\'">' +
                                        '<i class="fa-solid fa-check"></i> Mark Complete' +
                                    '</button>';
                                }
                                html += '</div>';
                            }

                            // Fallback: if no per-resource buttons rendered (all quizzes or no resources),
                            // show a lesson-level button for non-quiz lesson types
                            if (!isDone && nonQuizCount === 0 && lessonType !== 'quiz') {
                                html += '<button onclick="event.stopPropagation(); markComplete(\'' + esc(localKey) + '\', this)" style="display:inline-flex;align-items:center;gap:6px;padding:6px 14px;margin-top:4px;background:var(--color-primary);color:#fff;border:none;border-radius:6px;font-size:0.78rem;font-weight:600;cursor:pointer;transition:background 0.15s;" onmouseover="this.style.background=\'var(--color-primary-dark)\'" onmouseout="this.style.background=\'var(--color-primary)\'">' +
                                    '<i class="fa-solid fa-check"></i> Mark as Completed</button>';
                            }

                            html += '</div></div>'; // close expanded + lesson wrapper

                            prevLessonDone = isDone;
                        }
                    } else {
                        html += '<div style="padding:16px 40px;color:var(--color-text-muted);font-size:0.85rem;"><i class="fa-solid fa-lock" style="margin-right:6px;"></i>Complete the previous unit to unlock this one.</div>';
                    }

                    html += '</div></div>'; // close lessons container + unit

                    prevUnitComplete = (unitDone === modLessons.length && modLessons.length > 0);
                }
            }

            // ── Fallback ──
            if (!html) {
                html = '<div style="text-align:center;padding:30px;color:var(--color-text-muted);"><p>No lesson data available yet.</p></div>';
            }

            // ── Launch button ──
            html += '<div style="margin-top:20px;"><a href="https://alpha.timeback.com/app" target="_blank" rel="noopener" style="display:flex;align-items:center;gap:14px;padding:16px 20px;background:linear-gradient(135deg,var(--color-primary-light),#E0F7F4);border-radius:var(--radius);text-decoration:none;border:2px solid var(--color-primary);transition:all 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.transform=\'none\'"><div style="width:44px;height:44px;border-radius:10px;background:var(--color-primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;"><i class="fa-solid fa-rocket"></i></div><div style="flex:1;"><div style="font-weight:700;font-size:0.95rem;color:var(--color-text);">Open Full Course</div><div style="font-size:0.8rem;color:var(--color-text-secondary);">Launch on Timeback</div></div><i class="fa-solid fa-arrow-right" style="color:var(--color-primary);"></i></a></div>';

            contentEl.innerHTML = html;

        } catch(e) {
            console.error('[Course] Content fetch error:', e);
            var contentEl = document.getElementById('content-section');
            if (contentEl) {
                contentEl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--color-text-muted);"><p>Error loading content: ' + esc(e.message) + '</p></div>';
            }
        }
    });

    // Toggle unit expand/collapse
    function toggleCourseLock() {
        var params = new URLSearchParams(window.location.search);
        var cId = params.get('id') || params.get('title') || '';
        var key = 'course_unlocked_' + cId;
        var current = localStorage.getItem(key) === 'true';
        localStorage.setItem(key, current ? 'false' : 'true');
        location.reload();
    }

    function toggleUnit(id) {
        var el = document.getElementById(id);
        var chev = document.getElementById(id + '-chevron');
        if (!el) return;
        if (el.style.display === 'none') {
            el.style.display = 'block';
            if (chev) chev.style.transform = 'rotate(180deg)';
        } else {
            el.style.display = 'none';
            if (chev) chev.style.transform = 'rotate(0)';
        }
    }

    // Toggle lesson expand/collapse
    function toggleLesson(id) {
        var el = document.getElementById(id);
        var chev = document.getElementById(id + '-chevron');
        if (!el) return;
        if (el.style.display === 'none') {
            el.style.display = 'block';
            if (chev) chev.style.transform = 'rotate(180deg)';
        } else {
            el.style.display = 'none';
            if (chev) chev.style.transform = 'rotate(0)';
        }
    }

    // Mark a lesson as completed (stored in localStorage)
    function markComplete(key, btn) {
        localStorage.setItem(key, 'true');
        btn.outerHTML = '<span style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:#E8F5E9;color:#2E7D32;border-radius:8px;font-size:0.82rem;font-weight:600;"><i class="fa-solid fa-check"></i> Completed!</span>';
        // Refresh the page after a short delay to update progress
        setTimeout(function() { location.reload(); }, 1000);
    }
    </script>
</body>
</html>
