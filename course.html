<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Course</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .course-viewer { max-width: 800px; }
        .back-btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px; border: 1px solid var(--color-border);
            border-radius: var(--radius-sm); background: var(--color-surface);
            color: var(--color-text-secondary); font-size: 0.85rem; font-weight: 500;
            cursor: pointer; text-decoration: none; transition: all 0.2s; margin-bottom: 24px;
        }
        .back-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }

        .course-header-card {
            background: var(--color-surface); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 28px; margin-bottom: 24px;
        }
        .course-title { font-size: 1.5rem; font-weight: 700; color: var(--color-text); margin-bottom: 6px; }
        .course-meta { font-size: 0.9rem; color: var(--color-text-secondary); display: flex; gap: 16px; flex-wrap: wrap; }
        .course-meta-item { display: flex; align-items: center; gap: 6px; }
        .course-meta-item i { color: var(--color-primary); }

        .progress-card {
            background: var(--color-surface); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 24px; margin-bottom: 24px;
        }
        .progress-stats {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;
        }
        .progress-stat {
            text-align: center; padding: 16px;
            background: var(--color-bg); border-radius: var(--radius-sm);
        }
        .progress-stat-value { font-size: 1.5rem; font-weight: 700; color: var(--color-primary); display: block; }
        .progress-stat-label {
            font-size: 0.72rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--color-text-muted); margin-top: 4px; display: block;
        }
        .progress-bar-lg { height: 10px; background: var(--color-bg); border-radius: 5px; overflow: hidden; }
        .progress-fill-lg { height: 100%; background: var(--color-primary); border-radius: 5px; transition: width 0.6s ease; }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.82rem; color: var(--color-text-secondary); margin-top: 8px; }

        .content-card {
            background: var(--color-surface); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 24px; margin-bottom: 24px;
        }
        .content-card h2 {
            font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; color: var(--color-text);
        }
        .launch-btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 14px 28px; background: var(--color-primary); color: #fff;
            border: none; border-radius: var(--radius-sm); font-size: 1rem;
            font-weight: 600; cursor: pointer; transition: background 0.2s;
            text-decoration: none;
        }
        .launch-btn:hover { background: var(--color-primary-dark); color: #fff; }
        .launch-btn i { font-size: 1.1rem; }

        .content-placeholder {
            text-align: center; padding: 40px; color: var(--color-text-muted);
        }
        .content-placeholder i { font-size: 3rem; margin-bottom: 16px; display: block; opacity: 0.4; }
        .content-placeholder p { font-size: 0.95rem; margin-bottom: 16px; }

        .metadata-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            font-size: 0.88rem;
        }
        .metadata-item { padding: 10px 14px; background: var(--color-bg); border-radius: var(--radius-sm); }
        .metadata-key { font-weight: 600; color: var(--color-text-secondary); font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 2px; }
        .metadata-val { color: var(--color-text); font-weight: 500; }

        .skeleton { background: linear-gradient(90deg, #E8ECF1 25%, #F4F6F9 50%, #E8ECF1 75%); background-size: 200% 100%; animation: skeleton-pulse 1.5s ease-in-out infinite; border-radius: 4px; }
        @keyframes skeleton-pulse { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        @media (max-width: 768px) {
            .progress-stats { grid-template-columns: 1fr; }
            .metadata-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body data-view="student" data-active="home">

    <div class="layout">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="main-content">
            <div class="course-viewer">
                <a href="/dashboard" class="back-btn">
                    <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
                </a>

                <!-- Course Header -->
                <div class="course-header-card" id="course-header">
                    <div class="skeleton" style="height:24px;width:60%;margin-bottom:12px;"></div>
                    <div class="skeleton" style="height:14px;width:40%;"></div>
                </div>

                <!-- Progress -->
                <div class="progress-card" id="course-progress">
                    <div class="progress-stats">
                        <div class="progress-stat"><div class="skeleton" style="height:24px;width:40px;margin:0 auto 4px;"></div><div class="skeleton" style="height:10px;width:60px;margin:0 auto;"></div></div>
                        <div class="progress-stat"><div class="skeleton" style="height:24px;width:40px;margin:0 auto 4px;"></div><div class="skeleton" style="height:10px;width:60px;margin:0 auto;"></div></div>
                        <div class="progress-stat"><div class="skeleton" style="height:24px;width:40px;margin:0 auto 4px;"></div><div class="skeleton" style="height:10px;width:60px;margin:0 auto;"></div></div>
                    </div>
                </div>

                <!-- Course Content -->
                <div class="content-card" id="course-content">
                    <div class="content-placeholder">
                        <div class="skeleton" style="height:48px;width:48px;border-radius:50%;margin:0 auto 16px;"></div>
                        <div class="skeleton" style="height:14px;width:200px;margin:0 auto;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/layout.js"></script>
    <script src="/js/app.js"></script>
    <script>
    function esc(str) {
        if (str === null || str === undefined) return '';
        if (typeof str !== 'string') str = String(str);
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    document.addEventListener('DOMContentLoaded', async function() {
        var params = new URLSearchParams(window.location.search);
        var courseTitle = params.get('title') || 'Course';
        var courseId = params.get('id') || '';

        var userId = localStorage.getItem('alphalearn_userId') || localStorage.getItem('alphalearn_sourcedId') || '';

        // Set page title
        document.title = 'AlphaLearn - ' + courseTitle;

        // Show header immediately with title from URL
        document.getElementById('course-header').innerHTML =
            '<h1 class="course-title">' + esc(courseTitle) + '</h1>' +
            '<div class="course-meta"><span class="course-meta-item"><i class="fa-solid fa-spinner fa-spin"></i> Loading course data...</span></div>';

        if (!userId) {
            document.getElementById('course-content').innerHTML =
                '<div class="content-placeholder"><i class="fa-solid fa-circle-exclamation"></i><p>No user ID found. Please <a href="/login" style="color:var(--color-primary);">sign in</a> first.</p></div>';
            return;
        }

        // Fetch enrollment data
        var enrollment = null;
        try {
            var resp = await fetch('/api/enrollments?userId=' + encodeURIComponent(userId));
            var data = await resp.json();
            var enrollments = data.data || data.enrollments || data.courses || (Array.isArray(data) ? data : []);

            // Find matching enrollment by ID or title
            for (var i = 0; i < enrollments.length; i++) {
                var e = enrollments[i];
                var eId = e.id || e.sourcedId || '';
                var eTitle = (e.course || {}).title || e.title || '';
                if ((courseId && eId === courseId) || eTitle === courseTitle) {
                    enrollment = e;
                    break;
                }
            }
        } catch(err) {
            console.warn('[Course] Failed to fetch enrollments:', err.message);
        }

        if (!enrollment) {
            // Still show the page with the title
            document.getElementById('course-header').innerHTML =
                '<h1 class="course-title">' + esc(courseTitle) + '</h1>' +
                '<div class="course-meta"><span class="course-meta-item"><i class="fa-solid fa-info-circle"></i> Enrollment data not available</span></div>';
            document.getElementById('course-progress').innerHTML = '';
            document.getElementById('course-content').innerHTML =
                '<div class="content-placeholder"><i class="fa-solid fa-book"></i><p>This course is part of your AlphaLearn curriculum. Course content will appear here as it becomes available.</p></div>';
            return;
        }

        // Parse enrollment data
        var course = enrollment.course || {};
        var meta = { ...(course.metadata || {}), ...(enrollment.metadata || {}) };
        var goals = meta.goals || {};
        var metrics = meta.metrics || {};
        var subjects = (course.subjects || []).join(', ') || '';
        var xpEarned = enrollment.xpEarned || 0;
        var totalXp = metrics.totalXp || goals.dailyXp || 0;
        var dailyGoal = goals.dailyXp || 0;
        var totalLessons = metrics.totalLessons || 0;
        var isAlphaRead = meta.isAlphaRead || false;
        var isAlphaWrite = meta.isAlphaWrite || meta.isAlphawrite || false;
        var endDate = enrollment.endDate || '';

        // Render header
        var metaItems = [];
        if (subjects) metaItems.push('<span class="course-meta-item"><i class="fa-solid fa-book"></i> ' + esc(subjects) + '</span>');
        if (endDate) metaItems.push('<span class="course-meta-item"><i class="fa-solid fa-calendar"></i> Ends ' + esc(endDate.split('T')[0]) + '</span>');
        if (totalLessons) metaItems.push('<span class="course-meta-item"><i class="fa-solid fa-list-check"></i> ' + totalLessons + ' lessons</span>');

        document.getElementById('course-header').innerHTML =
            '<h1 class="course-title">' + esc(course.title || courseTitle) + '</h1>' +
            '<div class="course-meta">' + (metaItems.length ? metaItems.join('') : '<span class="course-meta-item"><i class="fa-solid fa-graduation-cap"></i> AlphaLearn Course</span>') + '</div>';

        // Render progress
        var pct = totalXp > 0 ? Math.min((xpEarned / totalXp) * 100, 100) : 0;
        document.getElementById('course-progress').innerHTML =
            '<div class="progress-stats">' +
                '<div class="progress-stat"><span class="progress-stat-value">' + xpEarned + '</span><span class="progress-stat-label">XP Earned</span></div>' +
                '<div class="progress-stat"><span class="progress-stat-value">' + totalXp + '</span><span class="progress-stat-label">Total XP</span></div>' +
                '<div class="progress-stat"><span class="progress-stat-value">' + dailyGoal + '</span><span class="progress-stat-label">Daily XP Goal</span></div>' +
            '</div>' +
            '<div class="progress-bar-lg"><div class="progress-fill-lg" style="width:' + pct + '%;"></div></div>' +
            '<div class="progress-label"><span>' + Math.round(pct) + '% complete</span><span>' + xpEarned + ' / ' + totalXp + ' XP</span></div>';

        // ── Build content sections ──
        var contentHTML = '';

        // ── Daily Goals (student-friendly) ──
        var hasGoals = goals.dailyXp || goals.dailyLessons || goals.dailyActiveMinutes || goals.dailyAccuracy || goals.dailyMasteredUnits;
        if (hasGoals) {
            var goalCards = '';
            if (goals.dailyXp) goalCards += '<div class="progress-stat"><span class="progress-stat-value">' + goals.dailyXp + '</span><span class="progress-stat-label">Daily XP</span></div>';
            if (goals.dailyLessons) goalCards += '<div class="progress-stat"><span class="progress-stat-value">' + goals.dailyLessons + '</span><span class="progress-stat-label">Daily Lessons</span></div>';
            if (goals.dailyActiveMinutes) goalCards += '<div class="progress-stat"><span class="progress-stat-value">' + goals.dailyActiveMinutes + ' min</span><span class="progress-stat-label">Active Minutes</span></div>';
            if (goals.dailyAccuracy) goalCards += '<div class="progress-stat"><span class="progress-stat-value">' + goals.dailyAccuracy + '%</span><span class="progress-stat-label">Accuracy Goal</span></div>';
            if (goals.dailyMasteredUnits) goalCards += '<div class="progress-stat"><span class="progress-stat-value">' + goals.dailyMasteredUnits + '</span><span class="progress-stat-label">Mastered Units</span></div>';
            contentHTML += '<div class="content-card"><h2><i class="fa-solid fa-bullseye" style="color:var(--color-primary);margin-right:8px;"></i>Your Daily Goals</h2><div class="progress-stats" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr));">' + goalCards + '</div></div>';
        }

        // ── Alpha Read / Alpha Write launch ──
        if (isAlphaRead) {
            contentHTML +=
                '<div class="content-card"><h2><i class="fa-solid fa-book-open-reader" style="color:var(--color-primary);margin-right:8px;"></i>Alpha Read</h2>' +
                '<p style="color:var(--color-text-secondary);margin-bottom:16px;">Improve your reading skills with guided practice and comprehension exercises.</p>' +
                '<a href="#" class="launch-btn"><i class="fa-solid fa-rocket"></i> Launch Alpha Read</a></div>';
        }
        if (isAlphaWrite) {
            contentHTML +=
                '<div class="content-card"><h2><i class="fa-solid fa-pen-nib" style="color:var(--color-primary);margin-right:8px;"></i>Alpha Write</h2>' +
                '<p style="color:var(--color-text-secondary);margin-bottom:16px;">Practice writing with AI-powered feedback and guided prompts.</p>' +
                '<a href="#" class="launch-btn"><i class="fa-solid fa-rocket"></i> Launch Alpha Write</a></div>';
        }

        // ── Lesson Progress Tracker ──
        if (totalLessons > 0) {
            var lessonsDone = totalXp > 0 ? Math.min(Math.round((xpEarned / totalXp) * totalLessons), totalLessons) : 0;
            var lessonPct = Math.min((lessonsDone / totalLessons) * 100, 100);
            contentHTML +=
                '<div class="content-card">' +
                    '<h2><i class="fa-solid fa-list-check" style="color:var(--color-primary);margin-right:8px;"></i>Lesson Progress</h2>' +
                    '<div style="display:flex;align-items:baseline;gap:8px;margin-bottom:12px;">' +
                        '<span style="font-size:2rem;font-weight:700;color:var(--color-primary);">' + lessonsDone + '</span>' +
                        '<span style="font-size:1rem;color:var(--color-text-secondary);"> / ' + totalLessons + ' lessons completed</span>' +
                    '</div>' +
                    '<div class="progress-bar-lg"><div class="progress-fill-lg" style="width:' + lessonPct + '%;"></div></div>' +
                    '<div class="progress-label"><span>' + Math.round(lessonPct) + '% complete</span><span>' + (totalLessons - lessonsDone) + ' remaining</span></div>' +
                '</div>';
        }

        // ── Content section: classes + any additional content from API ──
        contentHTML += '<div class="content-card" id="content-section">' +
            '<div style="text-align:center;padding:20px;color:var(--color-text-muted);">' +
                '<div class="loading-spinner" style="margin:0 auto 8px;width:28px;height:28px;"></div>' +
                'Loading course content...' +
            '</div></div>';

        document.getElementById('course-content').innerHTML = contentHTML;

        // Fetch ALL course content from our backend (OneRoster + EduBridge)
        try {
            var enrollmentId = enrollment.id || enrollment.sourcedId || '';
            var courseSourcedId = course.sourcedId || course.id || '';

            var contentUrl = '/api/course-content?';
            if (courseSourcedId) contentUrl += 'courseId=' + encodeURIComponent(courseSourcedId);
            if (enrollmentId) contentUrl += '&enrollmentId=' + encodeURIComponent(enrollmentId);
            if (userId) contentUrl += '&userId=' + encodeURIComponent(userId);

            var contentResp = await fetch(contentUrl);
            var contentData = contentResp.ok ? await contentResp.json() : {};

            var contentEl = document.getElementById('content-section');
            if (!contentEl) return;

            var html = '';

            // ── Render PowerPath lesson plan tree (the actual course content!) ──
            var lessonPlan = contentData.lessonPlan;
            if (lessonPlan) {
                var tree = lessonPlan.tree || lessonPlan.children || lessonPlan.units || lessonPlan.lessons || lessonPlan.data || (Array.isArray(lessonPlan) ? lessonPlan : []);
                if (!Array.isArray(tree) && typeof tree === 'object') {
                    // Might be a single root node with children
                    if (tree.children) tree = tree.children;
                    else if (tree.units) tree = tree.units;
                    else if (tree.lessons) tree = tree.lessons;
                    else tree = [tree];
                }

                function renderNode(node, depth) {
                    if (!node || typeof node !== 'object') return '';
                    var title = node.title || node.name || node.label || '';
                    var type = node.type || node.nodeType || '';
                    var status = node.status || node.state || '';
                    var children = node.children || node.units || node.lessons || node.items || [];
                    var isUnit = depth === 0 || type === 'unit' || type === 'module' || type === 'topic';
                    var isLesson = type === 'lesson' || type === 'activity' || type === 'quiz' || type === 'test' || depth > 0;

                    var icons = { unit: 'fa-layer-group', module: 'fa-folder', topic: 'fa-bookmark', lesson: 'fa-file-lines', quiz: 'fa-clipboard-check', test: 'fa-flask', activity: 'fa-pen' };
                    var icon = icons[type] || (isUnit ? 'fa-layer-group' : 'fa-file-lines');
                    var bgColor = isUnit ? 'var(--color-primary)' : 'var(--color-primary-light)';
                    var fgColor = isUnit ? '#fff' : 'var(--color-primary-dark)';
                    var statusBg = status === 'completed' || status === 'mastered' ? '#E8F5E9' : status === 'in_progress' || status === 'started' ? '#FFF8E1' : 'var(--color-bg)';
                    var statusFg = status === 'completed' || status === 'mastered' ? '#2E7D32' : status === 'in_progress' || status === 'started' ? '#F9A825' : 'var(--color-text-muted)';
                    var pad = depth > 0 ? 'padding-left:' + (depth * 20 + 16) + 'px;' : 'padding-left:16px;';

                    var h = '';
                    if (title) {
                        h += '<div style="display:flex;align-items:center;gap:12px;' + pad + 'padding-top:' + (isUnit ? '14' : '10') + 'px;padding-bottom:' + (isUnit ? '14' : '10') + 'px;padding-right:16px;background:' + (isUnit ? 'var(--color-bg)' : '#fff') + ';border-radius:var(--radius-sm);' + (isUnit ? 'margin-top:' + (depth > 0 ? '6' : '12') + 'px;' : '') + '">' +
                            '<div style="width:' + (isUnit ? '40' : '32') + 'px;height:' + (isUnit ? '40' : '32') + 'px;border-radius:' + (isUnit ? '50%' : 'var(--radius-sm)') + ';background:' + bgColor + ';color:' + fgColor + ';display:flex;align-items:center;justify-content:center;font-size:' + (isUnit ? '0.9' : '0.8') + 'rem;flex-shrink:0;"><i class="fa-solid ' + icon + '"></i></div>' +
                            '<div style="flex:1;min-width:0;">' +
                                '<div style="font-weight:' + (isUnit ? '700' : '500') + ';font-size:' + (isUnit ? '0.95' : '0.88') + 'rem;">' + esc(title) + '</div>' +
                                (type ? '<div style="font-size:0.72rem;color:var(--color-text-muted);text-transform:capitalize;">' + esc(type) + '</div>' : '') +
                            '</div>' +
                            (status ? '<span style="font-size:0.72rem;font-weight:600;padding:3px 10px;border-radius:20px;background:' + statusBg + ';color:' + statusFg + ';text-transform:capitalize;">' + esc(status) + '</span>' : '') +
                        '</div>';
                    }

                    if (Array.isArray(children)) {
                        for (var ci = 0; ci < children.length; ci++) {
                            h += renderNode(children[ci], depth + 1);
                        }
                    }
                    return h;
                }

                if (Array.isArray(tree) && tree.length > 0) {
                    html += '<h2><i class="fa-solid fa-sitemap" style="color:var(--color-primary);margin-right:8px;"></i>Lesson Plan</h2>';
                    html += '<div style="display:flex;flex-direction:column;gap:4px;border:1px solid var(--color-border);border-radius:var(--radius);padding:8px;overflow:hidden;">';
                    for (var t = 0; t < tree.length; t++) {
                        html += renderNode(tree[t], 0);
                    }
                    html += '</div>';
                } else if (typeof lessonPlan === 'object' && Object.keys(lessonPlan).length > 0) {
                    // Render whatever structure we got
                    html += '<h2><i class="fa-solid fa-sitemap" style="color:var(--color-primary);margin-right:8px;"></i>Lesson Plan</h2>';
                    html += '<pre style="background:var(--color-bg);padding:16px;border-radius:var(--radius-sm);font-size:0.8rem;overflow-x:auto;max-height:400px;">' + esc(JSON.stringify(lessonPlan, null, 2)) + '</pre>';
                }
            }

            // ── Render course progress ──
            var progress = contentData.courseProgress;
            if (progress) {
                var progItems = progress.lineItems || progress.assessments || progress.items || progress.data || (Array.isArray(progress) ? progress : []);
                if (Array.isArray(progItems) && progItems.length > 0) {
                    html += '<h2 style="margin-top:20px;"><i class="fa-solid fa-chart-line" style="color:var(--color-primary);margin-right:8px;"></i>Your Progress (' + progItems.length + ' items)</h2>';
                    html += '<div style="display:flex;flex-direction:column;gap:8px;">';
                    for (var pi = 0; pi < progItems.length; pi++) {
                        var p = typeof progItems[pi] === 'object' ? progItems[pi] : {};
                        var pTitle = p.title || p.name || p.lessonTitle || 'Item ' + (pi+1);
                        var pScore = p.score || p.grade || p.result || '';
                        var pStatus = p.status || p.state || '';
                        var pColor = pStatus === 'completed' || pStatus === 'mastered' ? '#2E7D32' : 'var(--color-primary)';
                        html += '<div style="display:flex;align-items:center;gap:12px;padding:10px 16px;background:var(--color-bg);border-radius:var(--radius-sm);">' +
                            '<div style="width:32px;height:32px;border-radius:var(--radius-sm);background:#E8F5E9;color:#2E7D32;display:flex;align-items:center;justify-content:center;flex-shrink:0;"><i class="fa-solid fa-check-circle"></i></div>' +
                            '<div style="flex:1;font-weight:500;font-size:0.88rem;">' + esc(pTitle) + '</div>' +
                            (pScore ? '<span style="font-weight:700;color:' + pColor + ';">' + esc(String(pScore)) + '</span>' : '') +
                            (pStatus ? '<span style="font-size:0.72rem;font-weight:600;color:var(--color-text-muted);text-transform:capitalize;">' + esc(pStatus) + '</span>' : '') +
                        '</div>';
                    }
                    html += '</div>';
                } else if (typeof progress === 'object' && Object.keys(progress).length > 0) {
                    html += '<h2 style="margin-top:20px;"><i class="fa-solid fa-chart-line" style="color:var(--color-primary);margin-right:8px;"></i>Course Progress</h2>';
                    html += '<pre style="background:var(--color-bg);padding:16px;border-radius:var(--radius-sm);font-size:0.8rem;overflow-x:auto;max-height:400px;">' + esc(JSON.stringify(progress, null, 2)) + '</pre>';
                }
            }

            // ── Show line items if any ──
            var lineItems = contentData.lineItems || [];
            if (lineItems.length > 0) {
                html += '<h2 style="margin-top:20px;"><i class="fa-solid fa-clipboard-list" style="color:var(--color-primary);margin-right:8px;"></i>Assignments (' + lineItems.length + ')</h2>';
                html += '<div style="display:flex;flex-direction:column;gap:8px;">';
                for (var li = 0; li < lineItems.length; li++) {
                    var item = lineItems[li];
                    html += '<div style="display:flex;align-items:center;gap:12px;padding:10px 16px;background:var(--color-bg);border-radius:var(--radius-sm);">' +
                        '<div style="width:32px;height:32px;border-radius:var(--radius-sm);background:var(--color-primary-light);color:var(--color-primary-dark);display:flex;align-items:center;justify-content:center;flex-shrink:0;"><i class="fa-solid fa-file-lines"></i></div>' +
                        '<div style="flex:1;font-weight:500;font-size:0.88rem;">' + esc(item.title || 'Assignment') + '</div>' +
                    '</div>';
                }
                html += '</div>';
            }

            // ── Fallback: if nothing found at all ──
            if (!html) {
                html = '<div style="text-align:center;padding:30px;color:var(--color-text-muted);">' +
                    '<p>No lesson data available yet for this course.</p>' +
                '</div>';
            }

            // ── Always show launch button ──
            html += '<div style="margin-top:20px;">' +
                '<a href="https://alpha.timeback.com/app" target="_blank" rel="noopener" style="display:flex;align-items:center;gap:14px;padding:16px 20px;background:linear-gradient(135deg,var(--color-primary-light),#E0F7F4);border-radius:var(--radius);text-decoration:none;border:2px solid var(--color-primary);transition:all 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(69,181,170,0.3)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'none\'">' +
                    '<div style="width:44px;height:44px;border-radius:10px;background:var(--color-primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;"><i class="fa-solid fa-rocket"></i></div>' +
                    '<div style="flex:1;"><div style="font-weight:700;font-size:0.95rem;color:var(--color-text);">Open Full Course</div><div style="font-size:0.8rem;color:var(--color-text-secondary);">Launch on Timeback platform</div></div>' +
                    '<i class="fa-solid fa-arrow-right" style="color:var(--color-primary);"></i>' +
                '</a></div>';

            contentEl.innerHTML = html;

        } catch(e) {
            console.error('[Course] Content fetch error:', e);
            var contentEl = document.getElementById('content-section');
            if (contentEl) {
                contentEl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--color-text-muted);"><p>Error loading content: ' + esc(e.message) + '</p></div>';
            }
        }
    });
    </script>
</body>
</html>
