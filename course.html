<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Course</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* ── Course Page ─────────────────────────────────────────── */
        .course-page { max-width: 820px; margin: 0 auto; }

        .back-link {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px; border: 1px solid var(--color-border);
            border-radius: var(--radius-sm); background: var(--color-surface);
            color: var(--color-text-secondary); font-size: 0.85rem; font-weight: 500;
            cursor: pointer; text-decoration: none; transition: all var(--transition);
            margin-bottom: 24px;
        }
        .back-link:hover { border-color: var(--color-primary); color: var(--color-primary); }

        /* ── Course Header ───────────────────────────────────────── */
        .course-hero {
            background: var(--color-surface); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 28px 32px; margin-bottom: 20px;
        }
        .course-hero h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 8px; }
        .course-hero .meta {
            display: flex; gap: 16px; flex-wrap: wrap;
            font-size: 0.85rem; color: var(--color-text-secondary);
        }
        .course-hero .meta-item { display: flex; align-items: center; gap: 6px; }
        .course-hero .meta-item i { color: var(--color-primary); font-size: 0.8rem; }

        /* ── Progress Overview ────────────────────────────────────── */
        .progress-overview {
            background: var(--color-surface); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 24px 28px; margin-bottom: 24px;
        }
        .progress-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 14px;
        }
        .progress-header .label { font-weight: 600; font-size: 0.95rem; }
        .progress-header .value { font-weight: 800; font-size: 1.4rem; color: var(--color-primary); }
        .progress-bar-track { height: 8px; background: var(--color-bg); border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; border-radius: 4px; background: var(--color-primary); transition: width 0.6s ease; }
        .progress-stats-row {
            display: flex; gap: 12px; margin-top: 14px;
        }
        .progress-chip {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            padding: 12px; background: var(--color-bg); border-radius: var(--radius-sm);
        }
        .progress-chip .num { font-size: 1.15rem; font-weight: 700; color: var(--color-text); }
        .progress-chip .txt {
            font-size: 0.68rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.4px; color: var(--color-text-muted); margin-top: 2px;
        }
        .progress-sub {
            display: flex; justify-content: space-between;
            margin-top: 8px; font-size: 0.78rem; color: var(--color-text-muted);
        }

        /* ── Admin Banner ────────────────────────────────────────── */
        .admin-banner {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 16px; margin-bottom: 16px;
            background: linear-gradient(135deg, #FFF8E1, #FFF3E0);
            border: 1px solid #FFE082; border-radius: var(--radius);
        }
        .admin-banner i.shield { color: #F57F17; font-size: 1.1rem; }
        .admin-banner .ab-title { font-weight: 700; font-size: 0.88rem; color: #E65100; }
        .admin-banner .ab-desc { font-size: 0.8rem; color: #BF360C; margin-left: 6px; }

        /* ── Unit Card ───────────────────────────────────────────── */
        .unit-card {
            background: var(--color-surface); border-radius: var(--radius);
            border: 1px solid var(--color-border);
            border-left: 4px solid var(--color-primary);
            overflow: hidden; transition: box-shadow var(--transition);
        }
        .unit-card + .unit-card { margin-top: 12px; }
        .unit-card:hover { box-shadow: var(--shadow-md); }
        .unit-card.complete { border-left-color: #16A34A; }
        .unit-card.locked {
            border-left-color: #A0AEC0; opacity: 0.55;
        }
        .unit-card.locked:hover { box-shadow: none; }

        .unit-header {
            display: flex; align-items: center; gap: 14px;
            padding: 18px 22px; cursor: pointer;
            transition: background var(--transition);
        }
        .unit-header:hover { background: #FAFBFC; }
        .unit-card.locked .unit-header { cursor: default; }
        .unit-card.locked .unit-header:hover { background: transparent; }

        .unit-num {
            width: 42px; height: 42px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1rem; color: #fff; flex-shrink: 0;
            background: var(--color-primary);
        }
        .unit-card.complete .unit-num { background: #16A34A; }
        .unit-card.locked .unit-num { background: #A0AEC0; }

        .unit-info { flex: 1; min-width: 0; }
        .unit-info .u-label {
            font-size: 0.68rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--color-text-muted); margin-bottom: 2px;
        }
        .unit-info h3 {
            font-size: 1rem; font-weight: 700; margin: 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .unit-info .u-sub { font-size: 0.78rem; color: var(--color-text-muted); margin-top: 2px; }

        .unit-status { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }

        .complete-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 12px; border-radius: 20px;
            background: #DCFCE7; color: #16A34A;
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .complete-badge i { font-size: 0.6rem; }

        /* SVG progress ring */
        .unit-ring { position: relative; width: 40px; height: 40px; flex-shrink: 0; }
        .unit-ring svg { transform: rotate(-90deg); }
        .unit-ring .ring-pct {
            position: absolute; inset: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.62rem; font-weight: 700; color: var(--color-text);
        }

        .unit-chevron {
            font-size: 0.7rem; color: var(--color-text-muted);
            transition: transform 0.25s ease; flex-shrink: 0;
        }
        .unit-chevron.open { transform: rotate(180deg); }

        .unit-body {
            max-height: 0; overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .unit-body.open { max-height: 8000px; }

        /* ── Timeline ────────────────────────────────────────────── */
        .timeline {
            position: relative;
            padding: 4px 22px 16px 48px;
        }
        .timeline::before {
            content: ''; position: absolute;
            left: 33px; top: 0; bottom: 16px;
            width: 2px; background: var(--color-border);
        }

        .tl-item { position: relative; }
        .tl-item + .tl-item { margin-top: 2px; }

        .tl-dot {
            position: absolute; left: -26px; top: 16px;
            width: 20px; height: 20px; border-radius: 50%;
            background: var(--color-surface);
            border: 2.5px solid var(--color-border);
            display: flex; align-items: center; justify-content: center;
            z-index: 1; font-size: 0.5rem;
            transition: all var(--transition);
        }
        .tl-dot.done { background: #16A34A; border-color: #16A34A; color: #fff; }
        .tl-dot.active { border-color: var(--color-primary); background: var(--color-primary-light); color: var(--color-primary); }
        .tl-dot.locked { background: #F4F6F9; border-color: #E2E8F0; color: #CBD5E0; }

        /* ── Lesson Row ──────────────────────────────────────────── */
        .lesson-row {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px; border-radius: var(--radius-sm);
            cursor: pointer; transition: all var(--transition);
        }
        .lesson-row:hover { background: var(--color-bg); }
        .tl-item.locked .lesson-row { cursor: default; opacity: 0.5; pointer-events: none; }

        .lesson-info { flex: 1; min-width: 0; }
        .lesson-title { font-weight: 600; font-size: 0.9rem; }
        .lesson-type-tag {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 0.7rem; font-weight: 600; margin-top: 3px;
        }
        .lesson-type-tag.video { color: #DC2626; }
        .lesson-type-tag.reading { color: var(--color-primary-dark); }
        .lesson-type-tag.quiz { color: #7C3AED; }

        .lesson-stats { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

        .pct-badge {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 42px; padding: 3px 10px; border-radius: 20px;
            font-size: 0.7rem; font-weight: 700;
        }
        .pct-badge.green { background: #DCFCE7; color: #16A34A; }
        .pct-badge.amber { background: #FEF3C7; color: #D97706; }
        .pct-badge.red { background: #FEE2E2; color: #DC2626; }
        .pct-badge.gray { background: var(--color-bg); color: var(--color-text-muted); }

        .act-text {
            font-size: 0.76rem; font-weight: 500; color: var(--color-text-muted);
            display: flex; align-items: center; gap: 4px;
        }
        .act-text i { color: var(--color-primary); font-size: 0.7rem; }

        .done-pill {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 10px; border-radius: 12px;
            background: #DCFCE7; color: #16A34A;
            font-size: 0.68rem; font-weight: 700;
        }

        .lesson-chev {
            font-size: 0.55rem; color: var(--color-text-muted);
            transition: transform 0.2s ease;
        }
        .lesson-chev.open { transform: rotate(180deg); }

        /* ── Lesson Expanded Body ────────────────────────────────── */
        .lesson-body {
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease;
            padding-left: 16px; padding-right: 16px;
        }
        .lesson-body.open { max-height: 1200px; padding-bottom: 12px; }

        .resource-list { display: flex; flex-direction: column; gap: 6px; }

        .resource-card {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 14px; border-radius: var(--radius-sm);
            background: #F8FAFC; border: 1px solid var(--color-border);
            text-decoration: none; color: var(--color-text);
            transition: all 0.15s ease;
        }
        .resource-card:hover {
            border-color: var(--color-primary); background: var(--color-primary-light);
            transform: translateX(2px);
        }
        .resource-card.res-done { background: #F0FFF4; border-color: #BBF7D0; }
        .resource-card.res-done:hover { background: #DCFCE7; }

        .res-icon {
            width: 34px; height: 34px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; flex-shrink: 0;
        }
        .res-icon.video { background: #FEE2E2; color: #DC2626; }
        .res-icon.reading { background: var(--color-primary-light); color: var(--color-primary-dark); }
        .res-icon.quiz { background: #EDE9FE; color: #7C3AED; }
        .res-icon.done-icon { background: #DCFCE7; color: #16A34A; }

        .res-details { flex: 1; min-width: 0; }
        .res-name { font-weight: 600; font-size: 0.82rem; }
        .res-meta { font-size: 0.7rem; color: var(--color-text-muted); margin-top: 1px; }
        .res-meta .done-text { color: #16A34A; font-weight: 600; }

        .res-arrow { font-size: 0.7rem; color: var(--color-primary); flex-shrink: 0; }

        .mark-btn {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 5px 12px; margin: 4px 0 0 46px;
            background: var(--color-primary); color: #fff; border: none;
            border-radius: 6px; font-size: 0.72rem; font-weight: 600;
            cursor: pointer; transition: background 0.15s;
        }
        .mark-btn:hover { background: var(--color-primary-dark); }

        /* ── Review / Assessment Highlight ────────────────────────── */
        .tl-item.review .lesson-row { background: #FFFBEB; }
        .tl-item.review .lesson-row:hover { background: #FEF3C7; }

        /* ── Launch CTA ──────────────────────────────────────────── */
        .launch-cta {
            display: flex; align-items: center; gap: 14px;
            padding: 16px 20px; margin-top: 20px;
            background: linear-gradient(135deg, var(--color-primary-light), #E0F7F4);
            border: 2px solid var(--color-primary);
            border-radius: var(--radius); text-decoration: none;
            transition: all 0.2s; color: var(--color-text);
        }
        .launch-cta:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .launch-cta .cta-icon {
            width: 44px; height: 44px; border-radius: 10px;
            background: var(--color-primary); color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; flex-shrink: 0;
        }
        .launch-cta .cta-text { flex: 1; }
        .launch-cta .cta-title { font-weight: 700; font-size: 0.95rem; }
        .launch-cta .cta-sub { font-size: 0.8rem; color: var(--color-text-secondary); }

        /* ── Goals Card ──────────────────────────────────────────── */
        .goals-card {
            background: var(--color-surface); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 24px 28px; margin-bottom: 16px;
        }
        .goals-card h2 {
            font-size: 1rem; font-weight: 600; margin-bottom: 14px;
            display: flex; align-items: center; gap: 8px;
        }
        .goals-card h2 i { color: var(--color-primary); }
        .goals-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;
        }
        .goal-chip {
            text-align: center; padding: 14px;
            background: var(--color-bg); border-radius: var(--radius-sm);
        }
        .goal-chip .gv { font-size: 1.3rem; font-weight: 700; color: var(--color-primary); display: block; }
        .goal-chip .gl {
            font-size: 0.68rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.4px; color: var(--color-text-muted); margin-top: 2px; display: block;
        }

        /* ── Content Card (generic) ──────────────────────────────── */
        .content-card {
            background: var(--color-surface); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 24px 28px; margin-bottom: 16px;
        }
        .content-card h2 {
            font-size: 1rem; font-weight: 600; margin-bottom: 14px;
            display: flex; align-items: center; gap: 8px;
        }
        .content-card h2 i { color: var(--color-primary); }

        /* ── Skeleton ────────────────────────────────────────────── */
        .sk {
            background: linear-gradient(90deg, #E8ECF1 25%, #F4F6F9 50%, #E8ECF1 75%);
            background-size: 200% 100%; border-radius: 4px;
            animation: sk-pulse 1.5s ease-in-out infinite;
        }
        @keyframes sk-pulse { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* ── Debug Toggle ────────────────────────────────────────── */
        .debug-toggle {
            position: fixed; bottom: 20px; right: 20px; z-index: 9999;
            display: flex; align-items: center; gap: 8px;
            padding: 10px 18px; border-radius: 24px;
            font-size: 0.78rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15); border: none;
            font-family: var(--font);
        }
        .debug-toggle.is-admin {
            background: linear-gradient(135deg, #FFF8E1, #FFF3E0);
            color: #E65100; border: 1px solid #FFE082;
        }
        .debug-toggle.is-student {
            background: linear-gradient(135deg, #E3F0FF, #DBEAFE);
            color: #1E40AF; border: 1px solid #93C5FD;
        }
        .debug-toggle:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .debug-toggle i { font-size: 0.85rem; }

        /* ── Responsive ──────────────────────────────────────────── */
        @media (max-width: 768px) {
            .course-hero { padding: 20px; }
            .progress-stats-row { flex-direction: column; }
            .lesson-stats { gap: 6px; }
            .unit-header { padding: 14px 16px; gap: 10px; }
            .timeline { padding-left: 38px; }
            .unit-info h3 { white-space: normal; }
        }
    </style>
</head>
<body data-view="student" data-active="home">

    <div class="layout">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="main-content">
            <div class="course-page">
                <a href="/dashboard" class="back-link">
                    <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
                </a>

                <!-- Course Header -->
                <div id="course-header" class="course-hero">
                    <div class="sk" style="height:24px;width:60%;margin-bottom:12px;"></div>
                    <div class="sk" style="height:14px;width:40%;"></div>
                </div>

                <!-- Course Content -->
                <div id="course-content">
                    <div style="text-align:center;padding:40px;color:var(--color-text-muted);">
                        <div class="sk" style="height:48px;width:48px;border-radius:50%;margin:0 auto 16px;"></div>
                        <div class="sk" style="height:14px;width:200px;margin:0 auto;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/layout.js"></script>
    <script src="/js/app.js"></script>
    <script>
    /* ====================================================================
       Course Detail Page — Units → Lessons → Resources (Video/Article/Quiz)
       ==================================================================== */

    function esc(str) {
        if (str === null || str === undefined) return '';
        if (typeof str !== 'string') str = String(str);
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    /* ── Expand / Collapse helpers ─────────────────────────────── */
    function toggleUnit(id) {
        var body = document.getElementById(id);
        var chev = document.getElementById(id + '-chev');
        if (!body) return;
        body.classList.toggle('open');
        if (chev) chev.classList.toggle('open');
    }

    function toggleLesson(id) {
        var body = document.getElementById(id);
        var chev = document.getElementById(id + '-chev');
        if (!body) return;
        body.classList.toggle('open');
        if (chev) chev.classList.toggle('open');
    }

    function markComplete(key, btn) {
        localStorage.setItem(key, 'true');
        btn.outerHTML = '<span style="display:inline-flex;align-items:center;gap:6px;padding:6px 14px;margin-left:46px;background:#DCFCE7;color:#16A34A;border-radius:8px;font-size:0.78rem;font-weight:600;"><i class="fa-solid fa-check"></i> Completed!</span>';
        setTimeout(function() { location.reload(); }, 800);
    }

    /* ── Resource-type helpers ──────────────────────────────────── */
    function resIcon(type) {
        var t = (type || '').toLowerCase();
        if (t === 'video') return 'fa-play';
        if (t.includes('assess') || t === 'quiz' || t === 'test' || t === 'exam' || t === 'frq') return 'fa-clipboard-question';
        return 'fa-file-lines';
    }

    function resLabel(type, url) {
        var t = (type || '').toLowerCase();
        if (t === 'video') return 'Video';
        if (t === 'assessment' || t === 'quiz' || t === 'test' || t === 'exam' || t === 'frq') return 'Quiz';
        if (t.includes('assessment') && !t.includes('stimulus') && !t.includes('reading')) return 'Quiz';
        if (url && url.includes('stimuli')) return 'Article';
        if (url && (url.includes('/assessment') || url.includes('/quiz'))) return 'Quiz';
        return 'Article';
    }

    function resClass(label) {
        if (label === 'Video') return 'video';
        if (label === 'Quiz') return 'quiz';
        return 'reading';
    }

    function pctBadgeClass(pct) {
        if (pct >= 80) return 'green';
        if (pct >= 50) return 'amber';
        if (pct > 0) return 'red';
        return 'gray';
    }

    /* ── SVG progress ring helper ──────────────────────────────── */
    function progressRing(pct) {
        var r = 16, circ = 2 * Math.PI * r;
        var offset = circ * (1 - pct / 100);
        var color = pct >= 80 ? '#16A34A' : pct >= 50 ? '#D97706' : pct > 0 ? '#DC2626' : '#E8ECF1';
        return '<div class="unit-ring">' +
            '<svg width="40" height="40"><circle cx="20" cy="20" r="' + r + '" fill="none" stroke="#E8ECF1" stroke-width="3"></circle>' +
            '<circle cx="20" cy="20" r="' + r + '" fill="none" stroke="' + color + '" stroke-width="3" stroke-dasharray="' + circ.toFixed(1) + '" stroke-dashoffset="' + offset.toFixed(1) + '" stroke-linecap="round"></circle></svg>' +
            '<span class="ring-pct">' + pct + '%</span></div>';
    }

    /* ── Main ──────────────────────────────────────────────────── */
    document.addEventListener('DOMContentLoaded', async function() {
        var params = new URLSearchParams(window.location.search);
        var courseTitle = params.get('title') || 'Course';
        var courseId = params.get('id') || '';
        var userId = localStorage.getItem('alphalearn_userId') || localStorage.getItem('alphalearn_sourcedId') || '';

        // Admin detection (real role, before debug override)
        var userRole = (localStorage.getItem('alphalearn_role') || '').toLowerCase();
        var userEmail = (localStorage.getItem('alphalearn_email') || '').toLowerCase();
        var realIsAdmin = userRole.includes('admin') || userRole.includes('administrator')
            || userEmail === 'twsevenyw@gmail.com' || userEmail === 'austin.way@alpha.school';
        var isAdmin = realIsAdmin;

        // Debug override: force student view to test locks
        var debugMode = localStorage.getItem('al_debug_mode');
        if (debugMode === 'student' && realIsAdmin) isAdmin = false;

        // Show debug toggle for real admins
        if (realIsAdmin) {
            var isStudentMode = (debugMode === 'student');
            var dbgBtn = document.createElement('button');
            dbgBtn.className = 'debug-toggle ' + (isStudentMode ? 'is-student' : 'is-admin');
            dbgBtn.innerHTML = isStudentMode
                ? '<i class="fa-solid fa-lock"></i> Student View (Locked)'
                : '<i class="fa-solid fa-shield-halved"></i> Admin View (Unlocked)';
            dbgBtn.onclick = function() {
                localStorage.setItem('al_debug_mode', isStudentMode ? '' : 'student');
                location.reload();
            };
            document.body.appendChild(dbgBtn);
        }

        document.title = 'AlphaLearn - ' + courseTitle;

        // Show header with title
        document.getElementById('course-header').innerHTML =
            '<h1>' + esc(courseTitle) + '</h1>' +
            '<div class="meta"><span class="meta-item"><i class="fa-solid fa-spinner fa-spin"></i> Loading course data...</span></div>';

        if (!userId) {
            document.getElementById('course-content').innerHTML =
                '<div style="text-align:center;padding:40px;color:var(--color-text-muted);"><i class="fa-solid fa-circle-exclamation" style="font-size:2.5rem;display:block;margin-bottom:12px;opacity:0.4;"></i><p>No user ID found. Please <a href="/login" style="color:var(--color-primary);">sign in</a> first.</p></div>';
            return;
        }

        // ── Fetch enrollment ───────────────────────────────────────
        var enrollment = null;
        try {
            var resp = await fetch('/api/enrollments?userId=' + encodeURIComponent(userId));
            var data = await resp.json();
            var enrollments = data.data || data.enrollments || data.courses || (Array.isArray(data) ? data : []);
            for (var i = 0; i < enrollments.length; i++) {
                var e = enrollments[i];
                var eId = e.id || e.sourcedId || '';
                var eTitle = (e.course || {}).title || e.title || '';
                if ((courseId && eId === courseId) || eTitle === courseTitle) { enrollment = e; break; }
            }
        } catch(err) { console.warn('[Course] Failed to fetch enrollments:', err.message); }

        if (!enrollment) {
            document.getElementById('course-header').innerHTML =
                '<h1>' + esc(courseTitle) + '</h1>' +
                '<div class="meta"><span class="meta-item"><i class="fa-solid fa-info-circle"></i> Enrollment data not available</span></div>';
            document.getElementById('course-content').innerHTML =
                '<div style="text-align:center;padding:40px;color:var(--color-text-muted);"><i class="fa-solid fa-book" style="font-size:2.5rem;display:block;margin-bottom:12px;opacity:0.4;"></i><p>This course is part of your AlphaLearn curriculum. Course content will appear here as it becomes available.</p></div>';
            return;
        }

        // ── Parse enrollment ───────────────────────────────────────
        var course = enrollment.course || {};
        var meta = Object.assign({}, course.metadata || {}, enrollment.metadata || {});
        var goals = meta.goals || {};
        var metrics = meta.metrics || {};
        var subjects = (course.subjects || []).join(', ') || '';
        var xpEarned = enrollment.xpEarned || 0;
        var totalXp = metrics.totalXp || goals.dailyXp || 0;
        var dailyGoal = goals.dailyXp || 0;
        var totalLessons = metrics.totalLessons || 0;
        var isAlphaRead = meta.isAlphaRead || false;
        var isAlphaWrite = meta.isAlphaWrite || meta.isAlphawrite || false;
        var endDate = enrollment.endDate || '';

        // ── Render Header ──────────────────────────────────────────
        var metaItems = [];
        if (subjects) metaItems.push('<span class="meta-item"><i class="fa-solid fa-book"></i> ' + esc(subjects) + '</span>');
        if (endDate) metaItems.push('<span class="meta-item"><i class="fa-solid fa-calendar"></i> Ends ' + esc(endDate.split('T')[0]) + '</span>');
        if (totalLessons) metaItems.push('<span class="meta-item"><i class="fa-solid fa-list-check"></i> ' + totalLessons + ' lessons</span>');

        document.getElementById('course-header').innerHTML =
            '<h1>' + esc(course.title || courseTitle) + '</h1>' +
            '<div class="meta">' + (metaItems.length ? metaItems.join('') : '<span class="meta-item"><i class="fa-solid fa-graduation-cap"></i> AlphaLearn Course</span>') + '</div>';

        // ── Build content sections ─────────────────────────────────
        var contentHTML = '';

        // Loading placeholder for course content
        contentHTML += '<div id="content-section">' +
            '<div style="text-align:center;padding:24px;color:var(--color-text-muted);">' +
                '<div class="loading-spinner" style="margin:0 auto 8px;width:28px;height:28px;"></div>' +
                'Loading course content...</div></div>';

        document.getElementById('course-content').innerHTML = contentHTML;

        // ── Fetch course content ───────────────────────────────────
        try {
            var enrollmentId = enrollment.id || enrollment.sourcedId || '';
            var courseSourcedId = course.sourcedId || course.id || '';

            var contentUrl = '/api/course-content?';
            if (courseSourcedId) contentUrl += 'courseId=' + encodeURIComponent(courseSourcedId);
            if (enrollmentId) contentUrl += '&enrollmentId=' + encodeURIComponent(enrollmentId);
            if (userId) contentUrl += '&userId=' + encodeURIComponent(userId);

            var contentResp = await fetch(contentUrl);
            var contentData = contentResp.ok ? await contentResp.json() : {};
            var contentEl = document.getElementById('content-section');
            if (!contentEl) return;

            var html = '';

            // ── Build progress lookup ──────────────────────────────
            var progressByTitle = {};
            var cp = contentData.courseProgress;
            if (cp && cp.lineItems) {
                for (var pi = 0; pi < cp.lineItems.length; pi++) {
                    var pItem = cp.lineItems[pi];
                    var pTitle = (pItem.title || '').trim();
                    if (pTitle && pItem.results && pItem.results.length > 0) {
                        var r = pItem.results[0];
                        progressByTitle[pTitle] = {
                            scoreStatus: r.scoreStatus || '',
                            textScore: r.textScore || '',
                            score: r.score,
                            scorePercentile: r.scorePercentile,
                            scoreDate: r.scoreDate || '',
                        };
                    }
                }
            }

            // Count total completed (API + localStorage)
            var totalCompleted = Object.keys(progressByTitle).length;
            for (var k in localStorage) {
                if (k.startsWith('completed_') && localStorage.getItem(k) === 'true') {
                    var lName = k.replace('completed_', '');
                    if (!progressByTitle[lName]) totalCompleted++;
                }
            }

            // ── Parse lesson plan ──────────────────────────────────
            var plan = contentData.lessonPlan;
            var innerPlan = (plan && plan.lessonPlan) ? plan.lessonPlan : plan;
            var units = (innerPlan && innerPlan.subComponents) ? innerPlan.subComponents : [];
            units.sort(function(a, b) { return (a.sortOrder || '').localeCompare(b.sortOrder || ''); });

            var courseSubject = (course.subjects || [])[0] || '';
            var courseGrade = ((course.grades || [])[0] || '').replace(/[^0-9]/g, '');
            var quizExtra = '';
            if (courseSubject) quizExtra += '&subject=' + encodeURIComponent(courseSubject);
            if (courseGrade) quizExtra += '&grade=' + encodeURIComponent(courseGrade);

            if (units.length > 0) {
                // ── Pre-pass: count total & completed ACTIVITIES across all units ──
                var grandTotalAct = 0, grandDoneAct = 0;
                for (var pu = 0; pu < units.length; pu++) {
                    var pUnit = units[pu];
                    var pLessons = (pUnit.subComponents || []).slice();
                    var pUnitRes = pUnit.componentResources || [];
                    if (pLessons.length === 0 && pUnitRes.length > 0) {
                        for (var puri = 0; puri < pUnitRes.length; puri++) {
                            var pR = pUnitRes[puri].resource || pUnitRes[puri] || {};
                            pLessons.push({ title: pR.title || '', id: pR.id || pR.sourcedId || '', sourcedId: pR.sourcedId || pR.id || '', componentResources: [pUnitRes[puri]] });
                        }
                    }
                    for (var pl = 0; pl < pLessons.length; pl++) {
                        var pLesson = pLessons[pl];
                        var pRes = pLesson.componentResources || [];
                        var pCount = Math.max(pRes.length, 1);
                        grandTotalAct += pCount;
                        var pLTitle = (pLesson.title || '').trim();
                        var pLocalKey = 'completed_' + (pLesson.id || pLesson.sourcedId || pLTitle);
                        var pLessonDone = !!progressByTitle[pLTitle] || localStorage.getItem(pLocalKey) === 'true';
                        if (pLessonDone) {
                            grandDoneAct += pCount;
                        } else {
                            for (var pr = 0; pr < pRes.length; pr++) {
                                if (localStorage.getItem(pLocalKey + '_r' + pr) === 'true') grandDoneAct++;
                            }
                        }
                    }
                }
                var overallPct = grandTotalAct > 0 ? Math.round((grandDoneAct / grandTotalAct) * 100) : 0;

                // Overall progress header (activity-based)
                html += '<div class="progress-overview" style="margin-bottom:16px;">' +
                    '<div class="progress-header"><span class="label">Overall Progress</span><span class="value">' + overallPct + '%</span></div>' +
                    '<div class="progress-bar-track"><div class="progress-bar-fill" style="width:' + overallPct + '%;"></div></div>' +
                    '<div class="progress-sub"><span>' + grandDoneAct + ' of ' + grandTotalAct + ' activities completed</span><span>' + units.length + ' units</span></div></div>';

                // ── Render Units ───────────────────────────────────
                var prevUnitComplete = true;

                for (var mi = 0; mi < units.length; mi++) {
                    var mod = units[mi];
                    var modTitle = mod.title || 'Unit ' + (mi + 1);
                    var modLessons = mod.subComponents || [];
                    modLessons.sort(function(a, b) { return (a.sortOrder || '').localeCompare(b.sortOrder || ''); });

                    // Handle units with componentResources but no subComponent lessons
                    var unitRes = mod.componentResources || [];
                    if (modLessons.length === 0 && unitRes.length > 0) {
                        for (var uri = 0; uri < unitRes.length; uri++) {
                            var uRes = unitRes[uri].resource || unitRes[uri] || {};
                            modLessons.push({
                                title: uRes.title || ('Assessment ' + (uri + 1)),
                                id: uRes.id || uRes.sourcedId || '',
                                sourcedId: uRes.sourcedId || uRes.id || '',
                                sortOrder: uRes.sortOrder || String(uri),
                                componentResources: [unitRes[uri]],
                            });
                        }
                    }

                    // Calculate unit progress
                    var unitDone = 0;
                    for (var lc = 0; lc < modLessons.length; lc++) {
                        var lcTitle = (modLessons[lc].title || '').trim();
                        var lcLocalKey = 'completed_' + (modLessons[lc].id || modLessons[lc].sourcedId || lcTitle);
                        if (progressByTitle[lcTitle] || localStorage.getItem(lcLocalKey) === 'true') unitDone++;
                    }
                    var unitPct = modLessons.length > 0 ? Math.round((unitDone / modLessons.length) * 100) : 0;
                    var unitLocked = isAdmin ? false : !prevUnitComplete;
                    var unitComplete = (unitDone === modLessons.length && modLessons.length > 0);
                    var unitId = 'unit-' + mi;

                    // Determine auto-expand BEFORE using it
                    var autoExpand = !unitLocked && unitDone < modLessons.length && prevUnitComplete;

                    // Unit card
                    var unitClass = 'unit-card';
                    if (unitComplete) unitClass += ' complete';
                    if (unitLocked) unitClass += ' locked';

                    html += '<div class="' + unitClass + '">';

                    // Unit header
                    html += '<div class="unit-header" onclick="' + (unitLocked ? '' : "toggleUnit('" + unitId + "')") + '">' +
                        '<div class="unit-num">' + (unitLocked ? '<i class="fa-solid fa-lock" style="font-size:0.75rem;"></i>' : (mi + 1)) + '</div>' +
                        '<div class="unit-info">' +
                            '<div class="u-label">Unit ' + (mi + 1) + '</div>' +
                            '<h3>' + esc(modTitle) + '</h3>' +
                            '<div class="u-sub">' + modLessons.length + ' lessons · ' + unitDone + ' completed' + (unitLocked ? ' · <i class="fa-solid fa-lock" style="font-size:0.6rem;"></i> Complete previous unit first' : '') + '</div>' +
                        '</div>' +
                        '<div class="unit-status">';

                    if (unitComplete) {
                        html += '<span class="complete-badge"><i class="fa-solid fa-check"></i> COMPLETE</span>';
                    } else if (!unitLocked) {
                        html += progressRing(unitPct);
                    }

                    html += '</div>' +
                        '<i class="fa-solid fa-chevron-down unit-chevron' + (autoExpand ? ' open' : '') + '" id="' + unitId + '-chev"></i>' +
                    '</div>';

                    // Unit body (collapsible)
                    html += '<div class="unit-body' + (autoExpand ? ' open' : '') + '" id="' + unitId + '">';

                    if (!unitLocked) {
                        html += '<div class="timeline">';
                        var prevLessonDone = true;

                        for (var li = 0; li < modLessons.length; li++) {
                            var lesson = modLessons[li];
                            var lTitle = lesson.title || 'Lesson ' + (li + 1);
                            var prog = progressByTitle[lTitle.trim()] || null;
                            var isDone = prog && (prog.scoreStatus === 'fully graded' || prog.textScore === 'Completed');
                            var localKey = 'completed_' + (lesson.id || lesson.sourcedId || lTitle);
                            var isLocalDone = localStorage.getItem(localKey) === 'true';
                            isDone = isDone || isLocalDone;
                            var lessonLocked = isAdmin ? false : !prevLessonDone;
                            var resources = lesson.componentResources || [];

                            // Detect assessment type from title
                            var isAssessmentTitle = /assess|aps[\s:\-]|quiz|final\s*test|unit\s*test|exam|cumulative\s*review/i.test(lTitle);
                            var isReview = /cumulative\s*review|review/i.test(lTitle);

                            // Determine lesson type from resources + title
                            var lessonType = isAssessmentTitle ? 'quiz' : 'reading';
                            var openUrl = '';
                            var resDetails = [];

                            for (var ri = 0; ri < resources.length; ri++) {
                                var resObj = resources[ri];
                                var res = resObj.resource || resObj || {};
                                var rmeta = (typeof res === 'object' ? res.metadata : null) || {};
                                var rtype = (rmeta.type || res.type || '').toLowerCase();
                                var rurl = rmeta.url || res.url || rmeta.href || res.href || '';
                                var rTitle2 = (typeof res === 'object' ? (res.title || '') : '').substring(0, 60);
                                var resId = res.id || res.sourcedId || resObj.id || resObj.sourcedId || '';

                                if (rtype === 'video') lessonType = 'video';
                                else if (rtype.includes('assess') || rtype.includes('quiz') || rtype.includes('test')) lessonType = 'quiz';

                                var pillUrl = '';
                                if (rtype === 'video' && rurl) { pillUrl = rurl; }
                                else if (rurl && !rurl.includes('flashcard.com')) { pillUrl = '/quiz?url=' + encodeURIComponent(rurl) + '&title=' + encodeURIComponent(lTitle) + quizExtra; }
                                else if (resId) { pillUrl = '/quiz?id=' + encodeURIComponent(resId) + '&type=' + encodeURIComponent(rtype || 'assessment') + '&title=' + encodeURIComponent(lTitle) + quizExtra; }

                                var lbl = resLabel(rtype, rurl);
                                resDetails.push({ type: rtype, url: rurl, pillUrl: pillUrl, title: rTitle2, label: lbl });

                                if (!openUrl && pillUrl) openUrl = pillUrl;
                            }

                            // Fallback URL from lesson-level properties
                            if (!openUrl) {
                                var lessonMetaUrl = (lesson.metadata || {}).url || lesson.url || '';
                                var lessonResId = lesson.id || lesson.sourcedId || '';
                                if (lessonMetaUrl) {
                                    openUrl = '/quiz?url=' + encodeURIComponent(lessonMetaUrl) + '&title=' + encodeURIComponent(lTitle) + quizExtra;
                                } else if (lessonResId && (lessonType === 'quiz' || isAssessmentTitle)) {
                                    openUrl = '/quiz?id=' + encodeURIComponent(lessonResId) + '&type=assessment&title=' + encodeURIComponent(lTitle) + quizExtra;
                                }
                            }
                            if (resDetails.length === 0 && openUrl) {
                                resDetails.push({ type: 'assessment', url: '', pillUrl: openUrl, title: lTitle, label: 'Quiz' });
                            }

                            // Per-resource completion tracking
                            var nonQuizCount = 0, nonQuizDoneCount = 0;
                            for (var rci = 0; rci < resDetails.length; rci++) {
                                var isQuizRes = (resDetails[rci].label === 'Quiz');
                                resDetails[rci]._isQuiz = isQuizRes;
                                if (!isQuizRes) {
                                    nonQuizCount++;
                                    var resKey = localKey + '_r' + rci;
                                    resDetails[rci]._localKey = resKey;
                                    resDetails[rci]._resDone = localStorage.getItem(resKey) === 'true';
                                    if (resDetails[rci]._resDone) nonQuizDoneCount++;
                                } else {
                                    resDetails[rci]._localKey = '';
                                    resDetails[rci]._resDone = false;
                                }
                            }
                            // Lesson done when all non-quiz resources complete
                            if (!isDone && nonQuizCount > 0 && nonQuizDoneCount === nonQuizCount) {
                                isDone = true;
                                localStorage.setItem(localKey, 'true');
                            }

                            // Calculate lesson-level percentage
                            var totalRes = resDetails.length;
                            var doneRes = 0;
                            for (var dc = 0; dc < resDetails.length; dc++) {
                                if (resDetails[dc]._resDone || resDetails[dc]._isQuiz) doneRes++;
                            }
                            if (isDone) doneRes = totalRes;
                            var lessonPctVal = totalRes > 0 ? Math.round((doneRes / totalRes) * 100) : (isDone ? 100 : 0);

                            var typeIcon = lessonType === 'video' ? 'fa-play' : lessonType === 'quiz' ? 'fa-clipboard-question' : 'fa-file-lines';
                            var typeLabel = lessonType === 'video' ? 'Video' : lessonType === 'quiz' ? 'Quiz' : 'Article';
                            var typeClass = lessonType === 'video' ? 'video' : lessonType === 'quiz' ? 'quiz' : 'reading';
                            var lessonId = 'lesson-' + mi + '-' + li;

                            // Sort resources: Video first, then Article, then Quiz
                            var sortedRes = resDetails.slice().sort(function(a, b) {
                                var order = { 'Video': 0, 'Article': 1, 'Quiz': 2 };
                                return (order[a.label] || 1) - (order[b.label] || 1);
                            });

                            // Timeline item
                            var tlClass = 'tl-item';
                            if (lessonLocked) tlClass += ' locked';
                            if (isReview) tlClass += ' review';

                            html += '<div class="' + tlClass + '">';

                            // Timeline dot
                            var dotClass = 'tl-dot';
                            if (isDone) dotClass += ' done';
                            else if (lessonLocked) dotClass += ' locked';
                            else dotClass += ' active';

                            html += '<div class="' + dotClass + '">';
                            if (isDone) html += '<i class="fa-solid fa-check"></i>';
                            else if (lessonLocked) html += '<i class="fa-solid fa-lock"></i>';
                            else html += '<i class="fa-solid ' + typeIcon + '"></i>';
                            html += '</div>';

                            // Lesson row
                            html += '<div class="lesson-row" onclick="toggleLesson(\'' + lessonId + '\')">' +
                                '<div class="lesson-info">' +
                                    '<div class="lesson-title">' + esc(lTitle) + '</div>' +
                                    '<div class="lesson-type-tag ' + typeClass + '"><i class="fa-solid ' + typeIcon + '"></i> ' + typeLabel + '</div>' +
                                '</div>' +
                                '<div class="lesson-stats">' +
                                    '<span class="pct-badge ' + pctBadgeClass(lessonPctVal) + '">' + lessonPctVal + '%</span>' +
                                    '<span class="act-text"><i class="fa-solid fa-layer-group"></i> ' + doneRes + '/' + totalRes + ' Activities</span>' +
                                    (isDone ? '<span class="done-pill"><i class="fa-solid fa-check"></i> Done</span>' : '') +
                                '</div>' +
                                '<i class="fa-solid fa-chevron-down lesson-chev" id="' + lessonId + '-chev"></i>' +
                            '</div>';

                            // Lesson body (expandable) — resources sorted: Video → Article → Quiz
                            html += '<div class="lesson-body" id="' + lessonId + '">' +
                                '<div class="resource-list">';

                            for (var rd = 0; rd < sortedRes.length; rd++) {
                                var d = sortedRes[rd];
                                var isInt = d.pillUrl && d.pillUrl.startsWith('/');
                                var rLabel = d.label;
                                var rCls = resClass(rLabel);
                                var iconCls = d._resDone ? 'done-icon' : rCls;

                                html += '<a ' + (d.pillUrl ? (isInt ? 'href="' + esc(d.pillUrl) + '"' : 'href="' + esc(d.pillUrl) + '" target="_blank"') : '') + ' class="resource-card' + (d._resDone ? ' res-done' : '') + '">' +
                                    '<div class="res-icon ' + iconCls + '"><i class="fa-solid ' + (d._resDone ? 'fa-check' : resIcon(d.type)) + '"></i></div>' +
                                    '<div class="res-details">' +
                                        '<div class="res-name">' + esc(d.title || rLabel) + '</div>' +
                                        '<div class="res-meta">' + rLabel + (d._resDone ? ' · <span class="done-text">Completed</span>' : '') + '</div>' +
                                    '</div>' +
                                    (d.pillUrl ? '<i class="fa-solid fa-arrow-right res-arrow"></i>' : '') +
                                '</a>';

                                // Mark Complete button for non-quiz resources
                                if (!d._isQuiz && !d._resDone && d._localKey) {
                                    html += '<button class="mark-btn" onclick="event.stopPropagation(); markComplete(\'' + esc(d._localKey) + '\', this)">' +
                                        '<i class="fa-solid fa-check"></i> Mark Complete</button>';
                                }
                            }

                            // Fallback lesson-level mark complete
                            if (!isDone && nonQuizCount === 0 && lessonType !== 'quiz') {
                                html += '<button class="mark-btn" onclick="event.stopPropagation(); markComplete(\'' + esc(localKey) + '\', this)">' +
                                    '<i class="fa-solid fa-check"></i> Mark as Completed</button>';
                            }

                            html += '</div></div>'; // resource-list + lesson-body
                            html += '</div>'; // tl-item

                            prevLessonDone = isDone;
                        }

                        html += '</div>'; // timeline
                    } else {
                        html += '<div style="padding:16px 24px;color:var(--color-text-muted);font-size:0.85rem;">' +
                            '<i class="fa-solid fa-lock" style="margin-right:6px;"></i> Complete the previous unit to unlock this one.</div>';
                    }

                    html += '</div></div>'; // unit-body + unit-card

                    prevUnitComplete = unitComplete;
                }
            }

            // Fallback
            if (!html) {
                html = '<div style="text-align:center;padding:30px;color:var(--color-text-muted);"><p>No lesson data available yet.</p></div>';
            }

            // Launch CTA
            html += '<a href="https://alpha.timeback.com/app" target="_blank" rel="noopener" class="launch-cta">' +
                '<div class="cta-icon"><i class="fa-solid fa-rocket"></i></div>' +
                '<div class="cta-text"><div class="cta-title">Open Full Course</div><div class="cta-sub">Launch on Timeback</div></div>' +
                '<i class="fa-solid fa-arrow-right" style="color:var(--color-primary);"></i></a>';

            contentEl.innerHTML = html;

        } catch(e) {
            console.error('[Course] Content fetch error:', e);
            var contentEl = document.getElementById('content-section');
            if (contentEl) {
                contentEl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--color-text-muted);"><p>Error loading content: ' + esc(e.message) + '</p></div>';
            }
        }
    });
    </script>
</body>
</html>
