<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Assign Tests</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" as="style">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preload" href="/css/style.css" as="style">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* ── Search ───────────────────────────────────────────── */
        .search-wrap { position:relative; margin-bottom:20px; }
        .search-wrap i.si {
            position:absolute; left:14px; top:50%; transform:translateY(-50%);
            color:var(--color-text-muted); font-size:0.9rem; pointer-events:none;
        }
        .search-wrap input {
            width:100%; padding:11px 14px 11px 40px;
            border:1px solid var(--color-border); border-radius:var(--radius-sm);
            background:var(--color-surface); color:var(--color-text);
            font-size:0.92rem; outline:none; transition:border-color var(--transition);
            box-shadow:var(--shadow);
        }
        .search-wrap input:focus { border-color:var(--color-primary); }
        .search-wrap input::placeholder { color:var(--color-text-muted); }

        .search-dd {
            position:absolute; top:100%; left:0; right:0; z-index:1000;
            background:#fff; border:1px solid var(--color-border);
            border-radius:var(--radius-sm); box-shadow:var(--shadow-md);
            max-height:320px; overflow-y:auto; display:none; margin-top:4px;
        }
        .search-dd.open { display:block; }
        .sr {
            display:flex; align-items:center; gap:12px;
            padding:10px 14px; cursor:pointer;
            border-bottom:1px solid var(--color-border); transition:background 0.1s;
        }
        .sr:last-child { border-bottom:none; }
        .sr:hover { background:var(--color-primary-light); }
        .sr .av {
            width:32px; height:32px; border-radius:50%;
            background:var(--color-primary-light); color:var(--color-primary-dark);
            display:flex; align-items:center; justify-content:center;
            font-weight:600; font-size:0.8rem; flex-shrink:0;
        }
        .sr-info { flex:1; min-width:0; }
        .sr-name { font-weight:600; font-size:0.88rem; }
        .sr-email { font-size:0.78rem; color:var(--color-text-muted); }
        .sr-empty { padding:20px; text-align:center; color:var(--color-text-muted); font-size:0.85rem; }

        /* ── Student bar ──────────────────────────────────────── */
        .stu-bar {
            display:flex; align-items:center; gap:14px;
            background:var(--color-surface); border-radius:var(--radius-sm);
            box-shadow:var(--shadow); padding:12px 16px; margin-bottom:20px;
        }
        .stu-bar .av {
            width:36px; height:36px; border-radius:50%;
            background:var(--color-primary-light); color:var(--color-primary-dark);
            display:flex; align-items:center; justify-content:center;
            font-weight:700; font-size:0.95rem; flex-shrink:0;
        }
        .stu-bar-info { flex:1; min-width:0; }
        .stu-bar-name { font-weight:600; font-size:0.92rem; }
        .stu-bar-email { font-size:0.78rem; color:var(--color-text-muted); }
        .stu-bar .change-btn {
            padding:5px 12px; border:1px solid var(--color-border);
            border-radius:var(--radius-sm); background:transparent;
            color:var(--color-text-secondary); font-size:0.78rem; font-weight:500;
            cursor:pointer; transition:all var(--transition);
        }
        .stu-bar .change-btn:hover { border-color:#E53E3E; color:#E53E3E; }

        /* ── Grid ─────────────────────────────────────────────── */
        .two-col { display:grid; grid-template-columns:1fr 1fr; gap:20px; }

        /* ── Card ─────────────────────────────────────────────── */
        .card {
            background:var(--color-surface); border-radius:var(--radius);
            box-shadow:var(--shadow); overflow:visible;
        }
        .card-hd {
            padding:14px 18px; border-bottom:1px solid var(--color-border);
        }
        .card-hd h3 { font-size:0.92rem; font-weight:600; margin:0; }
        .card-hd h3 i { color:var(--color-primary); margin-right:6px; }
        .card-bd { padding:16px 18px; }

        /* ── Form ─────────────────────────────────────────────── */
        .fg { margin-bottom:12px; }
        .fg label {
            display:block; font-size:0.75rem; font-weight:600;
            color:var(--color-text-muted); text-transform:uppercase;
            letter-spacing:0.5px; margin-bottom:4px;
        }
        .fg select {
            width:100%; padding:8px 10px; border:1px solid var(--color-border);
            border-radius:var(--radius-sm); background:var(--color-surface);
            color:var(--color-text); font-size:0.88rem; outline:none;
            transition:border-color var(--transition); font-family:inherit;
        }
        .fg select:focus { border-color:var(--color-primary); }
        .row2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

        .abtn {
            display:flex; align-items:center; justify-content:center; gap:6px;
            width:100%; padding:9px; background:var(--color-primary); color:#fff;
            border:none; border-radius:var(--radius-sm);
            font-size:0.88rem; font-weight:600; cursor:pointer;
            transition:background var(--transition); margin-top:4px;
        }
        .abtn:hover:not(:disabled) { background:var(--color-primary-dark); }
        .abtn:disabled { background:var(--color-border); color:var(--color-text-muted); cursor:not-allowed; }

        .msg {
            margin-top:8px; padding:8px 10px; border-radius:var(--radius-sm);
            font-size:0.82rem; font-weight:500; display:none;
        }
        .msg.ok { display:block; background:#E8F5E9; color:#2E7D32; }
        .msg.err { display:block; background:#FFF5F5; color:#E53E3E; }
        .msg.warn { display:block; background:#FFF8E1; color:#F57F17; }

        /* ── Recent ───────────────────────────────────────────── */
        .rtbl { width:100%; border-collapse:collapse; }
        .rtbl th {
            padding:8px 12px; text-align:left; font-weight:600; font-size:0.72rem;
            color:var(--color-text-muted); text-transform:uppercase; letter-spacing:0.5px;
            background:var(--color-bg); border-bottom:1px solid var(--color-border);
        }
        .rtbl td { padding:8px 12px; border-bottom:1px solid var(--color-border); font-size:0.84rem; }
        .rtbl tbody tr:hover { background:#FAFBFC; }
        .rtbl tbody tr:last-child td { border-bottom:none; }

        .empty { text-align:center; padding:24px 16px; color:var(--color-text-muted); }
        .empty i { font-size:1.4rem; margin-bottom:6px; display:block; opacity:0.3; }
        .empty p { font-size:0.82rem; margin:0; }

        @media(max-width:900px) { .two-col { grid-template-columns:1fr; } }
        @media(max-width:768px) { .row2 { grid-template-columns:1fr; } }
    </style>
</head>
<body data-view="admin" data-active="assign-tests">

<div class="layout">
    <nav class="sidebar" id="sidebar"></nav>
    <main class="main-content">
        <div>
            <div class="page-header">
                <h1 class="page-title">Assign Tests</h1>
                <p class="page-subtitle">Search for a student, then assign a mastery test or screening</p>
            </div>

            <!-- Search -->
            <div class="search-wrap" id="search-wrap">
                <i class="fa-solid fa-magnifying-glass si"></i>
                <input type="text" id="q" placeholder="Type a student name or email..." autocomplete="off">
                <div class="search-dd" id="dd"></div>
            </div>

            <!-- Selected student (hidden) -->
            <div id="stu" style="display:none"></div>

            <!-- Form + Recent (hidden until student picked) -->
            <div class="two-col" id="panels" style="display:none">
                <div class="card">
                    <div class="card-hd"><h3><i class="fa-solid fa-clipboard-check"></i>New Assignment</h3></div>
                    <div class="card-bd">
                        <div class="row2">
                            <div class="fg">
                                <label>Subject</label>
                                <select id="subj" onchange="chk()">
                                    <option value="">Select...</option>
                                    <option>Math</option><option>Reading</option><option>Writing</option>
                                    <option>Science</option><option>Social Studies</option>
                                    <option>Language</option><option>Vocabulary</option>
                                </select>
                            </div>
                            <div class="fg">
                                <label>Grade</label>
                                <select id="grd" onchange="chk()">
                                    <option value="">Select...</option>
                                    <option value="3">3</option><option value="4">4</option>
                                    <option value="5">5</option><option value="6">6</option>
                                    <option value="7">7</option><option value="8">8</option>
                                    <option value="9">9</option><option value="10">10</option>
                                    <option value="11">11</option><option value="12">12</option>
                                </select>
                            </div>
                        </div>
                        <div class="fg">
                            <label>Type</label>
                            <select id="typ">
                                <option value="test-assignment">Test Assignment</option>
                                <option value="screening">Screening</option>
                            </select>
                        </div>
                        <div class="msg" id="warn"></div>
                        <button class="abtn" id="btn" onclick="submit()" disabled>
                            <i class="fa-solid fa-paper-plane"></i> Assign Test
                        </button>
                        <div class="msg" id="res"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-hd"><h3><i class="fa-solid fa-clock-rotate-left"></i>Recent</h3></div>
                    <div id="recent">
                        <div class="empty"><i class="fa-solid fa-inbox"></i><p>No assignments yet.</p></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="/js/auth-guard.js?v=3"></script>
<script src="/js/layout.js?v=2"></script>
<script src="/js/app.js"></script>
<script>
var students=[], sel=null, done=new Set(), recents=[];

function esc(s){if(s==null)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

/* ── Init ─────────────────────────────────────────────────────── */
var qi, timer;
document.addEventListener('DOMContentLoaded', async function(){
    qi=document.getElementById('q');
    qi.addEventListener('input',function(){
        clearTimeout(timer);
        var v=this.value.trim();
        if(v.length<1){cdd();return;}
        timer=setTimeout(function(){search(v);},150);
    });
    document.addEventListener('click',function(e){if(!e.target.closest('.search-wrap'))cdd();});

    try{
        var r=await fetch('/api/users');
        var d=await r.json();
        students=(d.users||[]).filter(function(u){return(u.role||'').toLowerCase()==='student';});
    }catch(e){}
});

/* ── Search ───────────────────────────────────────────────────── */
function search(q){
    var lq=q.toLowerCase();
    if(lq.includes('@')){
        fetch('/api/user-lookup?email='+encodeURIComponent(q))
            .then(function(r){return r.json();})
            .then(function(d){rdd(d.user?[d.user]:[]);})
            .catch(function(){rdd([]);});
        return;
    }
    var res=students.filter(function(u){
        var f=(u.givenName||'').toLowerCase(), l=(u.familyName||'').toLowerCase();
        return f.includes(lq)||l.includes(lq)||(f+' '+l).includes(lq)
            ||(u.email||'').toLowerCase().includes(lq)||(u.username||'').toLowerCase().includes(lq);
    });
    rdd(res.slice(0,30));
}

function rdd(list){
    var dd=document.getElementById('dd');
    if(!list.length){dd.innerHTML='<div class="sr-empty">No students found.</div>';dd.classList.add('open');return;}
    dd.innerHTML=list.map(function(u){
        var nm=((u.givenName||'')+' '+(u.familyName||'')).trim()||'Unknown';
        return '<div class="sr" data-id="'+esc(u.sourcedId)+'" onclick="pick(this)">'+
            '<div class="av">'+esc((u.givenName||'?')[0].toUpperCase())+'</div>'+
            '<div class="sr-info"><div class="sr-name">'+esc(nm)+'</div><div class="sr-email">'+esc(u.email||'')+'</div></div></div>';
    }).join('');
    dd.classList.add('open');
}
function cdd(){document.getElementById('dd').classList.remove('open');}

/* ── Pick student ─────────────────────────────────────────────── */
function pick(el){
    var id=el.getAttribute('data-id');
    sel=students.find(function(u){return u.sourcedId===id;})||null;
    if(!sel){
        var n=el.querySelector('.sr-name'),e=el.querySelector('.sr-email');
        sel={sourcedId:id,givenName:n?n.textContent:'',familyName:'',email:e?e.textContent:'',role:'student'};
    }
    cdd(); qi.value='';
    done=new Set();

    var nm=((sel.givenName||'')+' '+(sel.familyName||'')).trim()||'Unknown';
    var ini=(sel.givenName||'?')[0].toUpperCase();
    document.getElementById('stu').style.display='';
    document.getElementById('stu').innerHTML=
        '<div class="stu-bar"><div class="av">'+esc(ini)+'</div>'+
        '<div class="stu-bar-info"><div class="stu-bar-name">'+esc(nm)+'</div>'+
        '<div class="stu-bar-email">'+esc(sel.email||'')+'</div></div>'+
        '<button class="change-btn" onclick="clr()"><i class="fa-solid fa-xmark"></i> Change</button></div>';

    document.getElementById('panels').style.display='';
    document.getElementById('subj').value='';
    document.getElementById('grd').value='';
    hide('warn'); hide('res'); upd();

    // Fetch enrollments + results
    loadData(sel.sourcedId);
}

function clr(){
    sel=null; done=new Set();
    document.getElementById('stu').style.display='none';
    document.getElementById('panels').style.display='none';
    qi.focus();
}

/* ── Fetch completion data ────────────────────────────────────── */
async function loadData(sid){
    try{
        var [er,rr]=await Promise.all([
            fetch('/api/enrollments?userId='+encodeURIComponent(sid)).then(function(r){return r.json();}),
            fetch('/api/results?userId='+encodeURIComponent(sid)).then(function(r){return r.json();}).catch(function(){return{results:[]};})
        ]);
        var raw=er.data||er.enrollments||er.courses||(Array.isArray(er)?er:[]);
        for(var i=0;i<raw.length;i++){
            var e=raw[i], m=(e.metadata&&e.metadata.metrics)||{}, cm=((e.course||{}).metadata||{}), cx=cm.metrics||{};
            var mt=m.courseType==='mastery_test'||m.courseType==='mastery-test'||m.courseType==='masteryTest'
                ||cx.courseType==='mastery_test'||cx.courseType==='mastery-test'||cx.courseType==='masteryTest';
            if(!mt){var t=((e.course||{}).title||'').toLowerCase();mt=t.includes('mastery')&&t.includes('test');}
            if(mt){
                var subs=(e.course||{}).subjects||[], grs=(e.course||{}).grades||[];
                var subj=subs[0]||guessSub((e.course||{}).title||'');
                if(subj){for(var g=0;g<grs.length;g++)done.add(subj.toLowerCase()+'|'+grs[g]);
                if(!grs.length)done.add(subj.toLowerCase()+'|*');}
            }
        }
    }catch(e){}
    chk();
}

function guessSub(t){
    t=(t||'').toLowerCase();
    if(t.includes('math'))return'Math';if(t.includes('reading')||t.includes('ela'))return'Reading';
    if(t.includes('writing'))return'Writing';if(t.includes('science'))return'Science';
    if(t.includes('social'))return'Social Studies';if(t.includes('lang'))return'Language';
    if(t.includes('vocab'))return'Vocabulary';return'';
}

/* ── Completion check ─────────────────────────────────────────── */
function chk(){
    var s=document.getElementById('subj').value, g=document.getElementById('grd').value, w=document.getElementById('warn');
    if(s&&g&&(done.has(s.toLowerCase()+'|'+g)||done.has(s.toLowerCase()+'|*'))){
        w.innerHTML='<i class="fa-solid fa-triangle-exclamation" style="margin-right:4px;"></i>Already completed '+esc(s)+' Grade '+esc(g);
        w.className='msg warn'; w.style.display='block';
    } else { hide('warn'); }
    upd();
}

function upd(){
    var b=document.getElementById('btn');
    b.disabled=!(sel&&document.getElementById('subj').value&&document.getElementById('grd').value);
}
function hide(id){var e=document.getElementById(id);e.className='msg';e.style.display='none';}

/* ── Submit ───────────────────────────────────────────────────── */
async function submit(){
    if(!sel)return;
    var s=document.getElementById('subj').value, g=document.getElementById('grd').value, t=document.getElementById('typ').value;
    if(!s||!g)return;
    var b=document.getElementById('btn'), r=document.getElementById('res');
    b.disabled=true; b.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Assigning...';
    hide('res');

    var nm=((sel.givenName||'')+' '+(sel.familyName||'')).trim()||'Unknown';
    try{
        var resp=await fetch('/api/assign-test',{method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({studentId:sel.sourcedId,subject:s,grade:g,type:t})});
        var data=await resp.json().catch(function(){return{};});
        if(resp.ok&&data.success){
            r.textContent=data.message||'Test assigned!';
            r.className='msg ok'; r.style.display='block';
            addR(nm,s,g,'ok');
            done.add(s.toLowerCase()+'|'+g);
            document.getElementById('subj').value='';
            document.getElementById('grd').value='';
            hide('warn');
        } else {
            r.textContent=data.error||data.message||'Assignment failed.';
            r.className='msg err'; r.style.display='block';
            addR(nm,s,g,'err');
        }
    }catch(e){
        r.textContent='Network error — the API may be slow. Please try again.';
        r.className='msg err'; r.style.display='block';
        addR(nm,s,g,'err');
    }
    b.innerHTML='<i class="fa-solid fa-paper-plane"></i> Assign Test';
    upd();
}

/* ── Recents ──────────────────────────────────────────────────── */
function addR(nm,s,g,st){
    recents.unshift({nm:nm,s:s,g:g,st:st});
    if(recents.length>15)recents.pop();
    var el=document.getElementById('recent');
    el.innerHTML='<table class="rtbl"><thead><tr><th>Student</th><th>Test</th><th>Status</th></tr></thead><tbody>'+
        recents.map(function(a){
            var bd=a.st==='ok'?'<span class="status-badge status-active">Assigned</span>':'<span class="status-badge status-tobedeleted">Failed</span>';
            return '<tr><td style="font-weight:600;">'+esc(a.nm)+'</td><td>'+esc(a.s)+' Gr.'+esc(a.g)+'</td><td>'+bd+'</td></tr>';
        }).join('')+'</tbody></table>';
}
</script>
</body>
</html>
