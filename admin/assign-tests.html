<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Assign Tests</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" as="style">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preload" href="/css/style.css" as="style">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* ── Hero Banner ──────────────────────────────────────── */
        .hero-banner {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }
        .hero-banner img {
            width: 100%; height: 150px; object-fit: cover; display: block;
        }
        .hero-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(135deg, rgba(69,181,170,0.88), rgba(56,158,148,0.82));
            display: flex; align-items: center; padding: 0 32px;
        }
        .hero-overlay h1 {
            font-size: 1.7rem; font-weight: 700; color: #fff; margin: 0 0 4px;
        }
        .hero-overlay p {
            font-size: 0.95rem; color: rgba(255,255,255,0.85); margin: 0;
        }

        /* ── Search ───────────────────────────────────────────── */
        .search-wrap {
            position: relative;
            margin-bottom: 20px;
        }
        .search-wrap .search-icon {
            position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
            color: var(--color-text-muted); font-size: 0.9rem; pointer-events: none;
        }
        .search-wrap input {
            width: 100%;
            padding: 10px 14px 10px 40px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 0.9rem;
            outline: none;
            transition: border-color var(--transition);
            box-shadow: var(--shadow);
        }
        .search-wrap input:focus { border-color: var(--color-primary); }
        .search-wrap input::placeholder { color: var(--color-text-muted); }

        .search-dropdown {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 1000;
            background: #fff; border: 1px solid var(--color-border);
            border-radius: var(--radius-sm); box-shadow: var(--shadow-md);
            max-height: 320px; overflow-y: auto; display: none; margin-top: 4px;
        }
        .search-dropdown.open { display: block; }
        .search-item {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 14px; cursor: pointer;
            border-bottom: 1px solid var(--color-border);
            transition: background 0.1s;
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background: var(--color-primary-light); }
        .search-item-name { font-weight: 600; font-size: 0.9rem; color: var(--color-text); }
        .search-item-email { font-size: 0.8rem; color: var(--color-text-muted); }
        .search-empty {
            padding: 20px; text-align: center;
            color: var(--color-text-muted); font-size: 0.85rem;
        }

        /* ── Selected Student Chip ────────────────────────────── */
        .student-chip {
            display: inline-flex; align-items: center; gap: 8px;
            background: var(--color-primary-light); color: var(--color-primary-dark);
            padding: 6px 14px; border-radius: 20px;
            font-size: 0.85rem; font-weight: 600; margin-bottom: 20px;
        }
        .student-chip i { font-size: 0.8rem; }

        /* ── Two Column Grid ──────────────────────────────────── */
        .two-col {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }

        /* ── Cards ────────────────────────────────────────────── */
        .panel-card {
            background: var(--color-surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: visible;
        }
        .panel-card .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-border);
        }
        .panel-card .card-title {
            font-size: 1.05rem; font-weight: 600; margin: 0;
        }
        .panel-card .card-title i {
            color: var(--color-primary); margin-right: 8px;
        }
        .panel-body {
            padding: 20px;
        }

        /* ── Form ─────────────────────────────────────────────── */
        .form-field {
            margin-bottom: 14px;
        }
        .form-field label {
            display: block;
            font-size: 0.82rem; font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 6px;
        }
        .form-field select {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 0.9rem;
            font-family: inherit;
            outline: none;
            transition: border-color var(--transition);
        }
        .form-field select:focus { border-color: var(--color-primary); }
        .form-row-2 {
            display: grid; grid-template-columns: 1fr 1fr; gap: 14px;
        }

        .assign-btn {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%;
            padding: 10px;
            background: var(--color-primary); color: #fff; border: none;
            border-radius: var(--radius-sm);
            font-size: 0.9rem; font-weight: 600; font-family: inherit;
            cursor: pointer;
            transition: background var(--transition);
        }
        .assign-btn:hover:not(:disabled) { background: var(--color-primary-dark); }
        .assign-btn:disabled {
            background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed;
        }

        .feedback {
            margin-top: 10px; padding: 9px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem; font-weight: 500;
            display: none;
        }
        .feedback.success { display: block; background: #E8F5E9; color: #2E7D32; }
        .feedback.error   { display: block; background: #FFF5F5; color: #E53E3E; }
        .feedback.warning { display: block; background: #FFF8E1; color: #F57F17; }

        /* ── Recent Table ─────────────────────────────────────── */
        .recent-table { width: 100%; border-collapse: collapse; }
        .recent-table th {
            padding: 10px 16px; text-align: left;
            font-weight: 600; font-size: 0.78rem;
            color: var(--color-text-secondary);
            text-transform: uppercase; letter-spacing: 0.5px;
            background: var(--color-bg);
            border-bottom: 1px solid var(--color-border);
        }
        .recent-table td {
            padding: 10px 16px;
            border-bottom: 1px solid var(--color-border);
            font-size: 0.88rem;
        }
        .recent-table tbody tr:hover { background: #FAFBFC; }
        .recent-table tbody tr:last-child td { border-bottom: none; }

        .empty-state {
            text-align: center; padding: 32px 16px; color: var(--color-text-muted);
        }
        .empty-state i {
            font-size: 1.6rem; margin-bottom: 8px; display: block; opacity: 0.3;
        }
        .empty-state p { font-size: 0.85rem; margin: 0; }

        /* ── Remove button ────────────────────────────────────── */
        .remove-btn {
            padding: 3px 10px; border: 1px solid var(--color-border);
            border-radius: var(--radius-sm); background: transparent;
            color: var(--color-text-muted); font-size: 0.75rem; font-weight: 600;
            cursor: pointer; transition: all var(--transition);
        }
        .remove-btn:hover {
            border-color: #E53E3E; color: #E53E3E; background: #FFF5F5;
        }

        /* ── Responsive ───────────────────────────────────────── */
        @media (max-width: 900px) {
            .two-col { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .hero-overlay { padding: 0 20px; }
            .hero-overlay h1 { font-size: 1.3rem; }
            .form-row-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body data-view="admin" data-active="assign-tests">

<div class="layout">
    <nav class="sidebar" id="sidebar"></nav>
    <main class="main-content">
        <div>
            <!-- Hero Banner -->
            <div class="hero-banner">
                <img src="/img/assign-tests-header.png" alt="">
                <div class="hero-overlay">
                    <div>
                        <h1>Assign Tests</h1>
                        <p>Assign mastery tests and screening assignments for your students!</p>
                    </div>
                </div>
            </div>

            <!-- Student Search -->
            <div class="search-wrap">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="student-search" placeholder="Search for a student by name or email..." autocomplete="off">
                <div class="search-dropdown" id="search-dropdown"></div>
            </div>

            <!-- Selected Student Chip (hidden until picked) -->
            <div id="student-chip" style="display:none;"></div>

            <!-- Form + Recent side by side (hidden until student picked) -->
            <div class="two-col" id="panels" style="display:none;">

                <!-- Assign Form -->
                <div class="panel-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fa-solid fa-clipboard-check"></i>New Assignment</h2>
                    </div>
                    <div class="panel-body">
                        <div class="form-row-2">
                            <div class="form-field">
                                <label>Subject</label>
                                <select id="assign-subject" onchange="checkCombo()">
                                    <option value="">Select subject...</option>
                                    <option value="Math">Math</option>
                                    <option value="Reading">Reading</option>
                                    <option value="Writing">Writing</option>
                                    <option value="Science">Science</option>
                                    <option value="Social Studies">Social Studies</option>
                                    <option value="Language">Language</option>
                                    <option value="Vocabulary">Vocabulary</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label>Grade Level</label>
                                <select id="assign-grade" onchange="checkCombo()">
                                    <option value="">Select grade...</option>
                                    <option value="3">Grade 3</option>
                                    <option value="4">Grade 4</option>
                                    <option value="5">Grade 5</option>
                                    <option value="6">Grade 6</option>
                                    <option value="7">Grade 7</option>
                                    <option value="8">Grade 8</option>
                                    <option value="9">Grade 9</option>
                                    <option value="10">Grade 10</option>
                                    <option value="11">Grade 11</option>
                                    <option value="12">Grade 12</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-field">
                            <label>Type</label>
                            <select id="assign-type">
                                <option value="test-assignment">Test Assignment</option>
                                <option value="screening">Screening Test</option>
                            </select>
                        </div>
                        <div class="feedback" id="completion-warn"></div>
                        <button class="assign-btn" id="assign-btn" onclick="submitAssignment()" disabled>
                            <i class="fa-solid fa-paper-plane"></i> Assign Test
                        </button>
                        <div class="feedback" id="assign-feedback"></div>
                    </div>
                </div>

                <!-- Current Test Assignments -->
                <div class="panel-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fa-solid fa-list-check"></i>Current Assignments</h2>
                    </div>
                    <div id="assignments-body">
                        <div class="empty-state">
                            <i class="fa-solid fa-spinner fa-spin" style="opacity:0.5;"></i>
                            <p>Loading assignments...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="/js/auth-guard.js?v=3"></script>
<script src="/js/layout.js?v=2"></script>
<script src="/js/app.js"></script>
<script>
/* ==================================================================
   State
   ================================================================== */
var cachedStudents = [];
var selectedStudent = null;
var completedCombos = new Set();

function esc(s) {
    if (s == null) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ==================================================================
   Init
   ================================================================== */
var searchInput, searchTimer;

document.addEventListener('DOMContentLoaded', async function() {
    searchInput = document.getElementById('student-search');

    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimer);
        var q = this.value.trim();
        if (q.length < 1) { closeDropdown(); return; }
        searchTimer = setTimeout(function() { doSearch(q); }, 150);
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-wrap')) closeDropdown();
    });

    // Pre-fetch all students
    try {
        var resp = await fetch('/api/users');
        var data = await resp.json();
        cachedStudents = (data.users || []).filter(function(u) {
            return (u.role || '').toLowerCase() === 'student';
        });
    } catch(e) {
        console.warn('[Admin] Failed to load students:', e.message);
    }
});

/* ==================================================================
   Search
   ================================================================== */
function doSearch(query) {
    var q = query.toLowerCase();

    if (q.includes('@')) {
        fetch('/api/user-lookup?email=' + encodeURIComponent(query))
            .then(function(r) { return r.json(); })
            .then(function(d) { renderDropdown(d.user ? [d.user] : []); })
            .catch(function() { renderDropdown([]); });
        return;
    }

    var results = cachedStudents.filter(function(u) {
        var first = (u.givenName || '').toLowerCase();
        var last = (u.familyName || '').toLowerCase();
        var full = first + ' ' + last;
        return first.includes(q) || last.includes(q) || full.includes(q)
            || (u.email || '').toLowerCase().includes(q)
            || (u.username || '').toLowerCase().includes(q);
    });

    renderDropdown(results.slice(0, 30));
}

function renderDropdown(results) {
    var dd = document.getElementById('search-dropdown');
    if (!results.length) {
        dd.innerHTML = '<div class="search-empty">No students found.</div>';
        dd.classList.add('open');
        return;
    }
    dd.innerHTML = results.map(function(u) {
        var name = ((u.givenName || '') + ' ' + (u.familyName || '')).trim() || 'Unknown';
        var email = u.email || '';
        var initial = (u.givenName || '?')[0].toUpperCase();
        return '<div class="search-item" data-id="' + esc(u.sourcedId) + '" onclick="pickStudent(this)">' +
            '<div class="user-cell-avatar">' + esc(initial) + '</div>' +
            '<div style="flex:1;min-width:0;">' +
                '<div class="search-item-name">' + esc(name) + '</div>' +
                '<div class="search-item-email">' + esc(email) + '</div>' +
            '</div></div>';
    }).join('');
    dd.classList.add('open');
}

function closeDropdown() {
    document.getElementById('search-dropdown').classList.remove('open');
}

/* ==================================================================
   Pick Student
   ================================================================== */
function pickStudent(el) {
    var id = el.getAttribute('data-id');
    var user = cachedStudents.find(function(u) { return u.sourcedId === id; });
    if (!user) {
        var nameEl = el.querySelector('.search-item-name');
        var emailEl = el.querySelector('.search-item-email');
        user = { sourcedId: id, givenName: nameEl ? nameEl.textContent : '', familyName: '', email: emailEl ? emailEl.textContent : '', role: 'student' };
    }

    selectedStudent = user;
    completedCombos = new Set();
    closeDropdown();

    // Show selected name in the search input
    var name = ((user.givenName || '') + ' ' + (user.familyName || '')).trim();
    searchInput.value = name;

    // Show chip
    var chipEl = document.getElementById('student-chip');
    chipEl.style.display = '';
    chipEl.innerHTML = '<div class="student-chip"><i class="fa-solid fa-user-check"></i>' + esc(name) + ' &mdash; ' + esc(user.email || '') + '</div>';

    // Show panels
    document.getElementById('panels').style.display = '';

    // Reset form
    document.getElementById('assign-subject').value = '';
    document.getElementById('assign-grade').value = '';
    hideFeedback('completion-warn');
    hideFeedback('assign-feedback');
    updateBtn();

    // Fetch completion data
    loadStudentData(user.sourcedId);
}

/* ==================================================================
   Fetch Enrollment + Results + Existing Assignments
   ================================================================== */
var existingAssignments = [];

async function loadStudentData(studentId) {
    // Fetch enrollments, results, and existing assignments in parallel
    try {
        var [enrollResp, resultsResp, assignResp] = await Promise.all([
            fetch('/api/enrollments?userId=' + encodeURIComponent(studentId)).then(function(r) { return r.json(); }),
            fetch('/api/results?userId=' + encodeURIComponent(studentId)).then(function(r) { return r.json(); }).catch(function() { return { results: [] }; }),
            fetch('/api/assign-test?userId=' + encodeURIComponent(studentId)).then(function(r) { return r.json(); }).catch(function() { return { assignments: [] }; }),
        ]);

        // Parse enrollments for completed mastery tests
        var raw = enrollResp.data || enrollResp.enrollments || enrollResp.courses || (Array.isArray(enrollResp) ? enrollResp : []);

        for (var i = 0; i < raw.length; i++) {
            var e = raw[i];
            var meta = (e.metadata && e.metadata.metrics) || {};
            var courseMeta = ((e.course || {}).metadata || {});
            var courseMetrics = courseMeta.metrics || {};

            var isMastery = meta.courseType === 'mastery_test' || meta.courseType === 'mastery-test' || meta.courseType === 'masteryTest'
                || courseMetrics.courseType === 'mastery_test' || courseMetrics.courseType === 'mastery-test' || courseMetrics.courseType === 'masteryTest';

            if (!isMastery) {
                var title = ((e.course || {}).title || '').toLowerCase();
                isMastery = title.includes('mastery') && title.includes('test');
            }

            if (isMastery) {
                var subjects = (e.course || {}).subjects || [];
                var grades = (e.course || {}).grades || [];
                var subject = subjects[0] || guessSubject((e.course || {}).title || '');

                if (subject) {
                    for (var g = 0; g < grades.length; g++) {
                        completedCombos.add(subject.toLowerCase() + '|' + grades[g]);
                    }
                    if (!grades.length) {
                        completedCombos.add(subject.toLowerCase() + '|*');
                    }
                }
            }
        }

        // Store existing test assignments
        existingAssignments = assignResp.assignments || [];

        // Also build display list from mastery enrollments if API returned nothing
        if (!existingAssignments.length) {
            existingAssignments = raw.filter(function(e) {
                var m = (e.metadata && e.metadata.metrics) || {};
                var cm = ((e.course || {}).metadata || {}).metrics || {};
                return m.courseType === 'mastery_test' || m.courseType === 'mastery-test' || m.courseType === 'masteryTest'
                    || cm.courseType === 'mastery_test' || cm.courseType === 'mastery-test' || cm.courseType === 'masteryTest'
                    || (((e.course || {}).title || '').toLowerCase().includes('mastery') && ((e.course || {}).title || '').toLowerCase().includes('test'));
            }).map(function(e) {
                var c = e.course || {};
                return {
                    id: e.id || e.sourcedId || '',
                    title: c.title || 'Unknown Test',
                    subject: (c.subjects || [])[0] || guessSubject(c.title || ''),
                    grade: (c.grades || [])[0] || '',
                    status: e.status || 'active',
                    _fromEnrollment: true,
                };
            });
        }

    } catch(err) {
        console.warn('[Admin] Error fetching student data:', err.message);
    }

    renderAssignments();
    checkCombo();
}

/* ==================================================================
   Render Existing Assignments
   ================================================================== */
function renderAssignments() {
    var el = document.getElementById('assignments-body');
    if (!existingAssignments.length) {
        el.innerHTML = '<div class="empty-state"><i class="fa-solid fa-circle-check"></i><p>No test assignments found for this student.</p></div>';
        return;
    }

    el.innerHTML = '<table class="recent-table"><thead><tr><th>Test</th><th>Subject</th><th>Grade</th><th></th></tr></thead><tbody>' +
        existingAssignments.map(function(a, idx) {
            var title = esc(a.title || a.name || a.subject || 'Test');
            var subj = esc(a.subject || '');
            var grade = esc(a.grade || '');
            var aid = esc(a.id || a.sourcedId || a.assignmentId || '');
            return '<tr>' +
                '<td style="font-weight:600;">' + title + '</td>' +
                '<td>' + subj + '</td>' +
                '<td>' + (grade ? 'Grade ' + grade : '') + '</td>' +
                '<td><button class="remove-btn" onclick="removeAssignment(' + idx + ')" title="Remove this assignment"><i class="fa-solid fa-trash-can" style="margin-right:3px;"></i>Remove</button></td>' +
            '</tr>';
        }).join('') + '</tbody></table>';
}

async function removeAssignment(idx) {
    var a = existingAssignments[idx];
    if (!a || !selectedStudent) return;

    var aid = a.id || a.sourcedId || a.assignmentId || '';
    var subj = a.subject || '';
    var grade = a.grade || '';

    // Optimistic UI — remove from list immediately
    existingAssignments.splice(idx, 1);
    renderAssignments();

    // Also remove from completed combos so it can be re-assigned
    if (subj && grade) {
        completedCombos.delete(subj.toLowerCase() + '|' + grade);
        checkCombo();
    }

    // Call API to remove
    try {
        await fetch('/api/assign-test', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                assignmentId: aid,
                studentId: selectedStudent.sourcedId,
                subject: subj,
                grade: grade,
            }),
        });
    } catch(e) {
        console.warn('[Admin] Remove assignment error:', e.message);
    }
}

function guessSubject(title) {
    var t = (title || '').toLowerCase();
    if (t.includes('math')) return 'Math';
    if (t.includes('reading') || t.includes('ela')) return 'Reading';
    if (t.includes('writing')) return 'Writing';
    if (t.includes('science')) return 'Science';
    if (t.includes('social')) return 'Social Studies';
    if (t.includes('lang')) return 'Language';
    if (t.includes('vocab')) return 'Vocabulary';
    return '';
}

/* ==================================================================
   Check Completion
   ================================================================== */
function checkCombo() {
    var subject = (document.getElementById('assign-subject') || {}).value || '';
    var grade = (document.getElementById('assign-grade') || {}).value || '';
    var warnEl = document.getElementById('completion-warn');

    if (subject && grade) {
        var key = subject.toLowerCase() + '|' + grade;
        var wildKey = subject.toLowerCase() + '|*';
        if (completedCombos.has(key) || completedCombos.has(wildKey)) {
            warnEl.innerHTML = '<i class="fa-solid fa-triangle-exclamation" style="margin-right:6px;"></i>This student has already completed ' + esc(subject) + ' Grade ' + esc(grade) + '.';
            warnEl.className = 'feedback warning';
            warnEl.style.display = 'block';
        } else {
            hideFeedback('completion-warn');
        }
    } else {
        hideFeedback('completion-warn');
    }

    updateBtn();
}

/* ==================================================================
   Assign Button
   ================================================================== */
function updateBtn() {
    var btn = document.getElementById('assign-btn');
    if (!btn) return;
    var hasStudent = !!selectedStudent;
    var hasSubject = (document.getElementById('assign-subject') || {}).value !== '';
    var hasGrade = (document.getElementById('assign-grade') || {}).value !== '';
    btn.disabled = !(hasStudent && hasSubject && hasGrade);
}

function hideFeedback(id) {
    var el = document.getElementById(id);
    if (el) { el.className = 'feedback'; el.style.display = 'none'; }
}

async function submitAssignment() {
    if (!selectedStudent) return;
    var subject = (document.getElementById('assign-subject') || {}).value || '';
    var grade = (document.getElementById('assign-grade') || {}).value || '';
    var assignType = (document.getElementById('assign-type') || {}).value || 'test-assignment';
    if (!subject || !grade) return;

    var btn = document.getElementById('assign-btn');
    var fbEl = document.getElementById('assign-feedback');
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Assigning...';
    hideFeedback('assign-feedback');

    var name = ((selectedStudent.givenName || '') + ' ' + (selectedStudent.familyName || '')).trim() || 'Unknown';

    try {
        var resp = await fetch('/api/assign-test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                studentId: selectedStudent.sourcedId,
                subject: subject,
                grade: grade,
                type: assignType,
            }),
        });
        var data = await resp.json().catch(function() { return {}; });

        if (resp.ok && data.success) {
            fbEl.textContent = data.message || 'Test assigned successfully!';
            fbEl.className = 'feedback success';
            fbEl.style.display = 'block';
            completedCombos.add(subject.toLowerCase() + '|' + grade);
            // Add to the existing assignments list
            existingAssignments.push({
                title: subject + ' Grade ' + grade,
                subject: subject,
                grade: grade,
                id: (data.response && data.response.id) || '',
                status: 'active',
            });
            renderAssignments();
            document.getElementById('assign-subject').value = '';
            document.getElementById('assign-grade').value = '';
            hideFeedback('completion-warn');
        } else {
            fbEl.textContent = data.error || data.message || 'Assignment failed.';
            fbEl.className = 'feedback error';
            fbEl.style.display = 'block';
        }
    } catch(e) {
        fbEl.textContent = 'The API is slow or unreachable. Please try again.';
        fbEl.className = 'feedback error';
        fbEl.style.display = 'block';
    }

    btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Assign Test';
    updateBtn();
}

/* (Recent assignments replaced by existing assignments panel) */
</script>
</body>
</html>
