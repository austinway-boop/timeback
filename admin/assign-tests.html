<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Assign Tests</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" as="style">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preload" href="/css/style.css" as="style">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* ── Hero ─────────────────────────────────────────────────── */
        .hero-banner {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }
        .hero-banner img {
            width: 100%; height: 160px; object-fit: cover; display: block;
        }
        .hero-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(135deg, rgba(69,181,170,0.88) 0%, rgba(56,158,148,0.82) 100%);
            display: flex; align-items: center; padding: 0 32px;
        }
        .hero-overlay h1 {
            font-size: 1.5rem; font-weight: 700; color: #fff; margin: 0 0 4px;
        }
        .hero-overlay p {
            font-size: 0.88rem; color: rgba(255,255,255,0.85); margin: 0;
        }

        /* ── Form card (matches dashboard-card pattern) ───────────── */
        .assign-card {
            background: var(--color-surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: visible;
            margin-bottom: 20px;
        }
        .assign-card .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-border);
        }
        .assign-card .card-header .card-title {
            font-size: 0.95rem; font-weight: 600;
        }
        .assign-card .card-header .card-title i {
            color: var(--color-primary); margin-right: 6px;
        }

        .assign-body { padding: 20px; }

        /* ── Form layout ──────────────────────────────────────────── */
        .form-row {
            display: grid;
            gap: 14px;
            margin-bottom: 14px;
        }
        .form-row-2 { grid-template-columns: 1fr 1fr; }
        .form-row-3 { grid-template-columns: 1fr 1fr 1fr; }

        .field {
            display: flex; flex-direction: column; position: relative;
        }
        .field label {
            font-size: 0.78rem; font-weight: 600;
            color: var(--color-text-muted);
            text-transform: uppercase; letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        .field input,
        .field select {
            padding: 9px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 0.9rem;
            outline: none;
            transition: border-color var(--transition);
        }
        .field input:focus,
        .field select:focus {
            border-color: var(--color-primary);
        }
        .field input::placeholder { color: var(--color-text-muted); }

        /* ── Submit area ──────────────────────────────────────────── */
        .submit-row {
            display: flex; align-items: center; gap: 12px;
            padding-top: 14px;
            border-top: 1px solid var(--color-border);
        }
        .assign-btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 9px 20px;
            background: var(--color-primary); color: #fff; border: none;
            border-radius: var(--radius-sm);
            font-size: 0.88rem; font-weight: 600;
            cursor: pointer; transition: background var(--transition);
        }
        .assign-btn:hover:not(:disabled) { background: var(--color-primary-dark); }
        .assign-btn:disabled {
            background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed;
        }
        .submit-hint {
            font-size: 0.82rem; color: var(--color-text-muted);
        }

        /* ── Feedback ─────────────────────────────────────────────── */
        .assign-msg {
            margin-top: 12px; padding: 9px 14px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem; font-weight: 500; display: none;
        }
        .assign-msg.success { display: block; background: #E8F5E9; color: #2E7D32; }
        .assign-msg.error { display: block; background: #FFF5F5; color: #E53E3E; }

        /* ── Search Dropdown ──────────────────────────────────────── */
        .search-results-dropdown {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 1000;
            background: #fff; border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-md);
            max-height: 260px; overflow-y: auto; display: none;
            margin-top: 2px;
        }
        .search-results-dropdown.open { display: block; }
        .search-result-item {
            padding: 9px 14px; cursor: pointer; font-size: 0.88rem;
            border-bottom: 1px solid var(--color-border); transition: background 0.1s;
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: var(--color-primary-light); }
        .search-result-name { font-weight: 600; color: var(--color-text); }
        .search-result-email { font-size: 0.78rem; color: var(--color-text-muted); }
        .search-result-empty {
            padding: 16px; text-align: center;
            color: var(--color-text-muted); font-size: 0.85rem;
        }

        /* ── Selected Student Chip ────────────────────────────────── */
        .selected-student-tag {
            display: inline-flex; align-items: center; gap: 6px;
            background: var(--color-primary-light); color: var(--color-primary-dark);
            padding: 4px 10px; border-radius: 20px;
            font-size: 0.82rem; font-weight: 600; margin-top: 6px;
        }
        .selected-student-tag button {
            border: none; background: none; color: var(--color-primary-dark);
            font-size: 1rem; cursor: pointer; padding: 0 2px; line-height: 1;
        }

        /* ── Recent table (matches mini-table pattern) ────────────── */
        .recent-table { width: 100%; border-collapse: collapse; }
        .recent-table th {
            padding: 10px 16px; text-align: left; font-weight: 600; font-size: 0.78rem;
            color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.5px;
            background: var(--color-bg); border-bottom: 1px solid var(--color-border);
        }
        .recent-table td {
            padding: 10px 16px; border-bottom: 1px solid var(--color-border); font-size: 0.88rem;
        }
        .recent-table tbody tr:hover { background: #FAFBFC; }
        .recent-table tbody tr:last-child td { border-bottom: none; }

        .empty-state {
            text-align: center; padding: 32px 16px; color: var(--color-text-muted);
        }
        .empty-state i { font-size: 1.8rem; margin-bottom: 8px; display: block; opacity: 0.35; }
        .empty-state p { font-size: 0.85rem; margin: 0; }

        @media (max-width: 768px) {
            .form-row-2, .form-row-3 { grid-template-columns: 1fr; }
            .hero-overlay { padding: 0 20px; }
            .hero-overlay h1 { font-size: 1.2rem; }
        }
    </style>
</head>
<body data-view="admin" data-active="assign-tests">

    <div class="layout">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="main-content">
            <div class="admin-assign-tests">

                <!-- Hero -->
                <div class="hero-banner">
                    <img src="/img/assign-tests-header.png" alt="">
                    <div class="hero-overlay">
                        <div>
                            <h1>Assign Tests</h1>
                            <p>Assign mastery tests and screening assignments for your students!</p>
                        </div>
                    </div>
                </div>

                <!-- Form -->
                <div class="assign-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fa-solid fa-clipboard-check"></i>New Assignment</h2>
                    </div>
                    <div class="assign-body">
                        <!-- Row 1: Student (full width) -->
                        <div class="form-row">
                            <div class="field">
                                <label>Student</label>
                                <input type="text" id="student-search-input" placeholder="Search by name or email..." autocomplete="off" oninput="onStudentSearch(this.value)">
                                <div id="student-search-results" class="search-results-dropdown"></div>
                                <div id="selected-student-display"></div>
                                <input type="hidden" id="selected-student-id" value="">
                            </div>
                        </div>
                        <!-- Row 2: Subject + Grade + Type -->
                        <div class="form-row form-row-3">
                            <div class="field">
                                <label>Subject</label>
                                <select id="assign-subject" onchange="updateAssignBtn()">
                                    <option value="">Select subject...</option>
                                    <option value="Math">Math</option>
                                    <option value="Reading">Reading</option>
                                    <option value="Writing">Writing</option>
                                    <option value="Science">Science</option>
                                    <option value="Social Studies">Social Studies</option>
                                    <option value="Language">Language</option>
                                    <option value="Vocabulary">Vocabulary</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>Grade</label>
                                <select id="assign-grade" onchange="updateAssignBtn()">
                                    <option value="">Select grade...</option>
                                    <option value="3">Grade 3</option>
                                    <option value="4">Grade 4</option>
                                    <option value="5">Grade 5</option>
                                    <option value="6">Grade 6</option>
                                    <option value="7">Grade 7</option>
                                    <option value="8">Grade 8</option>
                                    <option value="9">Grade 9</option>
                                    <option value="10">Grade 10</option>
                                    <option value="11">Grade 11</option>
                                    <option value="12">Grade 12</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>Type</label>
                                <select id="assign-type">
                                    <option value="test-assignment">Test Assignment</option>
                                    <option value="screening">Screening Test</option>
                                </select>
                            </div>
                        </div>
                        <!-- Submit -->
                        <div class="submit-row">
                            <button class="assign-btn" id="assign-btn" onclick="submitAssignment()" disabled>
                                <i class="fa-solid fa-paper-plane"></i> Assign Test
                            </button>
                            <span class="submit-hint" id="submit-hint">Select a student, subject, and grade to continue</span>
                        </div>
                        <div class="assign-msg" id="assign-msg"></div>
                    </div>
                </div>

                <!-- Recent Assignments -->
                <div class="assign-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fa-solid fa-clock-rotate-left"></i>Recent Assignments</h2>
                    </div>
                    <div id="recent-body">
                        <div class="empty-state">
                            <i class="fa-solid fa-inbox"></i>
                            <p>No assignments yet. Use the form above to assign a test.</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script src="/js/auth-guard.js?v=3"></script>
    <script src="/js/layout.js?v=2"></script>
    <script src="/js/app.js"></script>
    <script>
    /* ---- State ---------------------------------------------------------- */
    var cachedStudents = [];
    var selectedStudentId = '';
    var recentAssignments = [];

    function esc(s) {
        if (s == null) return '';
        if (typeof s !== 'string') s = String(s);
        return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    /* ---- Student search ------------------------------------------------- */
    var searchTimer = null;

    function onStudentSearch(query) {
        clearTimeout(searchTimer);
        if (!query || query.length < 2) {
            document.getElementById('student-search-results').className = 'search-results-dropdown';
            return;
        }
        searchTimer = setTimeout(function() { doStudentSearch(query); }, 300);
    }

    function doStudentSearch(query) {
        var q = query.toLowerCase();
        if (q.includes('@')) {
            fetch('/api/user-lookup?email=' + encodeURIComponent(query))
                .then(function(r) { return r.json(); })
                .then(function(d) { showSearchResults(d.user ? [d.user] : []); })
                .catch(function() { showSearchResults([]); });
        } else {
            var filtered = cachedStudents.filter(function(u) {
                var name = ((u.givenName||'') + ' ' + (u.familyName||'')).toLowerCase();
                return name.includes(q) || (u.email||'').toLowerCase().includes(q) || (u.username||'').toLowerCase().includes(q);
            }).slice(0, 20);
            showSearchResults(filtered);
        }
    }

    function showSearchResults(results) {
        var dd = document.getElementById('student-search-results');
        if (!results.length) {
            dd.innerHTML = '<div class="search-result-empty">No students found.</div>';
            dd.className = 'search-results-dropdown open';
            return;
        }
        dd.innerHTML = results.slice(0,20).map(function(u) {
            var name = ((u.givenName||'') + ' ' + (u.familyName||'')).trim() || 'Unknown';
            var email = u.email || '';
            var id = u.sourcedId || '';
            return '<div class="search-result-item" onclick="selectStudent(\'' + id + '\',\'' + name.replace(/'/g,"\\'") + '\',\'' + email.replace(/'/g,"\\'") + '\')">' +
                '<div class="search-result-name">' + esc(name) + '</div>' +
                '<div class="search-result-email">' + esc(email) + '</div></div>';
        }).join('');
        dd.className = 'search-results-dropdown open';
    }

    function selectStudent(id, name, email) {
        selectedStudentId = id;
        document.getElementById('selected-student-id').value = id;
        document.getElementById('student-search-input').value = '';
        document.getElementById('student-search-results').className = 'search-results-dropdown';
        document.getElementById('selected-student-display').innerHTML =
            '<div class="selected-student-tag"><i class="fa-solid fa-user"></i> ' + esc(name) + ' (' + esc(email) + ')' +
            '<button onclick="clearSelectedStudent()" title="Remove">&times;</button></div>';
        updateAssignBtn();
    }

    function clearSelectedStudent() {
        selectedStudentId = '';
        document.getElementById('selected-student-id').value = '';
        document.getElementById('selected-student-display').innerHTML = '';
        updateAssignBtn();
    }

    document.addEventListener('click', function(e) {
        var dd = document.getElementById('student-search-results');
        if (dd && !e.target.closest('.field')) dd.className = 'search-results-dropdown';
    });

    /* ---- Assign button -------------------------------------------------- */
    function updateAssignBtn() {
        var btn = document.getElementById('assign-btn');
        var hint = document.getElementById('submit-hint');
        if (!btn) return;
        var hasStudent = selectedStudentId !== '';
        var hasSubject = (document.getElementById('assign-subject')||{}).value !== '';
        var hasGrade = (document.getElementById('assign-grade')||{}).value !== '';
        var ready = hasStudent && hasSubject && hasGrade;
        btn.disabled = !ready;
        if (hint) {
            if (ready) hint.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#48BB78;margin-right:3px;"></i> Ready to assign';
            else {
                var m = [];
                if (!hasStudent) m.push('student');
                if (!hasSubject) m.push('subject');
                if (!hasGrade) m.push('grade');
                hint.textContent = 'Select ' + m.join(', ') + ' to continue';
            }
        }
    }

    async function submitAssignment() {
        var subject = (document.getElementById('assign-subject')||{}).value || '';
        var grade = (document.getElementById('assign-grade')||{}).value || '';
        var assignType = (document.getElementById('assign-type')||{}).value || 'test-assignment';
        if (!subject || !grade || !selectedStudentId) return;

        var btn = document.getElementById('assign-btn');
        var msgEl = document.getElementById('assign-msg');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Assigning...';
        msgEl.className = 'assign-msg'; msgEl.style.display = 'none';

        var tag = document.querySelector('.selected-student-tag');
        var studentName = tag ? tag.textContent.replace('\u00d7','').trim() : 'Unknown';

        try {
            var resp = await fetch('/api/assign-test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ studentId: selectedStudentId, subject: subject, grade: grade, type: assignType }),
            });
            var data = await resp.json().catch(function() { return {}; });
            if (resp.ok && data.success) {
                msgEl.textContent = data.message || 'Test assigned successfully!';
                msgEl.className = 'assign-msg success'; msgEl.style.display = 'block';
                addRecent(studentName, subject, grade, assignType, 'success');
                clearSelectedStudent();
                document.getElementById('assign-subject').value = '';
                document.getElementById('assign-grade').value = '';
            } else {
                msgEl.textContent = data.error || data.message || 'Assignment failed.';
                msgEl.className = 'assign-msg error'; msgEl.style.display = 'block';
                addRecent(studentName, subject, grade, assignType, 'error');
            }
        } catch(e) {
            msgEl.textContent = 'Network error. Please try again.';
            msgEl.className = 'assign-msg error'; msgEl.style.display = 'block';
            addRecent(studentName, subject, grade, assignType, 'error');
        }
        btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Assign Test';
        updateAssignBtn();
    }

    /* ---- Recent Assignments --------------------------------------------- */
    function addRecent(name, subject, grade, type, status) {
        recentAssignments.unshift({ name, subject, grade, type, status });
        if (recentAssignments.length > 20) recentAssignments.pop();
        renderRecent();
    }

    function renderRecent() {
        var el = document.getElementById('recent-body');
        if (!recentAssignments.length) {
            el.innerHTML = '<div class="empty-state"><i class="fa-solid fa-inbox"></i><p>No assignments yet.</p></div>';
            return;
        }
        el.innerHTML = '<table class="recent-table"><thead><tr><th>Student</th><th>Subject</th><th>Grade</th><th>Type</th><th>Status</th></tr></thead><tbody>' +
            recentAssignments.map(function(a) {
                var badge = a.status === 'success'
                    ? '<span class="status-badge status-active">Assigned</span>'
                    : '<span class="status-badge status-tobedeleted">Failed</span>';
                return '<tr><td style="font-weight:600;">' + esc(a.name) + '</td><td>' + esc(a.subject) +
                    '</td><td>Grade ' + esc(a.grade) + '</td><td>' + (a.type==='screening'?'Screening':'Test Assignment') +
                    '</td><td>' + badge + '</td></tr>';
            }).join('') + '</tbody></table>';
    }

    /* ---- Init ----------------------------------------------------------- */
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            var resp = await fetch('/api/users');
            var data = await resp.json();
            cachedStudents = (data.users||[]).filter(function(u) {
                return (u.role||'').toLowerCase() === 'student';
            }).slice(0, 500);
        } catch(e) {
            console.warn('[Admin] Failed to load students:', e.message);
        }
        updateAssignBtn();
    });
    </script>
</body>
</html>
