<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLearn - Assign Tests</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" as="style">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preload" href="/css/style.css" as="style">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .hero-banner { position:relative; border-radius:var(--radius); overflow:hidden; margin-bottom:24px; box-shadow:var(--shadow); }
        .hero-banner img { width:100%; height:150px; object-fit:cover; display:block; }
        .hero-overlay { position:absolute; inset:0; background:linear-gradient(135deg,rgba(69,181,170,0.88),rgba(56,158,148,0.82)); display:flex; align-items:center; padding:0 32px; }
        .hero-overlay h1 { font-size:1.7rem; font-weight:700; color:#fff; margin:0 0 4px; }
        .hero-overlay p { font-size:0.95rem; color:rgba(255,255,255,0.85); margin:0; }

        .search-wrap { position:relative; margin-bottom:20px; }
        .search-wrap .search-icon { position:absolute; left:14px; top:50%; transform:translateY(-50%); color:var(--color-text-muted); font-size:0.9rem; pointer-events:none; }
        .search-wrap input { width:100%; padding:10px 14px 10px 40px; border:1px solid var(--color-border); border-radius:var(--radius-sm); background:var(--color-surface); color:var(--color-text); font-size:0.9rem; outline:none; transition:border-color var(--transition); box-shadow:var(--shadow); }
        .search-wrap input:focus { border-color:var(--color-primary); }
        .search-wrap input::placeholder { color:var(--color-text-muted); }

        .search-dropdown { position:absolute; top:100%; left:0; right:0; z-index:1000; background:#fff; border:1px solid var(--color-border); border-radius:var(--radius-sm); box-shadow:var(--shadow-md); max-height:320px; overflow-y:auto; display:none; margin-top:4px; }
        .search-dropdown.open { display:block; }
        .search-item { display:flex; align-items:center; gap:12px; padding:10px 14px; cursor:pointer; border-bottom:1px solid var(--color-border); transition:background 0.1s; }
        .search-item:last-child { border-bottom:none; }
        .search-item:hover { background:var(--color-primary-light); }
        .search-item-name { font-weight:600; font-size:0.9rem; color:var(--color-text); }
        .search-item-email { font-size:0.8rem; color:var(--color-text-muted); }
        .search-empty { padding:20px; text-align:center; color:var(--color-text-muted); font-size:0.85rem; }

        .two-col { display:grid; grid-template-columns:1fr 1fr; gap:20px; }

        .panel-card { background:var(--color-surface); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
        .panel-card .card-header { padding:16px 20px; border-bottom:1px solid var(--color-border); display:flex; align-items:center; gap:12px; }
        .panel-card .card-title { font-size:1.05rem; font-weight:600; margin:0; flex:1; }
        .panel-card .card-title i { color:var(--color-primary); margin-right:8px; }
        .panel-body { padding:16px 20px; max-height:520px; overflow-y:auto; }

        /* Subject filter dropdown */
        .filter-select { padding:6px 10px; border:1px solid var(--color-border); border-radius:var(--radius-sm); background:var(--color-surface); color:var(--color-text); font-size:0.82rem; outline:none; cursor:pointer; font-family:inherit; }
        .filter-select:focus { border-color:var(--color-primary); }

        .test-row { display:flex; align-items:center; gap:12px; padding:9px 12px; border-radius:var(--radius-sm); border:1px solid var(--color-border); margin-bottom:6px; transition:all var(--transition); }
        .test-row:last-child { margin-bottom:0; }
        .test-row-info { flex:1; min-width:0; }
        .test-row-title { font-weight:600; font-size:0.88rem; color:var(--color-text); }
        .test-row-meta { font-size:0.75rem; color:var(--color-text-muted); }
        .test-btn { padding:4px 12px; border:none; border-radius:var(--radius-sm); font-size:0.75rem; font-weight:600; cursor:pointer; transition:all var(--transition); white-space:nowrap; }
        .test-btn.assign { background:var(--color-primary); color:#fff; }
        .test-btn.assign:hover { background:var(--color-primary-dark); }
        .test-btn.assigned { background:#FFF8E1; color:#F57F17; cursor:default; }
        .test-btn.completed { background:#E8F5E9; color:#2E7D32; cursor:default; }
        .test-btn.failed { background:#FFF3E0; color:#E65100; cursor:default; }
        .test-btn.loading { background:var(--color-border); color:var(--color-text-muted); cursor:wait; }

        .pending-row { display:flex; align-items:center; gap:12px; padding:9px 12px; border-radius:var(--radius-sm); background:var(--color-bg); margin-bottom:6px; }
        .pending-row:last-child { margin-bottom:0; }
        .pending-row-info { flex:1; }
        .pending-row-title { font-weight:600; font-size:0.88rem; }
        .pending-row-meta { font-size:0.75rem; color:var(--color-text-muted); }
        .remove-btn { padding:3px 10px; border:1px solid var(--color-border); border-radius:var(--radius-sm); background:transparent; color:var(--color-text-muted); font-size:0.72rem; font-weight:600; cursor:pointer; transition:all var(--transition); }
        .remove-btn:hover { border-color:#E53E3E; color:#E53E3E; background:#FFF5F5; }

        .feedback { margin:10px 20px 16px; padding:9px 12px; border-radius:var(--radius-sm); font-size:0.85rem; font-weight:500; display:none; }
        .feedback.success { display:block; background:#E8F5E9; color:#2E7D32; }
        .feedback.error { display:block; background:#FFF5F5; color:#E53E3E; }

        .empty-state { text-align:center; padding:32px 16px; color:var(--color-text-muted); }
        .empty-state i { font-size:1.6rem; margin-bottom:8px; display:block; opacity:0.3; }
        .empty-state p { font-size:0.85rem; margin:0; }

        @media(max-width:900px) { .two-col { grid-template-columns:1fr; } }
    </style>
</head>
<body data-view="admin" data-active="assign-tests">

<div class="layout">
    <nav class="sidebar" id="sidebar"></nav>
    <main class="main-content">
        <div>
            <div class="hero-banner">
                <img src="/img/assign-tests-header.png" alt="">
                <div class="hero-overlay">
                    <div>
                        <h1>Assign Tests</h1>
                        <p>Assign mastery tests and screening assignments for your students!</p>
                    </div>
                </div>
            </div>

            <div class="search-wrap">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="student-search" placeholder="Search for a student by name or email..." autocomplete="off">
                <div class="search-dropdown" id="search-dropdown"></div>
            </div>

            <div class="two-col" id="panels" style="display:none;">
                <div class="panel-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fa-solid fa-clipboard-check"></i>Available Tests</h2>
                        <select class="filter-select" id="subject-filter" onchange="renderTests()">
                            <option value="all">All Subjects</option>
                        </select>
                    </div>
                    <div class="panel-body" id="tests-list"></div>
                    <div id="assign-feedback"></div>
                </div>

                <div class="panel-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fa-solid fa-hourglass-half"></i>Student's Tests</h2>
                    </div>
                    <div class="panel-body" id="pending-tests"></div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="/js/auth-guard.js?v=3"></script>
<script src="/js/layout.js?v=2"></script>
<script src="/js/app.js"></script>
<script>
var cachedStudents = [];
var selectedStudent = null;
var existingAssignments = [];
var enrolledKeys = new Set();

function esc(s) {
    if (s == null) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ── Test catalog ──────────────────────────────────────────── */
var TEST_CATALOG = [
    { subject: 'Reading',        grades: ['3','4','5','6','7','8','9','10','11','12'] },
    { subject: 'Math',           grades: ['3','4','5','6','7','8','9','10','11','12'] },
    { subject: 'Writing',        grades: ['3','4','5','6','7','8'] },
    { subject: 'Language',       grades: ['3','4','5','6','7','8'] },
    { subject: 'Science',        grades: ['3','4','5','6','7','8'] },
    { subject: 'Social Studies', grades: ['3','4','5','6','7','8'] },
    { subject: 'Vocabulary',     grades: ['3','4','5','6','7','8','9','10','11','12'] },
    { subject: 'FastMath',       grades: ['3','4','5','6','7','8','9','10','11','12'] },
];

var ALL_TESTS = [];
TEST_CATALOG.forEach(function(cat) {
    cat.grades.forEach(function(g) {
        ALL_TESTS.push({ subject: cat.subject, grade: g, name: cat.subject + ' Grade ' + g });
    });
});

/* ── Init ──────────────────────────────────────────────────── */
var searchInput, searchTimer;

document.addEventListener('DOMContentLoaded', async function() {
    searchInput = document.getElementById('student-search');
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimer);
        var q = this.value.trim();
        if (q.length < 1) { closeDD(); return; }
        // Start showing results immediately as you type
        searchTimer = setTimeout(function() { doSearch(q); }, 100);
    });
    document.addEventListener('click', function(e) { if (!e.target.closest('.search-wrap')) closeDD(); });

    try {
        var r = await fetch('/api/users');
        var d = await r.json();
        cachedStudents = (d.users || []).filter(function(u) { return (u.role || '').toLowerCase() === 'student'; });
    } catch(e) {}
});

/* ── Search ────────────────────────────────────────────────── */
function doSearch(q) {
    var lq = q.toLowerCase();
    if (lq.includes('@')) {
        fetch('/api/user-lookup?email=' + encodeURIComponent(q))
            .then(function(r) { return r.json(); })
            .then(function(d) { renderDD(d.user ? [d.user] : []); })
            .catch(function() { renderDD([]); });
        return;
    }
    var res = cachedStudents.filter(function(u) {
        var f = (u.givenName || '').toLowerCase(), l = (u.familyName || '').toLowerCase();
        return f.includes(lq) || l.includes(lq) || (f + ' ' + l).includes(lq)
            || (u.email || '').toLowerCase().includes(lq) || (u.username || '').toLowerCase().includes(lq);
    });
    renderDD(res.slice(0, 30));
}

function renderDD(list) {
    var dd = document.getElementById('search-dropdown');
    if (!list.length) { dd.innerHTML = '<div class="search-empty">No students found.</div>'; dd.classList.add('open'); return; }
    dd.innerHTML = list.map(function(u) {
        var nm = ((u.givenName || '') + ' ' + (u.familyName || '')).trim() || 'Unknown';
        return '<div class="search-item" data-id="' + esc(u.sourcedId) + '" onclick="pickStudent(this)">' +
            '<div class="user-cell-avatar">' + esc((u.givenName || '?')[0].toUpperCase()) + '</div>' +
            '<div style="flex:1;min-width:0;"><div class="search-item-name">' + esc(nm) +
            '</div><div class="search-item-email">' + esc(u.email || '') + '</div></div></div>';
    }).join('');
    dd.classList.add('open');
}

function closeDD() { document.getElementById('search-dropdown').classList.remove('open'); }

/* ── Pick Student ──────────────────────────────────────────── */
function pickStudent(el) {
    var id = el.getAttribute('data-id');
    var user = cachedStudents.find(function(u) { return u.sourcedId === id; });
    if (!user) {
        var n = el.querySelector('.search-item-name'), e = el.querySelector('.search-item-email');
        user = { sourcedId: id, givenName: n ? n.textContent : '', familyName: '', email: e ? e.textContent : '' };
    }

    selectedStudent = user;
    existingAssignments = [];
    closeDD();

    var nm = ((user.givenName || '') + ' ' + (user.familyName || '')).trim();
    searchInput.value = nm;

    document.getElementById('panels').style.display = '';
    document.getElementById('tests-list').innerHTML = '<div class="empty-state"><i class="fa-solid fa-spinner fa-spin" style="opacity:0.5;"></i><p>Loading tests...</p></div>';
    document.getElementById('pending-tests').innerHTML = '<div class="empty-state"><i class="fa-solid fa-spinner fa-spin" style="opacity:0.5;"></i><p>Loading...</p></div>';
    document.getElementById('subject-filter').value = 'all';
    clearFeedback();

    loadAssignments(user.sourcedId);
}

/* ── Load Enrollments + Assignments ────────────────────────── */
async function loadAssignments(studentId) {
    existingAssignments = [];
    enrolledKeys = new Set();

    try {
        var [assignResp, enrollResp] = await Promise.all([
            fetch('/api/assign-test?studentId=' + encodeURIComponent(studentId)).then(function(r) { return r.json(); }).catch(function() { return { testAssignments: [] }; }),
            fetch('/api/enrollments?userId=' + encodeURIComponent(studentId)).then(function(r) { return r.json(); }).catch(function() { return {}; }),
        ]);

        existingAssignments = assignResp.testAssignments || [];

        // Build enrolled subject+grade set from enrollments
        var raw = enrollResp.data || enrollResp.enrollments || enrollResp.courses || (Array.isArray(enrollResp) ? enrollResp : []);
        for (var i = 0; i < raw.length; i++) {
            var e = raw[i];
            var c = e.course || {};
            var title = (c.title || '').trim();
            var subjects = c.subjects || [];
            var grades = c.grades || [];
            if (!title || !subjects.length) continue;
            if (title.startsWith('Manual XP') || title.includes('Hole-Filling')) continue;
            var subj = subjects[0];
            for (var g = 0; g < grades.length; g++) {
                enrolledKeys.add(subj.toLowerCase() + '|' + grades[g]);
            }
        }

        // Include any existing test assignments as enrolled too
        for (var j = 0; j < existingAssignments.length; j++) {
            var a = existingAssignments[j];
            if (a.subject && a.grade) enrolledKeys.add(a.subject.toLowerCase() + '|' + a.grade);
        }
    } catch(e) {}

    // Rebuild filter dropdown to only show enrolled subjects
    var sel = document.getElementById('subject-filter');
    var current = sel.value;
    sel.innerHTML = '<option value="all">All Subjects</option>';
    var seen = {};
    ALL_TESTS.forEach(function(t) {
        if (enrolledKeys.has(t.subject.toLowerCase() + '|' + t.grade) && !seen[t.subject]) {
            seen[t.subject] = true;
            var opt = document.createElement('option');
            opt.value = t.subject;
            opt.textContent = t.subject;
            sel.appendChild(opt);
        }
    });
    if (seen[current]) sel.value = current; else sel.value = 'all';

    renderTests();
    renderPending();
}

/* ── Render All Tests ──────────────────────────────────────── */
function renderTests() {
    var el = document.getElementById('tests-list');
    var filter = document.getElementById('subject-filter').value;

    // Build status lookup from existing assignments
    var statusMap = {};
    existingAssignments.forEach(function(a) {
        var key = (a.subject || '').toLowerCase() + '|' + (a.grade || '');
        statusMap[key] = a.assignmentStatus || 'assigned';
    });

    // Only show tests the student is enrolled in
    var tests = ALL_TESTS.filter(function(t) {
        return enrolledKeys.has(t.subject.toLowerCase() + '|' + t.grade);
    });
    if (filter !== 'all') {
        tests = tests.filter(function(t) { return t.subject === filter; });
    }

    if (!tests.length) {
        el.innerHTML = '<div class="empty-state"><i class="fa-solid fa-clipboard-list"></i><p>No assignable tests for this student' +
            (filter !== 'all' ? ' in ' + esc(filter) : '') + '.</p></div>';
        return;
    }

    el.innerHTML = tests.map(function(t, idx) {
        var key = t.subject.toLowerCase() + '|' + t.grade;
        var status = statusMap[key] || '';
        var btnHtml;

        if (status === 'completed') {
            btnHtml = '<span class="test-btn completed"><i class="fa-solid fa-check" style="margin-right:3px;"></i>Done</span>';
        } else if (status === 'assigned' || status === 'in_progress') {
            btnHtml = '<span class="test-btn assigned"><i class="fa-solid fa-clock" style="margin-right:3px;"></i>Pending</span>';
        } else if (status === 'failed') {
            btnHtml = '<span class="test-btn failed"><i class="fa-solid fa-rotate" style="margin-right:3px;"></i>Failed</span>';
        } else {
            btnHtml = '<button class="test-btn assign" id="tbtn-' + idx + '" onclick="assignTest(\'' + esc(t.subject) + '\',\'' + esc(t.grade) + '\',' + idx + ')"><i class="fa-solid fa-plus" style="margin-right:3px;"></i>Assign</button>';
        }

        return '<div class="test-row">' +
            '<div class="test-row-info">' +
                '<div class="test-row-title">' + esc(t.name) + '</div>' +
            '</div>' + btnHtml + '</div>';
    }).join('');
}

/* ── Render Student's Existing Tests ───────────────────────── */
function renderPending() {
    var el = document.getElementById('pending-tests');
    if (!existingAssignments.length) {
        el.innerHTML = '<div class="empty-state"><i class="fa-solid fa-check-circle"></i><p>No test assignments yet.</p></div>';
        return;
    }

    el.innerHTML = existingAssignments.map(function(a, idx) {
        var title = a.testName || ((a.subject || '') + ' Grade ' + (a.grade || ''));
        var status = a.assignmentStatus || 'assigned';
        var statusLabel = status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ');
        var date = a.assignedAt ? new Date(a.assignedAt).toLocaleDateString() : '';
        var statusClass = status === 'completed' ? 'status-active' : status === 'failed' ? 'status-tobedeleted' : 'status-testing';

        return '<div class="pending-row">' +
            '<div class="pending-row-info">' +
                '<div class="pending-row-title">' + esc(title) + '</div>' +
                '<div class="pending-row-meta"><span class="status-badge ' + statusClass + '">' + esc(statusLabel) + '</span>' +
                    (date ? ' &middot; ' + esc(date) : '') + '</div>' +
            '</div>' +
            (status !== 'completed' ? '<button class="remove-btn" onclick="removeAssignment(' + idx + ')"><i class="fa-solid fa-xmark"></i></button>' : '') +
        '</div>';
    }).join('');
}

/* ── Assign ────────────────────────────────────────────────── */
async function assignTest(subject, grade, idx) {
    if (!selectedStudent) return;
    var btn = document.getElementById('tbtn-' + idx);
    if (btn) { btn.className = 'test-btn loading'; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; }
    clearFeedback();

    try {
        var resp = await fetch('/api/assign-test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ studentId: selectedStudent.sourcedId, subject: subject, gradeLevel: grade }),
        });
        var data = await resp.json().catch(function() { return {}; });

        if (resp.ok && data.success) {
            showFeedback(data.message || 'Test assigned!', 'success');
            existingAssignments.push({
                sourcedId: (data.response && data.response.assignmentId) || '',
                subject: subject, grade: grade,
                assignmentStatus: 'assigned',
                assignedAt: new Date().toISOString(),
                testName: subject + ' Grade ' + grade,
            });
            renderTests();
            renderPending();
        } else {
            showFeedback(data.error || data.message || 'Assignment failed.', 'error');
            if (btn) { btn.className = 'test-btn assign'; btn.innerHTML = '<i class="fa-solid fa-plus" style="margin-right:3px;"></i>Assign'; }
        }
    } catch(e) {
        showFeedback('Network error. Try again.', 'error');
        if (btn) { btn.className = 'test-btn assign'; btn.innerHTML = '<i class="fa-solid fa-plus" style="margin-right:3px;"></i>Assign'; }
    }
}

/* ── Remove ────────────────────────────────────────────────── */
async function removeAssignment(idx) {
    var a = existingAssignments[idx];
    if (!a) return;
    existingAssignments.splice(idx, 1);
    renderPending();
    renderTests();
    try {
        await fetch('/api/assign-test', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ assignmentId: a.sourcedId || '', studentId: selectedStudent ? selectedStudent.sourcedId : '', subject: a.subject || '', gradeLevel: a.grade || '' }),
        });
    } catch(e) {}
}

function showFeedback(msg, type) { document.getElementById('assign-feedback').innerHTML = '<div class="feedback ' + type + '">' + esc(msg) + '</div>'; }
function clearFeedback() { document.getElementById('assign-feedback').innerHTML = ''; }
</script>
</body>
</html>
